"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function GanttService(e,t){if(!t){this.sfdcType="service",this.id=e.Fields.Id||null,this.name=e.Fields.AppointmentNumber||null,this.AssignedResourceLastModifiedDate=e.AssignedResourceLastModifiedDate||null,this.ServiceAppointmentLastModifiedDate=e.ServiceAppointmentLastModifiedDate||null,this.accountName=e.Fields["Account.Name"]||null,this.accountId=e.Fields.AccountId||null,this.latitude=e.Fields.Latitude||null,this.longitude=e.Fields.Longitude||null,this.arrivalWindowEndTime=e.Fields.ArrivalWindowEndTime||null,this.arrivalWindowStartTime=e.Fields.ArrivalWindowStartTime||null,this.dueDate=e.Fields.DueDate||null,this.durationType=e.Fields.DurationType||null,this.earliestStartTime=e.Fields.EarliestStartTime||null,this.estDuration=e.Fields.Duration||null,this.travelTimeFrom=e.Fields.EstimatedTravelTimeFrom__c||null,this.travelTimeTo=e.Fields.EstimatedTravelTime||null,this.ganttLabel=e.Fields.GanttLabel__c||null,this.jeopardy=e.Fields.InJeopardy__c||null,this.jeopardyReason=e.Fields.InJeopardyReason__c||null,this.parentRecord=e.Fields.ParentRecordId||null,this.parentRecordStatus=e.Fields.ParentRecordStatusCategory||null,this.parentRecordType=e.Fields.ParentRecordType||null,this.pinned=e.Fields.Pinned__c||!1,this.schedEndTime=e.Fields.SchedEndTime||null,this.schedStartTime=e.Fields.SchedStartTime||null,this.serviceTerritory=e.Fields.ServiceTerritory||null,this.serviceTerritoryName=e.Fields["ServiceTerritory.Name"]||null,this.status=e.Fields.Status||null,this.statusCategory=e.Fields.StatusCategory||null,this.subject=e.Fields.Subject||null,this.ganttColor=e.Fields.GanttColor__c||null,this.resource=e.Resource||null,this.resourceName=e.ResourceName||null,this.resourceContractor=e.ResourceContractor||null,this.assignedResource=e.AssignedResource||null,this.violations=null,this.relatedTo=e.relatedTo||null,this.relatedFather=null,this.priority=this.minPriority,this.relatedFather=e.relatedFather,this.policyUsed=e.Fields.Scheduling_Policy_Used__c||null,this.scheduleMode=e.Fields.Schedule_Mode__c||null,this.emergency=e.Fields.Emergency__c||!1,this.isServiceInChain=usingNewMstModel&&e.isServiceInChain,this.relatedService2=e.relatedService2||null,this.relatedService1=e.relatedService1||null;var n="WorkOrder"==e.Fields.ParentRecordType?CustomSettings.woPriorityField:CustomSettings.woliPriorityField;n&&e.ParentFields&&e.ParentFields[n]&&(this.priority=e.ParentFields[n]);var s=fslNamespace?mdtBooleanField.replace(fslNamespace+"__",""):mdtBooleanField;this.isMDT=e.Fields[s]?!0:!1,e.Fields.MDT_Operational_Time__c?this.calculateMdtTimes(e.Fields.MDT_Operational_Time__c):this.isMDT&&(this.mdtTimes={travel:[],working:[]}),this.parentFields={};for(var i in e.ParentFields)this.parentFields[i]=e.ParentFields[i];this.setSchedulerProperties();for(var r in GanttService.prototype.allFieldSets)addFieldSetToServiceObject(GanttService.prototype.allFieldSets[r],e.Fields,this);this.isMDT&&(this.travelTimeFrom=0,this.travelTimeTo=0)}}function getGanttResourceWithSecondaryStms(e){if(showSecondarySTMs){var t=e.resourceId.split(",");if(e.resourceBeforeDrag&&e.resourceBeforeDrag!=e.resourceId&&t.length>1)for(var n=0;n<t.length;n++)if(e.resourceBeforeDrag.split(",")[n]!=t[n]){e.resourceId=t[n];break}}}function addFieldSetToServiceObject(e,t,n){for(var s=0;s<e.length;s++){var i=null;if(i=t[e[s].APIName],i||0==i){switch(e[s].Type){case"DATETIME":var r=60*new Date(i).getTimezoneOffset()*1e3;i=new Date(i+r);break;case"DATE":var r=60*new Date(i).getTimezoneOffset()*1e3;i=new Date(i+r);break;case"REFERENCE":var a=e[s].JsAPIName.replace("__r","__c");n[a]=t[a]}n[e[s].APIName]=i}}}function LastKnownPosition(e){this.id=e.Id,this.latitude=e[fieldNames.ServiceResource.LastKnownLocation__Latitude__s],this.longitude=e[fieldNames.ServiceResource.LastKnownLocation__Longitude__s],this.lastModifiedDate=e[fieldNames.ServiceResource.LastKnownLocationUpdate__c];var t=void 0;this.lastModifiedDate&&(t=60*new Date(this.lastModifiedDate).getTimezoneOffset()*1e3),this.lastModifiedDate=this.lastModifiedDate?new Date(this.lastModifiedDate+t):null}function OptimizationRequest(e){if(this.id=e.Id,this.lastModifiedDate=e.LastModifiedDate,this.name=e.Name,this.scheduledAmount=e[fieldNames.Optimization_Request.Objects_Scheduled__c],this.objectToScheduled=e[fieldNames.Optimization_Request.Objects_To_Schedule__c],this.status=e[fieldNames.Optimization_Request.Status__c]||null,this.allTasks=e[fieldNames.Optimization_Request.All_Tasks_Mode__c]||null,this.includeEmptyLocations=e[fieldNames.Optimization_Request.Include_Services_With_Empty_Location__c]||null,this.type=e[fieldNames.Optimization_Request.Type__c]||null,this.failureReason=e[fieldNames.Optimization_Request.Failure_Reason__c]||null,this.optimizationData=e[fieldNames.Optimization_Request.Optimization_Data__c]||null,this.orgResourceAbsence=e[fieldNames.Optimization_Request.Originating_Resource_Absence__c]||null,this.orgServiceAppointment=e[fieldNames.Optimization_Request.Originating_Service_Appointment__c]||null,this.policy=e[fieldNames.Optimization_Request.Scheduling_Policy__c]||null,this.serviceAppointment=e[fieldNames.Optimization_Request.Service_Appointment__c]||null,this.resource=e[fieldNames.Optimization_Request.Service_Resource__c]||null,this.result=e[fieldNames.Optimization_Request.Result__c]||null,this.timespan=null,this.finish=e[fieldNames.Optimization_Request.Finish__c]?new Date(e[fieldNames.Optimization_Request.Finish__c]):null,this.start=e[fieldNames.Optimization_Request.Start__c]?new Date(e[fieldNames.Optimization_Request.Start__c]):null,this.start){var t=60*new Date(this.start).getTimezoneOffset()*1e3;this.start=new Date(this.start.valueOf()+t)}if(this.finish){var n=60*new Date(this.finish).getTimezoneOffset()*1e3;this.finish=new Date(this.finish.valueOf()+n)}}function ResourceAbsence(e){this.id=e.Id,this.end=e[fieldNames.ResourceAbsence.End],this.resource=e[fieldNames.ResourceAbsence.Resource],this.start=e[fieldNames.ResourceAbsence.Start],this.absenceType=e[fieldNames.ResourceAbsence.Type]||"",this.reason=e[fieldNames.ResourceAbsence.Type]||"",this.ganttLabel=e[fieldNames.ResourceAbsence.GanttLabel__c]||null,this.lastModifiedDate=e.LastModifiedDate||null,this.name=e.AbsenceNumber,this.resourceName=e[fieldNames.ResourceAbsence.Resource__r].Name,this.ganttColor=e[fieldNames.ResourceAbsence.Gantt_Color__c],this.approved=e[fieldNames.ResourceAbsence.Approved__c],this.travelTo=e[fieldNames.ResourceAbsence.EstTravelTime__c]?60*e[fieldNames.ResourceAbsence.EstTravelTime__c]:0,this.travelFrom=e[fieldNames.ResourceAbsence.EstTravelTimeFrom__c]?60*e[fieldNames.ResourceAbsence.EstTravelTimeFrom__c]:0,this.sfdcType="absence",e.RecordType&&e.RecordType.DeveloperName&&"Non_Availability"==e.RecordType.DeveloperName?this.type="na":this.type="break",this.setSchedulerProperties()}function ResourceCapacity(e){this.sfdcType="capacity",this.id=e.Id,this.end=e[fieldNames.ResourceCapacity.EndDate],this.resource=e[fieldNames.ResourceCapacity.ServiceResource],this.resourceName=e[fieldNames.ResourceCapacity.ServiceResource__r]?e[fieldNames.ResourceCapacity.ServiceResource__r].Name:null,this.start=e[fieldNames.ResourceCapacity.StartDate],this.hoursInUse=e[fieldNames.ResourceCapacity.HoursInUse__c],this.hoursPerTimePeriod=e[fieldNames.ResourceCapacity.CapacityInHours]||0,this.minutesUsed=e[fieldNames.ResourceCapacity.MinutesUsed__c],this.lastModifiedDate=e.LastModifiedDate||null,this.name=e.CapacityNumber,this.timePeriod=e[fieldNames.ResourceCapacity.TimePeriod],this.workItemsAllocated=e[fieldNames.ResourceCapacity.Work_Items_Allocated__c],this.workItemsPerTimePeriod=e[fieldNames.ResourceCapacity.CapacityInWorkItems]||0,this.setSchedulerProperties()}function addDaysToDate(e,t){var n=864e5*t;return new Date(e.getTime()+n)}function calcCapacityPercentage(e,t){return parseFloat((e/t*100).toFixed(2))}function ResourcesAndTerritories(e){this.id=e.Id,this.name=e.MemberNumber,this.effectiveEndDate=e[fieldNames.ServiceTerritoryMember.EffectiveEndDate]||null,this.effectiveStartDate=e[fieldNames.ServiceTerritoryMember.EffectiveStartDate],this.latitude=e[fieldNames.ServiceTerritoryMember.Latitude],this.longitude=e[fieldNames.ServiceTerritoryMember.Longitude],this.serviceResource=e[fieldNames.ServiceTerritoryMember.ServiceResource],this.serviceResource__r=e[fieldNames.ServiceTerritoryMember.ServiceResource__r],this.serviceTerritory=e[fieldNames.ServiceTerritoryMember.ServiceTerritory],this.serviceTerritory__r=e[fieldNames.ServiceTerritoryMember.ServiceTerritory__r],this.serviceTerritoryType=e[fieldNames.ServiceTerritoryMember.TerritoryType],this.operatingHours=e[fieldNames.ServiceTerritoryMember.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritoryMember.OperatingHours__r];var t=void 0,n=void 0;this.effectiveStartDate&&(t=60*new Date(this.effectiveStartDate).getTimezoneOffset()*1e3),this.effectiveEndDate&&(n=60*new Date(this.effectiveEndDate).getTimezoneOffset()*1e3),this.effectiveStartDate=this.effectiveStartDate?new Date(this.effectiveStartDate+t):new Date(0),this.effectiveEndDate=this.effectiveEndDate?new Date(this.effectiveEndDate+n):new Date(24e11),this.timezone=e[fieldNames.ServiceTerritoryMember.ServiceTerritory__r][fieldNames.ServiceTerritory.OperatingHours__r][fieldNames.OperatingHours.Timezone]}function ServiceResource(e){var t=this;this.id=e.Id,this.online=!1,this.name=e.Name,this.isCapacityBased=e[fieldNames.ServiceResource.IsCapacityBased],this.description=e[fieldNames.ServiceResource.Description]||"",this.isOptimizationCapable=e[fieldNames.ServiceResource.IsOptimizationCapable],this.relatedRecord=e[fieldNames.ServiceResource.RelatedRecord],this.relatedRecord__r=e[fieldNames.ServiceResource.RelatedRecord__r],this.resourceType=e[fieldNames.ServiceResource.ResourceType],this.ganttLabel=e[fieldNames.ServiceResource.GanttLabel__c],this.lastKnownLongitude=e[fieldNames.ServiceResource.LastKnownLongitude],this.lastKnownLocationDate=e[fieldNames.ServiceResource.LastKnownLocationDate],this.lastKnownLatitude=e[fieldNames.ServiceResource.LastKnownLatitude],this.relatedRecord__r&&(this.pictureLink=this.relatedRecord__r.SmallPhotoUrl),this.onlineOffset=e[fieldNames.ServiceResource.Online_Offset__c]||orgOnlineOffset,this.pictureLink&&this.pictureLink.endsWith("profilephoto/005/T")&&(this.pictureLink=null),this.skills={},this.sobject=e,e[fieldNames.ServiceResource.Skills]&&e[fieldNames.ServiceResource.Skills].forEach(function(e){t.skills[e[fieldNames.ServiceResourceSkill.Skill]]=new ServiceResourceSkill(e)})}function ServiceResourceSkill(e){this.id=e.Id,this.name=e.SkillNumber,this.effectiveEndDate=e[fieldNames.ServiceResourceSkill.EffectiveEndDate],this.effectiveStartDate=e[fieldNames.ServiceResourceSkill.EffectiveStartDate],this.level=e[fieldNames.ServiceResourceSkill.SkillLevel],this.serviceResource=e[fieldNames.ServiceResourceSkill.ServiceResource],this.skill=e[fieldNames.ServiceResourceSkill.Skill];var t=void 0,n=void 0;this.effectiveStartDate&&(t=60*new Date(this.effectiveStartDate).getTimezoneOffset()*1e3),this.effectiveEndDate&&(n=60*new Date(this.effectiveEndDate).getTimezoneOffset()*1e3),this.effectiveStartDate=this.effectiveStartDate?new Date(this.effectiveStartDate+t):new Date(0),this.effectiveEndDate=this.effectiveEndDate?new Date(this.effectiveEndDate+n):new Date(864e11)}function ServiceTerritory(e){this.id=e.Id,this.name=e.Name,this.latitude=e[fieldNames.ServiceTerritory.Latitude],this.longitude=e[fieldNames.ServiceTerritory.Longitude],this.operatingHours=e[fieldNames.ServiceTerritory.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritory.OperatingHours__r],this.description=e[fieldNames.ServiceTerritory.Description],this.parentTerritory=e[fieldNames.ServiceTerritory.ParentTerritory],this.isActive=e[fieldNames.ServiceTerritory.IsActive],e[fieldNames.ServiceTerritory.ParentTerritory]&&e[fieldNames.ServiceTerritory.ParentTerritory]&&(this.parentTerritory=new ServiceTerritory(e[fieldNames.ServiceTerritory.ParentTerritory__r]))}function setHoursToDisplay(e,t,n){minHourToDisplay=e,maxHourToDisplay=t,includeWeekends=n}function showTimesWhenDragging(e,t){cachedDomElements.timesDragFix=cachedDomElements.timesDragFix||$("#timesDragFix");var n=(t.start_date.getMinutes()+t.travelTo/60)%60,s=n%serviceJumpsOnGantt,i=serviceJumpsOnGantt-n%serviceJumpsOnGantt;if(scheduler.getState().drag_id!==t.id)return void(scheduler.getState().drag_id||cachedDomElements.timesDragFix.hide());var r=t.finish-t.start,a=new Date(e);a.setSeconds(0),t.travelTo&&a.setSeconds(a.getSeconds()+t.travelTo),a=s>i?new Date(a.getTime()+60*i*1e3):new Date(a.getTime()-60*s*1e3);var o=new Date(a.getTime()+r),c=moment(a).format("lll"),l=moment(o).format("lll"),u="Scheduling time<br/>"+c+" - "+l;cachedDomElements.timesDragFix.html(u).show()}function generateBreakEventHtml(e){var t="Break_Laebl",n="breakIcon";return"ZoomLevel2"!=scheduler._mode&&"ZoomLevel3"!=scheduler._mode&&(t="Break_Laebl BreakLabelSmall",n="breakIconSmall"),e.ganttLabel?'<span class="'+t+'">\n                    <img src="'+lsdIcons.breakImg+'" class="'+n+'" draggable="false"/>\n                    '+e.ganttLabel+"\n                </span>":'<span class="'+t+'">\n                <img src="'+lsdIcons.breakImg+'" class="'+n+' NA_Break_NoLabel_Icon" draggable="false"/>\n            </span>'}function generateCapacityHtml(e){var t="",n="contractorCapacityHoursUsed ",s="fa-battery-empty",i=0;return e.hoursPerTimePeriod>0?i=e.hoursInUse/e.hoursPerTimePeriod*100:e.workItemsPerTimePeriod>0&&(i=e.workItemsAllocated/e.workItemsPerTimePeriod*100),s=25>=i?"fa-battery-empty":50>=i?"fa-battery-quarter":75>=i?"fa-battery-half":90>=i?"fa-battery-three-quarters":"fa-battery-full",i=i>100?100:i,t+='<span class="'+n+'" style="width:calc('+i+'% - 5px);"></span>',e.text&&(t+="ZoomLevel6"===scheduler._mode?'<div class="ServiceEventPadding"><span class="Capacity_Label"><i class="fa '+s+'"></i>'+e.text.split(" ")[0]+"</span></div>":"MonthlyView"===scheduler._mode?'<div class="ServiceEventPadding"><span class="Capacity_Label">'+e.text.split(" ")[0]+"</span></div>":'<div class="ServiceEventPadding"><span class="Capacity_Label"><i class="fa '+s+'"></i>'+e.text+"</span></div>"),t}function generateNAhtml(e,t,n){return n?'<div class="ServiceEvent" style="'+t+'">\n                    <div class="ServiceEventPadding">\n                        <svg aria-hidden="true" class="slds-icon naIcon">\n                            <use xlink:href="'+lsdIcons.na+'"></use>\n                        </svg>\n                        <span class="NA_Label">\n                            '+(e.ganttLabel||e.reason)+"\n                        </span>\n                    </div>\n                </div>":'<div class="ServiceEventPadding" style="'+t+'">\n                <svg aria-hidden="true" class="slds-icon naIcon">\n                    <use xlink:href="'+lsdIcons.na+'"></use>\n                </svg>\n                <span class="NA_Label">\n                    '+(e.ganttLabel||e.reason)+"\n                </span>\n            </div>"}function generateIconsHtmlForService(e){var t="";if(e.violations&&(t="<div class='violationsOnService'><i class='fa fa-warning'></i></div>"),e.jeopardy&&(t='<div class="jeopardyOnService"><img src="'+lsdIcons.jeopardyImg+'"></div>'),e.emergency&&(t+='<svg aria-hidden="true" class="slds-icon emergencyOnService"><use xlink:href="'+lsdIcons.emergency+'"></use></svg>'),e.pinned&&(t+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.pin+'"></use></svg>'),flaggedServices[e.id]&&(t+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.flag+'"></use></svg>'),(e.relatedFather||e.relatedTo||e.isServiceInChain)&&(t+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.related+'"></use></svg>'),e.isMDT){var n='<svg aria-hidden="true" class="slds-icon onServiceIcon">\n                                <use xlink:href="'+lsdIcons.clock+'"></use>\n                            </svg>',s='<svg aria-hidden="true" class="slds-icon onServiceIcon forwardIcon">\n                                <use xlink:href="'+lsdIcons.forward+'"></use>\n                            </svg>';t+=n+s}return t}function generateServiceColorAndFont(e){var t="";if("na"==e.type&&e.ganttColor&&e.travelTo&&(t+="margin-right:-6px;"),e.ganttColor&&!globalSelectedGanttServices[e.id]){var n=generateGanttTextColor(e.ganttColor.substr(1,7));t+="color:#"+n+";background:"+e.ganttColor+";"}return"ZoomLevel3"!=scheduler._mode&&"ZoomLevel2"!=scheduler._mode&&(t+="font-size:10px;"),t}function attchDatalessSchedulerEvents(){function e(e){if(t(e))return!0;var n=s();return!(e.getHours()>=n.min&&e.getHours()<n.max)}function t(e){if("ZoomLevel6"==scheduler.getState().mode||"MonthlyView"==scheduler.getState().mode){var t=0==firstDayOfTheWeek?6:0,n=0==firstDayOfTheWeek?5:6;if(!includeWeekends&&(e.getDay()==n||e.getDay()==t))return!0}return!1}function n(e){var n=s();if(t(e.start_date)&&t(e.end_date))return!1;var i=[];if("ZoomLevel2"===scheduler._mode)i.push({start:scheduler._min_date.getTime(),finish:scheduler._max_date.getTime()});else for(var r=scheduler._min_date.getTime(),a=scheduler._max_date.getTime(),o=r;a>o;o+=864e5){var c={start:o+1e3*n.min*60*60,finish:o+1e3*n.max*60*60};i.push(c)}return isMultipleIntersection({start:e.start_date.getTime(),finish:e.end_date.getTime()},i)}function s(){var e=scheduler.getState().mode,t=minHourToDisplay,n=maxHourToDisplay,s=null;switch(e){case"ZoomLevel4":s=2;break;case"ZoomLevel5":s=4;break;case"ZoomLevel6":s=6}if(null!=s){t-=t%s;var i=s-n%s;i!=s&&(n+=i)}return{min:t,max:n}}function i(e,t){if(gameOn)return!1;var s=n(t),i=!0;return contractorSupport&&(t.resourceContractor&&(i=!1),"contractorcapacity"==t.type&&t.timePeriod!=capacityDurationFilter&&(i=!1)),s&&i}scheduler.date.ZoomLevel1_start=function(e){var t=scheduler.date.day_start(new Date(e));return t.setHours(e.getHours()),t},scheduler.date.ZoomLevel2_start=function(e){var t=scheduler.date.day_start(new Date(e));return t.setHours(e.getHours()),t},scheduler.templates.event_bar_text=function(e,t,n){var i=void 0,r=void 0,a=void 0,o=void 0,c=void 0,l=void 0,u=s(),d=n.finish-n.start,v=new Date(e),h=void 0;if(v.setSeconds(0),n.travelTo&&v.setSeconds(v.getSeconds()+n.travelTo),h=new Date(v.getTime()+d),showTimesWhenDragging(e,n),"break"===n.type)return generateBreakEventHtml(n);if("contractorcapacity"===n.type)return generateCapacityHtml(n);var g=generateIconsHtmlForService(n),p=generateServiceColorAndFont(n),m=!0,f=new Date(scheduler._min_date),S=new Date(scheduler._max_date);if(f.setHours(u.min),S.setHours(u.max),isIntersect(v,h,f,S)||"ZoomLevel2"===scheduler._mode||(m=!1),m&&(n.travelTo||n.travelFrom)){if(i=getXPositionOfEvent({start_date:v,end_date:h},!1,scheduler.matrix[scheduler._mode]),r=getXPositionOfEvent({start_date:v,end_date:h},!0,scheduler.matrix[scheduler._mode]),a=r-i+12,2>=a&&(a=3),p+="width:"+a+"px;",n.travelTo){var b=new Date(e);b.setMinutes(b.getMinutes()+n.travelTo/60),o=getXPositionOfEvent({start_date:n.start_date,end_date:b},!1,scheduler.matrix[scheduler._mode]),c=getXPositionOfEvent({start_date:n.start_date,end_date:b},!0,scheduler.matrix[scheduler._mode]),l=c-o+7,p+="margin-left:"+l+"px;"}return"na"==n.type?generateNAhtml(n,p,!0):'<div class="ServiceEvent" territory_id="'+n.getGanttTerritory()+'" style="'+p+'");"><div class="ServiceEventPadding">'+g+n.text+"</div></div>"}if("na"==n.type)return generateNAhtml(n,p,!1);var y=g+n.text;return m||(y=""),'<div class="ServiceEventPadding" style="'+p+'">'+y+"</div>"},scheduler.templates.event_class=function(e,t,n){if("break"==n.type)return"NA_Break";var s="";return"na"==n.type&&(s+=" NA_Absence "),"na"==n.type&&n.ganttColor&&!n.travelTo&&(s+=" na_with_color_no_travel_to "),"na"==n.type&&n.ganttColor&&n.travelTo&&(s+=" na_with_color "),"contractorcapacity"==n.type?(s+=" eventContractorCapacity",n.hoursPerTimePeriod>0?n.hoursInUse>0&&n.hoursInUse>n.hoursPerTimePeriod&&(s+=" overCapacityPattern"):n.workItemsPerTimePeriod>0&&n.workItemsAllocated>0&&n.workItemsAllocated>n.workItemsPerTimePeriod&&(s+=" overCapacityPattern"),showCandidates.on&&(s+=" fadedSlot"),s):("service"==n.type&&(s+=getClassByStatus(n.statusCategory)),n.isMDT&&(s+=" mdtEvent"),showCandidates.on&&n.id!==showCandidates.id&&(s+=" fadedSlot"),n.hiddenTravelFrom&&(s+=" dhx_long_travel_from_time_background"),n.hiddenTravelTo&&(s+=" dhx_long_travel_to_time_background"),s+=n.travelTo&&n.travelFrom?" dhx_travelToFrom dhx_travel_time_background":n.travelTo&&!n.travelFrom?" dhx_travelTo dhx_travel_time_background":!n.travelTo&&n.travelFrom?" dhx_travelFrom dhx_travel_time_background":"na"==n.type?" NA_Absence_NoTravel":" dhx_noTravel","service"==n.type&&(globalSelectedGanttServices[n.id]&&(n.travelTo||n.travelFrom)?s+=" selectedEvent":globalSelectedGanttServices[n.id]?s+=" selectedEventNoTravel":n.id==scheduler._select_id&&(n.travelTo||n.travelFrom)?s+=" selectedEvent":n.id==scheduler._select_id&&(s+=" selectedEventNoTravel")),n.status&&(s+=" GanttCustomStatus_"+n.status.split(" ").join("")),s)},scheduler.templates.tooltip_text=function(e,t,n){var s;if(contextShown)return!1;var i="",r=getLocationdIdByResource(n.resourceId),a=utils.getLocationOffset(e,r)-utils.getUserOffset(e),o=new Date(n.start);o.setMinutes(o.getMinutes()+a);var c=new Date(n.finish);c.setMinutes(c.getMinutes()+a);var l=0,u=0;if(i+='<div class="tooltipBody">',"contractorcapacity"==n.type)return s="fa-battery-empty",n.hoursPerTimePeriod>0?(l=n.hoursInUse/n.hoursPerTimePeriod*100,u=Math.floor(n.hoursInUse/n.hoursPerTimePeriod*100*100)/100):n.workItemsPerTimePeriod>0&&(l=n.workItemsAllocated/n.workItemsPerTimePeriod*100,u=Math.floor(n.workItemsAllocated/n.workItemsPerTimePeriod*100*100)/100),s=25>=l?"fa-battery-empty":50>=l?"fa-battery-quarter":75>=l?"fa-battery-half":90>=l?"fa-battery-three-quarters":"fa-battery-full",i+='<div class="tooltipLine"><b style="font-size:15px"><i class="fa '+s+'"></i> '+n.resourceName+"</b> ("+u+"%)</div>",n.workItemsPerTimePeriod&&(i+='<div class="tooltipLine">'+customLabels.NumServicesScheduled.replaceAll(n.workItemsAllocated,n.workItemsPerTimePeriod)+"</div>"),n.hoursPerTimePeriod&&(i+='<div class="tooltipLine">'+customLabels.NumHoursScheduled.replace("{0}",n.hoursInUse).replace("{1}",n.hoursPerTimePeriod)+"</div>"),i+='<div class="tooltipHR"></div>',i+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Start+"</span> "+moment(n.start_date).format("llll")+"</div>",i+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Finish+"</span> "+moment(n.end_date).format("llll")+"</div>",i+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Duration_Type+"</span> "+n.timePeriod+"</div>",n.workItemsAllocated>0&&(i+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.NumberOfServices+"</span> "+n.workItemsAllocated+"</div>"),i+="</div>";if("service"!=n.type)return s=absenceTypeIcon(n.type),i+=n.ganttLabel?'<div class="tooltipLine"><b>'+s+'<span class="tooltipName">'+n.ganttLabel+"</span> </b> </div>":'<div class="tooltipLine"><b>'+s+'<span class="tooltipName">'+n.name+"</span> </b> </div>",i+='<div class="tooltipHR"></div>',i+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Start+"</span> "+moment(n.start).format("llll")+"</div>",i+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Finish+"</span> "+moment(n.finish).format("llll")+"</div>",a&&!useLocationTimezone&&(i+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Resource_start+"</span> "+moment(o).format("llll")+"</div>",i+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Resource_finish+"</span> "+moment(c).format("llll")+"</div>"),n.travelTo&&(i+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(n.travelTo/60)+"</div>"),n.travelFrom&&(i+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(n.travelFrom/60)+"</div>"),(n.reason||n.comment)&&(i+='<div class="tooltipHR"></div>'),n.reason&&(i+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Reason+"</span> "+n.reason+"</div>"),i+="</div>";var d='<svg aria-hidden="true" class="slds-icon tooltipJeopardyIcon">\n                                <use xlink:href="'+lsdIcons.jeopardy+'"></use>\n                            </svg>',v='<svg aria-hidden="true" class="slds-icon tooltipMDTIcon">\n                                <use xlink:href="'+lsdIcons.clock+'"></use>\n                            </svg>',h='<svg aria-hidden="true" class="slds-icon tooltipMDTArrowIcon">\n                                <use xlink:href="'+lsdIcons.forward+'"></use>\n                            </svg>',g='<svg aria-hidden="true" class="slds-icon tooltipMDTArrowIcon">\n                                <use xlink:href="'+lsdIcons.emergency+'"></use>\n                            </svg>',p="";n.ganttColor&&(p='style="background:'+n.ganttColor+'"'),i+=n.ganttLabel?'<div class="tooltipLine"><div '+p+' class="tooltipStatus '+getClassByStatus(n.statusCategory)+'"></div><b style="font-size:15px">'+n.name+" / "+n.ganttLabel+"</b> ("+statusTranslations[n.status]+")</div>":'<div class="tooltipLine"><div '+p+' class="tooltipStatus '+getClassByStatus(n.statusCategory)+'"></div><b style="font-size:15px">'+n.name+"</b> ("+statusTranslations[n.status]+")</div>",n.jeopardy&&n.jeopardyReason&&(i+='<div class="tooltipJeopardy">'+d+"<span>"+customLabels.JeopardyTooltip+" "+n.jeopardyReason+"</span></div>"),n.emergency?i+='<div class="tooltipJEmergency">'+g+"<span>"+customLabels.ScheduledWithEmergency+"</span></div>":n.jeopardy&&(i+='<div class="tooltipJeopardy">'+d+"<span>"+customLabels.JeopardyTooltipLong+"</span></div>"),n.pinned&&(i+='<div class="tooltipLine tooltipPinned"><i>'+customLabels.Pinned_Tooltip+"</i></div>");var m=GanttService.prototype.allFieldSets.GanttToolTip;if(m)for(var f=0;f<m.length;f++){var S=n[m[f].APIName];"Status"===m[f].APIName?S=statusTranslations[n.status]:"DATETIME"==m[f].Type&&S?S=moment(S).format("llll"):"DATE"==m[f].Type&&S&&(S=moment(S).format("L")),S&&(i+='<div class="tooltipLine"><b>'+m[f].Label+": </b> "+S+"</div>")}if(i+='<div class="tooltipHR"></div>',i+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Start+"</span> "+moment(n.start).format("llll")+"</div>",i+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Finish+"</span> "+moment(n.finish).format("llll")+"</div>",!a&&!alwaysShowLocalTimeTooltip||useLocationTimezone||(i+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Resource_start+"</span> "+moment(o).format("llll")+"</div>",i+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Resource_finish+"</span> "+moment(c).format("llll")+"</div>"),n.hiddenTravelTo?i+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(n.hiddenTravelTo.hiddenTravel/60)+"</div>":n.travelTo&&(i+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(n.travelTo/60)+"</div>"),n.hiddenTravelFrom?i+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(n.hiddenTravelFrom.hiddenTravel/60)+"</div>":n.travelFrom&&(i+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(n.travelFrom/60)+"</div>"),n.tooltipText&&(i+='<div class="tooltipHR"></div>',i+='<div class="tooltipLine tooltipTitle">'+customLabels.Custom_Tooltip_Field+'</div><div class="tooltipLine">'+n.tooltipText+"</div>"),i+="</div>",(n.hiddenTravelTo||n.hiddenTravelFrom||n.isMDT)&&(i+='<div class="tooltipTravel">',(n.hiddenTravelTo||n.hiddenTravelFrom)&&(i+='<div class="tooltipLine tooltipTitle"><i class="fa fa-car"></i>'+customLabels.Travel_time+"</div><div>",i+=customLabels.Travel_time_too_long.replace("{0}",maxTravelTimeInSeconds/60/60)+'<div class="travelExplain">'+customLabels.To_change_maximum_travel_hours+"</div>",i+="</div>"),n.isMDT&&(i+='<div class="tooltipLine tooltipTitle">'+v+h+customLabels.Multi_Day_Service+"</div><div>",i+=customLabels.This_service_spans_across_more_than_one_day,i+="</div>"),i+="</div>"),n.violations){i+='<div class="tooltipViolation">',i+='<div class="tooltipLine tooltipTitle"><i class="fa fa-warning"></i>'+customLabels.Rule_violations_Tooltip+"</div><div>";for(var f=0;f<n.violations.length;f++)-1!=n.violations[f].ViolationString.indexOf(violationDelimiter)?(i+=n.violations[f].RuleName+" - ",i+=n.violations[f].ViolationString.substring(0,n.violations[f].ViolationString.indexOf(violationDelimiter))+"<br/>",i+=n.violations[f].ViolationString.substring(n.violations[f].ViolationString.indexOf(violationDelimiter)+violationDelimiter.length)+"<br/>"):i+=n.violations[f].RuleName+" - "+n.violations[f].ViolationString+"<br/>";i+="</div>"}return i};var r=!1;return dhtmlxEvent(scheduler._obj,"mouseleave",function(e){scheduler.getState().drag_id&&(r=!0,scheduler._on_mouse_up(e),cachedDomElements.timesDragFix.hide(),window.getSelection().removeAllRanges())}),scheduler.attachEvent("onBeforeEventChanged",function(){return r?(r=!1,!1):!0}),scheduler._hover=null,scheduler.attachEvent("onMouseMove",function(e,t){if(!e)return void(scheduler._hover&&($(".dhx_cal_event_line, .ServiceEvent").removeClass("hoverRelated"),scheduler._hover=null));if(scheduler._events[e].relatedTo||scheduler._events[e].relatedFather){var n=$(scheduler.getRenderedEvent(e)).find(".ServiceEvent"),s=null;if(0===n.length&&(n=$(scheduler.getRenderedEvent(e))),scheduler._events[e].relatedFather?(s=$(scheduler.getRenderedEvent(scheduler._events[e].relatedFather)).find(".ServiceEvent"),0===s.length&&(s=$(scheduler.getRenderedEvent(scheduler._events[e].relatedFather)))):(s=$(scheduler.getRenderedEvent(scheduler._events[e].relatedTo)).find(".ServiceEvent"),0===s.length&&(s=$(scheduler.getRenderedEvent(scheduler._events[e].relatedTo)))),scheduler._hover=e,n&&s){if($(n).hasClass("hoverRelated"))return;$(n).addClass("hoverRelated"),$(s).addClass("hoverRelated")}}}),scheduler.templates.ZoomLevel2_scale_date=function(e){var t=e.getHours(),n=e.getMinutes()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getMinutes()):formatNumberToLocaleString(e.getMinutes());return isAMPM?0===t?formatNumberToLocaleString(12)+":"+n+" AM":12===t?formatNumberToLocaleString(12)+":"+n+" PM":t>12?formatNumberToLocaleString(t-12)+":"+n+" PM":formatNumberToLocaleString(t)+":"+n+" AM":formatNumberToLocaleString(t)+":"+n},scheduler.templates.ZoomLevel3_scale_date=function(e){var t=e.getHours(),n=e.getMinutes()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getMinutes()):formatNumberToLocaleString(e.getMinutes());return isAMPM?0===t?formatNumberToLocaleString(12)+" AM":12==t?formatNumberToLocaleString(12)+" PM":t>12?formatNumberToLocaleString(t-12)+" PM":formatNumberToLocaleString(t)+" AM":(e.getHours()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getHours()):formatNumberToLocaleString(e.getHours()))+":"+n},scheduler.templates.ZoomLevel4_scale_date=scheduler.templates.ZoomLevel3_scale_date,
scheduler.templates.ZoomLevel5_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel6_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel4_cell_class=function(e,t,n){return!n.children&&shouldSeparateCell(t)?"BorderForDayChange":""},scheduler.templates.ZoomLevel2_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel5_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel6_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.filter_ZoomLevel1=i,scheduler.filter_ZoomLevel2=i,scheduler.filter_ZoomLevel3=i,scheduler.filter_ZoomLevel4=i,scheduler.filter_ZoomLevel5=i,scheduler.filter_ZoomLevel6=i,scheduler.filter_MonthlyView=function(e,t){return"contractorcapacity"===t.type},scheduler.filter_MTDView=function(e,t){return"contractorcapacity"===t.type||t.isMDT},scheduler.ignore_ZoomLevel3=e,scheduler.ignore_ZoomLevel4=e,scheduler.ignore_ZoomLevel5=e,scheduler.ignore_ZoomLevel6=e,scheduler.ignore_MonthlyView=function(e){return t(e)},scheduler.ignore_MTDView=scheduler.ignore_MonthlyView,{isDateInsideWeekend:t}}function shouldSeparateCell(e){var t=getMinAndMaxHoursToDisplay();switch(scheduler._mode){case"ZoomLevel4":t.max-=2;break;case"ZoomLevel5":t.max-=4;break;case"ZoomLevel6":t.max-=6}if("ZoomLevel2"===scheduler._mode&&23===e.getHours()&&30===e.getMinutes())return!0;if(e.getHours()==t.max){var n=new Date(e);if(n.setHours(n.getHours()+24),n<=scheduler._max_date)return!0}return!1}function getXPositionOfEvent(e,t,n){var s=0,i=n._step,r=n.round_position,a=0,o=t?e.end_date:e.start_date;o.valueOf()>scheduler._max_date.valueOf()&&(o=scheduler._max_date);var c=o-scheduler._min_date_timeline;if(c>0){var l=scheduler._get_date_index(n,o);scheduler._ignores[l]&&(r=!0);for(var u=0;l>u;u++)s+=scheduler._cols[u];var d=scheduler.date.add(scheduler._min_date_timeline,scheduler.matrix[scheduler._mode].x_step*l,scheduler.matrix[scheduler._mode].x_unit);r?+o>+d&&t&&(a=scheduler._cols[l]):(c=o-d,n.first_hour||n.last_hour?(c-=n._start_correction,0>c&&(c=0),a=Math.round(c/i),a>scheduler._cols[l]&&(a=scheduler._cols[l])):a=Math.round(c/i))}return s+=t?0===c||r?a-14:a-12:a+1}function getResourceEventsIds(e,t,n){var s=[];for(var i in scheduler._events)"service"==scheduler._events[i].type&&scheduler._events[i].start_date>=e&&scheduler._events[i].end_date<=t&&scheduler._events[i].resourceId==n&&(s.push(i),scheduler._events[i].relatedTo&&s.push(scheduler._events[i].relatedTo),scheduler._events[i].relatedFather&&s.push(scheduler._events[i].relatedFather));return s}function getEventIdsOfResources(e){var t=[];for(var n in scheduler._events)"service"==scheduler._events[n].type&&e.indexOf(scheduler._events[n].resourceId)>-1&&(t.push(n),scheduler._events[n].relatedTo&&t.push(scheduler._events[n].relatedTo),scheduler._events[n].relatedFather&&t.push(scheduler._events[n].relatedFather));return t}function getEventIdsOfLocation(e,t,n){var s=[];for(var i in scheduler._events)"service"==scheduler._events[i].type&&scheduler._events[i].start_date>=e&&scheduler._events[i].end_date<=t&&n.indexOf(scheduler._events[i].location)>-1&&s.push(i);return s}function setCapacityFilter(e,t){contractorSupport&&(capacityDurationFilter=e,t&&scheduler._is_initialized()&&scheduler.updateView())}function cantLoadGantt(e){$(".keypressEvents")&&($(".bodyDiv").css("background","#fff"),$(".keypressEvents").remove(),$("#ErrorLoadingGantt").show()),$("#ErrorContainer").append(e)}function getLocationdIdByResource(e){for(var t=scheduler.serverList("resources"),n=0;n<t.length;n++)for(var s=0;s<t[n].children.length;s++)if(e.split(",")[0]==t[n].children[s].key)return t[n].key;return null}function absenceTypeIcon(e){return"break"==e?'<svg aria-hidden="true" class="slds-icon tooltipBreakIcon">\n                    <use xlink:href="'+lsdIcons["break"]+'"></use>\n                </svg>':'<svg aria-hidden="true" class="slds-icon tooltipNAIcon">\n                <use xlink:href="'+lsdIcons.na+'"></use>\n            </svg>'}function getClassByStatus(e){switch(e){case globalCategories.NONE:return"eventStatusNew";case globalCategories.SCHEDULED:return"eventStatusAssigned";case globalCategories.DISPATCHED:return"eventStatusDispatched";case globalCategories.IN_PROGRESS:return"eventStatusTravel";case globalCategories.RUNNING_LONG:return"eventStatusOnSite";case globalCategories.COMPLETED:return"eventStatusCompleted";case globalCategories.MISSED:return"eventStatusIncomplete";case globalCategories.COULD_NOT_COMPLETE:return"eventStatusCouldntComplete";case globalCategories.CANCELED:return"eventStatusCancelled";default:return"eventCustomStatus"}}function getMinAndMaxHoursToDisplay(){var e=scheduler.getState().mode,t=minHourToDisplay,n=maxHourToDisplay,s=null;switch(e){case"ZoomLevel4":s=2;break;case"ZoomLevel5":s=4;break;case"ZoomLevel6":s=6}if(null!==s){t-=t%s;var i=s-n%s;i!=s&&(n+=i)}return{min:t,max:n}}function isIntersect(e,t,n,s){return s>e&&t>n}function isMultipleIntersection(e,t){for(var n=0;n<t.length;n++)if(isIntersect(e.start,e.finish,t[n].start,t[n].finish))return!0;return!1}function generateGanttTextColor(e){var t=parseInt("0x888888",16),n=parseInt("0x"+e,16);return n>t?"000000":"ffffff"}function formatNumberToLocaleString(e){try{return e.toLocaleString(jsUserLocale)}catch(t){console.warn("Something wrong with your locale settings: "+jsUserLocale)}return e}function generateHoursMinutes(e){if(60>e)return customLabels.MinutesGanttTooltip.replace("$0",e);var t=e%60,n=Math.floor(e/60);return customLabels.MinutesHoursGanttTooltip.replace("$0",n).replace("$1",t)}!function(){String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var n=this.toString();("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>n.length)&&(t=n.length),t-=e.length;var s=n.lastIndexOf(e,t);return-1!==s&&s===t})}(),function(){var e=angular.module("serviceExpert",["uiGmapgoogle-maps","angularMoment","ui.bootstrap","chart.js","MstResolver"]);e.run(["amMoment",function(e){e.changeLocale(userLocale)}]),e.config(["$sceDelegateProvider","$compileProvider","MstResolverProvider",function(e,t,n){debugMode||t.debugInfoEnabled(!1),n.setConfig({fslOperationRemoteAction:RemoteActions.getFslOperation,apiVersion:"38.0",fieldNames:fieldNames.FslOperation}),e.resourceUrlWhitelist(["self","https://**.force.com"])}])}(),function(){angular.module("serviceExpert").controller("ctrlBulkActions",["$scope","$rootScope","$q","$sce","utils","servicesService","sfdcService","userSettingsManager","StateService","ServiceSelectorService",function(e,t,n,s,i,r,a,o,c,l){function u(){var t=0;e.selectedServicesObjects.length=0;for(var n in i.servicesSelection)i.servicesSelection[n]&&(t++,e.selectedServicesObjects.push(r.servicesObjects[n]));return t}console.log("hi bulk"),e.actionName="",e.actionNameHeader="",e.locations=i.resources,e.contractorSupport=c.areContractorsSupported(),e.filteredLocations=[],e.selectedLocations={},e.orphanServices=!1,e.selectedServicesObjects=[],e.selectedServices=l.SelectedServices,e.successfullyScheduled=0,e.currentSchedulingIndex=0,e.isScheduleRunning=!1,e.bulkActionRunning=!1,e.statuses=i.statuses,e.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],e.minutes=[],e.startHour="0",e.endHour="0",e.startMinutes="0",e.optimizeAllServices="all",e.endMinutes="0",e.policyOptions=r.policies,e.unscheduleBreaks=!1,e.trust=i.trust,e.optimizeSelectedFilter="noFilter",e.createServiceLightbox=!1,e.createLightboxFormUrl=null,e.isAmpm=isAMPM?"ampm":"24",e.isInConsole=c.isInConsole;for(var d=0;60>d;d++)e.minutes.push(d);e.$on("onInjectedResultsTable",function(t,n){e.actionName="Bulk Action Results",e.actionNameHeader=customLabels[e.actionName.split(" ").join("_")],e.bulkActionSummary=n.actionSummary,e.injectedResultsTabel=i.trust(n.tableString)}),e.$on("openBulkActions",function(n,s){var a;e.actionName=s;var o=s.split(" ").join("_");if("Change Status"==s?e.actionNameHeader=customLabels.Change_status:e.actionNameHeader=customLabels[o],e.filteredLocations=e.getVisibleLocations(),"Schedule"==e.actionName&&e.isScheduleRunning)return void alert(customLabels.alertSchedulingRunning);if(e.filteredLocations)for(a=0;a<e.filteredLocations.length;a++){var l=e.filteredLocations[a];e.selectedLocations[l.id]=!0}for(a=0;a<r.policies.length;a++)r.policies[a].Id==t.policy&&(e.selectedPolicy=r.policies[a]);if(e.actionStart=scheduler.getState().min_date,e.actionStart.setHours(0),e.actionStart.setMinutes(0),e.actionStart.setMilliseconds(0),e.actionFinish=scheduler.getState().max_date,"Optimize"==e.actionName&&(e.actionFinish=i.addDaysToDate(e.actionFinish,-1)),0!==e.actionFinish.getHours()&&(e.actionFinish=i.addDaysToDate(e.actionFinish,1)),e.actionFinish.setHours(0),e.actionFinish.setMinutes(0),e.actionFinish.setMilliseconds(0),e.orphanServices=!1,e.selectedCount=u(),e.globalSelectedCount=0,e.currentSchedulingIndex=0,e.successfullyScheduled=0,e.bulkActionRunning=!1,e.bulkStatus=i.statuses.dispatched,e.startHour="0",e.endHour="0",e.startMinutes="0",e.endMinutes="0",e.optimizeAllServices="unscheduled",e.unscheduleBreaks=!1,e.includeContractorServices=!c.areContractorsSupported(),e.checkBoxFields=i.checkBoxFields,0===e.selectedCount?e.targetServices="locations":e.targetServices="selectedServices","Schedule"==e.actionName&&(0!==e.selectedCount?e.bulkSchedule(e.selectedServicesObjects,e.selectedCount):(e.closeLightbox(),alert(customLabels.NoServicesSelected))),"Delete"==e.actionName)if(0!==e.selectedCount){var d=customLabels.are_you_sure_delete;if(1==e.selectedCount&&(d=customLabels.are_you_sure_delete_single),!confirm(d))return void e.closeLightbox();e.bulkDelete()}else e.closeLightbox(),alert(customLabels.NoServicesSelected);"Flag-Unflag"==e.actionName&&(0!==e.selectedCount?e.bulkFlag():(e.closeLightbox(),alert(customLabels.NoServicesSelected)))}),e.getVisibleLocations=function(){var t,n,s=[],i=o.GetUserSettingsProperty("locations");for(n in e.selectedLocations)e.selectedLocations[n]=!1;if(i)for(t=0;t<e.locations.length;t++)i.indexOf(e.locations[t].Id)>-1&&e.locations[t].Resources__r&&s.push({name:e.locations[t].Name,id:e.locations[t].Id});else for(t=0;t<e.locations.length;t++)e.locations[t].Resources__r&&s.push({name:e.locations[t].Name,id:e.locations[t].Id});return s},e.dateSelectStartWidget=function(t){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:t,date:new Date(e.actionStart),navigation:!0,handler:function(t,n){var s=new Date(t);s.setMinutes(parseInt(e.startMinutes)),s.setHours(parseInt(e.startHour)),s>e.actionFinish?alert(customLabels.startBeforeEnd):e.actionStart=s,scheduler.destroyCalendar()}})},e.dateSelectFinishWidget=function(t){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:t,date:new Date(e.actionFinish),navigation:!0,handler:function(t,n){var s=new Date(t);s.setMinutes(parseInt(e.endMinutes)),s.setHours(parseInt(e.endHour)),s<e.actionStart?alert(customLabels.finishAfterStart):e.actionFinish=s,scheduler.destroyCalendar()}})},e.closeLightbox=function(){$("#BulkActionsLightbox").attr("style",""),e.isScheduleRunning||(e.bulkActionRunning=!1,e.actionName="",e.isScheduleRunning=!1)},e.$on("keypress",function(t,n){27==n.which&&e.closeLightbox(),e.createServiceLightbox&&e.closeCreateService()}),e.bulkUnschedule=function(){var n,s,a=[],o=[];if("selectedServices"==e.targetServices){for(s in i.servicesSelection)i.servicesSelection[s]&&(a.push(s),r.servicesObjects[s].resourceId&&o.push(r.servicesObjects[s].resourceId));n=getEventIdsOfResources(o),e.bulkActionRunning=!0,r.unscheduleServicesByServicesId(a).then(function(s){if(s){var o=customLabels.x_services_were_unscheduled.replaceAll(s.changed.length),c=customLabels.x_services_were_unscheduled_out_of_y.replaceAll(s.changed.length,s.changed.length,a.length);if(s.noChange.length>0){for(var l="",u=0;u<s.noChange.length;u++)l+=s.noChange[u].name+", ";l=l.substr(0,l.length-2),c+=" <div title='"+l+"' class='dashedBorder' style='display:inline-block;'>"+customLabels.failed_to_unschedule.replaceAll(s.noChange.length)+". "+customLabels.View_services+"</div>."}i.addNotification(o,c,function(t){if(0!==s.noChange.length){e.actionName="Bulk Action Results",e.bulkActionSummary=customLabels.x_services_failed_to_unsch_out_of_y.replaceAll(s.noChange.length,s.noChange.length,s.noChange.length+s.changed.length);var n=i.createBulkActionResultTable(t);e.injectedResultsTabel=i.trust(n)}},s.noChange.slice(0)),e.closeLightbox(),r.checkRules(n,t.policy).then(function(e){for(var t=0;t<n.length;t++)scheduler._events[n[t]]&&scheduler.updateEvent(n[t])})}else e.closeLightbox(),i.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)})}else if("locations"==e.targetServices){for(s in e.selectedLocations)e.selectedLocations[s]&&a.push(s);if(0===a.length)return void alert(customLabels.noLocationWasSelected);n=getEventIdsOfLocation(scheduler._min_date,scheduler._max_date,a),e.bulkActionRunning=!0,r.unscheduleServicesByLocations(a,e.actionStart,e.actionFinish,e.unscheduleBreaks,e.includeContractorServices).then(function(s){if(s){if(0===s.noChange.length&&0===s.changed.length)i.addNotification(customLabels.No_service_was_unscheduled,customLabels.no_service_found_no_change);else{var o=customLabels.x_services_were_unscheduled.replaceAll(s.changed.length),c=customLabels.x_services_were_unscheduled_out_of_y.replaceAll(s.changed.length,s.changed.length,a.length);if(s.noChange.length>0){for(var l="",u=0;u<s.noChange.length;u++)l+=s.noChange[u].name+", ";l=l.substr(0,l.length-2),c+=" <span title='"+l+"' class='dashedBorder' style='display:inline-block;'>"+customLabels.failed_to_unschedule.replaceAll(s.noChange.length)+". "+customLabels.View_services+"</span>."}i.addNotification(o,c,function(t){if(0!==s.noChange.length){e.actionName="Bulk Action Results",e.bulkActionSummary=customLabels.x_services_failed_to_unsch_out_of_y.replaceAll(s.noChange.length,s.noChange.length,s.noChange.length+s.changed.length);var n=i.createBulkActionResultTable(t);e.injectedResultsTabel=i.trust(n)}},s.noChange.slice(0))}e.closeLightbox(),r.checkRules(n,t.policy).then(function(e){for(var t=0;t<n.length;t++)scheduler._events[n[t]]&&scheduler.updateEvent(n[t])})}else e.closeLightbox(),i.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)})}},e.$on("MultiServiceSchedule",function(t,n){e.actionName="Schedule",e.currentSchedulingIndex=0,e.successfullyScheduled=0,e.bulkSchedule(n.servicesObjects,n.servicesCount)}),e.bulkSchedule=function(s,a){function o(){scheduler.updateView()}function c(n){r.scheduleFromBulk(s[n].id).then(function(s){if(s.value||"exception"!=s.eventType){if(s.value&&s.value.resourceId&&e.successfullyScheduled++,e.afterSchedulingServiceObjects.push(s.value),e.currentSchedulingIndex++,a>n+1&&l[n+1].resolve(n+1),n+1==a){var c=[];for(var u in scheduler._events)c.push(u);e.isScheduleRunning=!1,e.bulkActionRunning=!1,r.checkRules(c,t.policy).then(o)}}else e.isScheduleRunning=!1,e.bulkActionRunning=!1,e.closeLightbox(),i.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)})}var l=[];e.isScheduleRunning=!0,e.globalSelectedCount=a,e.globalSelectedServiceObjects=s,e.afterSchedulingServiceObjects=[];for(var u=0;a>u;u++)l.push(n.defer());for(s=s.sort(function(e,t){var n=e.priority,s=t.priority;return n==s?1:n>s?1:s>n?-1:void 0}),u=0;a>u;u++)l[u].promise.then(c);l[0].resolve(0)},e.showScheduleResults=function(){e.actionName="Schedule Results",e.actionNameHeader=customLabels[e.actionName.split(" ").join("_")],e.isScheduleRunning=!1,e.servicesToShowAfterMultiSchedule=[];for(var t=0;t<e.afterSchedulingServiceObjects.length;t++){var n={};e.afterSchedulingServiceObjects[t]?(n.service=e.afterSchedulingServiceObjects[t],n.isScheduledSuccessFromBulk=!0):(n.service=e.globalSelectedServiceObjects[t],n.isScheduledSuccessFromBulk=!1),e.servicesToShowAfterMultiSchedule.push(n)}},e.showOnGantt=function(e){i.showOnGantt(e)},e.bulkChangeStatuses=function(){var t,n=[];if("selectedServices"==e.targetServices){for(t in i.servicesSelection)i.servicesSelection[t]&&n.push(t);e.bulkActionRunning=!0,r.changeStatusesByServicesId(n,e.bulkStatus).then(function(t){if(t){var n=customLabels.x_statuses_changed_to_y.replaceAll(t.changed.length,e.bulkStatus),s=customLabels.The_status_of_x_changed_to_y.replaceAll(t.changed.length,e.bulkStatus)+".";if(t.noChange.length>0){for(var r="",a=0;a<t.noChange.length;a++)r+=t.noChange[a].name+", ";r=r.substr(0,r.length-2),s+=" <span title='"+r+"' class='dashedBorder' style='display:inline-block;'>"+customLabels.failed_to_change.replaceAll(t.noChange.length)+". "+customLabels.View_services+"</span>."}i.addNotification(n,s,function(n){if(0!=t.noChange.length){e.actionName="Bulk Action Results",e.bulkActionSummary=customLabels.x_failed_to_change_out_of_y.replaceAll(t.noChange.length,t.noChange.length+t.changed.length);var s=i.createBulkActionResultTable(n);e.injectedResultsTabel=i.trust(s)}},t.noChange.slice(0)),e.closeLightbox()}else i.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action),e.closeLightbox()})}else if("locations"==e.targetServices){for(t in e.selectedLocations)e.selectedLocations[t]&&n.push(t);if(0===n.length&&!e.orphanServices)return void alert(customLabels.noLocationWasSelected);e.bulkActionRunning=!0,r.changeStatusesByLocations(n,e.actionStart,e.actionFinish,e.bulkStatus,e.includeContractorServices).then(function(t){if(t){if(0===t.noChange.length&&0===t.changed.length)i.addNotification(customLabels.No_service_was_changed,customLabels.no_service_found_no_change),e.closeLightbox();else{var n=customLabels.x_statuses_changed_to_y.replaceAll(t.changed.length,e.bulkStatus),s=customLabels.The_status_of_x_changed_to_y.replaceAll(t.changed.length,e.bulkStatus)+".";if(t.noChange.length>0){for(var r="",a=0;a<t.noChange.length;a++)r+=t.noChange[a].name+", ";r=r.substr(0,r.length-2),s+=" <span title='"+r+"' class='dashedBorder' style='display:inline-block;'>"+customLabels.failed_to_change.replaceAll(t.noChange.length)+". "+customLabels.View_services+"</span>."}i.addNotification(n,s,function(n){if(0!=t.noChange.length){e.actionName="Bulk Action Results",e.bulkActionSummary=customLabels.x_failed_to_change_out_of_y.replaceAll(t.noChange.length,t.noChange.length+t.changed.length);var s=i.createBulkActionResultTable(n);e.injectedResultsTabel=i.trust(s)}},t.noChange.slice(0))}e.closeLightbox()}else i.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action),e.closeLightbox()})}},e.validateDatesStart=function(){var t=new Date(e.actionStart);t.setMinutes(parseInt(e.startMinutes)),t.setHours(parseInt(e.startHour)),t>=e.actionFinish?(alert(customLabels.startBeforeEnd),e.startMinutes=e.actionStart.getMinutes(),e.startHour=e.actionStart.getHours().toString()):e.actionStart=t},e.validateDatesEnd=function(){var t=new Date(e.actionFinish);t.setMinutes(parseInt(e.endMinutes)),t.setHours(parseInt(e.endHour)),t<=e.actionStart?(alert(customLabels.finishAfterStart),e.endMinutes=e.actionFinish.getMinutes().toString(),e.endHour=e.actionFinish.getHours().toString()):e.actionFinish=t},e.runOptimization=function(){var t=[],n=!0;for(var s in e.selectedLocations)e.selectedLocations[s]&&t.push(s);if(0===t.length)return void alert(customLabels.noLocationWasSelected);if("all"!=e.optimizeAllServices&&(n=!1),e.actionStart>e.actionFinish)return void alert(customLabels.startBeforeEnd);var r=new Date(e.actionFinish);r.setDate(r.getDate()+1),e.closeLightbox();var o=e.optimizeSelectedFilter;"noFilter"==o&&(o=null),a.runOptimization(e.actionStart,r,t,n,e.orphanServices,e.selectedPolicy.Id,o).then(function(e){e?a.getRequestObject(e).then(function(e){e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?i.addNotification(customLabels.Optimization_Request_Sent,customLabels.Optimization_sent_details,function(e){window.open("../"+e)},e.Id):i.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){window.open("../"+e)},e.Id)}):i.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)})},e.bulkFlag=function(){for(var e in i.servicesSelection)i.servicesSelection[e]&&(r.flagged[e]?(r.flagged[e]=!1,flaggedServices[e]=!1):(r.flagged[e]=!0,flaggedServices[e]=!0));scheduler.updateView()},e.progressBarStyle=function(){return{width:(e.currentSchedulingIndex+1)/e.globalSelectedCount*100+"%"}},e.getStatusTranslations=i.getStatusTranslations,e.$on("openCreateServiceLightbox",function(t,n){$("#CreateServiceLightboxHeader h1").text(customLabels.Create_Quick_Service),e.createServiceLightbox=!0,e.createLightboxFormUrl=s.trustAsResourceUrl(customNewServiceLightbox).toString()}),e.closeCreateService=function(){a.getDelta().then(function(){e.createServiceLightbox=!1},function(){e.createServiceLightbox=!1})}}])}(),function(){angular.module("serviceExpert").controller("ctrlGantt",["$scope","$rootScope","$q","sfdcService","servicesService","utils","calendarsService","userSettingsManager","resourceFilterHelper","monthlyViewHelperService","ResourcesAndTerritoriesService","TimePhasedDataService","StateService","CapacityLightboxService","ResourceSmallMenu","AbsencesService","SkillsService","DeltaService","AbsenceLightboxService","ResourceLightboxService","ServiceAppointmentLightboxService","kpiCalculationsService","ResourceCapacitiesService","SERVICE_STATUS","SERVICE_CATEGORY","GetSlotsService","bulkScheduleService","GeneralLightbox",function(e,t,n,s,i,r,a,o,c,l,u,d,v,h,g,p,m,f,S,b,y,T,L,w,k,C,R,D){function A(){if(q)return void(q=!1);setHoursToDisplay(e.businessHoursRange.start,e.businessHoursRange.end,e.businessHoursRange.includeWeekends),scheduler.setCurrentView(),r.ganttSettings.startHour=e.businessHoursRange.start,r.ganttSettings.finishHour=e.businessHoursRange.end;var t={};t.Gantt_View_Start_Hour__c=r.ganttSettings.startHour,t.Gantt_View_Finish_Hour__c=r.ganttSettings.finishHour,t.Include_Weekends__c=e.businessHoursRange.includeWeekends,o.SetUserSettingProperties(t)}function I(e,t){if(""===t&&(t=prompt(customLabels.msg_to_post_to_chatter,"")),null!==t){if(""===t)return void alert(customLabels.no_empty_msg_to_chatter);1==e.length&&(i.recentlyUsed[e[0]]=!0),i.postToChatter(e,t).then(function(e){})}}function x(){for(var t in e.selectedGanttServices)delete e.selectedGanttServices[t]}function F(t){for(var n=!1,s=0;s<e.pinnedStatusesSF.length;s++)scheduler._events[t].status===e.pinnedStatusesSF[s]&&(n=!0);scheduler._events[t].pinned||n?(j.hideItem("reschedule"),j.hideItem("candidates"),j.hideItem("unschedule"),j.hideItem("status"),j.hideItem("reshuffle"),j.hideItem("groupNearby")):(j.showItem("reschedule"),j.showItem("candidates"),j.showItem("unschedule"),j.showItem("status"),j.showItem("reshuffle"),j.showItem("groupNearby")),scheduler._events[t].pinned?j.hideItem("status"):j.showItem("status"),scheduler._events[t].latitude&&scheduler._events[t].longitude&&r.hasCustomPermission("Group_Nearby")?j.showItem("groupNearby"):j.hideItem("groupNearby"),r.hasCustomPermission("Schedule")?j.showItem("reschedule"):j.hideItem("reschedule"),r.hasCustomPermission("Reshuffle")?j.showItem("reshuffle"):j.hideItem("reshuffle"),j.removeItem("showRelated"),(scheduler._events[t].isServiceInChain||scheduler._events[t].relatedTo||scheduler._events[t].relatedFather)&&j.addNewChild(j.topId,5,"showRelated",r.getSVGIconHTML(lsdIcons.related)+customLabels.Show_related,!1),v.isMapEnabled()&&null!==scheduler._events[t].latitude?j.showItem("map"):j.hideItem("map"),j.removeItem("flag"),i.flagged[t]?j.addNewChild(j.topId,1,"flag","<span class='emptyFlag'>"+r.getSVGIconHTML(lsdIcons.flag)+"</span> "+customLabels.Unflag,!1):j.addNewChild(j.topId,1,"flag","<span class='fullFlag'>"+r.getSVGIconHTML(lsdIcons.flag)+"</span> "+customLabels.Flag,!1),j.removeItem("pin"),scheduler._events[t].pinned?j.addNewChild(j.topId,9,"pin","<span class='emptyFlag'>"+r.getSVGIconHTML(lsdIcons.unpin)+"</span> "+customLabels.Unpin,!1):j.addNewChild(j.topId,9,"pin","<span class='fullFlag'>"+r.getSVGIconHTML(lsdIcons.pin)+"</span> "+customLabels.Pin,!1),j.removeItem("consoleTab"),e.isInConsole()&&j.addNewChild(j.topId,1,"consoleTab",r.getSVGIconHTML(lsdIcons.external)+customLabels.Open_Tab,!1)}function M(e){var t=void 0,n=0;if(_.isEmpty(r.statusFlow)){j.removeItem("status"),j.addNewChild(j.topId,5,"status",r.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1);for(var s in r.statuses)t="ContextMenu_"+r.statusTranslations[r.statuses[s]].split(" ").join(""),j.addNewChild("status",n,"status_change_"+n,"<span class='StatusColorChanger "+t+" "+r.getCSSClassForContext(r.statusTranslations[r.statuses[s]],w)+"'></span>"+r.statusTranslations[r.statuses[s]],!1),K["status_change_"+n++]=r.statuses[s]}else{if(!(r.statusFlow[e]&&r.statusFlow[e].length>0))return void j.removeItem("status");for(j.removeItem("status"),j.addNewChild(j.topId,5,"status",r.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),K={},n=0;n<r.statusFlow[e].length;n++)t="ContextMenu_"+r.statusFlow[e][n].split(" ").join(""),j.addNewChild("status",n,"status_change_"+n,"<span class='StatusColorChanger "+t+" "+r.getCSSClassForContext(r.statusFlow[e][n],w)+"'></span>"+r.statusTranslations[r.statusFlow[e][n]],!1),K["status_change_"+n]=r.statusFlow[e][n]}}function E(t){for(var n in e.selectedGanttServices)e.selectedGanttServices[n]&&(i.flagged[n]=t);scheduler.updateView()}function O(){if(scheduler._is_initialized()&&e.datalessMethods){for(var t=0;t<e.nowTimespans.length;t++)scheduler.deleteMarkedTimespan(e.nowTimespans[t]);e.nowTimespans.length=0;var n=scheduler.serverList("resources"),s=getMinAndMaxHoursToDisplay();for(t=0;t<n.length;t++){var i=new Date,a=new Date(i.valueOf()+6e4*i.getTimezoneOffset());if(useLocationTimezone?a.setMinutes(a.getMinutes()+r.getLocationOffset(a,n[t].key)):a=r.convertDateBetweenTimeZones(a,"GMT",userTimeZone),s.min<=a.getHours()&&a.getHours()<s.max&&!e.datalessMethods.isDateInsideWeekend(a)&&"MonthlyView"!==scheduler._mode){var o={};o[scheduler.getState().mode]=[];for(var c=0;c<n[t].children.length;c++)o[scheduler.getState().mode].push(n[t].children[c].key);e.nowTimespans.push(scheduler.addMarkedTimespan({start_date:a,end_date:scheduler.date.add(a,1,"minute"),css:"dhx_now_time dhx_matrix_now_time",sections:o}))}}}}function P(e){if(!confirm(customLabels.are_you_sure_unschedule))return!0;var t=[],n=[];e.forEach(function(e){n.push(d.serviceAppointments()[e]),t.push(d.serviceAppointments()[e].resource),i.recentlyUsed[e]=!0}),i.unscheduleServices(e).then(function(e){i.drawServicesAndAbsences(e.services,e.absences),T.calculateKpis(),x()})["catch"](function(e){r.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})}function N(e,t){if(t===w.CANCELED&&!confirm(customLabels.AreYouSureYouWantToCancel))return!0;var n=[],s=[];e.forEach(function(e){s.push(d.serviceAppointments()[e]),n.push(d.serviceAppointments()[e].resource),i.recentlyUsed[e]=!0}),i.changeStatus(e,t).then(function(e){i.drawServicesAndAbsences(e.services),x()})["catch"](function(e){r.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})}function B(e){var t=(e.start_date.getMinutes()+e.travelTo/60)%60,n="na"===e.type?e.end-e.start:e.schedEndTime-e.schedStartTime,s=t%serviceJumpsOnGantt,i=serviceJumpsOnGantt-t%serviceJumpsOnGantt;0!==s&&(s>i?e.start_date=new Date(e.start_date.getTime()+60*i*1e3):e.start_date=new Date(e.start_date.getTime()-60*s*1e3),e.end_date=new Date(e.start_date.getTime()+n+1e3*e.travelFrom+1e3*e.travelTo),e.schedStartTime=e.start_date.getTime()+1e3*e.travelTo,e.schedEndTime=e.end_date.getTime()-1e3*e.travelFrom)}var H="",G="",V={},U=!0,j=new dhtmlXMenuObject({parent:"contextZone_A",context:!0}),z=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});e.selectedGanttServices={},e.resourceFilterHelper=c,e.resources=[],e.searchEmployee="",e.resourceFieldToSortyBy="Name",e.successfullyScheduled=0,e.currentSchedulingIndex=0,e.ganttLocked=!1,e.timelineName="",e.nowTimespans=[],e.selectedSkills={},e.pinnedStatusesSF=CustomSettings.pinnedStatusesSF.split(","),e.hasCustomPermission=r.hasCustomPermission,t.statusTranslations=r.statusTranslations,e.$watch("resourceFilterHelper",function(){$("#resourceExplainCrap").html(e.resourceFilterHelper.generateFilterExplanation(e.resourceFilters.showWorkingResource))},!0),p.getEmployeeAbsenceTypes().then(function(t){e.nonAvailabilityTypes=t,e.defaultDragNa={selectedNaDuration:JSON.parse(o.GetUserSettingsProperty("Drag_Na_Duration__c"))||60,selectedNaType:o.GetUserSettingsProperty("Drag_Na_Type__c")||e.nonAvailabilityTypes[0],selectedNaLabel:o.GetUserSettingsProperty("Drag_Na_Label__c")}}),e.businessHoursRange={start:r.ganttSettings.startHour,end:r.ganttSettings.finishHour,includeWeekends:o.GetUserSettingsProperty("Include_Weekends__c")},e.resourceFilters={showWorkingResource:!1,resourcesWorkingInRange:{}},e.isInConsole=v.isInConsole,e.openConsoleTab=r.openConsoleTab,e.capacityFields=l.capacityCalculationFields,Object.defineProperty(e.selectedGanttServices,"getSelected",{enumrable:!1,value:function(){var e=[];for(var t in this)this[t]&&e.push(t);return e}}),e.isGanttFilterApplied=function(){return e.skillsFilter||c.isResourceFilterApplied()||e.resourceFilters.showWorkingResource},cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix"));var q=!0;e.$watchCollection("businessHoursRange",A),u.promises.resources().then(function(){e.resources=u.getResources}),e.saveDragNaDefaults=function(t){switch(t){case"duration":o.SetUserSettingsProperty("Drag_Na_Duration__c",e.defaultDragNa.selectedNaDuration);break;case"type":o.SetUserSettingsProperty("Drag_Na_Type__c",e.defaultDragNa.selectedNaType);break;case"label":o.SetUserSettingsProperty("Drag_Na_Label__c",e.defaultDragNa.selectedNaLabel)}},e.getTimePhasedObjects=function(e){var n=scheduler.getState().min_date,s=scheduler.getState().max_date;return"undefined"!=typeof e?"left"==e?(s.setDate(n.getDate()+1),n.setDate(n.getDate()-1)):"right"==e&&(n.setDate(s.getDate()-1),s.setDate(s.getDate()+1)):(n.setDate(n.getDate()-1),s.setDate(s.getDate()+1)),d.getTimePhasedObjects(n,s).then(function(e){if(t.$broadcast("ganttFinishedLoadingServices"),U){U=!1,scheduler.updateView();var n=null;document.URL.indexOf("service=")>-1&&(n=document.URL.substr(document.URL.indexOf("service=")+8,18)),scheduler._events[n]?(scheduler._select_id=n,scheduler.select(n),setTimeout(function(){r.showOnGantt(n)},0)):n&&alert(customLabels.cant_display_service)}})},e.changeDatesByArrows=function(t){e.getTimePhasedObjects(t)},scheduler.attachEvent("onDblClick",function(t,n){r.safeApply(e,function(){"service"===scheduler.getEvent(t).type?(i.recentlyUsed[t]=!0,y.open(t)):"contractorcapacity"===scheduler.getEvent(t).type?h.open(t):S.open(t)})}),scheduler.attachEvent("onBeforeFolderToggle",function(t,n,s){return r.safeApply(e,function(){v.ganttOpenedTerritories[t.key]=n}),!0}),scheduler.attachEvent("onViewChange",function(t,n){r.safeApply(e,function(){switch(scheduler._mode){case"ZoomLevel2":e.timelineName=customLabels.In_Day;break;case"ZoomLevel3":e.timelineName=customLabels.Daily;break;case"ZoomLevel4":e.timelineName=customLabels.X2_Days;break;case"ZoomLevel5":e.timelineName=customLabels.X3_Days;break;case"ZoomLevel6":e.timelineName=customLabels.Weekly;break;case"MonthlyView":e.timelineName=customLabels.Utilization;break;case"MTDView":e.timelineName=customLabels.MDTVIEW}$("#MonthlyLocationViewTooltip").remove(),O(),scheduler.updateView(),T.calculateKpis()})}),scheduler.attachEvent("onBeforeDrag",function(t,n,s){var i,r=s.ctrlKey||s.metaKey;if(!t||"create"==n){if(!r)for(i in e.selectedGanttServices)e.selectedGanttServices[i]=!1,
scheduler.getRenderedEvent(i)&&scheduler.updateEvent(i);return!1}if(t&&"service"==scheduler.getEvent(t).type){if(r)return z.hide(),e.selectedGanttServices[t]?(e.selectedGanttServices[t]=!1,scheduler.updateEvent(t)):(e.selectedGanttServices[t]=!0,scheduler.updateEvent(t)),!1;e.selectedGanttServices[t]=!0;for(i in e.selectedGanttServices)i!=t&&(e.selectedGanttServices[i]=!1,scheduler.getEvent(i)&&scheduler.getSection(scheduler.getEvent(i).resourceId)&&scheduler.updateEvent(i))}else if(!r&&e.selectedGanttServices.getSelected().length>=1)for(i in e.selectedGanttServices)e.selectedGanttServices[i]=!1,scheduler.getRenderedEvent(i)&&scheduler.updateEvent(i);if(!("service"!=scheduler.getEvent(t).type&&"na"!=scheduler.getEvent(t).type||t&&"service"==scheduler.getEvent(t).type&&scheduler.getEvent(t).pinned&&preventUpdateOfPinned))return!0}),e.$watchCollection("selectedGanttServices",function(t,n){globalSelectedGanttServices=e.selectedGanttServices}),e.jumpToDate=function(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"JumpToDate",date:scheduler._date,navigation:!0,handler:function(t,n){scheduler.setCurrentView(t),scheduler.destroyCalendar(),e.changeDatesByArrows()}})};var W=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});W.addNewChild(W.topId,0,"details",r.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),W.attachEvent("onClick",function(t,n,s){switch(t){case"details":r.safeApply(e,function(){S.open(G)});break;case"delete":r.safeApply(e,function(){confirm(customLabels.naDeleteConfirm)&&p.deleteAbsence(G).then(function(e){e?scheduler.deleteEvent(G):alert(customLabels.Failed_To_Delete_Break)})})}}),function(){j.addNewChild(j.topId,0,"details",r.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),j.addNewChild(j.topId,3,"reschedule",r.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),j.addNewChild(j.topId,4,"candidates",r.getSVGIconHTML(lsdIcons.candidates)+customLabels.Get_Candidates,!1),j.addNewChild(j.topId,10,"reshuffle",r.getSVGIconHTML(lsdIcons.retweet)+customLabels.Reshuffle,!1),j.addNewChild(j.topId,11,"groupNearby",r.getSVGIconHTML(lsdIcons.groupNearby)+customLabels.GroupNearby,!1),j.addNewChild(j.topId,5,"status",r.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),j.addNewChild(j.topId,6,"map",r.getSVGIconHTML(lsdIcons.world)+customLabels.Map,!1),j.addNewChild(j.topId,8,"unschedule",r.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),fieldTrackingEnabled.service&&(j.addNewChild(j.topId,7,"chatter",r.getSVGIconHTML(lsdIcons.chat)+customLabels.Chatter+"<i id='chatterArrowContext' class='fa fa-caret-right chatter-carret'></i>",!1),j.addNewChild("chatter",0,"chatter_welldone",r.getSVGIconHTML(lsdIcons.like)+customLabels.well_done,!1),j.addNewChild("chatter",1,"chatter_hurryup",r.getSVGIconHTML(lsdIcons.hurry)+customLabels.Hurry_up,!1),j.addNewChild("chatter",2,"chatter_requestupdate",r.getSVGIconHTML(lsdIcons.help)+customLabels.Request_update,!1),j.addNewChild("chatter",3,"chatter_custom",r.getSVGIconHTML(lsdIcons.threedots)+customLabels.Custom_message,!1))}();var K={};scheduler.attachEvent("onContextMenu",function(t,n){if(scheduler.config.readonly)return!0;if(t&&"service"!=scheduler.getEvent(t).type&&"break"!=scheduler.getEvent(t).type&&"na"!=scheduler.getEvent(t).type)return!1;if(t){scheduler.dhtmlXTooltip.hide();var s=0,i=0;if(n.pageX||n.pageY?(s=n.pageX,i=n.pageY):(n.clientX||n.clientY)&&(s=n.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,i=n.clientY+document.body.scrollTop+document.documentElement.scrollTop),e.selectedGanttServices.getSelected().length<2)return"break"==scheduler._events[t].type?(W.removeItem("delete"),W.showContextMenu(s,i),G=t,!1):"na"==scheduler._events[t].type?(W.removeItem("delete"),W.addNewChild(W.topId,1,"delete",r.getSVGIconHTML(lsdIcons["delete"])+customLabels.Delete,!1),W.showContextMenu(s,i),G=t,!1):(F(t),scheduler.getEvent(t).pinned||M(scheduler.getEvent(t).status),j.showContextMenu(s,i),H=t,!1);z.removeItem("selectedNumber"),z.addNewChild(z.topId,0,"selectedNumber","<i class='fa fa-check-square-o'></i> "+customLabels.x_services_selected.replaceAll(e.selectedGanttServices.getSelected().length),!0),z.removeItem("status"),z.addNewChild(z.topId,4,"status",r.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),K={};var a=0;for(var o in r.statuses){var c="ContextMenu_"+r.statusTranslations[r.statuses[o]].split(" ").join("");z.addNewChild("status",a,"status_change_"+a,"<span class='StatusColorChanger "+c+" "+r.getCSSClassForContext(r.statusTranslations[r.statuses[o]],w)+"'></span>"+r.statusTranslations[r.statuses[o]],!1),K["status_change_"+a++]=r.statuses[o]}return z.showContextMenu(s,i),!1}return H="",G="",!0}),j.attachEvent("onShow",function(e){contextShown=!0}),j.attachEvent("onHide",function(e){contextShown=!1}),W.attachEvent("onShow",function(e){contextShown=!0}),W.attachEvent("onHide",function(e){contextShown=!1}),j.attachEvent("onClick",function(t,n,a){e.$evalAsync(function(){switch(t){case"details":r.safeApply(e,function(){y.open(H)});break;case"consoleTab":e.openConsoleTab(null,H);break;case"flag":e.$evalAsync(function(){i.flagged[H]=!i.flagged[H],scheduler.updateEvent(H)});break;case"pin":i.changePin([scheduler._events[H].id],!scheduler._events[H].pinned).then(function(){return scheduler.updateView()});break;case"reschedule":e.$evalAsync(function(){i.autoScheduleService(H).then(function(e){0===e.services.length&&alert(customLabels.NoCandidates),i.drawServicesAndAbsences(e.services,e.absences)})["catch"](function(e){var t=d.serviceAppointments()[H].name;r.addNotification(t+" - "+customLabels.Action_Could_Not_Be_Performed,e.message,function(){y.open(H)})})});break;case"reshuffle":e.$evalAsync(function(){s.runReshuffle(H,v.selectedPolicyId).then(function(e){f.updateOptimizationRequest(e)},function(){r.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message)})});break;case"groupNearby":e.$evalAsync(function(){s.runGroupNearby(H,v.selectedPolicyId).then(function(e){f.updateOptimizationRequest(e)},function(){r.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message)})});break;case"candidates":C.get(H);break;case"chatter_welldone":I([H],customLabels.Well_done_mate);break;case"chatter_hurryup":I([H],customLabels.hurry_up_with_this_service);break;case"chatter_requestupdate":I([H],customLabels.please_update_service);break;case"chatter_custom":I([H],"");break;case"unschedule":e.$evalAsync(function(){P([H])});break;case"map":e.showOnMap(H);break;case"showRelated":if(usingNewMstModel)return void D.open("Related Services For "+scheduler._events[H].name,mstPage+"?ingantt=true&id="+H);if(scheduler._events[scheduler._events[H].relatedFather])return void r.showOnGantt(scheduler._events[H].relatedFather);if(scheduler._events[scheduler._events[H].relatedTo])return void r.showOnGantt(scheduler._events[H].relatedTo);scheduler._events[H].relatedFather?alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[H].relatedFather].name)):alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[H].relatedTo].name));break;default:e.$evalAsync(function(){N([H],K[t])})}})}),$(".dhtmlxMenu_dhx_skyblue_SubLevelArea_Polygon").mouseover(function(){scheduler.dhtmlXTooltip.hide()}),z.addNewChild(z.topId,1,"flag",r.getSVGIconHTML(lsdIcons.flag)+customLabels.Flag,!1),z.addNewChild(z.topId,2,"unflag","<span class='emptyFlag'>"+r.getSVGIconHTML(lsdIcons.flag)+"</span>"+customLabels.Unflag,!1),z.addNewChild(z.topId,3,"reschedule",r.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),z.addNewChild(z.topId,5,"unschedule",r.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),z.addNewChild(z.topId,7,"pin",r.getSVGIconHTML(lsdIcons.pin)+customLabels.Pin,!1),z.addNewChild(z.topId,8,"unpin","<span class='emptyFlag'>"+r.getSVGIconHTML(lsdIcons.unpin)+"</span>"+customLabels.Unpin,!1),z.attachEvent("onShow",function(e){contextShown=!0}),z.attachEvent("onHide",function(e){contextShown=!1}),z.attachEvent("onClick",function(t,n,s){e.$evalAsync(function(){switch(t){case"flag":r.safeApply(e,function(){E(!0)});break;case"unflag":r.safeApply(e,function(){E(!1)});break;case"reschedule":R.schedule(e.selectedGanttServices.getSelected());break;case"pin":i.changePin(e.selectedGanttServices.getSelected(),!0).then(function(){return scheduler.updateView()});break;case"unpin":i.changePin(e.selectedGanttServices.getSelected(),!1).then(function(){return scheduler.updateView()});break;case"unschedule":P(e.selectedGanttServices.getSelected());break;default:N(e.selectedGanttServices.getSelected(),K[t])}})}),e.lockGanttToggle=function(){scheduler.config.readonly=!scheduler.config.readonly,e.ganttLocked=scheduler.config.readonly},e.unSelecteAllSkills=function(){for(var t in e.selectedSkills)e.selectedSkills[t]=!1},e.selectAllSkills=function(){for(var t in e.selectedSkills)e.selectedSkills[t]=!0},m.promises.skills().then(function(t){e.skills=t}),scheduler.attachEvent("onYScaleClick",function(e,t,n){for(var s=["resourceMenuBtn","resourceMenuIcon"],i=0;i<s.length;i++)if(n.target.classList&&n.target.classList.contains(s[i])||n.target.parentNode&&n.target.parentNode.classList.contains(s[i]))return void g.open(t.resourceId,t.key,n.target);t.children||b.open(t.resourceId,t.key)}),e.$on("keypress",function(t,n){if($("#MonthlyViewTooltip").remove(),!v.isLightboxOpened()&&!$("*:focus").is("textarea, input"))switch(n.which){case 13:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(i.recentlyUsed[scheduler._selected_id]=!0,y.open(scheduler._select_id));break;case 37:$(".dhx_cal_prev_button").click();break;case 38:var s=$(".dhx_cal_data").scrollTop();$(".dhx_cal_data").scrollTop(s-30);break;case 39:$(".dhx_cal_next_button").click();break;case 40:s=$(".dhx_cal_data").scrollTop(),$(".dhx_cal_data").scrollTop(s+30);break;case 87:""!==scheduler._select_id&&scheduler._select_id&&"service"==scheduler.getEvent(scheduler._select_id).type&&scheduler.getEvent(scheduler._select_id).parentRecord&&(e.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._events[scheduler._select_id].parentRecord],function(e){sforce.console.openConsoleUrl(null,e.consoleUrl,!0)}):window.open("../"+scheduler._events[scheduler._select_id].parentRecord));break;case 83:""!==scheduler._select_id&&scheduler._select_id&&"service"==scheduler.getEvent(scheduler._select_id).type&&(e.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._select_id],function(e){sforce.console.openConsoleUrl(null,e.consoleUrl,!0)}):window.open("../"+scheduler._select_id));break;case 84:e.jumpToToday();break;case 70:1===e.selectedGanttServices.getSelected().length&&""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(i.flagged[scheduler._select_id]?(i.flagged[scheduler._select_id]=!1,scheduler.updateEvent(scheduler._select_id)):(i.flagged[scheduler._select_id]=!0,scheduler.updateEvent(scheduler._select_id)));break;case 48:e.changeTimeline(0);break;case 96:e.changeTimeline(0);break;case 49:e.changeTimeline(1);break;case 97:e.changeTimeline(1);break;case 50:e.changeTimeline(2);break;case 98:e.changeTimeline(2);break;case 51:e.changeTimeline(3);break;case 99:e.changeTimeline(3);break;case 55:e.changeTimeline(7);break;case 77:r.hasCustomPermission("MDT_View")&&monthlyViewSettings.isMonthlyAvailable&&e.changeTimeline(35);break;case 85:r.hasCustomPermission("Monthly_Utilization")&&monthlyViewSettings.isMonthlyAvailable&&e.changeTimeline(30);break;case 103:e.changeTimeline(7)}}),e.changeTimeline=function(t){var n=scheduler._min_date,s=scheduler._max_date,i=void 0;switch(t){case 0:if(i="ZoomLevel2",i==scheduler._mode)return;e.timelineName=customLabels.In_Day;break;case 1:if(i="ZoomLevel3",i==scheduler._mode)return;e.timelineName=customLabels.Daily;break;case 2:if(i="ZoomLevel4",i==scheduler._mode)return;e.timelineName=customLabels.X2_Days;break;case 3:if(i="ZoomLevel5",i==scheduler._mode)return;e.timelineName=customLabels.X3_Days;break;case 7:if(i="ZoomLevel6",i==scheduler._mode)return;e.timelineName=customLabels.Weekly;break;case 30:if(i="MonthlyView",i==scheduler._mode)return;e.timelineName=customLabels.Utilization;break;case 35:if(i="MTDView",i==scheduler._mode)return;e.timelineName=customLabels.MDTVIEW}scheduler.setCurrentView(n,i),e.changeDatesByArrows(s)},setInterval(O,6e5),e.jumpToToday=function(){var t=new Date;t.setHours(0),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0),scheduler.setCurrentView(t),e.changeDatesByArrows()},t.$on("afterShowEvent",function(){setTimeout(function(){e.changeDatesByArrows(),O(),scheduler.updateView(),t.$broadcast("updateKpis")},800)}),e.showOnMap=function(n){t.$broadcast("showServiceOnMap",n),r.safeApply(e)},scheduler.attachEvent("onBeforeEventChanged",function(e,t,n,s){var i=void 0,r=void 0,a=void 0,o=void 0;if(e.resourceId==s.resourceId){if(i=e.start_date.getTime(),r=e.end_date.getTime(),a=s.start_date.getTime(),o=s.end_date.getTime(),Math.abs((i-a)/1e3/60)<minDragMinutes||Math.abs((r-o)/1e3/60)<minDragMinutes)return cachedDomElements.timesDragFix.hide(),!1}else if("na"==e.type)return!1;if(v.areContractorsSupported()&&"service"==e.type&&u.getResources()[e.getGanttResource()].isCapacityBased){for(var c in d.resourceCapacities()){var l=d.resourceCapacities()[c];if(l.resource==u.getResources()[e.getGanttResource()].id&&e.start.getTime()>=l.start_date.getTime()&&e.start.getTime()<=l.end_date.getTime())return e.resourceBeforeDrag=s.resourceId,e.eventBeforeDrag=s,B(e),!0}return cachedDomElements.timesDragFix.hide(),alert(customLabels.serviceCantBeAssignedWithoutCapacity),!1}return V=GanttService.copy(s),snapTo=t.ctrlKey,B(e),e.resourceBeforeDrag=s.resourceId,e.eventBeforeDrag=s,!0}),e.updateMonthlyKpi=function(){"MonthlyView"===scheduler._mode&&scheduler.updateView()},t.$on("gotNewTimePhasedObjects",function(e,t){i.drawServicesAndAbsences(t.serviceAppointments,t.resourceAbsences,[],t.resourceCapacities),_.isEmpty(t.serviceAppointments)&&_.isEmpty(t.resourceAbsences)&&_.isEmpty(t.resourceCapacities)||i.checkRules(r.getServicesBetweenDates(t.start,t.finish)).then(function(){return scheduler.updateView()})}),f.register("services",function(e){i.drawServicesAndAbsences(e.updated||[],[],e.deleted||[])}),f.register("absences",function(e){i.drawServicesAndAbsences([],e.updated||[],e.deleted||[])}),f.register("capacities",function(e){i.drawServicesAndAbsences([],[],e.deleted||[],e.updated||[])}),f.register("rules",function(e){i.checkRules(e).then(function(){return scheduler.updateView()})}),scheduler.attachEvent("onEventChanged",function(t,n){("service"===n.type||"na"===n.type)&&r.safeApply(e,function(){return"na"===n.type?void p.saveChangesToAbsence(V,n).then(function(e){i.drawServicesAndAbsences(e.services||[],e.absences||[])})["catch"](function(e){console.warn("Couldn't update absence"),e[0].error?r.addNotification(customLabels.Action_Could_Not_Be_Performed,e[0].error):r.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")}):void i.saveChangesToServiceAppointment(V,n).then(function(e){var t=[],n=[];e.absences.forEach(function(e){e.isScheduled()&&e.setGanttResource(d.resourcesAndTerritories(),r.generateResourceId),n.push(e)}),e.services.forEach(function(e){e.isScheduled()&&e.setGanttResource(d.resourcesAndTerritories(),r.generateResourceId),t.push(e)}),i.drawServicesAndAbsences(t,n)})["catch"](function(e){console.warn("Couldn't update service. "+e[2]),r.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")})})}),e.$on("GotSlotsEnded",function(){}),e.$on("JumpToDate",function(t,n){scheduler.setCurrentView(n),e.changeDatesByArrows()}),e.$on("GotSlots",function(t,n){var s=getMinAndMaxHoursToDisplay();(n.minDateOfCandidate.getHours()<s.min||n.minDateOfCandidate.getHours()>=s.max)&&confirm(customLabels.confirmChangeBusinessHours)&&(n.minDateOfCandidate.getHours()<s.min?e.businessHoursRange.start=n.minDateOfCandidate.getHours():e.businessHoursRange.end=24,A())})}])}(),function(){angular.module("serviceExpert").controller("mainController",["$scope","StateService",function(e,t){e.isOSX=t.isOSX,e.lang=t.lang}])}(),function(){angular.module("serviceExpert").controller("ctrlMap",["$scope","sfdcService","$rootScope","$q","userSettingsManager","servicesService","bulkScheduleService","$timeout","$filter","utils","ServiceAppointmentLightboxService","ResourceLightboxService","TimePhasedDataService","FieldSetFieldsService","ResourcesAndTerritoriesService","LastKnownPositionService","DeltaService","SERVICE_STATUS","SERVICE_CATEGORY","DRAWING_STATES",function(e,t,n,s,i,r,a,o,c,l,u,d,v,h,g,p,m,f,S,b){function y(t){e.allMarkersArray=[],e.showResources&&D(),e.showServices&&I(),e.showLivePositions&&C(),e.showTerritories&&E(),w(t)}function T(t){var n=t.type;switch(e.serviceInfoWindow.show=!1,e.resourceInfoWindow.show=!1,e.territoryInfoWindow.show=!1,e.reportInfoWindow.show=!1,e.livePosInfoWindow.show=!1,e.currentMarker=t,n){case"service":e.serviceInfoWindow.show=!0,e.currentMarker.item=v.serviceAppointments()[t.id];break;case"lastKnownPosition":e.livePosInfoWindow.show=!0;break;case"resource":e.resourceInfoWindow.show=!0;break;case"territory":e.territoryInfoWindow.show=!0;break;case"report":e.reportFields=[],e.reportFields.push.apply(e.reportFields,t.item.otherProperties),e.reportInfoWindow.show=!0}o(function(){e.$apply(),l.setMapCloseButtonPosition()},0)}function L(){e.resourcesFilterList=[];var t=scheduler.getState().min_date,n=scheduler.getState().max_date,s=v.resourcesAndTerritories(),i=g.getResources();for(var r in i){var a=s[r],o=i[r];for(var c in a){var l=a[c];if(isIntersect(t,n,l.effectiveStartDate,l.effectiveEndDate)){e.resourcesFilterList.push({label:o.name,value:o.id});break}}}}function w(t){var n=maxReportMarkers;for(var s in e.reportsData){var i=e.reportsData[s];if(i.show){i.displayCount=0;for(var r=0;r<i.data.length;r++){var a=i.data[r];if(0==n){t&&(e.showTooManyReportsAlert=!0);break}var o=k(a,s+i.displayCount);o&&(i.displayCount++,n--)}}}}function k(t,n){if(t.latitude){var s=staticResources.report;"ServiceAppointment"===t.sObjectType?s=staticResources.service_png:void 0!==staticResources[t.sObjectType.toLowerCase().replace(/ /g,"_")]&&(s=staticResources[t.sObjectType.toLowerCase().replace(/ /g,"_")]);var i={id:n,icon:s,type:"report",coords:{latitude:t.latitude,longitude:t.longitude},item:t};return e.allMarkersArray.push(i),!0}}function C(){var e=scheduler.getState().min_date,t=scheduler.getState().max_date,n=v.resourcesAndTerritories(),s=p.lastKnownPositions();for(var i in s){var r=n[i];for(var a in r){var o=r[a];if(isIntersect(e,t,o.effectiveStartDate,o.effectiveEndDate)){R(s[i]);break}}}}function R(t){var n=g.getResources()[t.id];if(e.isEmpty(e.filteredResources)||e.filteredResources[n.id]){var s={id:t.id+"_position",icon:staticResources.livepos_png,type:"lastKnownPosition",resourceId:t.id,coords:{latitude:t.latitude,longitude:t.longitude},item:angular.extend(angular.copy(t),{resourceName:n.name})};s.item.lastModifiedDate=l.convertDateBetweenTimeZones(s.item.lastModifiedDate,"UTC",userTimeZone),e.allMarkersArray.push(s)}}function D(){var e=scheduler.getState().min_date,t=scheduler.getState().max_date,n=v.resourcesByPrimariesAndRelocations();for(var s in n){var i=n[s];for(var r in i){var a=i[r];isIntersect(e,t,a.effectiveStartDate,a.effectiveEndDate)&&A(a)}}}function A(t){if(t.latitude){var n=g.getResources()[t.serviceResource];if(e.isEmpty(e.filteredResources)||e.filteredResources[n.id]){var s={id:t.id,icon:staticResources.homebase_png,type:"resource",resourceId:n.id,serviceTerritory:t.serviceTerritory,coords:{latitude:t.latitude,longitude:t.longitude},item:angular.extend(angular.copy(t),{resourceName:n.name})};e.allMarkersArray.push(s)}}}function I(){for(var t=e.filteredServices.servicesArray,n=0;n<t.length;n++){var s=t[n];s.id!=e.currentShowOnMapServiceId&&M(s)}e.currentShowOnMapServiceId&&M(v.serviceAppointments()[e.currentShowOnMapServiceId])}function x(e,t){for(var n=new google.maps.LatLngBounds,s=0;s<e.length;s++){var i=t?e[s].coords.latitude:e[s].latitude,r=t?e[s].coords.longitude:e[s].longitude;if(i&&r){var a=new google.maps.LatLng(i,r);n.extend(a)}}return n}function F(){var t=new google.maps.LatLng(37.794024,-122.394837),n=e.filteredServices.servicesArray,s=x(n);s.isEmpty()&&(s=x(_.values(v.serviceAppointments()))),s.isEmpty()?e.map.setCenter(t):e.map.fitBounds(s)}function M(t){if(!t.latitude)return!1;if(!e.showServices)return!1;var n=t.getGanttResource();if(!(e.isEmpty(e.filteredResources)||null!=n&&e.filteredResources[n]))return!1;var s=staticResources.service_png;t.statusCategory==S.COMPLETED&&(s=staticResources.service_completed_png);var i={id:t.id,icon:s,type:"service",animation:2,coords:{latitude:t.latitude,longitude:t.longitude},item:t};e.allMarkersArray.push(i)}function E(){var t=g.territories;for(var n in t)t[n].latitude&&e.allMarkersArray.push({id:n,icon:staticResources.territory_map_icon,type:"territory",animation:2,coords:{latitude:t[n].latitude,longitude:t[n].longitude},item:t[n]})}function O(t,n){if(e.polygons[t])e.polygons[t].polygon.setVisible(n),H(t);else if(e.territories[t]||"NoTerritoryPolygon"==t){H(t);for(var s=e.myTreeView.getSubItems(t),i=0;i<s.length;i++)P(s[i],n)}B()}function P(t,n){n?e.myTreeView.checkItem(t):e.myTreeView.uncheckItem(t)}function N(){var e=i.GetUserSettingsProperty("Invisible_Polygons__c");return void 0==e?[]:JSON.parse(i.GetUserSettingsProperty("Invisible_Polygons__c"))}function B(){return i.SetUserSettingsProperty("Invisible_Polygons__c",JSON.stringify(e.InvisiblePolygons))}function H(t){for(var n=0;n<e.InvisiblePolygons.length;n++)if(e.InvisiblePolygons[n]==t)return void e.InvisiblePolygons.splice(n,1);e.InvisiblePolygons.push(t)}function G(t){if(t)for(var n=0;n<t.length;n++)t[n][fieldNames.Polygon.KML__c]&&(e.polygons[t[n].Id]=t[n])}function V(){function t(e){if(e.id&&e.parent){if(r[e.parent.id])return e.parent;var n={};return g.allTerritories[e.parent.id]&&(n={id:g.allTerritories[e.parent.id].id,parent:g.allTerritories[e.parent.id].parentTerritory?g.allTerritories[e.parent.id].parentTerritory:0}),t(n)}}var n=s.defer(),i=g.territories,r={},a=[],o=(l.getFilteredLocations(),{NoTerritoryPolygon:{id:"NoTerritoryPolygon"}});for(var c in e.polygons)r[c]={id:c,parent:e.polygons[c][fieldNames.Polygon.Service_Territory__c]?i[e.polygons[c][fieldNames.Polygon.Service_Territory__c]]:o.NoTerritoryPolygon,text:e.polygons[c].Name,icons:{file:"fa-square"},icon_color:e.polygons[c][fieldNames.Polygon.Color__c],checked:-1==e.InvisiblePolygons.indexOf(c)?1:0,items:[]};for(var u in i)r[u]={id:u,parent:g.territories[u].parentTerritory?g.territories[u].parentTerritory:0,text:g.territories[u].name,icons:{file:"fa-building-o"},checked:-1==e.InvisiblePolygons.indexOf(u)?1:0,items:[]};r.NoTerritoryPolygon={id:"NoTerritoryPolygon",parent:0,text:customLabels.Polygons_without_Service_Territory,icons:{file:"fa-building-o"},checked:-1==e.InvisiblePolygons.indexOf("NoTerritoryPolygon")?1:0,items:[]};for(var d in r){var v=r[d],h=t(v);0!==v.parent&&h?r[h.id].items.push(v):a.push(v)}return n.resolve(a),n.promise}function U(){if(e.geoXmlParser=new geoXML3.parser({map:e.map,suppressInfoWindows:!0,zoom:!1}),!e.isEmpty(e.polygons)){var t=0;try{for(var n in e.polygons){e.geoXmlParser.parseKmlString(e.polygons[n][fieldNames.Polygon.KML__c]);for(var s=0;s<e.geoXmlParser.docs[t].placemarks.length;s++)if(e.geoXmlParser.docs[t].placemarks[s].polygon){e.geoXmlParser.docs[t].placemarks[s].id=e.polygons[n].Id,e.geoXmlParser.docs[t].placemarks[s].polygon.id=e.polygons[n].Id,e.geoXmlParser.docs[t].placemarks[s].polygon.name=e.polygons[n].Name,e.geoXmlParser.docs[t].placemarks[s].polygon.territory=e.polygons[n][fieldNames.Polygon.Service_Territory__c];var i=-1==e.InvisiblePolygons.indexOf(n)?!0:!1;e.geoXmlParser.docs[t].placemarks[s].polygon.setVisible(i),e.geoXmlParser.docs[t].placemarks[s].polygon.addListener("click",function(){e.shouldBound=!1,le.hide(),q(this)}),e.geoXmlParser.docs[t].placemarks[s].polygon.addListener("rightclick",se),e.polygons[n].polygon=e.geoXmlParser.docs[t].placemarks[s].polygon}t++}}catch(r){alert("Problem parsing KML string"),console.error(r)}}}function j(){google.maps.event.addListener(e.drawingManager,"overlaycomplete",function(t){var n=t.overlay;return e.cancelDrawingShape?(e.cancelDrawingShape=!1,void n.setMap(null)):(n.type=t.type,n.set("fillColor",e.selectedColor),n.set("name",e.polygonName),n.set("territory",e.polygonTerritory),e.drawingManager.setDrawingMode(null),google.maps.event.addListener(n,"click",function(e){if(void 0!==e.vertex&&n.type===google.maps.drawing.OverlayType.POLYGON){var t=n.getPaths().getAt(e.path);t.removeAt(e.vertex),t.length<3&&n.setMap(null)}q(n)}),void q(n))}),"function"!=typeof google.maps.Polygon.prototype.ToWKT&&(google.maps.Polygon.prototype.ToWKT=function(){for(var e=this,t="POLYGON(",n=e.getPaths(),s=0;s<n.getLength();s++){var i=n.getAt(s);t+="(";for(var r=0;r<i.getLength();r++)t+=i.getAt(r).lng().toString()+" "+i.getAt(r).lat().toString()+",";t+=i.getAt(0).lng().toString()+" "+i.getAt(0).lat().toString()+"),"}return t=t.substring(0,t.length-1)+")"})}function z(){e.selectedShape&&("marker"!==e.selectedShape.type&&e.selectedShape.setEditable(!1),e.selectedShape.set("strokeWeight",1),e.selectedShape=null,e.currentEditPolygon=null,e.polygonName="",e.polygonTerritory="null"),e.drawState=e.drawState==b.DRAW?b.EDIT:b.NONE}function q(t){if(this&&(t=this),e.drawState==b.INTERSECT){if(e.currentIntersectingId==t.id)return;return e.selectedIntersectingPolygons[t.id]?delete e.selectedIntersectingPolygons[t.id]:e.selectedIntersectingPolygons[t.id]=!0,void e.$apply()}"marker"!==t.type&&(z(),e.selectedShapeColor=t.get("fillColor"),e.drawState!=b.EDIT&&(e.drawState=b.SELECTED)),e.polygonName=t.name,e.polygonTerritory=t.territory||"null",e.selectedShape=t,K(),t.id!=e.myTreeView.getSelectedId()&&(e.shouldBound=!1,e.myTreeView.selectItem(t.id)),e.$apply()}function W(t){e.selectedShape&&(e.selectedShape.set("fillColor",t),e.selectedShapeColor=t),e.selectedColor=t}function K(){e.selectedShape&&e.selectedShape.set("strokeWeight",3)}function Z(){e.selectedShape&&(e.selectedShape.setMap(null),o(function(){e.currentEditPolygon&&te(e.currentEditPolygon),e.polygonName="",e.polygonTerritory="null"},0))}function X(t){var n=e.drawingManager.get("polygonOptions");n.fillColor=t,e.drawingManager.set("polygonOptions",n)}function J(t,n){if(!n){var s=t[fieldNames.Polygon.Service_Territory__c]?t[fieldNames.Polygon.Service_Territory__c]:"NoTerritoryPolygon";e.myTreeView.addItem(t.Id,t.Name,s)}e.myTreeView.checkItem(t.Id),e.myTreeView.setItemIcons(t.Id,{file:"fa-square"}),e.myTreeView.setIconColor(t.Id,t[fieldNames.Polygon.Color__c])}function Y(e,t){return t+e.substring(5,7)+e.substring(3,5)+e.substring(1,3)}function Q(e){for(var t="",n=0;n<e.length;n++)t+=e[n].lng+","+e[n].lat+",0\n";return t+=e[0].lng+","+e[0].lat+",0"}function ee(e,t,n){return'<?xml version="1.0" encoding="UTF-8"?> \n                            <kml xmlns="http://www.opengis.net/kml/2.2">\n                                <Style id="'+n.replace(" ","")+'Style"> \n                                    <LineStyle> \n                                        <width>1</width> \n                                    </LineStyle> \n                                    <PolyStyle> \n                                        <color>'+Y(t,80)+"</color> \n                                    </PolyStyle> \n                                </Style> \n                                <Placemark> \n                                    <name>"+n.replace(" ","")+"</name> \n                                    <styleUrl>#"+n.replace(" ","")+"Style</styleUrl> \n                                    <Polygon> \n                                        <outerBoundaryIs> \n                                            <LinearRing>\n                                                <coordinates>"+Q(e)+"</coordinates> \n                                            </LinearRing> \n                                        </outerBoundaryIs> \n                                    </Polygon> \n                                </Placemark> \n                            </kml>"}function te(t){e.geoXmlParser.parseKmlString(t[fieldNames.Polygon.KML__c]);for(var n=e.geoXmlParser.docs.length-1,s=0;s<e.geoXmlParser.docs[n].placemarks.length;s++)e.geoXmlParser.docs[n].placemarks[s].id=t.Id,e.geoXmlParser.docs[n].placemarks[s].polygon.id=t.Id,e.geoXmlParser.docs[n].placemarks[s].polygon.name=t.Name,e.geoXmlParser.docs[n].placemarks[s].polygon.territory=t[fieldNames.Polygon.Service_Territory__c],e.geoXmlParser.docs[n].placemarks[s].polygon.addListener("click",function(){e.shouldBound=!1,le.hide(),q(this)}),e.geoXmlParser.docs[n].placemarks[s].polygon.addListener("rightclick",se),e.polygons[t.Id]=t,e.polygons[t.Id].polygon=e.geoXmlParser.docs[n].placemarks[s].polygon}function ne(e,t){t=t||{},this.setMap(e),this.mapDiv=e.getDiv(),this.menuItems=t.menuItems||{},this.isVisible=!1}function se(t){le.hide(),this.clickedPolygon_=this,q(this);var n=le.getProjection(),s=n.fromLatLngToDivPixel(t.latLng);le.show(s),e.map.setOptions({draggableCursor:"pointer"})}function ie(t){switch(t){case"menu-edit-polygon":e.mapOptionsToggle=!0,$(".polygonsTab").click(),e.editPolygon();break;case"menu-intersect-polygon":e.mapOptionsToggle=!0,$(".polygonsTab").click(),e.currentIntersectingId=angular.copy(e.selectedShape.id),e.drawState=b.INTERSECT,e.$apply();break;case"menu-delete-polygon":e.deletePolygon();break;case"menu-schedule-polygon":a.schedule(re(e.selectedShape)),e.$apply();break;case"menu-unschedule-polygon":r.unscheduleServices(re(e.selectedShape));break;case"menu-dispatch-polygon":r.changeStatus(re(e.selectedShape),f.DISPATCHED).then(function(e){r.drawServicesAndAbsences(e.services)})["catch"](function(e){l.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)});break;case"menu-joepardy-polygon":r.setInJeopardy(re(e.selectedShape))}}function re(t){for(var n=[],s=0;s<e.filteredServices.servicesArray.length;s++){var i=e.filteredServices.servicesArray[s];if(null!=i.latitude&&null!=i.longitude){var r=new google.maps.LatLng(i.latitude,i.longitude);google.maps.geometry.poly.containsLocation(r,t)&&n.push(i.id)}}return n}function ae(t){for(var n=t.slice(9,t.length-2).split(","),s=[],i=0;i<n.length;i++){var r=n[i].split(" ");s.push(new google.maps.LatLng({lat:parseFloat(r[1]),lng:parseFloat(r[0])}))}e.selectedShape.setPath(s),e.savePolygon(),e.selectedIntersectingPolygons={}}e.SERVICE_STATUS=f,e.invokedActions={},e.allMarkersArray=[],e.reports={},e.reportsData={},e.map=null,e.markersControl={},e.territoriesMarkers=[],e.firstMapShow=!0,e.trafficLayerEnabled=!1,e.mapControl={},e.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}},e.showServices=!0,e.showResources=!0,e.showLivePositions=!0,e.showTerritories=!0,e.showOnMap=!1,e.showTooManyReportsAlert=!1,e.resourcesFilterList=[],e.filterResourceInputValue="",e.filteredResources={},e.selectedReport="null",e.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},resource:{pixelOffset:new google.maps.Size(0,-38)},report:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)}},e.serviceInfoWindow={show:!1,control:{}},e.resourceInfoWindow={show:!1,control:{}},e.territoryInfoWindow={show:!1,control:{}},e.reportInfoWindow={show:!1,control:{}
},e.livePosInfoWindow={show:!1,control:{}},e.filteredServices=r.filteredServices,e.filter=r.filter,e.currentShowOnMapServiceId=null,e.drawingStates=b,e.drawState=b.NONE,e.selectedShape=null,e.selectedShapeColor=e.selectedColor,e.drawingManager,e.setSelectedShapeColor=W,e.polygons={},e.polygonName="",e.polygonTerritory="null",e.territories={},e.selectedIntersectingPolygons={},e.shouldBound=!0,e.cancelDrawingShape=!1,e.InvisiblePolygons=N(),e.hasCustomPermission=l.hasCustomPermission,e.getServiceInfoRowClass=l.getServiceInfoRowClass,e.pinnedStatusesSF=CustomSettings.pinnedStatusesSF,l.getReports().then(function(t){if(t)for(var n=0;n<t.length;n++)e.reports[t[n].Id]=t[n]}),p.getLastKnownPositions(),e.redrawAllMarkers=y,e.$watch("workingState",function(t){"map"==t?(e.map=e.mapControl.getGMap(),o(function(){if(L(),y(),google.maps.event.trigger(e.mapControl.getGMap(),"resize"),e.firstMapShow){e.showOnMap||F();var t=e.map.getStreetView(),n={fullscreenControl:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER}};t.setOptions(n);var s={fillOpacity:.5,strokeWeight:1,editable:!0,draggable:!0,fillColor:e.selectedColor};e.drawingManager=new google.maps.drawing.DrawingManager({drawingMode:null,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER,drawingModes:["polygon"]},polygonOptions:s,rectangleOptions:s}),e.drawingManager.setMap(e.map),j(),U(),google.maps.event.addListener(e.map,"click",function(){e.map.setOptions({draggableCursor:"grab"}),le.hide()}),le=new ne(e.map,oe),e.firstMapShow=!1,e.showOnMap=!1}},0)):e.currentShowOnMapServiceId=null}),e.$on("resizeMap",function(t,n){google.maps.event.trigger(e.mapControl.getGMap(),"resize")}),e.$on("showServiceOnMap",function(t,s){e.currentShowOnMapServiceId=s,n.$broadcast("changeWorkingState","map"),e.map=e.mapControl.getGMap(),e.showOnMap=!0,o(function(){google.maps.event.trigger(e.mapControl.getGMap(),"resize");var t=v.serviceAppointments()[s],n=new google.maps.LatLng(t.latitude,t.longitude);e.map.setCenter(n),e.map.setZoom(20),o(function(){e.markersControl.getPlurals().get(s).gObject.setAnimation(google.maps.Animation.BOUNCE),o(function(){var t=e.markersControl.getPlurals().get(s);t&&t.gObject.setAnimation(null)},3500)},100)},0)}),h.fieldsSetFields().then(function(t){e.serviceFields=t.MapInfo}),e.isEmpty=function(e){return e?_.isEmpty(e):!0},e.markerCloseClicked=function(){e.serviceInfoWindow.show=!1,e.resourceInfoWindow.show=!1,e.territoryInfoWindow.show=!1,e.reportInfoWindow.show=!1,e.livePosInfoWindow.show=!1,e.$apply()},e.openLink=function(t,n){return"Resource__r"==n.APIName?void e.openLightbox(t.resourceId,"resource"):void l.openLink(t,n)},e.openReportLink=function(t){if(t.isReference){if("ServiceResource"==t.APIName)return void e.openLightbox(t.Value,"resource");if("ServiceAppointment"==t.APIName)return void e.openLightbox(t.Value,"service");var n=l.openConsoleTab(null,t.Value);n||window.open("../"+t.Value,"_blank")}},e.markerClicked=function(e,t,n){T(n)},e.openLightbox=function(t,n,s){var i=null;switch(s&&(i=l.generateResourceId(t,s)),n){case"service":r.recentlyUsed[t]=!0,u.open(t);break;case"resource":d.open(t,i);break;case"homeBase":e.$emit("showResourceLightbox",e.resources[t])}},e.$watch("filter",function(t,n){"map"===e.workingState&&y()},!0),e.clearResource=function(t){delete e.filteredResources[t],y()},e.clearAllResources=function(){e.filteredResources={},y()},e.addResourceToFilterList=function(){var t=g.getResources();""!=e.filterResourceInputValue&&t[e.filterResourceInputValue.value]&&(e.filteredResources[e.filterResourceInputValue.value]=t[e.filterResourceInputValue.value],e.filterResourceInputValue="",y())},e.toggleReportMarkers=function(t){var n=e.reportsData[t];n.show=!n.show,y()},e.removeReportFromMap=function(t){delete e.reportsData[t],y()},e.removeAllReportsFromMap=function(){e.reportsData={},y()},e.showReportOnMap=function(){"null"!=e.selectedReport&&t.getReportRowsForMap(e.selectedReport).then(function(t){e.reportsData[e.selectedReport]={show:!0,data:t,displayCount:0};var n=!0;y(n)})},m.register("positions",function(e){y()}),e.isPinnedStatus=function(){if(e.currentMarker){for(var t=e.pinnedStatusesSF.split(","),n=0;n<t.length;n++)if(e.currentMarker.item.status===t[n])return!0;return!1}},e.needToShowDispatchButton=function(){return e.currentMarker&&"service"==e.currentMarker.type&&e.currentMarker.item.statusCategory!=S.DISPATCHED&&e.currentMarker.item.statusCategory==S.SCHEDULED},e.isServiceCurrentlyDispatching=function(){return e.currentMarker&&"dispatched"==e.invokedActions[e.currentMarker.id]},e.changeStatusToDispatch=function(t){return e.invokedActions[t]?void alert(customLabels.another_operation_running):(e.invokedActions[e.currentMarker.id]="dispatched",void r.changeStatus([t],f.DISPATCHED).then(function(t){t.services.length>0&&(e.currentMarker.item=t.services[0])})["finally"](function(){delete e.invokedActions[e.currentMarker.id]}))},e.isServiceCurrentlyScheduling=function(){return e.currentMarker&&"schedule"==e.invokedActions[e.currentMarker.id]},e.autoScheduleService=function(t){var t=e.currentMarker.id;return e.invokedActions[t]?void alert(customLabels.another_operation_running):(r.recentlyUsed[t]=!0,e.invokedActions[t]="schedule",void r.autoScheduleService(t).then(function(n){r.drawServicesAndAbsences(n.services,n.absences),delete e.invokedActions[t]}))},e.myTreeView={},e.lastSelectedLeafId=null,s.all([l.getPolygons(),g.promises.territories()]).then(function(t){G(t[0]);for(var n in g.territories)-1!=l.getFilteredLocations().indexOf(n)&&(e.territories[n]=g.territories[n]);E(),V().then(function(t){e.locationsTree=t,e.myTreeView=new dhtmlXTreeView({parent:"polygonsByTerritoriesTree",iconset:"font_awesome",checkboxes:!0,items:e.locationsTree}),e.myTreeView.attachEvent("onSelect",function(t,n){return e.drawState!=b.NONE&&e.drawState!=b.SELECTED?!1:(e.lastSelectedLeafId||(e.lastSelectedLeafId=t),!e.polygons[t]||void 0==e.lastSelectedLeafId||e.lastSelectedLeafId==t&&void 0==e.polygons[t]?void z():(n&&(q(e.polygons[t].polygon),e.shouldBound&&e.selectedShape.getVisible()&&e.map.fitBounds(e.selectedShape.bounds),e.shouldBound=!0),void(e.lastSelectedLeafId=e.polygons[t].Id)))}),e.myTreeView.attachEvent("onCheck",O)})}),e.toggleDrawMode=function(){e.drawState!=b.INTERSECT&&(e.drawingManager.setDrawingMode("polygon"),z(),X(e.selectedColor),e.drawState=b.DRAW)},e.cancelPolygon=function(){null!=e.drawingManager.getDrawingMode()&&(e.cancelDrawingShape=!0,e.drawingManager.setDrawingMode(null)),e.drawState==b.EDIT&&Z(),e.drawState=b.NONE,e.selectedIntersectingPolygons={}},e.editPolygon=function(){e.drawState==b.SELECTED&&e.selectedShape.getVisible()&&(e.currentEditPolygon=e.polygons[e.selectedShape.id],e.drawState=b.EDIT,e.selectedShape.setEditable(!0),e.selectedShape.setDraggable(!0))},e.savePolygon=function(){if(!e.selectedShape)return void(e.drawState=b.NONE);var n=[];e.selectedShape.getPath().forEach(function(e,t){n.push({lat:e.lat(),lng:e.lng()})});var s=e.selectedShape.id||null,i="null"!=e.polygonTerritory?e.polygonTerritory:null;return e.polygonName?(t.savePolygon(ee(n,e.selectedShapeColor,e.polygonName),e.selectedShapeColor,e.polygonName,i,s).then(function(t){e.selectedShape.setMap(null),te(t),J(t,s),e.selectedShape=e.polygons[t.Id].polygon}),void(e.drawState=b.NONE)):void alert(customLabels.Polygon_name_field_is_empty)},e.deletePolygon=function(){if(!e.selectedShape)return void(e.drawState=b.NONE);if(confirm(customLabels.This_will_delete_the_selected_polygon.replaceAll(e.selectedShape.name))){var n=e.selectedShape.id||null;t.deletePolygon(n).then(function(t){e.selectedShape.setMap(null),e.myTreeView.deleteItem(n),z()}),e.drawState=b.NONE}};var oe={},ce=[],le=void 0;ne.prototype=new google.maps.OverlayView,ne.prototype.onAdd=function(){$("<div id='cMenu' class='context-menu-polygon'></div>").appendTo($("#map"));for(var e=$("#cMenu").get(0),t=0;t<this.menuItems.length;t++){var n=this.menuItems[t];$('<div id="'+n.id+'" class="truncate context-menu-polygon-item" title="'+n.name+'">'+n.label+"</div>").appendTo(e)}this.div_=e;var s=this.getPanes();s.overlayMouseTarget.appendChild(this.div_);for(var i=this,t=0;t<this.menuItems.length;t++){var n=this.menuItems[t],r=function(){i.clickedItem=this.id,google.maps.event.trigger(i,"click")};google.maps.event.addDomListener($("#"+n.id).get(0),"click",$.proxy(r,n))}google.maps.event.addListener(i,"click",function(){ie(i.clickedItem),event.stopPropagation(),le.hide()})},ne.prototype.draw=function(){var e=this.div_;e.style.left="0px",e.style.top="0px",e.style.width="140px"},ne.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_),this.div_=null},ne.prototype.hide=function(){this.div_&&(this.div_.style.visibility="hidden")},ne.prototype.show=function(e){if(this.div_){var t=this.div_;t.style.left=e.x+10+"px",t.style.top=e.y+15+"px",this.div_.style.visibility="visible"}},e.hasCustomPermission("Polygons_create_update")&&ce.push({id:"menu-intersect-polygon",className:"context_menu_item",eventName:"intersect",label:l.getSVGIconHTML(lsdIcons.cut)+customLabels.Cut_Intersections,name:customLabels.Cut_Intersections}),e.hasCustomPermission("Bulk_Schedule")&&ce.push({id:"menu-schedule-polygon",className:"context_menu_item",eventName:"schedule",label:l.getSVGIconHTML(lsdIcons.calendar)+customLabels.Schedule,name:customLabels.Schedule}),ce.push({id:"menu-unschedule-polygon",className:"context_menu_item",eventName:"unschedule",label:l.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,name:customLabels.Unschedule}),e.hasCustomPermission("Bulk_Dispatch")&&ce.push({id:"menu-dispatch-polygon",className:"context_menu_item",eventName:"dispatch",label:l.getSVGIconHTML(lsdIcons.dispatch)+customLabels.Dispatch,name:customLabels.Dispatch}),ce.push({id:"menu-joepardy-polygon",className:"context_menu_item",eventName:"joepardy",label:l.getSVGIconHTML(lsdIcons.jeopardy)+customLabels.In_Jeopardy,name:customLabels.In_Jeopardy}),e.hasCustomPermission("Polygons_create_update")&&ce.push({id:"menu-delete-polygon",className:"context_menu_item",eventName:"delete",label:l.getSVGIconHTML(lsdIcons["delete"])+customLabels.Delete_polygon,name:customLabels.Delete_polygon}),oe.menuItems=ce,e.getIntersectionsForPolygons=function(){if(!e.isEmpty(e.selectedIntersectingPolygons))try{var t=new jsts.io.WKTReader,n=t.read(e.selectedShape.ToWKT());for(var s in e.selectedIntersectingPolygons){var i=t.read(e.polygons[s].polygon.ToWKT());n=n.difference(i)}var r=new jsts.io.WKTWriter,a=r.write(n);ae(a)}catch(o){alert("Problem finding intersections in given polygons."),console.error(o)}}}])}(),function(){angular.module("serviceExpert").controller("ctrlRightSide",["$q","$scope","$rootScope","$filter","$sce","sfdcService","utils","servicesService","kpiCalculationsService","StateService","DeltaService","TimePhasedDataService",function(e,t,n,s,i,r,a,o,c,l,u,d){function v(){var e=moment(scheduler._min_date).format("M/D/YYYY"),t=new Date(scheduler._max_date);t=moment(t.setDate(scheduler._max_date.getDate()+1)).format("M/D/YYYY");for(var n=scheduler.serverList("resources"),s="",i=0;i<n.length;i++)s+=i+1<n.length?n[i].key.substr(0,15)+",":n[i].key.substr(0,15);return{locations:s,start:e,end:t}}function h(e){"Failed"!==e.status&&"Completed"!==e.status&&"Global Optimization"!==e.type&&e.start&&e.finish&&(e.timespan=g(e))}function g(e){if(!e.resource)return(new Date).getTime();var t=void 0,n=d.getResoruceGanttIdByDate(e.resource,e.start),s="reshufle-on-gantt";if(!n)return(new Date).getTime();switch(t=n.split(","),e.type){case"Fix Overlaps":s="fix-overlaps-on-gantt";break;case"SA Reshuffle":s="reshufle-on-gantt";break;case"Fill-In Schedule":s="fillin-on-gantt";break;case"Group Nearby SAs":s="group-near-on-gantt";break;default:s="reshufle-on-gantt"}return scheduler.addMarkedTimespan({start_date:e.start,end_date:e.finish,sections:{ZoomLevel2:t,ZoomLevel3:t,ZoomLevel4:t,ZoomLevel5:t,ZoomLevel6:t},css:"smart-on-gantt "+s,html:"<div><span>"+e.type+"</span></div>"})}t.isMapEnabled=l.isMapEnabled(),t.servicesObjects=o.servicesObjects,t.flaggedServices=o.flagged,t.servicesScheduledToCapacity={},t.notifications=a.butlerNotifications,t.unreadNotifications=0,t.showServiceList=a.showServiceList,t.optRunning=!1,t.optQueued=!1,t.optimizationRequests={},t.workingState="gantt",t.openConsoleTab=a.openConsoleTab,t.openSObjectLink=a.openSObjectLink,t.activeRequests=r.activeRequests,t.kpi=c.kpis,t.optimizationRequsts={},t.$watch("workingState",function(e){"gantt"==e&&setTimeout(function(){scheduler._is_initialized()&&scheduler.updateView()},0)}),r.getServiceMapInfoWindowFields().then(function(e){t.serviceFields=e}),t.getServiceInfoRowClass=a.getServiceInfoRowClass,t.openLink=a.openLink,t.order=function(e,n){t.orderByField=e,t.reverse=n},t.$on("changeWorkingState",function(e,n){t.workingState=n,"gantt"==n?setTimeout(function(){scheduler.updateView()},100):$(".dhtmlXTooltip").remove()}),t.showNotifications=function(e){t.unreadNotifications=0;for(var n=0;n<a.butlerNotifications.length;n++)a.butlerNotifications[n].unread=!1},t.calcUnreadNotifications=function(){t.unreadNotifications=0;for(var e=0;e<a.butlerNotifications.length;e++)a.butlerNotifications[e].unread&&t.unreadNotifications++;return t.unreadNotifications},t.changeResourceLightboxTab=function(e){e!=t.selectedResourceLightboxTab&&(t.selectedResourceLightboxTab=e)},t.closeContractorCapacityLightbox=function(){t.lightboxContractorCapacity=null,$("#ContractorCapacityLightbox").attr("style","")},t.$on("keypress",function(e,n){27==n.which&&l.areContractorsSupported()&&t.closeContractorCapacityLightbox()}),t.formatTravel=function(e){var t=Math.floor(e/60/60),n=Math.floor(e/60%60);return t+customLabels.kpi_h+" "+n+customLabels.kpi_m},t.toggleServiceList=function(){t.showServiceList.show=!0,setTimeout(function(){scheduler.updateView(),n.$broadcast("resizeMap",{})},830)},t.openReport=function(e){var t=v(),n="../"+sfdcReports[e]+"?pv0="+t.start+"&pv1="+t.end+"&pv2="+t.locations;a.openConsoleTab(n)||window.open(n)},t.getObjectKeys=function(e){return Object.keys(e).length>0?Object.keys(e):0},t.isEmpty=function(e){return Object.keys(e).length},e.all([d.promises.initialPhasedData,r.getOptimizationRequests()]).then(function(e){e[1].forEach(function(e){t.optimizationRequsts[e.Id]=new OptimizationRequest(e),h(t.optimizationRequsts[e.Id])})}),t.getRequestCss=function(e){switch(e){case"In Progress":return"smart_in_progress";case"Completed":return"smart_completed";case"Failed":return"smart_failed";case"Open":return"smart_open";case"Queued":return"smart_queued"}},u.register("optimizationRequests",function(e){e.forEach(function(e){var n=new OptimizationRequest(e);t.optimizationRequsts[e.Id]&&t.optimizationRequsts[e.Id].timespan&&scheduler.deleteMarkedTimespan(t.optimizationRequsts[e.Id].timespan),t.optimizationRequsts[e.Id]=n,h(n)}),scheduler.updateView()}),t.getNumOfRunningRequests=function(){var e=0;for(var n in t.optimizationRequsts)"Completed"!=t.optimizationRequsts[n].status&&"Failed"!=t.optimizationRequsts[n].status&&e++;return e},t.marginLeftForBox=0,t.openSomethingBox=function(e,n){"smart"===n?t.marginLeftForBox=e.target.offsetLeft-227:t.marginLeftForBox=e.target.offsetLeft-200}}])}(),function(){angular.module("serviceExpert").controller("serviceListCtrl",["$scope","$compile","$rootScope","$filter","utils","$timeout","$sce","servicesService","sfdcService","ResourcesAndTerritoriesService","GetSlotsService","userSettingsManager","StateService","TimePhasedDataService","LoadServiceListService","FieldSetFieldsService","ServiceAppointmentLightboxService","ServiceSelectorService","LocationFilteringService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService",function(e,t,n,s,i,r,a,o,c,l,u,d,v,h,g,p,m,f,S,b,y,_){function T(e,t){for(var n=0;n<t.length;n++)if(t[n].name==e)return t[n].filter;return!1}function L(){var e=d.GetUserSettingsProperty("Filters__c");return void 0==e?[]:JSON.parse(d.GetUserSettingsProperty("Filters__c"))}function w(){return d.SetUserSettingsProperty("Filters__c",JSON.stringify(e.storageFilters))}function k(){e.storageFilters=L();for(var t=0;t<e.storageFilters.length;t++)e.filterOptions.push({name:e.storageFilters[t].name,value:e.storageFilters[t].name});C(e.storageFilters.length>0?e.storageFilters[0].name:null)}function C(t){if(e.lastSelectedFilter=t,t){for(var n=0;n<e.storageFilters.length;n++)e.storageFilters[n].name==t&&(e.filter.advancedFilter=angular.copy(e.storageFilters[n].filter));e.customFilterName=t,e.DisplayComboBowArrow=!0,e.IsCustomFilterReadonly=!0,e.displayNew=!0,e.displayEdit=!0,e.displayDelete=!0}else e.filter.advancedFilter=R(),e.customFilterName="",e.DisplayComboBowArrow=!1,e.IsCustomFilterReadonly=!0,e.displayNew=!0,e.displayEdit=!1,e.displayDelete=!1}function R(){var t={statusCheckboxs:{},minDate:new Date,maxDate:new Date,servicePriority:10,unScheduled:!0,violations:!0,jeopardies:!0,noLocation:!0,locationsCheckboxs:{}};if(Object.keys(e.statusTranslations).length>0)for(var s in e.statusTranslations)t.statusCheckboxs[e.statusTranslations[s]]=!0;else n.$on("gotStatuses",function(){for(var n in e.statusTranslations)t.statusCheckboxs[e.statusTranslations[n]]=!0});for(var i=0;i<e.territories.length;i++){var r=e.territories[i];t.locationsCheckboxs[r.name]=!0}return t}function D(t){for(var n=0;n<e.filterOptions.length;n++)e.filterOptions[n].name==t&&e.filterOptions.splice(n,1)}angular.element(document).ready(function(){function e(){if(0!=s.width()&&!i){i=!0,null!=t&&t>0&&100>t&&(n=s.width()*t*.01),400>n&&(n=400);var r=n+3;$("#RightSideContainer").width("calc(100% - "+r+"px)"),Split(["#LeftSideContainer","#RightSideContainer"],{sizes:[n+"px"],minSize:[400,700],snapOffset:10,gutterSize:3,onDragEnd:function(){scheduler.updateView();var e=$("#LeftSideContainer").width()/s.width();e*=100,d.SetUserSettingsProperty("Left_Panel_Width_Percentage__c",e)}}),$(window).unbind("resize",e)}}var t=d.GetUserSettingsProperty("Left_Panel_Width_Percentage__c"),n=400,s=$("#contentWrapper"),i=!1;0==s.length&&(s=$(window)),e(),$(window).bind("resize",e)}),e.fieldsTypes=i.fieldsTypes,e.openConsoleTab=i.openConsoleTab,e.woPriorities=i.woPriorities,e.isMapEnabled=v.isMapEnabled(),e.contractorSupport=v.areContractorsSupported(),e.statuses=b,e.statusTranslations=i.statusTranslations,e.pinnedStatusesSF=CustomSettings.pinnedStatusesSF,e.ganttSettings=i.ganttSettings,e.showServiceList=i.showServiceList,e.trust=i.trust,e.hasCustomPermission=i.hasCustomPermission,e.isLightning=i.isLightning,e.isOptimizationEnabled=isOptimizationEnabled,e.bulkActionsOrder=bulkActionsOrder,e.isInConsole=v.isInConsole,e.matchGantt=!1,e.fullScreen=!1,window.location.search.match(/[&?]fullScreen=(\d)/)&&(e.fullScreen="1"===window.location.search.match(/[&?]fullScreen=(\d)/)[1]?"0":"1"),e.servicesObjects=h.serviceAppointments,e.selectedServiceId=null,e.lastSelectedServiceId=null,e.servicesListVisitedDays={},e.servicesListInited=!1,e.servicesListFields=[],e.flagged=o.flagged,e.loadedTerritories=[],e.selectorService=f,e.servicesSelection=e.selectorService.SelectedServices,e.selectedPolicy=null,e.policyOptions=[],e.showGanttSettings=!1,e.ganttSettingDraft=null,e.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],e.reallyHideList=!1,e.showAdvancedFilter=!1,e.invokedAction={},e.invokedActionFor={},e.showCustomFilterDropdown=!1,e.storageFilters=null,e.prevEndDate=null,e.sortingColumn="start",e.sortingColumnName={start:customLabels.Start_time,finish:customLabels.Finish_time,accountName:customLabels.Account,serviceTypeName:customLabels.Service_type,priority:customLabels.Priority,resourceName:customLabels.Resource,earlyStart:customLabels.Early_start,dueDate:customLabels.Due_date,locationName:customLabels.Location},e.selectedDates={earlyStart:customLabels.Early_start,dueDate:customLabels.Due_date,appStart:customLabels.Appointment_start,appEnd:customLabels.Appointment_finish,start_date:customLabels.Start,end_date:customLabels.Finish},e.actionNames={Schedule:{name:customLabels.Schedule,icon:lsdIcons.calendar},"Change Status":{name:customLabels.Change_status,icon:lsdIcons.replace},"Create Service":{name:customLabels.Create_Service,icon:lsdIcons.page},Optimize:{name:customLabels.Optimize,icon:lsdIcons.magicwand},"Flag-Unflag":{name:customLabels.Flag_Unflag,icon:lsdIcons.flag},Unschedule:{name:customLabels.Unschedule,icon:lsdIcons.na},Delete:{name:customLabels.Delete,icon:lsdIcons["delete"]}},e.filter=o.filter,e.orderByField=o.filter.orderByField,e.reverse=o.filter.reverse,e.filteredServices=o.filteredServices,e.filterOptions=[],i.hasCustomPermission("Service_List_Todo")&&e.filterOptions.push({name:customLabels.Todo,value:"Todo"}),e.filterOptions.push({name:customLabels.AllServices,value:"All"}),e.filterOptions.push({name:customLabels.Recently_used,value:"Recent"}),i.hasCustomPermission("Service_List_Flagged")&&e.filterOptions.push({name:customLabels.Flagged,value:"Flagged"}),i.hasCustomPermission("Service_List_Selected")&&e.filterOptions.push({name:customLabels.Selected_Capital,value:"Selected"}),i.hasCustomPermission("Service_List_Unscheduled")&&e.filterOptions.push({name:customLabels.UnscheduledCapital,value:"Unscheduled"}),i.hasCustomPermission("Service_List_Scheuled")&&e.filterOptions.push({name:customLabels.Scheduled,value:"Scheduled"}),i.hasCustomPermission("Service_List_In_Jeopardy")&&e.filterOptions.push({name:customLabels.In_Jeopardy,value:"inJeopardy"}),i.hasCustomPermission("Service_List_Rule_Violating")&&e.filterOptions.push({name:customLabels.Rules_violating,value:"Violating"}),i.hasCustomPermission("Service_List_Gantt")&&e.filterOptions.push({name:customLabels.Gantt,value:"Gantt filter"}),i.hasCustomPermission("Service_List_Canceled")&&e.filterOptions.push({name:customLabels.Cancelled,value:"Cancelled filter"}),v.areContractorsSupported()&&i.hasCustomPermission("Service_List_Contractors")&&e.filterOptions.push({name:customLabels.Contractors,value:"Contractors filter"}),p.fieldsSetFields().then(function(t){e.servicesListFields=t.ListColumns,e.clickedServiceFieldPairs=[];for(var n=0;n<t.ListExpanded.length;){for(var s=n+2,i=[];n<t.ListExpanded.length&&s>n;n++)i.push(t.ListExpanded[n]);e.clickedServiceFieldPairs.push(i)}}),e.isPinnedStatus=function(t){for(var n=e.pinnedStatusesSF.split(","),s=0;s<n.length;s++)if(t===n[s])return!0;return!1},e.getSingleTaskColumnClass=function(e){var t={SingleTaskColumn:!0,truncate:!0};return t["Field-"+e.Type]=!0,t},e.getHeaderTaskColumnClass=function(e){var t={SortingTasksListColumn:!0};return t["Field-"+e.Type]=!0,t},e.loadServiceAppointmentsToList=function(){var t=(new Date(e.endDate),new Date(e.endDate.getTime()-24*i.ganttSettings.backHorizon*60*60*1e3),g.getBackHorizonToFetch(e.servicesListVisitedDays,e.endDate,i.ganttSettings.backHorizon));t.horizon<=0||g.loadServiceAppointmentsToList(e.servicesObjects(),e.servicesListVisitedDays,e.endDate,i.ganttSettings.backHorizon).then(function(t){if(t.remainingCount>0)i.addNotification(customLabels.Too_Many_Services_Header_Services_List,customLabels.Too_Many_Services_Services_List);else for(;t.newStart<=t.horizon.date;)e.servicesListVisitedDays[t.newStart]=!0,t.newStart=i.addDaysToDate(t.newStart,1);for(var n=[],s=0;s<t.scheduledServices.length;s++)n.push(t.scheduledServices[s].id);o.checkRules(n).then(function(e){scheduler.updateView()})})["catch"](function(e){console.warn("loadServiceAppointmentsToList failed "+e)})},e.formatServiceField=function(e,t){var n=e[t.APIName];switch(t.Type){case i.fieldsTypes.DateTime:n=s("amDateFormat")(n,"lll");break;case i.fieldsTypes.Date:n=s("amDateFormat")(n,"L")}return n},e.getRefFieldID=function(e,t){var n=t.JsAPIName.replace("__r","__c");return e[n]},e.isFieldEmpty=function(e,t){return"undefined"==typeof s("displayFieldSetField")(e,t)},e.openCalendarAdvanceFilterStart=function(){e.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMin",date:new Date(e.filter.endDate),navigation:!0,handler:function(t,n){i.safeApply(e,function(){t>new Date(e.filter.advancedFilter.maxDate)?alert(customLabels.startBeforeEnd):e.filter.advancedFilter.minDate=t}),scheduler.destroyCalendar()}}))},e.openCalendarAdvanceFilterFinish=function(){e.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMax",date:new Date(e.endDate),navigation:!0,handler:function(t,n){i.safeApply(e,function(){t<new Date(e.filter.advancedFilter.minDate)?alert(customLabels.startBeforeEnd):e.filter.advancedFilter.maxDate=t}),scheduler.destroyCalendar()}}))},e.openCalendarAdvanceFilterStart=function(){e.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMin",date:new Date(e.filter.endDate),navigation:!0,handler:function(t,n){i.safeApply(e,function(){t>new Date(e.filter.advancedFilter.maxDate)?alert(customLabels.startBeforeEnd):e.filter.advancedFilter.minDate=t}),scheduler.destroyCalendar()}}))},v.promises.policies().then(function(t){e.policyOptions=t;for(var n=!1,s=d.GetUserSettingsProperty("Gantt_Policy__c"),i=0;i<t.length;i++)if(s){if(t[i].Id===s){e.selectedPolicy=t[i],n=!0;break}}else if(t[i].Id===defaultPolicy){e.selectedPolicy=t[i],n=!0;break}n||(e.selectedPolicy=e.policyOptions[0]),v.selectedPolicyId=e.selectedPolicy.Id})["catch"](function(e){console.warn(e),cantLoadGantt(customLabels.no_policy_found)}),e.changePolicy=function(){v.selectedPolicyId=e.selectedPolicy.Id,d.SetUserSettingsProperty("Gantt_Policy__c",e.selectedPolicy.Id);var t=[];for(var n in scheduler._events)"service"===scheduler._events[n].type&&t.push(n);t.length>0&&o.checkRules(t).then(function(){return scheduler.updateView()})},e.order=function(t,n){e.filter.orderByField=t,e.filter.reverse=n},e.selectService=function(t){t==e.selectedServiceId?(e.selectedServiceId=null,e.lastSelectedServiceId=t):(e.lastSelectedServiceId=e.selectedServiceId,e.selectedServiceId=t)},e.violationsTooltip=function(e){if(e.isMDT&&!e.violations&&!e.jeopardy)return customLabels.Multi_Day_Service;if(e.violations||e.jeopardy){if(e.jeopardy&&e.jeopardyReason)return e.jeopardyReason;if(e.violations){for(var t="",n=0;n<e.violations.length;n++)t+=e.violations[n].RuleName+"\n";return t&&(t=t.substring(0,t.length-1)),t}}},e.getStatusClass=function(e){return i.getCSSClassForContext(e.statusCategory,y)},e.$on("initCompleted",function(t){e.initEndDate();var n=d.GetUserSettingsProperty("locations");e.territories=[];for(var s=0;s<n.length;s++)void 0!==l.territories[n[s]]&&e.territories.push(l.territories[n[s]]);k()}),e.initEndDate=function(){e.endDate=e.getSchedulerMaxDate(),e.endDate=i.addDaysToDate(e.endDate,1),e.prevEndDate=e.endDate,e.filter.endDate=e.endDate},e.$on("ganttFinishedLoadingServices",function(){(e.matchGantt||e.servicesListInited===!1)&&(e.servicesListInited||(null===e.endDate||isNaN(e.endDate.getTime()))&&e.initEndDate(),e.servicesListInited=!0,e.loadServiceAppointmentsToList())}),e.getSchedulerMaxDate=function(){var e=scheduler.getState().max_date;return 0===e.getHours()&&0===e.getMinutes()?e=new Date(e.getTime()-6e4):(e.setHours(23),e.setMinutes(59),e.setSeconds(0)),e},scheduler.attachEvent("onViewChange",function(t,n){v.isLoadingNewLocations||i.safeApply(e,function(){if(e.matchGantt){var t=e.getSchedulerMaxDate();e.filter.endDate=t,e.endDate=t,e.loadServiceAppointmentsToList()}})}),e.matchGanttClicked=function(){e.matchGantt?(e.prevEndDate=e.endDate,e.filter.endDate=e.getSchedulerMaxDate(),e.endDate=e.filter.endDate):(e.filter.endDate=e.prevEndDate,e.endDate=e.prevEndDate),e.loadServiceAppointmentsToList()},e.openLightBox=function(e){o.recentlyUsed[e]=!0,m.open(e)},e.flagging=function(e){return o.flagged[e]?void(o.flagged[e]&&(o.flagged[e]=!o.flagged[e],scheduler.updateEvent(e))):(o.flagged[e]=!0,void scheduler.updateEvent(e))},e.showOnGantt=function(e){o.recentlyUsed[e.id]=!0,scheduler._events[e.id]?"none"==$("#GanttMapContainer").css("display")?(n.$broadcast("changeWorkingState","gantt"),r(function(){scheduler.updateView()},20),r(function(){i.showOnGantt(e.id)},120)):i.showOnGantt(e.id):alert(customLabels.location_not_loaded)},e.changeStatusToDispatch=function(t){if(e.invokedActionFor[t]||v.schedulingRunningFor[t])return void alert(customLabels.another_operation_running);o.recentlyUsed[t]=!0,e.invokedAction[t]="dispatch",e.invokedActionFor[t]=!0;var n=[t];o.changeStatus(n,b.DISPATCHED).then(function(e){o.drawServicesAndAbsences(e.services)})},e.showOnMap=function(e){n.$broadcast("showServiceOnMap",e)},e.openDateEndCalendar=function(){e.matchGantt||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"DateStart",date:new Date(e.filter.endDate),navigation:!0,handler:function(t,n){i.safeApply(e,function(){e.endDate=t,e.endDate.setHours(23),e.endDate.setMinutes(59),e.endDate.setSeconds(0),e.filter.endDate=e.endDate,e.loadServiceAppointmentsToList()}),scheduler.destroyCalendar()}}))},e.openFullScreen=function(){var e=window.location.search.match(/[&?]fullScreen=(\d)/),t=0;if(e){var n="1"===e[1]?"0":"1";window.location.search=window.location.search.replace(/[&?]fullScreen=\d/,"&fullScreen="+n)}else window.location.search+="&fullScreen=1",t=1},e.getSlots=function(t){return o.recentlyUsed[t]=!0,"none"==$("#GanttMapContainer").css("display")&&(n.$broadcast("changeWorkingState","gantt"),setTimeout(function(){scheduler.updateView()},20)),e.invokedActionFor[t]||v.schedulingRunningFor[t]?void alert(customLabels.another_operation_running):void u.get(t)},e.scheduleAndReshuffle=function(t){return e.invokedActionFor[t]?void alert(customLabels.another_operation_running):(o.recentlyUsed[t]=!0,e.invokedAction[t]="reshuffle",e.invokedActionFor[t]=!0,void c.runReshuffle(t,v.selectedPolicyId).then(function(n){_.updateOptimizationRequest(n);var s=function i(s){s.forEach(function(s){var r=new OptimizationRequest(s);r.id!=n.Id||"Completed"!=r.status&&"Failed"!=r.status||(e.invokedAction[t]=null,e.invokedActionFor[t]=!1,_.unRegister("optimizationRequests",i))})};_.register("optimizationRequests",s)},function(){i.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message),e.invokedAction[t]=null,e.invokedActionFor[t]=!1}))},e.groupNearby=function(t){return e.invokedActionFor[t]?void alert(customLabels.another_operation_running):(o.recentlyUsed[t]=!0,e.invokedAction[t]="groupNearby",e.invokedActionFor[t]=!0,void c.runGroupNearby(t,v.selectedPolicyId).then(function(n){_.updateOptimizationRequest(n);var s=function i(s){s.forEach(function(s){var r=new OptimizationRequest(s);r.id!=n.Id||"Completed"!=r.status&&"Failed"!=r.status||(e.invokedAction[t]=null,e.invokedActionFor[t]=!1,_.unRegister("optimizationRequests",i))})};_.register("optimizationRequests",s)},function(){i.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message),e.invokedAction[t]=null,e.invokedActionFor[t]=!1}))},e.autoScheduleService=function(t){return e.invokedActionFor[t]||v.schedulingRunningFor[t]?void alert(customLabels.another_operation_running):(o.recentlyUsed[t]=!0,e.invokedAction[t]="schedule",e.invokedActionFor[t]=!0,void o.autoScheduleService(t).then(function(n){0===n.services.length&&alert(customLabels.NoCandidates),o.drawServicesAndAbsences(n.services,n.absences),e.invokedActionFor[t]=!1,e.invokedAction[t]=null})["catch"](function(n){i.addNotification(customLabels.Action_Could_Not_Be_Performed,n.message),e.invokedAction[t]=null,e.invokedActionFor[t]=!1}))},e.$on("autoScheduleServiceFinished",function(t,n){e.invokedAction[n]=null,e.invokedActionFor[n]=!1}),e.openBulkAction=function(e){return"Create Service"==e?void n.$broadcast("openCreateServiceLightbox",e):void n.$broadcast("openBulkActions",e)},e.openGanttSettings=function(){e.showGanttSettings=!0,i.ganttSettings?e.ganttSettings=i.ganttSettings:(e.ganttSettings.filterCandidates=!0,e.ganttSettings.servicesPerPage=200,e.ganttSettings.backHorizon=14,e.ganttSettings.capacityDuration="Day"),e.ganttSettingDraft=angular.copy(e.ganttSettings)},e.closeSettingsLightbox=function(){
e.showGanttSettings=!1,$("#ganttSettingsLightbox").attr("style",""),e.ganttSettingDraft=angular.copy(e.ganttSettings)},e.parseGanttSettingsToUserSetting=function(e){var t={};return t.Gantt_View_Start_Hour__c=e.startHour,t.Gantt_View_Finish_Hour__c=e.finishHour,t.Filter_Candidates__c=e.filterCandidates,t.Services_Per_Page__c=e.servicesPerPage,t.Resource_Row_Height__c=e.resourceRowHeight,t.Scheduling_horizon_limit__c=e.backHorizon,t.View_Capacity_Type__c=e.capacityDuration,t},e.saveGanttSettings=function(){return"undefined"==typeof e.ganttSettingDraft.backHorizon?void alert(customLabels.backHorizonInvalid):(schedulerConfig.setRowHeights(e.ganttSettingDraft.resourceRowHeight,!0),setCapacityFilter(e.ganttSettingDraft.capacityDuration,!0),e.ganttSettings=angular.copy(e.ganttSettingDraft),i.ganttSettings=angular.copy(e.ganttSettingDraft),e.filter.servicesPerPage=parseInt(e.ganttSettings.servicesPerPage),d.SetUserSettingProperties(e.parseGanttSettingsToUserSetting(e.ganttSettings)).then(function(){e.loadServiceAppointmentsToList()}),void(e.showGanttSettings=!1))},e.$on("keypress",function(t,n){27==n.which&&e.closeSettingsLightbox()}),e.stopPropagation=function(e){e.stopPropagation()},e.createArray=function(e,t){if("number"!=typeof e||isNaN(e))return[];if("number"!=typeof t||isNaN(t))return[];var n=Math.floor(e/t);return e%t>0&&n++,new Array(n)},e.changePage=function(t){switch(t){case"right":e.filter.totalPages!=e.filter.currentPage&&(e.filter.currentPage=parseInt(e.filter.currentPage)+1,e.filter.currentPage=e.filter.currentPage.toString());break;case"left":e.filter.currentPage>1&&(e.filter.currentPage=parseInt(e.filter.currentPage)-1,e.filter.currentPage=e.filter.currentPage.toString());break;case"first":e.filter.currentPage>1&&(e.filter.currentPage="1");break;case"last":e.filter.totalPages!=e.filter.currentPage&&(e.filter.currentPage=e.filter.totalPages.toString())}},e.hideServiceList=function(){e.showServiceList.show=!1,e.reallyHideList=!0,r(function(){scheduler.updateView(),n.$broadcast("resizeMap",{})},0)},e.$watch("showServiceList.show",function(t,n){t&&(e.reallyHideList=!1)}),e.getLocationName=function(t){return e.servicesObjectslocationNam},e.isDraggable=function(t){return e.servicesObjects()[t].resourceId||e.servicesObjects()[t].statusCategory!==y.NONE||e.servicesObjects()[t].pinned&&(!e.servicesObjects()[t].pinned||preventUpdateOfPinned)?!1:!0},e.showAdvancedFilterFunc=function(){$("#AdvancedFilteringOptions").css("display","block"),r(function(){e.showAdvancedFilter=!0},100)},e.hideAdvancedFilterFunc=function(){e.showAdvancedFilter=!1,setTimeout(function(){$("#AdvancedFilteringOptions").css("display","none")},700)},e.removeSpaces=function(e){return e?e.split(" ").join("+"):""},e.filterChanged=function(){var t=L(),n=T(e.filter.selectedFilter,t);n?(e.filter.advancedFilter=n,e.customFilterSelected=!0,e.customFilterName=e.filter.selectedFilter):e.customFilterSelected=!1},e.$on("gotNewResources",function(t,n){e.territories=[];for(var s=n.show,i=0;i<s.length;i++)void 0!==l.territories[s[i]]&&e.territories.push(l.territories[s[i]]);e.servicesListVisitedDays={},e.loadServiceAppointmentsToList()}),e.createCustomFilter=function(){e.isEditMode=!1,e.customFilterName="",e.displayCancel=!0,e.IsCustomFilterReadonly=!1,e.DisplayComboBowArrow=!1,e.displayNew=!1,e.displayEdit=!1,e.displaySave=!0,e.displayDelete=!1,e.filter.advancedFilter=R()},e.CancelSaveOrEditCustomFilter=function(){e.displayNew=!0,e.displayEdit=!0,e.DisplayComboBowArrow=!0,e.displaySave=!1,e.displayDelete=!0,e.displayCancel=!1,e.IsCustomFilterReadonly=!0,C(e.lastSelectedFilter)},e.saveCustomFilter=function(){if(0===e.customFilterName.length)return void alert(customLabels.Please_give_a_name_to_the_custom_filter);for(var t=0;t<e.filterOptions.length;t++)if(!e.isEditMode&&e.filterOptions[t].name==e.customFilterName||e.isEditMode&&e.filterOptions[t].name==e.customFilterName&&e.filterOptions[t].name!=e.lastSelectedFilter)return void alert("Please select another name");if(e.displayNew=!0,e.displayEdit=!0,e.DisplayComboBowArrow=!0,e.displaySave=!1,e.displayDelete=!0,e.displayCancel=!1,e.IsCustomFilterReadonly=!0,e.isEditMode){for(var n=0;n<e.storageFilters.length;n++)if(e.storageFilters[n].name==e.lastSelectedFilter){for(e.storageFilters[n].filter=e.filter.advancedFilter,e.storageFilters[n].name=e.customFilterName,w(),t=0;t<e.filterOptions.length;t++)if(e.filterOptions[t].name==e.lastSelectedFilter){e.filterOptions[t].name=e.customFilterName,e.filterOptions[t].value=e.customFilterName;break}e.filter.selectedFilter==e.lastSelectedFilter&&(e.filter.selectedFilter=e.customFilterName);break}}else e.storageFilters.push({name:angular.copy(e.customFilterName),filter:angular.copy(e.filter.advancedFilter)}),e.filterOptions.push({name:angular.copy(e.customFilterName),value:angular.copy(e.customFilterName)}),w(),e.customFilterSelected=!0,e.filter.selectedFilter=e.customFilterName;e.lastSelectedFilter=e.customFilterName},e.EditCustomFilter=function(){e.isEditMode=!0,e.displayCancel=!0,e.DisplayComboBowArrow=!1,e.displayNew=!1,e.displayEdit=!1,e.displaySave=!0,e.displayDelete=!1,e.IsCustomFilterReadonly=!1,e.DisplayComboBowArrow=!1,e.filter.advancedFilter=angular.copy(e.filter.advancedFilter)},e.deleteCustomFilter=function(){e.IsCustomFilterReadonly=!0,e.DisplayComboBowArrow=!0,e.displayNew=!0,e.displayEdit=!0,e.displaySave=!1,e.displayDelete=!0;for(var t=0;t<e.storageFilters.length;t++)if(e.storageFilters[t].name==e.customFilterName){e.storageFilters.splice(t,1);break}D(e.customFilterName),w(),e.filter.selectedFilter==e.customFilterName&&(e.filter.selectedFilter=customPermissions.Service_List_Todo?"Todo":"All"),C(e.storageFilters.length>0?e.storageFilters[0].name:null)},e.customFilterChanged=function(t){e.customFilterName=t,C(t)},e.showDropdownCustomFilters=function(t){t.stopPropagation(),e.storageFilters.length>0&&(e.showCustomFilterDropdown=!e.showCustomFilterDropdown)},e.toggleStatus=function(t,n){e.IsCustomFilterReadonly||(e.filter.advancedFilter.statusCheckboxs[n]=!e.filter.advancedFilter.statusCheckboxs[n])},e.toggleLocation=function(t){e.IsCustomFilterReadonly||(t?e.filter.advancedFilter.locationsCheckboxs[t]=!e.filter.advancedFilter.locationsCheckboxs[t]:e.filter.advancedFilter.noLocation=!e.filter.advancedFilter.noLocation)},e.clearRecentlyViewed=function(){for(var e in o.recentlyUsed)delete o.recentlyUsed[e]},e.openLocationFiltering=function(){S.open()}}])}(),function(){angular.module("serviceExpert").filter("ampmOr24",function(){return function(e,t,n){var s=parseInt(e),i=n?":00":"";return"ampm"==t?12===e?"12PM":0===e||24===e?"12AM":s>12?s-12+"PM":s+"AM":"24"==t?10>s?"0"+s+i:s+i:e}})}(),function(){angular.module("serviceExpert").filter("displayFieldSetField",["utils","$filter",function(e,t){return function(n,s){if(n&&s){var i=n[s.APIName];if(i)if("Status"===s.APIName)i=e.statusTranslations[n.status]||n.status;else switch(s.Type){case e.fieldsTypes.DateTime:i=t("amDateFormat")(i,"l LT");break;case e.fieldsTypes.Date:i=t("amDateFormat")(i,"L");break;case e.fieldsTypes.Currency:i=t("currency")(i,defaultCurrency)}return null==i&&(i=void 0),i}}}]).filter("displayReportField",["utils","$filter",function(e,t){return function(e){if(e){var n=e.Label;switch(e.Type){case"DATETIME_DATA":n=t("amDateFormat")(n,"l LT");break;case"DATE_DATA":n=t("amDateFormat")(n,"L")}return null==n&&(n=void 0),n}}}])}(),function(){angular.module("serviceExpert").filter("orderObjectBy",function(){return function(e,t,n){var s=[];return angular.forEach(e,function(e){s.push(e)}),s.sort(function(e,n){return e[t]>n[t]?1:-1}),n&&s.reverse(),s}})}(),function(){angular.module("serviceExpert").filter("pagination",["servicesService",function(e){return function(t,n,s){e.filter.totalServices=t.length,parseInt(e.filter.currentPage)>e.filter.totalPages&&(e.filter.currentPage="1",n=1);var i=[],r=(n-1)*s,a=(n-1)*s+s;return i=t.length<=s?t:t.slice(r,a),t.length==e.filter.servicesPerPage?e.filter.totalPages=1:(e.filter.totalPages=Math.floor(t.length/e.filter.servicesPerPage),t.length%e.filter.servicesPerPage>0&&e.filter.totalPages++),e.filter.firstVisibleService=r+1,e.filter.lastVisibleService=a,t.length<=s?e.filter.lastVisibleService=t.length:a>t.length&&(e.filter.lastVisibleService=t.length),i}}])}(),function(){angular.module("serviceExpert").filter("replaceLabels",function(){return function(e){for(var t=e,n=arguments.length,s=Array(n>1?n-1:0),i=1;n>i;i++)s[i-1]=arguments[i];for(var r=0;r<s.length;r++)t=t.replace("$"+r,s[r]);return t}})}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){angular.module("serviceExpert").filter("servicesListFilter",["utils","$filter","servicesService","userSettingsManager","ServiceSelectorService","SERVICE_STATUS","SERVICE_CATEGORY",function(e,t,n,s,i,r,a){function o(t,n,s){if(t.name&&-1!=t.name.toLowerCase().indexOf(n.toLowerCase()))return!0;if(t.ganttLabel&&-1!=t.ganttLabel.toLowerCase().indexOf(n.toLowerCase()))return!0;if(t.accountName&&-1!=t.accountName.toLowerCase().indexOf(n.toLowerCase()))return!0;if(t.resourceName&&-1!=t.resourceName.toLowerCase().indexOf(n.toLowerCase()))return!0;if(t.id&&-1!=t.id.toLowerCase().indexOf(n.toLowerCase()))return!0;if(t.serviceTerritoryName&&-1!=t.serviceTerritoryName.toLowerCase().indexOf(n.toLowerCase()))return!0;if(t.status&&-1!=t.status.toLowerCase().indexOf(n.toLowerCase()))return!0;for(var i=0;i<s.length;i++)if((s[i].Type==e.fieldsTypes.String||s[i].Type==e.fieldsTypes.TextArea||s[i].Type==e.fieldsTypes.Reference||s[i].Type==e.fieldsTypes.Picklist)&&t[s[i].APIName]&&-1!=t[s[i].APIName].toLowerCase().indexOf(n.toLowerCase()))return!0;return!1}function c(e,t,n,s){var i=new Date(s);return"undefined"!=typeof t.earlyStart&&t.earlyStart&&e.earlyStart&&e.earlyStart>n&&e.earlyStart<=i?!0:"undefined"!=typeof t.dueDate&&t.dueDate&&e.dueDate&&e.dueDate>n&&e.dueDate<=i?!0:"undefined"!=typeof t.appStart&&t.appStart&&e.appStart&&e.appStart>n&&e.appStart<=i?!0:"undefined"!=typeof t.appEnd&&t.appEnd&&e.appEnd&&e.appEnd>n&&e.appEnd<=i?!0:"undefined"!=typeof t.finish&&t.finish&&e.finish&&e.finish>n&&e.finish<=i?!0:"undefined"!=typeof t.start&&t.start&&e.start&&e.start>n&&e.start<=i?!0:!1}function l(e,t,n){var s=new Date(e.minDate);s.setHours(0),s.setMinutes(0);var i=new Date(e.maxDate);i.setDate(i.getDate()+1),i.setHours(0),i.setMinutes(0);for(var r in t)if(t[r]&&u(n,r,s,i))return!0;return!1}function u(e,t,n,s){if("undefined"==typeof e[t])return!1;var i=e[t];return i>=n&&s>=i?!0:!1}function d(e,t){return e.priority<=t}function v(e,t){return e.jeopardy&&!t.jeopardies?!1:e.violations&&!t.violations?!1:null!==e.start_date||t.unScheduled?!0:!1}function h(e,t,n){if(n&&!e.location)return!0;for(var s in t)if(e.serviceTerritoryName==s&&t[s])return!0;return!1}function g(e){if(void 0==s.GetUserSettingsProperty("Filters__c"))return null;for(var t="object"==_typeof(s.GetUserSettingsProperty("Filters__c"))?s.GetUserSettingsProperty("Filters__c"):JSON.parse(s.GetUserSettingsProperty("Filters__c")),n=0;n<t.length;n++)if(t[n].name==e)return t[n].filter;return null}return function(s,r,u){var p=[],m=new Date(r.endDate),f=e.addDaysToDate(m,-e.ganttSettings.backHorizon),S=scheduler.getState().min_date,b=scheduler.getState().max_date,y=g(r.selectedFilter),_=null,T=[];r.SearchText.indexOf(",")>-1&&(_=r.SearchText.replace(/, /g,",").split(","),""===_[_.length-1]&&_.length--),_?T=_:T.push(r.SearchText);for(var L in s)for(var w=0;w<T.length;w++){var k=o(s[L],T[w],u),C=c(s[L],r.selectedFiled,f,m);if("Selected"==r.selectedFilter){if(i.SelectedServices[L]&&i.SelectedServices[L]&&k){p.push(s[L]);break}}else if("Flagged"==r.selectedFilter&&k){if(n.flagged[L]){p.push(s[L]);break}}else if("Recent"==r.selectedFilter&&k){if(n.recentlyUsed[L]){p.push(s[L]);break}}else if("Todo"==r.selectedFilter){if((s[L].statusCategory==a.NONE||s[L].violations||s[L].jeopardy)&&s[L].statusCategory!=a.CANCELED&&s[L].statusCategory!=a.COMPLETED&&C){if(T[w].length>1&&k){p.push(s[L]);break}if(T[w].length<=1){p.push(s[L]);break}}}else if("All"==r.selectedFilter){if(C){if(T[w].length>1&&k){p.push(s[L]);break}if(T[w].length<=1){p.push(s[L]);break}}}else if("Unscheduled"==r.selectedFilter){if(!s[L].resource&&s[L].statusCategory!=a.CANCELED&&C){if(T[w].length>1&&k){p.push(s[L]);break}if(T[w].length<=1){p.push(s[L]);break}}}else if("Violating"==r.selectedFilter){if(s[L].violations&&s[L].statusCategory!=a.CANCELED&&C){if(T[w].length>1&&k){p.push(s[L]);break}if(T[w].length<=1){p.push(s[L]);break}}}else if("inJeopardy"==r.selectedFilter){if(s[L].jeopardy&&s[L].statusCategory!=a.CANCELED&&C){if(T[w].length>1&&k){p.push(s[L]);break}if(T[w].length<=1){p.push(s[L]);break}}}else if("Scheduled"==r.selectedFilter){if(s[L].resource&&C){if(T[w].length>1&&k){p.push(s[L]);break}if(T[w].length<=1){p.push(s[L]);break}}}else if("Gantt filter"==r.selectedFilter){if(s[L].resource&&(s[L].start<=b&&s[L].start>=S||s[L].finish<=b&&s[L].finish>=S)){if(T[w].length>1&&k){p.push(s[L]);break}if(T[w].length<=1){p.push(s[L]);break}}}else if("Contractors filter"==r.selectedFilter){if(s[L].resourceContractor&&C){if(T[w].length>1&&k){p.push(s[L]);break}if(T[w].length<=1){p.push(s[L]);break}}}else if("Cancelled filter"==r.selectedFilter){if(s[L].statusCategory==a.CANCELED&&C){if(T[w].length>1&&k){p.push(s[L]);break}if(T[w].length<=1){p.push(s[L]);break}}}else if(y&&y.statusCheckboxs[statusTranslations[s[L].status]]&&l(y,r.selectedFiled,s[L])&&d(s[L],y.servicePriority)&&v(s[L],y)&&h(s[L],y.locationsCheckboxs,y.noLocation)){if(T[w].length>1&&k){p.push(s[L]);break}if(T[w].length<=1){p.push(s[L]);break}}}return t("orderBy")(p,r.orderByField,r.reverse)}}])}(),function(){function e(e,c,l,u,d,v,h,g,p,m,f,S){var b=(new Date).getTime();return setInterval(function(){return b+=6e4},6e4),S.register("positions",function(e){var t=c.getResources();for(var n in e)t[n]&&(t[n].lastKnownLongitude=e[n].longitude,t[n].lastKnownLocationDate=e[n].lastModifiedDate.getTime()-1e3*e[n].lastModifiedDate.getTimezoneOffset()*60,t[n].lastKnownLatitude=e[n].latitude)}),function(m,S,y,_,T,L){function w(e){return e.lastKnownLocationDate&&e.lastKnownLocationDate&&e.onlineOffset&&(e.lastSeen=parseInt((b-e.lastKnownLocationDate)/1e3/60),e.lastKnownLocationDate+60*e.onlineOffset*1e3>b)?(e.online=!0,!0):(e.online=!1,!1)}function k(e,t){var n=c.getResources()[e.resourceId].sobject[p.resourceFieldToSortyBy],s=c.getResources()[t.resourceId].sobject[p.resourceFieldToSortyBy],i=p.descending?1:-1;return n>s?i:s>n?-1*i:0}var C=[],R={},D=[],A=S.replace(/, /g,",").split(","),I=l.resourcesAndTerritories(),x=Object.keys(c.territories).map(function(e){return c.territories[e]}).sort(r);if(x.forEach(function(e){C.push(new a(e,c.operatingHours[e.operatingHours],g)),R[e.id]=C.length-1}),y)for(var F in _)_[F]&&D.push(F);var M=v.GetUserSettingsProperty("locations");for(var E in I){var O=I[E],P=c.getResources()[E];if(P&&n(P.name,A)&&(!y||u.doesHaveSkills(E,D,scheduler._min_date,scheduler._max_date))){var N=!1;for(var $ in L.resourceFilteringOptions)if(L.resourceFilteringOptions[$]&&!P.sobject[$]){N=!0;break}if(!N){if("select_a_field"!==L.selectedPicklist){if(L.picklistOptions.length>0&&-1===L.picklistOptions.indexOf(P.sobject[L.selectedPicklist])){if(!L.picklistNullValues)continue;if("undefined"!=typeof P.sobject[L.selectedPicklist])continue}if(0===L.picklistOptions.length&&L.picklistNullValues&&"undefined"!=typeof P.sobject[L.selectedPicklist])continue}if(!h.getCandidatesIds()||h.getCandidatesIds()[E])for(var B in O){var H=e.generateResourceId(O[B].serviceResource,O[B].serviceTerritory);if((!T.showWorkingResource||t(H,d,e))&&(!M||-1!=M.indexOf(O[B].serviceTerritory))&&i(scheduler._min_date,scheduler._max_date,O[B].effectiveStartDate,O[B].effectiveEndDate)){var G=C[R[O[B].serviceTerritory]],V=new o(e.generateResourceId,c.getResources()[O[B].serviceResource],O[B].serviceTerritory,w(c.getResources()[O[B].serviceResource]),s(O[B]));-1===G.children.map(function(e){return e.key}).indexOf(V.key)&&G.children.push(V)}}}}}var U=[],j=0;return C.forEach(function(e,t){return 0===e.children.length&&U.push(t)}),U.forEach(function(e){return C.splice(e-j++,1)}),C.forEach(function(e){return e.children.sort(k)}),e.hasCustomPermission("Utilization_on_Service_Territory")&&showDailyUtilization&&"MonthlyView"!==scheduler._mode&&"MTDView"!==scheduler._mode&&C.forEach(function(e){for(var t=void 0,n=[],s=new Date(scheduler._min_date);s<scheduler._max_date;s.setDate(s.getDate()+1))n.push(f.calculateLocation(e.children,s));var i=n.reduce(function(e,t){return e["break"]+=t["break"],e.capacity+=t.capacity,e.overtime+=t.overtime,e.service+=t.service,e.travel+=t.travel,e.na+=t.na,e},{"break":0,capacity:0,overtime:0,service:0,travel:0,na:0});t=f.calculateLocationUtilization(i),e.addUtilizationHtml(t)}),C}}function t(e,t,n){var s=new Date(scheduler._min_date),i=t.resourceToWorkingDates[e];if(!i)return!1;for(;s<scheduler._max_date;){var r=i[n.formatDayToString(s)];if(r&&(r.regular>0||r.overtime>0))return!0;s.setDate(s.getDate()+1)}return!1}function n(e,t){if(0===t.length)return!0;for(var n=0;n<t.length;n++)if(e.toLowerCase().indexOf(t[n].toLowerCase())>-1)return!0;return!1}function s(e){return"S"==e.serviceTerritoryType}function i(e,t,n,s){return isIntersect(e,t,n,s)}function r(e,t){return e.name>t.name?1:e.name<t.name?-1:0}function a(e,t,n){this.key=e.id,this.name=e.name,this.children=[],this.generateHtml(e,t.timezone),void 0===n.ganttOpenedTerritories[e.id]&&(n.ganttOpenedTerritories[e.id]=!0),this.open=n.ganttOpenedTerritories[e.id]}function o(e,t,n,s,i){this.key=e(t.id,n),this.resourceId=t.id,this.name=t.name,this.contractor=!1,this.online=s,this.lastSeen=t.lastSeen,this.secondary=i,this.generateHtml(t)}angular.module("serviceExpert").filter("timelineFilter",e),e.$inject=["utils","ResourcesAndTerritoriesService","TimePhasedDataService","SkillsService","calendarsService","userSettingsManager","GetSlotsService","StateService","resourceFilterHelper","LastKnownPositionService","monthlyViewHelperService","DeltaService"],a.prototype.generateHtml=function(e,t){if(e.parentTerritory?this.label="<div class='truncate ParentName'>"+e.parentTerritory.name+"</div><div class='truncate LocationName'>"+e.name+"</div>":this.label="<div class='truncate LocationName'>"+e.name+"</div>","MonthlyView"!==scheduler._mode&&"MTDView"!==scheduler._mode){var n=new Date,s=e.parentTerritory?"margin-top:-26px;":"";n=new Date(n.valueOf()+6e4*n.getTimezoneOffset()),n.setMinutes(n.getMinutes()+utils.getLocationOffset(n,e.id)),this.label+="<div class='timeZoneFolder' style=\""+s+'">'+t+" - "+moment(n).format("llll")+"</div>"}},a.prototype.addUtilizationHtml=function(e){var t=this.label.indexOf("Parent")>-1?'style="margin-top: -9px"':"",n=this.label.indexOf("</div>"),s="green-daily-utlz";if(e>=monthlyViewSettings.high&&e<monthlyViewSettings.critical?s="yellow-daily-utlz":e>=monthlyViewSettings.critical&&(s="red-daily-utlz"),null!==e){var i='<b class="'+s+'">'+e+"%</b>";e='<div class="dailyViewUtilization" '+t+">"+customLabels.UtilizationDaily.replace("$0",i)+" </div>",this.label=this.label.slice(0,n+6)+e+this.label.slice(n+6)}},o.prototype.generateHtml=function(e){this.label="";var t=this.online?"online-indicator":"online-indicator offline-indicator",n=this.secondary?"<span class='secondaryGanttLabel' title=\""+customLabels.Secondary+'">('+customLabels.Secondary+")</span>":"",s=e.lastKnownLocationDate&&this.lastSeen<1440?'<div class="'+t+'" title="'+utils.hoursMinutes(this.lastSeen,customLabels.SeenXMinsHoursAgo,customLabels.SeenXAgoHours,customLabels.SeenXAgo)+'"></div>':"";if(e.pictureLink){var i=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourcePhoto":"ResourcePhoto";this.label+="<img src='"+e.pictureLink+"' title='"+e.description+"' class='"+i+"' />"+s}else{var r=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourcePhotoDefault":"NormalResourcePhotoDefault";this.label+="<div title='"+e.description+"' class=\"ResourcePhotoIcon "+r+'"></div>'+s}this.label+='<div class="resourceMenuBtn">\n                            <svg aria-hidden="true" class="slds-icon resourceMenuIcon">\n                                <use xlink:href="'+lsdIcons.threedots+'"></use>\n                            </svg>\n                        </div>',e.ganttLabel?scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.id+"' title='"+e.description+"'>"+this.name+" "+n+"</a>\n                <div class='smallResourceGanttLabel truncate'>"+e.ganttLabel+"</div>":this.label+="<a resource='"+this.id+"' class='smallResourceName' title='"+e.description+"'>"+this.name+" "+n+"</a>\n                <div class='resourceGanttLabel truncate'>"+e.ganttLabel+"</div>":scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.id+"' class='smallResourceName' style='margin-top:6px;' title='"+e.description+"'>"+this.name+" "+n+"</a>":this.label+="<a resource='"+this.id+"' style='margin-top:6px;' title='"+e.description+"'>"+this.name+" "+n+"</a>"}}(),function(){angular.module("serviceExpert").filter("toArray",function(){return function(e){var t=[];return angular.forEach(e,function(e,n){t.push(e)}),t}})}(),function(){function e(){function e(e,t,n,s,i,r,a,o){e.bulkActionsOrder=bulkActionsOrder,e.actionNames={Schedule:{name:customLabels.Schedule,icon:lsdIcons.calendar},Dispatch:{name:customLabels.Dispatch,icon:lsdIcons.dispatch},Optimize:{name:customLabels.Optimize,icon:lsdIcons.magicwand},"Flag-Unflag":{name:customLabels.Flag_Unflag,icon:lsdIcons.flag},Unschedule:{name:customLabels.Unschedule,icon:lsdIcons.na}},e.checkHasCustomPermission=function(e){return void 0==n.hasCustomPermission("Bulk_"+e)?!0:n.hasCustomPermission("Bulk_"+e)},e.openBulkAction=function(e){switch(e){case"Schedule":o.schedule(r.getSelected());break;case"Dispatch":s.open();break;case"Unschedule":i.open();break;case"Optimize":a.open();break;case"Flag-Unflag":for(var n=r.getSelected(),c=0;c<n.length;c++)t.flagged[n[c]]=!t.flagged[n[c]];scheduler.updateView()}}}e.$inject=["$scope","servicesService","utils","bulkDispatchService","bulkUnscheduleService","ServiceSelectorService","optimizeLightboxService","bulkScheduleService"];var t='<div id="quickActionsButtons">\n			                    <div id="actionQuickFirst" class="truncate quickActionBtn" ng-show="bulkActionsOrder.first.length && checkHasCustomPermission(actionNames[bulkActionsOrder.first[0].title].name)" ng-click="openBulkAction(bulkActionsOrder.first[0].title)" title="{{actionNames[bulkActionsOrder.first[0].title].name}}">\n									{{actionNames[bulkActionsOrder.first[0].title].name}}\n								</div>\n	                        	<div id="actionQuickSecond"\n									 class="truncate quickActionBtn"\n									 ng-show="bulkActionsOrder.second.length && checkHasCustomPermission(actionNames[bulkActionsOrder.second[0].title].name)"\n									 ng-click="openBulkAction(bulkActionsOrder.second[0].title)"\n									 title="{{actionNames[bulkActionsOrder.second[0].title].name}}">{{actionNames[bulkActionsOrder.second[0].title].name}}</div>\n		                    	<div class="truncate" id="ActionButton" ng-show="bulkActionsOrder.dropdown.length" cs-toggle="MainActionContainer">\n                                    <span ng-show="(!bulkActionsOrder.first.length &&\n                                                   !bulkActionsOrder.second.length) ||\n                                                   (!checkHasCustomPermission(actionNames[bulkActionsOrder.first[0].title].name) &&\n                                                   !checkHasCustomPermission(actionNames[bulkActionsOrder.second[0].title].name))">\n                                           '+customLabels.Actions+'\n                                    </span>\n                                    <i class="fa fa-caret-down"></i>\n		                    	</div>\n	                    	</div>\n	                        <div id="MainActionContainer">\n			                    <div class="truncate BulkActionMenuItem" ng-repeat="action in bulkActionsOrder.dropdown" ng-show="checkHasCustomPermission(actionNames[action.title].name)" ng-click="openBulkAction(action.title)">\n									<svg aria-hidden="true" class="slds-icon mainActionIcon">\n										\u2028<use xlink:href="{{actionNames[action.title].icon}}"></use>\n									\u2028</svg>\n									{{actionNames[action.title].name}}</div>\n	                        </div>';return{restrict:"E",template:t,scope:{},controller:e}}angular.module("serviceExpert").directive("bulkActionsButton",e),e.$inject=[]}(),function(){function e(){return customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n								<option value="all">'+customLabels.All+'</option>\n								<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n							</select>")}function t(){return customLabels.Use_the_following_policy_x_and_y.replace("$0",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions"></select>').replace("$1",'<select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n								 	<option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n								 	<option value="noFilter">'+customLabels.None+"</option>\n								 </select>")}function n(){return customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartChangeStatus" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartChangeStatus\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>').replace("$1",'<u id="bulkFinishChangeStatus" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishChangeStatus\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>')}function s(){return customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n							</select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>')}function i(){return customLabels.changeStatusBulkMsg.replace("$0",'<select class="selectChangeStatusBulk bulkStatusWidth" ng-model="bulkStatus">\n								<option ng-repeat="(statusType,statusLabel) in statuses" value="{{statusLabel}}" >{{getStatusTranslations()[statusLabel]}}</option>\n							</select>')}angular.module("serviceExpert").directive("bulkOptimizeOptions",function(){return{template:e()}}).directive("bulkOptimizePolicy",function(){return{template:t()}}).directive("bulkChangeStatusDates",function(){return{template:n()}}).directive("bulkUnscheduleDates",function(){return{template:s()}}).directive("bulkChangeStatusPicklist",function(){return{template:i()}})}(),function(){function e(){function e(e){e.colors=[{Name:"Red",Hex:"#E53935"},{Name:"Pink",Hex:"#D81B60"},{Name:"Purple",Hex:"#8E24AA"},{Name:"Indigo",Hex:"#3949AB"},{Name:"Blue",Hex:"#1E88E5"},{Name:"Cyan",Hex:"#00ACC1"},{Name:"Teal",Hex:"#00897B"},{Name:"Green",Hex:"#43A047"},{Name:"Lime",Hex:"#C0CA33"},{Name:"Yellow",Hex:"#FDD835"},{Name:"Amber",Hex:"#FFB300"},{Name:"Orange",Hex:"#FB8C00"},{Name:"Brown",Hex:"#6D4C41"},{Name:"Grey",Hex:"#757575"},{Name:"Blue Grey",Hex:"#546E7A"},{Name:"Black",Hex:"#000"}],e.selectColor=function(t){e.selectedColor=t.Hex,e.setSelectedShapeColor(t.Hex),e.showColorMenu=!1},e.showMenuClick=function(t){(e.drawState==e.drawingStates.EDIT||e.drawState==e.drawingStates.DRAW)&&(e.showColorMenu=!e.showColorMenu)},e.selectedColor="#546E7A",e.showColorMenu=!1,angular.element("#mapOptionsContainer").on("click",function(t){for(var n=["color-square","color-button"],s=0;s<n.length;s++)if(t.target.classList.contains(n[s])||t.target.parentNode&&t.target.parentNode.classList.contains(n[s]))return;e.showColorMenu&&(e.showColorMenu=!1)})}e.$inject=["$scope"];var t='<div id="select-color-btn" class="color-button truncate"  ng-click="showMenuClick()" ng-class="{disabledButton: drawState != drawingStates.EDIT && drawState != drawingStates.DRAW}">\n                            <span class="color-square" ng-style="{\'background-color\': selectedShapeColor || selectedColor}"></span><span>'+customLabels.Select_color+'</span>\n                        </div>\n                        <div class="color-menu" id="colorMenu" ng-show="showColorMenu == true">\n                            <span class="color-box" ng-repeat="color in colors" ng-click="selectColor(color)" ng-style="{\'background-color\': color.Hex}"></span>\n                        </div>';return{restrict:"E",template:t,scope:!1,controller:e}}angular.module("serviceExpert").directive("csColorPicker",e),e.$inject=[]}(),function(){angular.module("serviceExpert").directive("csRange",["$filter","utils",function(e,t){function n(n,s,i){var r=$($(s[0]).find(".showingDates")),a=isAMPM?"ampm":"24",o=$($(s[0]).find(".sliderSelector"));n.$watchCollection(i.ngModel,function(t,n){!o.slider("instance")||t.start===n.start&&t.end===n.end||(o.slider("values",[t.start,t.end]),r.text(i.showingText.replace("{1}",e("ampmOr24")(parseInt(t.start),a,!0)).replace("{2}",e("ampmOr24")(parseInt(t.end),a,!0))))}),o.slider({range:!0,min:parseInt(i.min),max:parseInt(i.max),values:[parseInt(i.defaultStart),parseInt(i.defaultEnd)],slide:function(t,n){r.text(i.showingText.replace("{1}",e("ampmOr24")(parseInt(n.values[0]),a,!0)).replace("{2}",e("ampmOr24")(parseInt(n.values[1]),a,!0)))},stop:function(e,s){t.safeApply(n,function(){n[i.ngModel].start=s.values[0],n[i.ngModel].end=s.values[1];
})}}),r.text(i.showingText.replace("{1}",e("ampmOr24")(parseInt(i.defaultStart),a,!0)).replace("{2}",e("ampmOr24")(parseInt(i.defaultEnd),a,!0)))}return{restrict:"CAE",link:n,scope:!0,template:'<div class="sliderSelector"></div><span class="showingDates"></span>'}}])}(),function(){angular.module("serviceExpert").directive("safeBinder",[function(){function e(e,t,n){$(t[0]).html(e.safeBinder)}return{restrict:"A",scope:{safeBinder:"="},link:e}}])}(),function(){angular.module("serviceExpert").directive("dhxScheduler",["$rootScope","$timeout","userSettingsManager","$q","sfdcService","ResourcesAndTerritoriesService","FieldSetFieldsService",function(e,t,n,s,i,r,a){return{restrict:"C",transclude:!0,template:'<div class="dhx_cal_navline" ng-transclude></div><div class="dhx_cal_header"></div><div class="dhx_cal_data"></div>',link:function(i,o,c){window.utils=angular.element("#serviceExpertApp").injector().get("utils"),i.$watch(c.resources,function(e){scheduler.updateCollection("resources",e)},!0),o.addClass("dhx_cal_container"),schedulerConfig.configTimelines(),schedulerConfig.setConfigurations();var l=n.GetUserSettingsProperty("Gantt_View_Start_Hour__c"),u=n.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),d=n.GetUserSettingsProperty("Resource_Row_Height__c"),v=n.GetUserSettingsProperty("View_Capacity_Type__c"),h=n.GetUserSettingsProperty("Include_Weekends__c");null!=d&&schedulerConfig.setRowHeights(d,!1),null!=v&&setCapacityFilter(v),null!=l&&null!=u&&setHoursToDisplay(l,u,h),e.policy=defaultPolicy;var g=s.all([r.promises.territories(),r.promises.resources(),a.fieldsSetFields()]);g.then(function(){scheduler.init(o[0],new Date,"ZoomLevel3"),i.scheduler=scheduler,i.datalessMethods=attchDatalessSchedulerEvents(),t(function(){switch(i.getTimePhasedObjects().then(function(){$("#FirstTimeLoading").remove()})["catch"](function(e){bootstrap.handleError(e)}),scheduler._mode){case"ZoomLevel2":i.timelineName=customLabels.In_Day;break;case"ZoomLevel3":i.timelineName=customLabels.Daily;break;case"ZoomLevel4":i.timelineName=customLabels.X2_Days;break;case"ZoomLevel5":i.timelineName=customLabels.X3_Days;break;case"ZoomLevel6":i.timelineName=customLabels.Weekly}},0),e.$broadcast("initCompleted")}),function(e){console.log("err:"+e)}}}}])}(),function(){angular.module("serviceExpert").directive("dragNA",function(){return{restrict:"CAE",scope:{dragService:"="},link:function(e,t,n,s){cachedDomElements.draggedBreak||(cachedDomElements.draggedBreak=$("#draggedBreak")),cachedDomElements.draggedBreakDiv||(cachedDomElements.draggedBreakDiv=$("#draggedBreak div")),t.bind("dragstart",function(e){var t=$("#breakDuration").val();e.originalEvent.dataTransfer.setData("text","absenceNA_"+t),cachedDomElements.draggedBreakDiv.html(t);var n=getMinAndMaxHoursToDisplay(),s=new Date(scheduler._min_date.getTime()+1e3*n.min*60*60),i=new Date(scheduler._min_date.getTime()+1e3*n.min*60*60);i.setMinutes(i.getMinutes()+t);var r=getXPositionOfEvent({start_date:s,end_date:i},!1,scheduler.matrix[scheduler._mode]),a=getXPositionOfEvent({start_date:s,end_date:i},!0,scheduler.matrix[scheduler._mode]),o=a-r+4;cachedDomElements.draggedBreak.css("width",o+"px");var c=document.getElementById("draggedBreak").cloneNode(!0);document.body.appendChild(c);var l=window.DataTransfer;"setDragImage"in l.prototype&&e.originalEvent.dataTransfer.setDragImage(c,0,40)})}}})}(),function(){angular.module("serviceExpert").directive("draggableService",["utils","servicesService","SERVICE_STATUS","SERVICE_CATEGORY",function(e,t,n,s){return{restrict:"CAE",scope:{dragService:"="},link:function(t,n,i,r){cachedDomElements.draggedEvent||(cachedDomElements.draggedEvent=$("#draggedEvent")),cachedDomElements.draggedEventDiv||(cachedDomElements.draggedEventDiv=$("#draggedEvent div")),n.bind("dragstart",function(n){n.originalEvent.dataTransfer.setData("text",t.dragService.id);var i=t.dragService.ganttLabel?t.dragService.ganttLabel:t.dragService.name,r="<b>"+i+"</b><br/>"+t.dragService.estDuration+" "+t.dragService.durationType;cachedDomElements.draggedEventDiv.html(r);var a=getMinAndMaxHoursToDisplay(),o=new Date(scheduler._min_date.getTime()+1e3*a.min*60*60),c=new Date(scheduler._min_date.getTime()+1e3*a.min*60*60);t.dragService.durationType?t.dragService.durationType==e.durationTypes.minutes?c.setMinutes(c.getMinutes()+t.dragService.estDuration):t.dragService.durationType==e.durationTypes.hours?c.setMinutes(c.getMinutes()+Math.floor(60*t.dragService.estDuration)):t.dragService.durationType==e.durationTypes.days&&c.setMinutes(c.getMinutes()+Math.floor(60*t.dragService.estDuration*24)):t.dragService.setMinutes(c.getMinutes()+60);var l=getXPositionOfEvent({start_date:o,end_date:c},!1,scheduler.matrix[scheduler._mode]),u=getXPositionOfEvent({start_date:o,end_date:c},!0,scheduler.matrix[scheduler._mode]),d=u-l+4,v="";switch(t.dragService.statusCategory){case s.NONE:v=" eventStatusNew";break;case s.SCHEDULED:v=" eventStatusAssigned";break;case s.DISPATCHED:v="eventStatusDispatched";break;case s.IN_PROGRESS:v=" eventStatusTravel";break;case s.COMPLETED:v=" eventStatusCompleted";break;case s.COULD_NOT_COMPLETE:v=" eventStatusCouldntComplete";break;case s.CANCELED:v=" eventStatusCancelled";break;default:v=" eventCustomStatus"}cachedDomElements.draggedEvent.css("width",d+"px"),cachedDomElements.draggedEvent.removeClass(),cachedDomElements.draggedEvent.addClass(v),t.dragService.ganttColor?cachedDomElements.draggedEvent.css("background",t.dragService.ganttColor):cachedDomElements.draggedEvent.css("background","");var h=document.getElementById("draggedEvent").cloneNode(!0);document.body.appendChild(h);var g=window.DataTransfer;"setDragImage"in g.prototype&&n.originalEvent.dataTransfer.setDragImage(h,0,28)})}}}]).directive("dragTarget",["$rootScope","$filter","utils","servicesService","sfdcService","kpiCalculationsService","ResourcesAndTerritoriesService","AbsencesService","TimePhasedDataService",function(e,t,n,s,i,r,a,o,c){return{restrict:"CAE",link:function(e,i,l,u){var d=Date.now();i.bind("dragover",function(e){if(cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix")),e.preventDefault(),!scheduler.config.readonly){var s=Date.now();if(!(500>s-d)){d=Date.now();var i=scheduler.getActionData(e.originalEvent),r=a.getResources()[i.section.split("_")[0]],o=i.section.split("_")[1];if(r&&o){var c=n.getLocationOffset(i.date,o)-n.getUserOffset(i.date),l=new Date(i.date);if(l.setMinutes(l.getMinutes()+c),r.name&&(!r.isCapacityBased||r.isCapacityBased&&!contractorSupport)){var u=new Date(i.date),v=i.date.getMinutes(),h=v%serviceJumpsOnGantt,g=serviceJumpsOnGantt-v%serviceJumpsOnGantt;u=h>g?new Date(u.getTime()+60*g*1e3):new Date(u.getTime()-60*h*1e3);var p=t("date")(u,"MMM d, y h:mm a"),m=new Date(u);m.setMinutes(m.getMinutes()+c);var f=t("date")(m,"MMM d, y h:mm a");cachedDomElements.timesDragFix.html("<b>"+r.name+"</b> on "+p+"<br/> "+(useLocationTimezone?"":customLabels.Location_time+" "+f)),cachedDomElements.timesDragFix.show()}else cachedDomElements.timesDragFix.hide()}}}}),i.bind("dragleave",function(e){cachedDomElements.timesDragFix.hide(),e.preventDefault()}),i.bind("drop",function(t){if(t.preventDefault(),void 0!==cachedDomElements.draggedEvent&&cachedDomElements.draggedEvent.removeClass(),cachedDomElements.timesDragFix.hide(),!scheduler.config.readonly){var i=scheduler.getActionData(t.originalEvent),l=new Date(i.date),u=i.date.getMinutes(),d=u%serviceJumpsOnGantt,v=serviceJumpsOnGantt-u%serviceJumpsOnGantt;l=d>v?new Date(l.getTime()+60*v*1e3):new Date(l.getTime()-60*d*1e3),i.date=l;var h=a.getResources()[i.section.split("_")[0]];a.territories[i.section.split("_")[1]];if(h&&h.name){var g=t.originalEvent.dataTransfer.getData("text");if(g.indexOf("absenceNA_")>-1){$("#naOptionsContainer").hide();var p=g.substr(10,g.length-10);p=parseInt(p);var m=new Date(i.date);m.setMinutes(m.getMinutes()+p);var f={end_date:m,resource:h.id,start_date:i.date,absenceType:"None"==e.defaultDragNa.selectedNaType?null:e.defaultDragNa.selectedNaType,ganttLabel:e.defaultDragNa.selectedNaLabel};return void n.safeApply(e,function(){o.saveNewAbsence(f).then(function(e){s.drawServicesAndAbsences(e.services||[],e.absences||[])})["catch"](function(e){console.warn("Couldn't update absence"),e.error?n.addNotification(customLabels.Action_Could_Not_Be_Performed,e.error):n.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})})}var S=c.serviceAppointments()[g];if(S){var b=new Date(i.date),y=60;if(S.durationType?S.durationType==n.durationTypes.minutes?b.setMinutes(b.getMinutes()+S.estDuration):S.durationType==n.durationTypes.hours?b.setMinutes(b.getMinutes()+Math.floor(60*S.estDuration)):S.durationType==n.durationTypes.days&&b.setDate(b.getDate()+Math.floor(S.estDuration)):b.setMinutes(b.getMinutes()+y),contractorSupport&&h.isCapacityBased){for(var _=!1,T=!0,L=scheduler.getEvents(i.date,b),w=0;w<L.length;w++)L[w].resourceId.indexOf(i.section)>-1&&"contractorcapacity"==L[w].type&&(_=!0,L[w].timePeriod==n.ganttSettings.capacityDuration&&(T=!1));if(!_)return void alert(customLabels.serviceCantBeAssignedWithoutCapacity);T&&alert(customLabels.is_assigned_to_contractor.replaceAll(S.name,h.name)+".\n"+customLabels.This_capacity_duration_is_filtered_out+".\n"+customLabels.To_change_the_capacity_duration)}var k=angular.copy(S);k.end_date=b,k.resourceId=i.section,k.start_date=new Date(i.date),k.assignedResource=null,n.safeApply(e,function(){s.saveChangesToServiceAppointment(S,k).then(function(e){e.absences.forEach(function(e){e.isScheduled()&&e.setGanttResource(c.resourcesAndTerritories(),n.generateResourceId)}),e.services.forEach(function(e){e.isScheduled()&&e.setGanttResource(c.resourcesAndTerritories(),n.generateResourceId)}),s.drawServicesAndAbsences(e.services||[],e.absences||[]),r.calculateKpis()})["catch"](function(e){console.warn("Couldn't update service. "+e[2]),n.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message||customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")})})}}}})}}}])}(),function(){angular.module("serviceExpert").directive("googlePlaces",function(){return{restrict:"E",replace:!0,scope:{myMap:"=",searchMarker:"="},template:'<input id="google_places_ac" name="google_places_ac" type="text" class="input-block-level"/>',link:function(e,t,n){var s=new google.maps.places.Autocomplete($("#google_places_ac")[0],{});google.maps.event.addListener(s,"place_changed",function(){var t=s.getPlace();e.searchMarker?e.searchMarker.setPosition(t.geometry.location):e.searchMarker=new google.maps.Marker({map:e.myMap,position:t.geometry.location}),t.geometry.viewport?e.myMap.fitBounds(t.geometry.viewport):(e.myMap.setCenter(t.geometry.location),e.myMap.setZoom(17))})}}})}(),function(){angular.module("serviceExpert").directive("csGroupActions",["$compile",function(e){function t(t,n,s){function i(e,t,n){return Math.ceil($(e).offset().top)>=t+n}var r,a,o=$('<ul class="moreQuickActionsContainer"></ul>'),c=$(n).parent().parent().children();angular.element(n[0]).on("click",function(s){s.stopPropagation();var l=$(c).last(),u=$(c).first(),d=$(u).offset().top,v=$(u).outerHeight(!0);if(o.hasClass("viewMoreActive"))return o.removeClass("viewMoreActive"),o.empty(),void o.remove();if(i($(l),d,v)){for(var h=c.length-1;h>1;h--)if(r=$(c[h]),a=i(r,d,v)){var g=$("<li></li>");r.find("> div:first-child").clone().removeClass("quickActionGoLeft").addClass("menuQuickAction").css({marginBottom:"0",border:"none",width:"87%"}).appendTo(g),g.css({display:"block"}).appendTo(o),e(g)(t)}$(o.children().get().reverse()).appendTo(o),$(n).append(o),o.addClass("viewMoreActive"),o.show();var p=o.offset().top,m=o.outerHeight(!0);i($("#TaskListPagination"),p,m)||$("#TaskListItems").animate({scrollTop:$("#TaskListItems").scrollTop()+36*o.children().length},500)}angular.element("body").on("mousedown",function(e){for(var t=["moreQuickActionsBtn","menuQuickAction","fa-caret-down"],n=0;n<t.length;n++)if(e.target.classList.contains(t[n])||e.target.parentNode&&e.target.parentNode.classList.contains(t[n]))return;o.hasClass("viewMoreActive")&&(o.removeClass("viewMoreActive"),o.empty(),o.remove(),angular.element("body").off("mousedown"))})})}return{restrict:"A",link:t}}]).directive("csLastAction",[function(){function e(e,t,n){var s=$(t),i=e.service,r=n.csLastAction;switch(r){case"edit":!i.pinned||i.latitude&&i.longitude||s.hide();break;case"reshuffle":i.resourceId||i.latitude&&i.longitude||s.hide();break;case"groupNearby":i.resourceId&&i.latitude&&i.longitude||s.hide();break;case"dispatch":i.resourceId||i.latitude&&i.longitude||s.hide();break;case"gantt":i.latitude&&i.longitude||s.hide()}}return{restrict:"A",link:e}}])}(),function(){angular.module("serviceExpert").directive("keypressEvents",["$rootScope",function(e){var t=[13,16,18,27,37,38,39,40,48,49,50,51,55,69,70,73,77,79,83,84,85,87,90,96,97,98,99,103];return{restrict:"C",link:function(){angular.element("body").bind("keydown",function(n){t.indexOf(n.which)>-1?e.$broadcast("keypress",n):n.stopPropagation()})}}}])}(),function(){function e(e,t){function n(n){n.optimizationRequests={},n.optRunning=0,n.optQueued=0,n.replaceText=function(e,t){var n=customLabels[e];return n.replaceAll(t.toString())},e.register("optimizationRequests",function(e){for(var s=0,i=0,r=0;r<e.length;r++){var a=new OptimizationRequest(e[r]);"Queued"==a.status&&i++,"In Progress"==a.status&&s++,n.optimizationRequests[a.id]&&"Completed"==a.status&&"Completed"!=n.optimizationRequests[a.id].status&&t.addNotification(customLabels.Optimization_Completed,customLabels.x_services_were_sched_out_of.replaceAll(a.scheduledAmount,a.objectToScheduled)+".",function(e){t.openSObjectLink("../"+e)},a.id),n.optimizationRequests[a.id]&&"Failed"==a.status&&"Failed"!=n.optimizationRequests[a.id].status&&t.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){t.openSObjectLink("../"+e)},a.id),n.optimizationRequests[a.id]=a}n.optQueued=i,n.optRunning=s})}return{restrict:"E",link:n,scope:{},template:'\n                <div id="optInProgress" ng-show="optRunning">\n                    '+customLabels.Optimization_in_progress+"\n	            	<span ng-show=\"optRunning > 1\">{{ replaceText('XoptimizationRunning',optRunning) }}</span>\n	            	<span ng-show=\"optQueued\">{{ replaceText('XoptimizationQueued',optQueued) }}</span>\n        		</div>"}}e.$inject=["DeltaService","utils"],angular.module("serviceExpert").directive("optimizationIndicator",e)}(),function(){angular.module("serviceExpert").directive("csStopPropagation",[function(){function e(e,t,n){angular.element(t[0]).on(n.csStopPropagation,function(e){e.stopPropagation()})}return{restrict:"A",link:e}}])}(),function(){angular.module("serviceExpert").directive("csToggle",[function(){function e(e,t,n){for(var s=$("#"+n.csToggle),i=$("[cs-toggle]"),r={},a=0;a<i.length;a++){var o=$(i[a]);r[o.attr("id")]=$("#"+o.attr("cs-toggle"))}1===s.length&&(angular.element(t[0]).on("click",function(e){e.stopPropagation();for(var t in r)t!==e.currentTarget.id?(r[t].hide(),$(".dhx_mini_calendar").hide()):s.toggle()}),angular.element("body").on("click",function(e){for(var t in r)r[t].hide()}))}return{restrict:"A",link:e}}])}(),function(){angular.module("serviceExpert").factory("SERVICE_CATEGORY",function(){return{NONE:"None",SCHEDULED:"Scheduled",DISPATCHED:"Dispatched",IN_PROGRESS:"InProgress",COULD_NOT_COMPLETE:"CannotComplete",COMPLETED:"Completed",CANCELED:"Canceled"}})}(),function(){angular.module("serviceExpert").factory("SERVICE_STATUS",function(){return serviceStatuses})}(),function(){angular.module("serviceExpert").constant("dhtmlxDays",{Sunday:"0",Monday:"1",Tuesday:"2",Wednesday:"3",Thursday:"4",Friday:"5",Saturday:"6"})}(),function(){angular.module("serviceExpert").constant("PARENT_RECORD_TYPE",{WORKORDER:"WorkOrder",LINEITEM:"WorkOrderLineItem",ACCOUNT:"Account"})}(),function(){angular.module("serviceExpert").constant("DRAWING_STATES",{NONE:0,EDIT:1,DRAW:2,SELECTED:3,INTERSECT:4})}(),function(){angular.module("serviceExpert").factory("servicesService",["$q","$rootScope","sfdcService","utils","userSettingsManager","monthlyViewHelperService","TimePhasedDataService","ServiceAppointmentLightboxService","kpiCalculationsService","bulkResultsService","SERVICE_STATUS","SERVICE_CATEGORY","StateService","MstResolver",function(e,t,n,s,i,r,a,o,c,l,u,d,v,h){function g(e,t,n){var i={};i.absences=a.updateTimePhaseData(e.na,"na").absences,i.services=a.updateTimePhaseData(e.services,"service").services,t.resolve(i),S.checkRules(s.getRelatedServices(n)).then(function(){return scheduler.updateView()})}function p(e){return e.isScheduled()?(e.setGanttResource(a.resourcesAndTerritories(),s.generateResourceId),!0):(scheduler._events[e.id]&&delete scheduler._events[e.id],!1)}var m=200,f=new Date;f.setDate(f.getDate()+3),window.globalStatuses=u,window.globalCategories=d;var S={servicesObjects:{},recentlyUsed:{},flagged:flaggedServices,filteredServices:{servicesArray:[]},filter:{advancedFilter:{statusCheckboxs:{New:!0,Assigned:!0,Dispatched:!0,Travel:!0,"On Site":!0,Incomplete:!0},selectedDates:{dueDate:!0,appEnd:!0,end_date:!0},minDate:new Date(Date.now()-6048e5),maxDate:new Date(Date.now()+6048e5),servicePriority:10,jeopardies:!0,violations:!0,unScheduled:!0},selectedFiled:{appEnd:!0,appStart:!0,dueDate:!0,earlyStart:!0,finish:!0,start:!0},selectedFilter:customPermissions.Service_List_Todo?"Todo":"All",orderByField:"start",reverse:!1,SearchText:"",endDate:f,currentPage:1,servicesPerPage:200,totalServices:0,totalPages:1}};return s.ganttSettings&&(S.filter.servicesPerPage=parseInt(s.ganttSettings.servicesPerPage)),S.checkRules=function(t){var i=e.defer(),r=[],o=[],l=[],u=1;if(Array.isArray(t)&&0===t.length)return i.resolve([]),i.promise;for(t.sort(function(e,t){return a.serviceAppointments()[e]||a.serviceAppointments()[t]?!a.serviceAppointments()[e]&&a.serviceAppointments()[t]?-1:a.serviceAppointments()[e]&&!a.serviceAppointments()[t]?1:a.serviceAppointments()[e].start==a.serviceAppointments()[t].start?0:a.serviceAppointments()[e].start>a.serviceAppointments()[t].start?1:-1:0});u!==Math.ceil(t.length/m+1);)l.push(t.slice((u-1)*m,u*m)),o.push(e.defer()),u++,o[o.length-1].promise.then(function(e){n.checkRules(l[e],v.selectedPolicyId).then(function(t){for(var n in t)if(t[n].length>0){if(!a.serviceAppointments()[n])continue;a.serviceAppointments()[n].violations=t[n],r.push(n)}else a.serviceAppointments()[n]&&(a.serviceAppointments()[n].violations=null);o[e+1]?o[e+1].resolve(e+1):(c.calculateKpis(),i.resolve(r))})["catch"](function(e){s.addNotification(customLabels.Rule_validation_failed,e.message),i.reject(e),console.warn("rule checking failed"),console.log(e)})});return o[0].resolve(0),i.promise},S.postToChatter=function(t,s){var i=e.defer();return n.postToChatter(t,s).then(function(e){i.resolve(e)}),i.promise},S.sortServicesByPriority=function(t){var s=e.defer();return n.sortServicesByPriority(t).then(function(e){s.resolve(e)}),s.promise},S.scheduleFromBulk=function(s){var i=e.defer(),r=[],a=null,o=null,c=null;return n.autoScheduleService(s,t.policy).then(function(e){var t={};if(!e.value)return void i.resolve(e);if(!e.value.Services)return i.resolve(e),null;for(var n=e.value.Services,s=e.value.Breaks,l=0;l<n.length;l++)a=S.parseService(n[l]),r.push(a),S.servicesObjects[a.id]=a;for(l=0;l<s.length;l++)o=S.parseNA(s[l]),r.push(o);for(l=0;l<e.value.ModifiedServices.length;l++)c=S.parseService(e.value.ModifiedServices[l]),r.push(c),S.servicesObjects[c.id]=c;scheduler.parse(r,"json"),n.length>0&&(t.value=r[0]),t.eventType=e.eventType,i.resolve(t)}),i.promise},S.autoScheduleService=function(t){var s=e.defer();return n.autoScheduleService(t,v.selectedPolicyId).then(function(n){return n.schedulingResult&&Array.isArray(n.schedulingResult)&&n.schedulingResult[0]&&n.schedulingResult[0].LongOperationId?void h.getUpdates(n.schedulingResult[0].LongOperationId).then(function(e){g(e,s,t)})["catch"](function(t){return console.error(t),e.reject({eventType:"exception",message:t})}):void g(n,s,t)})["catch"](function(e){console.log(e),s.reject(e)}),s.promise},S.saveChangesToServiceAppointment=function(t,i){var r=e.defer(),o=new Date(i.start_date.getTime()+1e3*i.travelTo),c=new Date(i.end_date.getTime()-1e3*i.travelFrom);if(useLocationTimezone){var l=a.getIntersectingSrstOffset(i,i.getGanttResource()),u=s.getUserOffset(o),d=s.getUserOffset(c);o.setMinutes(o.getMinutes()+u-l),c.setMinutes(c.getMinutes()+d-l)}return S.recentlyUsed[t.id]=!0,n.saveChangesToServiceAppointment(i.id,i.getGanttResource(showSecondarySTMs),i.assignedResource,o,c,v.selectedPolicyId,i.scheduleMode).then(function(e){var n={};n.absences=a.updateTimePhaseData(e.resourceAbsences,"na").absences,n.services=a.updateTimePhaseData(e.services,"service").services,e.ValidationError&&r.reject(["",t,e.ValidationError]),r.resolve(n);var o="";t.resourceId&&(o=t.resourceId+","),i.resourceId&&(o+=i.resourceId),S.checkRules(s.getRelatedServices(i.id,o)).then(function(){return scheduler.updateView()})})["catch"](function(e){r.reject([e,t,""]),console.warn(e)}),r.promise},S.unscheduleServices=function(t,i,r){var c=e.defer(),u=r?n.unscheduleServicesByLocationsId:n.unscheduleServicesByServicesId,d=null;return r||(d=s.getRelatedServices(t)),u(t,i,r).then(function(u){var v={};if(u.nothingToUnschedule)return void c.resolve(u);var g=e.defer();u.fslOperation?h.getUpdates(u.fslOperation).then(function(e){console.log(e);var t=e.fslOperation.result.services.map(function(e){return e.Id});n.getServicesById(t).then(function(t){a.updateTimePhaseData(t,"service").services,g.resolve({services:t,resourceAbsences:[],resourceCapacities:[],failedResults:e.fslOperation.result.failedResults})})})["catch"](function(e){g.reject(e)}):g.resolve(u),g.promise.then(function(e){v.absences=a.updateTimePhaseData(e.resourceAbsences,"na").absences,v.services=a.updateTimePhaseData(e.services,"service").services,v.capacities=a.updateTimePhaseData(e.resourceCapacities,"capacity").capacities,v.failedResults=e.failedResults,!r&&S.checkRules(d).then(function(){return scheduler.updateView()}),r&&S.checkRules(s.getServicesOfLocations(t,i,r)).then(function(){return scheduler.updateView()});var n=void 0,u=void 0;if(1!==t.length||r){var h=[],g=[];if(r?e.services.forEach(function(t){e.failedResults[t.Id]&&a.serviceAppointments()[t.Id].isScheduled()?g.push(t.Id):h.push(t.Id)}):t.forEach(function(e){a.serviceAppointments()[e].isScheduled()?g.push(e):h.push(e)}),n=customLabels.x_services_were_unscheduled.replaceAll(h.length),u=r?customLabels.x_services_were_unscheduled_out_of_y.replaceAll(h.length,h.length,g.length+h.length):customLabels.x_services_were_unscheduled_out_of_y.replaceAll(h.length,h.length,t.length),g.length>0){var p=g.map(function(e){return a.serviceAppointments()[e].name}).join(", ");u+="<div title='"+p+"' class='dashedBorder' style='display:inline-block;'> "+customLabels.failed_to_unschedule.replaceAll(g.length)+". "+customLabels.View_services+"</div>"}var m=angular.copy(e),f=[];m.services.forEach(function(e){if(r)e.Fields.SchedStartTime||f.push(e);else for(var n=0;n<t.length;n++)e.Id===t[n]&&f.push(e)}),m.services=f,s.addNotification(n,u,function(){var e={success:customLabels.SuccessfullyUnscheduled,fail:customLabels.FailToUnschedule};l.open(m,e)})}else{var b=a.serviceAppointments()[t[0]].name;a.serviceAppointments()[t[0]].isScheduled()?(n=customLabels.Couldnt_unschedule.replaceAll(b),u=customLabels.Couldnt_unschedule.replaceAll(b)+". "+e.failedResults[t[0]].errorMessage):(n=customLabels.was_unscheduled.replaceAll(b),u=customLabels.was_unscheduled_successfully.replaceAll(b)),s.addNotification(n,u,function(){S.recentlyUsed[t[0]]=!0,o.open(t[0])})}c.resolve(v)})})["catch"](function(e){c.reject(e),console.warn(e)}),c.promise},S.drawServicesAndAbsences=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=arguments[3],i=void 0,r={},a={},o={},c={scheduledServices:[],unscheduledServices:[],deletedIds:n};Array.isArray(e)?e.forEach(function(e){return r[e.id]=e}):r=e,Array.isArray(t)?t.forEach(function(e){return a[e.id]=e}):a=t,Array.isArray(s)?s.forEach(function(e){return o[e.id]=e}):o=s,i=angular.extend({},r,a,o);for(var l in i){var u=i[l];p(u)?c.scheduledServices.push(u):c.unscheduledServices.push(u)}return n.forEach(function(e){return delete scheduler._events[e]}),c.scheduledServices.length>0?scheduler.parse(c.scheduledServices,"json"):scheduler.updateView(),c},S.changeStatus=function(t,i,r,c){var u=e.defer(),d=c?n.changeStatusServicesByLocationsId:n.changeStatusServicesByServicesId;return d(t,i,r,c).then(function(e){var n={};if(e.nothingToDispatch)return void u.resolve(e);n.services=a.updateTimePhaseData(e.services,"service").services,n.failedResults=e.failedResults;var r=void 0,d=void 0;if(1!==t.length||c){var v=[],h=[];if(c?e.services.forEach(function(e){a.serviceAppointments()[e.Id].status!==i?v.push(e.Id):h.push(e.Id)}):t.forEach(function(e){a.serviceAppointments()[e].status===i?h.push(e):v.push(e)}),r=customLabels.x_services_were_changed.replaceAll(h.length,s.statusTranslations[i]||i),d=customLabels.x_services_were_changed_out_of_y.replaceAll(h.length,h.length,h.length+v.length,s.statusTranslations[i]||i),v.length>0){var g=v.map(function(e){return a.serviceAppointments()[e].name}).join(", "),p=customLabels.failed_to_change_status.replaceAll(v.length);d+="<div title='"+g+"' class='dashedBorder' style='display:inline-block;'> "+p+". "+customLabels.View_services+"</div>"}s.addNotification(r,d,function(){var t={success:customLabels.SuccessfullyDispatched,fail:customLabels.FailToDispatch};l.open(e,t)})}else{var m=a.serviceAppointments()[t[0]].name;a.serviceAppointments()[t[0]].status!==i&&(r=customLabels.could_not_change_title.replaceAll(m),d=customLabels.could_not_change_status.replaceAll(m,s.statusTranslations[i],e.failedResults[t[0]].errorMessage),s.addNotification(r,d,function(){o.open(t[0])})),S.recentlyUsed[t[0]]=!0}u.resolve(n)})["catch"](function(e){u.reject(e),console.warn(e)}),u.promise},S.changePin=function(t,s){var i=e.defer();return n.changePin(t,s).then(function(e){var t=fieldNames.Service_Appointment.pinned;e.forEach(function(e){return a.serviceAppointments()[e.Id].pinned=e[t]}),i.resolve()})["catch"](function(e){i.reject(e),console.warn(e)}),i.promise},S.setInJeopardy=function(t){var i=e.defer();return n.setServiceAppointmentsInJeopardy(t).then(function(e){e.forEach(function(e){return a.serviceAppointments()[e.Id].jeopardy=e[fieldNames.Service_Appointment.InJeopardy__c]}),s.addNotification("In Jeopardy Service Appointments",e.length+" service appointments were marked as in jeopardy"),i.resolve()})["catch"](function(e){i.reject(e),console.warn(e)}),i.promise},S}])}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){angular.module("serviceExpert").factory("userSettingsManager",["$q",function(e){var t={};return t.GetUserSettingsProperty=function(e){return bootstrap.loadedUserSettings[e]},t.SetUserSettingsProperty=function(t,n){var s=e.defer(),i="undefined"==typeof n?"undefined":_typeof(n);return Visualforce.remoting.Manager.invokeAction(RemoteActions.SetUserSettingsProperty,t,n,i,function(e,t){null!=t.result&&(bootstrap.loadedUserSettings=JSON.parse(t.result),s.resolve())},{buffer:!1,escape:!1,timeout:12e4}),s.promise},t.SetUserSettingProperties=function(t){var n=e.defer();for(var s in t){var i=t[s];t[s]=i+":"+("undefined"==typeof i?"undefined":_typeof(i))}return Visualforce.remoting.Manager.invokeAction(RemoteActions.SetUserSettingsProperties,t,function(e,t){var s=JSON.parse(t.result);s.FailedLocations?(bootstrap.loadedUserSettings=s,n.reject(s)):(bootstrap.loadedUserSettings=s,n.resolve())},{buffer:!1,escape:!1,timeout:12e4}),n.promise},t.SetUserSettingPropertiesPromise=function(n){var s=e.defer();return t.SetUserSettingProperties(n),bootstrap.loadedUserSettings=JSON.parse(ev.result),s.promise},t}])}(),function(){function e(e,t,n,s,i,r,a,o,c,l){function u(e,t){return Array.isArray(e)&&!Array.isArray(t)?e.map(function(e){return e+"_"+t}).join(","):Array.isArray(e)&&Array.isArray(t)?e.map(function(e,n){return e+"_"+t[n]}).join(","):Array.isArray(e)||Array.isArray(t)?!Array.isArray(e)&&Array.isArray(t)?t.map(function(t){return e+"_"+t}).join(","):void 0:e+"_"+t}function d(){var t=e.defer();return n.getReports().then(function(e){if(!e)return void t.resolve(null);for(var n=0;n<e.length;n++)J.push(e[n]);t.resolve(J)}),t.promise}function v(){var t=e.defer();return W("Polygons_view")?(n.getPolygons().then(function(e){if(!e)return void t.resolve(null);for(var n=0;n<e.length;n++)Y.push(e[n]);t.resolve(Y)}),t.promise):void t.resolve(null)}function h(e,t){var n="number"==typeof e||"string"==typeof e?scheduler.getEvent(e):e,c=getMinAndMaxHoursToDisplay(),l=n.start_date.getHours(),u=n.end_date.getHours();scheduler._min_date<=n.start_date&&n.start_date<scheduler._max_date?scheduler.setCurrentView(scheduler._min_date):scheduler.setCurrentView(new Date(n.start_date)),setTimeout(function(){if(t=t||scheduler._mode,0===n.end_date.getHours()&&n.end_date.getDate()>n.start_date.getDate()&&(u=24),"MonthlyView"===t)return void alert(customLabels.serviceCantDisplayMonthlyMsg);if("ZoomLevel2"!==scheduler._mode&&(c.min>u||c.max<=l))return void alert(customLabels.serviceCantDisplayMsg);for(var d=!0,v=scheduler.serverList("resources"),h=0;h<v.length;h++)for(var p=0;p<v[h].children.length;p++)if(n.resourceId.indexOf(v[h].children[p].key)>-1){d=!1;break}if(d)return void alert(customLabels.resource_filtered_out);var m=scheduler.getRenderedEvent(e);if(showSecondarySTMs&&n.ServiceTerritoryId&&n.resourceId.indexOf(",")>-1){for(var f=n.resourceId.split(","),S=f[0],b=0;b<f.length;b++)if(f[b].indexOf(n.ServiceTerritoryId)>-1){S=f[b];break}m=g(e,S.split("_")[1])||m}if($(m).removeClass("ShowEventEffect"),n&&(!scheduler.checkEvent("onBeforeEventDisplay")||scheduler.callEvent("onBeforeEventDisplay",[n,t]))){var y=scheduler.config.scroll_hour;scheduler.config.scroll_hour=n.start_date.getHours();var _=scheduler.config.preserve_scroll;if(scheduler.config.preserve_scroll=!1,(n.start_date<scheduler._min_date||n.start_date>scheduler._max_date)&&(a.areContractorsSupported()&&n.resourceContractor?scheduler.setCurrentView(new Date(n.start),t):scheduler.setCurrentView(new Date(n.start_date),t)),scheduler.config.scroll_hour=y,scheduler.config.preserve_scroll=_,a.areContractorsSupported()){var T=!0;if(n.resourceContractor){var L=scheduler.getEvents(n.start,n.finish);for(h=0;h<L.length;h++)if(L[h].resourceId==n.resourceId&&"contractorcapacity"==L[h].type&&L[h].timePeriod==r.GetUserSettingsProperty("View_Capacity_Type__c")){n=L[h],e=L[h].id,m=scheduler.getRenderedEvent(e),$(m).removeClass("ShowEventEffect"),T=!1;break}if(T)return void alert(customLabels.is_assigned_to_contractor.replaceAll(n.name,n.resourceName)+".\n"+customLabels.This_capacity_duration_is_filtered_out+".\n"+customLabels.To_change_the_capacity_duration)}}scheduler.matrix&&scheduler.matrix[t]&&(scheduler._els.dhx_cal_data[0].scrollTop=0,scheduler._els.dhx_cal_data[0].scrollTop=getAbsoluteTop(scheduler.getRenderedEvent(n.id))-getAbsoluteTop(scheduler._els.dhx_cal_data[0])-20),scheduler.callEvent("onAfterEventDisplay",[n,t]),$(m).addClass("ShowEventEffect"),i(function(){o.calculateKpis(),s.$broadcast("afterShowEvent")},400)}},200)}function g(e,t){for(var n=scheduler._rendered,s=0;s<n.length;s++){var i=n[s];if(i.getAttribute("event_id")==e&&i.children[0].getAttribute("territory_id")==t)return i}}function p(e,t){var n=864e5*t;return new Date(e.getTime()+n)}function m(e){var t=new Date(e);switch(scheduler._mode){case"ZoomLevel2":t=p(t,1);break;case"ZoomLevel3":t=p(t,1);break;case"ZoomLevel4":t=p(t,2);break;case"ZoomLevel5":t=p(t,3);break;case"ZoomLevel6":t=p(t,7);break;case"MonthlyView":t=p(t,30);break;case"MTDView":t=p(t,35)}return{start:new Date(e),end:t
}}function f(e,t,n,s){"undefined"==typeof s&&(s=null),Q.push({title:e,text:t,action:n,when:new Date,unread:!0,param:s});Q.length-1}function S(e,t){switch(e){case t.NONE:return"serviceList_new";case t.SCHEDULED:return"serviceList_assigned";case t.DISPATCHED:return"serviceList_dispatched";case t.IN_PROGRESS:return"serviceList_travel";case t.COMPLETED:return"serviceList_completed";case t.COULD_NOT_COMPLETE:return"serviceList_couldnt_complete";case t.CANCELED:return"serviceList_cancelled";default:return"serviceList_other"}}function b(e,t){return e.start>t.start?1:e.start.getTime()==t.start.getTime()?0:-1}function y(e,t){var n={},s=[];e.start>=t.start&&e.start<t.finish?(n.start=e.start,e.finish<t.finish?n.finish=e.finish:(n.finish=t.finish,s.push({start:t.finish,finish:e.finish,isStart:!1}))):e.finish>t.start&&e.finish<=t.finish?(e.start>t.start?n.start=e.start:(n.start=t.start,s.push({start:e.start,finish:t.start,isStart:!0})),n.finish=e.finish):e.start<t.start&&e.finish>t.finish?(n=angular.copy(t),s.push({start:e.start,finish:t.start,isStart:!0}),s.push({start:t.finish,finish:e.finish,isStart:!1})):n=null;for(var i=[],r=0;r<s.length;r++){var a=s[r];a.start.getTime()!=a.finish.getTime()&&i.push(a)}return{intersection:n,remainderFrom1:i}}function _(e){return!Object.keys(e).length}function T(e){if(e){var t={};return e.Type==ie.Reference&&(t.resourceOnServiceTT=!0),t}}function L(e,t){if(t.Type==ie.Reference){var n=t.JsAPIName.replace("__r","__c");w(e[n])}}function w(e){var t=C(null,e);t||window.open("../"+e,"_blank")}function k(e){return"string"==typeof e?t.trustAsHtml(e):null}function C(e,t){return a.isInConsole()?(e&&e.preventDefault(),sforce.console.generateConsoleUrl(["/"+t],function(e){sforce.console.openConsoleUrl(null,e.consoleUrl,!0)}),!0):!1}function R(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function D(e){var t={weekday:"short",month:"long",day:"numeric",year:"numeric"},n=new Date(e);n.setHours(12);try{return n.toLocaleDateString(userLocale.replace("_","-"),t)}catch(s){return null}}function A(e,t,n){var s=F(e,t);return M(s.tz(n))}function I(e){return-moment.tz.zone(userTimeZone).offset(F(e,userTimeZone).valueOf())}function x(e,t){var n=c.territories[t],s=c.operatingHours[n.operatingHours].timezone;return-moment.tz.zone(s).offset(F(e,s).valueOf())}function F(e,t){return moment.tz({year:e.getFullYear(),month:e.getMonth(),date:e.getDate(),hours:e.getHours(),minutes:e.getMinutes()},t)}function M(e){return new Date(e.year(),e.month(),e.date(),e.hours(),e.minutes())}function E(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n].id);return t}function O(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n]);return t}function P(e,t){var n=e.$root.$$phase;"$apply"==n||"$digest"==n?t&&"function"==typeof t&&t():e.$apply(t)}function N(e){var t=0;if(e.resourceBeforeDrag=e.resourceId,e.eventBeforeDrag=angular.copy(e),e.isScheduled())t=e.finish.getTime()-e.start.getTime();else switch(e.durationType){case ae.minutes:t=60*e.estDuration*1e3;break;case ae.hours:t=60*e.estDuration*60*1e3;break;case ae.days:t=24*e.estDuration*60*60*1e3;break;default:t=6e4}return t}function B(e,t){var n=Array.isArray(e)?e.concat():[e];t+=n.reduce(function(e,t){return scheduler._events[t]?e+","+scheduler._events[t].resource:e},"");for(var s in scheduler._events){var i=scheduler._events[s];"service"===i.type&&-1!=t.indexOf(i.resource)&&(n.push(i.id),i.relatedTo&&n.push(i.relatedTo),i.relatedFather&&n.push(i.relatedFather),i.relatedService2&&n.push(i.relatedService2),i.relatedService1&&n.push(i.relatedService1))}return n}function H(e,t,n){var s=[];e=Array.isArray(e)?e:[e];var i=e.join(",");for(var r in scheduler._events){var a=scheduler._events[r];"service"===a.type&&i.indexOf(a.serviceTerritory)&&isIntersect(a.start_date,a.end_date,t,n)&&(s.push(a.id),a.relatedTo&&s.push(a.relatedTo),a.relatedFather&&s.push(a.relatedFather),a.relatedService2&&s.push(a.relatedService2),a.relatedService1&&s.push(a.relatedService1))}return s}function G(e,t){var n=[];for(var s in scheduler._events){var i=scheduler._events[s];"service"===i.type&&isIntersect(i.start_date,i.end_date,e,t)&&(n.push(i.id),i.relatedTo&&n.push(i.relatedTo),i.relatedFather&&n.push(i.relatedFather),i.relatedService2&&n.push(i.relatedService2),i.relatedService1&&n.push(i.relatedService1))}return n}function V(){i(function(){var e=$(".gm-style-iw"),t=e.next();t.css({right:"12px",left:"",opacity:1})},0)}function U(e){return'<svg aria-hidden="true" class="slds-icon contextMenuIcon"><use xlink:href="'+e+'"></use></svg>'}function j(e){return'<svg aria-hidden="true" class="slds-icon contextMenuIcon"><use width="17px" height="17px" xlink:href="'+e+'"></use></svg>'}function z(){var e=r.GetUserSettingsProperty("locations");return e?e:[]}function q(e,t,n,s){if(60>e)return s.replaceAll([e]);var i=e%60,r=Math.round(e/60);return 0===i?n.replaceAll([r]):t.replace("$0",r).replace("$1",i)}function W(e){return customPermissions[e]}function K(){return"undefined"!=typeof sforce&&sforce&&!!sforce.one}var Z=void 0,X=[],J=[],Y=[],Q=[],ee={},te={},ne={},se={},ie={DateTime:"DATETIME",Date:"DATE",String:"STRING",TextArea:"TEXTAREA",Picklist:"PICKLIST",Reference:"REFERENCE",Currency:"CURRENCY"},re={show:!0},ae={minutes:"Minutes",hours:"Hours",days:"Days"};return n.getAllFormulaFields().then(function(e){Z=e}),n.getWorkOrderPriority().then(function(e){X.push.apply(X,_toConsumableArray(e))}),function(){ee.startHour=r.GetUserSettingsProperty("Gantt_View_Start_Hour__c"),null==ee.startHour&&(ee.startHour=0),ee.finishHour=r.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),null==ee.finishHour&&(ee.finishHour=24),ee.filterCandidates=r.GetUserSettingsProperty("Filter_Candidates__c"),null==ee.filterCandidates&&(ee.filterCandidates=!0),ee.servicesPerPage=r.GetUserSettingsProperty("Services_Per_Page__c"),null==ee.servicesPerPage&&(ee.servicesPerPage="75"),ee.resourceRowHeight=r.GetUserSettingsProperty("Resource_Row_Height__c"),null==ee.resourceRowHeight&&(ee.resourceRowHeight="medium"),ee.capacityDuration=r.GetUserSettingsProperty("View_Capacity_Type__c"),null==ee.capacityDuration&&(ee.capacityDuration="Day"),ee.backHorizon=r.GetUserSettingsProperty("Scheduling_horizon_limit__c"),null==ee.backHorizon&&(ee.backHorizon=14)}(),n.getCustomizationFiles().then(function(e){if(e&&e.CSS){var t=jQuery("<link>");t.attr({rel:"stylesheet",type:"text/css",href:e.CSS}),$("head").append(t)}e&&e.JS&&$.ajax({url:e.JS,dataType:"script"})}),window.openConsoleTabFromModal=function(e){a.isInConsole()&&sforce.console.generateConsoleUrl([e],function(e){sforce.console.openConsoleUrl(null,e.consoleUrl,!0)})},String.prototype.replaceAll=function(){for(var e=this,t=arguments.length,n=Array(t),s=0;t>s;s++)n[s]=arguments[s];for(var i=0;i<n.length;i++)e=e.replace("$"+i,n[i]);return e},n.getStatusFlow().then(function(e){if(e){angular.merge(te,e);for(var t in te)te[t]=te[t].sort()}})["catch"](function(e){console.warn("could not get status flow :("),console.log(e)}),n.getStatusTranslations().then(function(e){angular.merge(ne,e),window.statusTranslations=ne})["catch"](function(e){console.warn("could not get status translations :("),console.log(e)}),n.getStatuses().then(function(e){angular.merge(se,e)})["catch"](function(e){console.warn("could not get status :("),console.log(e)}),{getFilteredLocations:z,getSVGIconHTMLCustom:j,getSVGIconHTML:U,getRelatedServices:B,getServicesOfLocations:H,getServicesBetweenDates:G,getServiceDuration:N,safeApply:P,formatDayToString:R,showOnGantt:h,openConsoleTab:C,trust:k,openLink:L,openSObjectLink:w,getServiceInfoRowClass:T,isEmpty:_,generateResourceId:u,addNotification:f,addDaysToDate:p,setDatesByStartAndMode:m,sortByTime:b,getReports:d,getPolygons:v,intersectDates:y,getCSSClassForContext:S,fieldsTypes:ie,ganttSettings:ee,butlerNotifications:Q,getIdsOfSObjectsAbsence:O,showServiceList:re,checkBoxFields:function(){return Z},woPriorities:X,durationTypes:ae,statusFlow:te,statusTranslations:ne,statuses:se,convertDateBetweenTimeZones:A,convertDtToMomentDt:F,convertMomentDtToDt:M,getUserOffset:I,getLocationOffset:x,setMapCloseButtonPosition:V,getIdsOfSObjects:E,hoursMinutes:q,hasCustomPermission:W,formatDateWithDayOfWeek:D,isLightning:K}}e.$inject=["$q","$sce","sfdcService","$rootScope","$timeout","userSettingsManager","StateService","kpiCalculationsService","ResourcesAndTerritoriesService","$injector"],angular.module("serviceExpert").factory("utils",e)}(),function(){angular.module("serviceExpert").factory("sfdcService",["$q","$rootScope","userSettingsManager",function(e,t,n){function s(){var e=n.GetUserSettingsProperty("locations");return e?e:[]}function i(){return JSON.parse(n.GetUserSettingsProperty("Show_Orphan_Services__c"))}var r={servicesArray:[],servicesObjs:{},activeRequests:{active:0},firstTimeGettingEmployees:function(){return a}},a=e.defer();r.getEmployeesByLocation=function(){var t=e.defer();return r.resourcesUntouched?(t.resolve(angular.copy(r.resourcesUntouched)),t.promise):(r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getEmployeesByLocations,function(e,n){n.status?(r.resources=e,r.resourcesUntouched=angular.copy(e),r.activeRequests.active-=1,t.resolve(e)):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!0,timeout:12e4}),t.promise)},r.getUnPrivilegeUserSettingsFields=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getUnPrivilegeUserSettingsFields,function(e,n){n.status?(r.activeRequests.active-=1,t.resolve(e)):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!0,timeout:12e4}),t.promise},r.getAllFormulaFields=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getAllFormulaFields,function(e,n){n.status?(r.activeRequests.active-=1,t.resolve(e)):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!1,timeout:12e4}),t.promise};var o=null;r.getServiceListFields=function(){return null==o&&(o=e.defer(),r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceListFields,function(e,t){t.status?(r.activeRequests.active-=1,o.resolve(e)):(r.activeRequests.active-=1,o.reject(t))},{buffer:!1,escape:!1,timeout:12e4})),o.promise};var c=null;r.getGanttToolTipFields=function(){return null==c&&(c=e.defer(),r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceGanttTooltipFields,function(e,t){t.status?(r.activeRequests.active-=1,c.resolve(e)):(r.activeRequests.active-=1,c.reject(t))},{buffer:!1,escape:!1,timeout:12e4})),c.promise};var l=null;r.getServiceMiniFormFields=function(){return null==l&&(l=e.defer(),r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceMiniFormFields,function(e,t){t.status?(r.activeRequests.active-=1,l.resolve(e)):(r.activeRequests.active-=1,l.reject(t))},{buffer:!1,escape:!1,timeout:12e4})),l.promise};var u=null;r.getServiceMapInfoWindowFields=function(){return null==u&&(u=e.defer(),r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceMapInfoWindowFields,function(e,t){t.status?(r.activeRequests.active-=1,u.resolve(e)):(r.activeRequests.active-=1,u.reject(t))},{buffer:!1,escape:!1,timeout:12e4})),u.promise};var d=null;return r.getServiceCapacityColumns=function(){return null==d&&(d=e.defer(),r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceCapacityColumns,function(e,t){t.status?(r.activeRequests.active-=1,d.resolve(e)):(r.activeRequests.active-=1,d.reject(t))},{buffer:!1,escape:!1,timeout:12e4})),d.promise},r.getPolicies=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getPolicies,function(e,n){n.status?(r.activeRequests.active-=1,t.resolve(e)):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.sortServicesByPriority=function(t){var n=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.sortServicesByPriority,t,function(e,t){t.status?(r.activeRequests.active-=1,n.resolve(e)):(r.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.checkRules=function(n,s){var i=e.defer();return r.activeRequests.active+=1,t.policy||(t.policy=null),s||(s=t.policy),Visualforce.remoting.Manager.invokeAction(RemoteActions.checkRules,n,s,function(e,t){t.status?(r.activeRequests.active-=1,i.resolve(e)):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getDelta=function(t){var n=e.defer(),i=s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getDelta,t,i,function(e,t){t.status?n.resolve(e):n.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.postToChatter=function(t,n){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.postToChatter,t,n,function(e,t){t.status?(r.activeRequests.active-=1,s.resolve(e)):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.getLivePositions=function(){var t=e.defer();r.activeRequests.active+=1;var n=s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getLivePositions,n,function(e,n){n.status?(t.resolve(e),r.activeRequests.active-=1):(t.reject(n),r.activeRequests.active-=1)},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getSlots=function(t,n){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getSlots,t,n,function(e,t){var n={};n.value=e,n.eventType=t.type,"exception"==t.type&&(n.event=t,s.resolve(n),r.activeRequests.active-=1),t.status?(s.resolve(n),r.activeRequests.active-=1):(s.reject(t),r.activeRequests.active-=1)},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.getSkills=function(){var t=e.defer();s();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getSkills,function(e,n){n.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getPolygons=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getPolygons,function(e,n){n.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.savePolygon=function(t,n,s,i,a){var o=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.savePolygon,t,n,s,i,a,function(e,t){t.status?(o.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,o.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),o.promise},r.deletePolygon=function(t){var n=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.deletePolygon,t,function(e,t){t.status?(n.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.getLocale=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getLocale,function(e,n){n.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.autoScheduleService=function(t,n){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.autoScheduleService,t,n,function(e,t){t.status?(s.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.getDictionaries=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getDictionaries,function(e,n){n.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.unscheduleServicesByServicesId=function(t){var n=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.unscheduleServicesByServicesId,t,function(e,t){t.status?(n.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.unscheduleServicesByLocationsId=function(t,n,s){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.unscheduleServicesByLocationsId,t,n,s,function(e,t){t.status?(i.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getLocationsCurrentTime=function(t,n,s){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getLocationsCurrentTime,function(e,t){t.status?(i.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.changeStatusesByServicesId=function(t,n){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changeStatusesByServicesId,t,n,function(e,t){t.status?(s.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.changeStatusesByLocations=function(t,n,s,i,a){var o=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changeStatusesByLocations,t,n,s,i,a,function(e,t){t.status?(o.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,o.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),o.promise},r.keepAlive=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.keepAlive,function(e,t){t.status||("exception"===t.type?t.message.indexOf("Logged in")>-1&&(alert(customLabels.sessionTimedOut),location.reload()):console.log(customLabels.failed_to_refresh))},{buffer:!1,escape:!1,timeout:12e4})},r.getStatuses=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getStatuses,function(e,n){n.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getEmployeeAbsenceTypes=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getEmployeeAbsenceTypes,function(e,n){n.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getWorkOrderPriority=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getWorkOrderPriority,function(e,n){n.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getReports=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getReportsWithGeolocationCols,function(e,n){n.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getReportRowsForMap=function(t){var n=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getReportRowsForMap,t,function(e,t){t.status?(n.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.runOptimization=function(t,n,s,i,a,o,c){var l=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runOptimization,t,n,s,i,a,o,c,function(e,t){t.status?(l.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,l.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),l.promise},r.getRequestObject=function(t){var n=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getRequestObject,t,function(e,t){t.status?n.resolve(e):n.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.getCustomizationFiles=function(){var t=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getCustomizationFiles,function(e,n){n.status?t.resolve(e):t.reject(n)},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getShiftsInRange=function(t,n,i){var a=e.defer(),o=s();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getShifts,t,n,o,function(e,t){t.status?(a.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,a.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),a.promise},r.getOptimizationsRequest=function(){var t=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getOptimizationsRequest,function(e,n){n.status?t.resolve(e):t.reject(n)},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.saveChangesToBreak=function(t,n,i,a,o){var c=e.defer();r.activeRequests.active+=1;s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.saveChangesToBreak,t,n,i,a,o,function(e,t){t.status?(r.activeRequests.active-=1,c.resolve(e)):(r.activeRequests.active-=1,c.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),c.promise},r.deleteBreak=function(t){var n=e.defer();r.activeRequests.active+=1;s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.deleteBreak,t,function(e,t){t.status?(r.activeRequests.active-=1,n.resolve(e)):(r.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.getResourceFieldSetFields=function(){var t=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getResourceFieldSetFields,function(e,n){n.status?t.resolve(e):t.reject(n)},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getStatusTranslations=function(){var t=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getStatusTranslations,function(e,n){n.status?t.resolve(e):t.reject(n)},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getResourcePicklistValues=function(t){var n=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getResourcePicklistValues,t,function(e,t){t.status?n.resolve(e):n.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.GetResourcesAndTerritories=function(t){var n=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.GetResourcesAndTeritorries,t||s(),function(e,t){t.status?n.resolve(e):n.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.GetTimePhasedObjects=function(t,n,i){var a=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.GetTimePhasedObjects,t,n,i||s(),function(e,t){r.activeRequests.active-=1,t.status?a.resolve(e):a.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),a.promise},r.loadServiceAppointmentsToList=function(t,n,a,o){var c=e.defer(),l=i();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.LoadServiceAppointmentsToServiceList,t,s(),l,n,a,o,function(e,t){t.status?(c.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,c.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),c.promise},r.saveChangesToAbsence=function(t,n,s,i,a){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,c=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.saveChangesToAbsence,t,n,s,i,a,o,function(e,t){t.status?(c.resolve(e),r.activeRequests.active-=1):(c.reject(t),r.activeRequests.active-=1)},{buffer:!1,escape:!1,timeout:12e4}),c.promise},r.saveChangesToServiceAppointment=function(t,n,s,i,a,o,c){var l=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.saveChangesToServiceAppointment,t,n,s,i,a,o,c,function(e,t){t.status?(l.resolve(e),r.activeRequests.active-=1):(l.reject(t),r.activeRequests.active-=1)},{buffer:!1,escape:!1,timeout:12e4}),l.promise},r.changeStatusServicesByServicesId=function(t,n){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changeStatusServicesByServicesId,t,n,function(e,t){t.status?(s.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.changeStatusServicesByLocationsId=function(t,n,s,i){var a=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changeStatusServicesByLocationsId,t,n,s,i,function(e,t){t.status?(a.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,a.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),a.promise},r.deleteResourceAbsence=function(t){var n=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.deleteResourceAbsence,t,function(e,t){t.status?(n.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.getStatusFlow=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getStatusFlow,function(e,n){n.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getStatuses=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getStatuses,function(e,n){n.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.changePin=function(t,n){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changePins,t,n,function(e,t){t.status?(s.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.setServiceAppointmentsInJeopardy=function(t){var n=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.setServiceAppointmentsInJeopardy,t,function(e,t){t.status?(n.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.getOptimizationRequests=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getOptimizationRequests,s(),i(),function(e,n){n.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(n))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.runFillInSchedule=function(t,n,s){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runFillInSchedule,t,n,s,function(e,t){t.status?(i.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.runFixOverlaps=function(t,n,s){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runFixOverlaps,t,n,s,function(e,t){t.status?(i.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.runGroupNearby=function(t,n){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runGroupNearby,t,n,function(e,t){t.status?(s.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.runReshuffle=function(t,n){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runReshuffle,t,n,function(e,t){t.status?(s.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.getResourceActualRoute=function(t,n){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getResourceActualRoute,t,n,function(e,t){t.status?(s.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.getFslOperation=function(t){var n=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getFslOperation,t,function(e,t){t.status?(n.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.getServicesById=function(t){var n=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServicesById,t,function(e,t){t.status?(n.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r}])}(),function(){function e(e,t,n,s,i,r){function a(a){u=e.$new(!0),u.lightboxAbsence=t.resourceAbsences()[a],u.selectedTab="details",u.urls={chatter:n.trustAsResourceUrl(customAbsenceChatterPage+"?id="+a).toString(),details:n.trustAsResourceUrl(customAbsencePage+"?id="+a).toString()},u.changeTab=c,u.closeLightbox=o,u.chatterAvailable=fieldTrackingEnabled.absence,u.openConsoleTab=i.openConsoleTab;var d=l();d.find("#AbsenceLightbox").draggable({handle:"#AbsenceLightboxHeader"}),r.setLightBoxStatus(),u.$on("$destroy",function(){return d.remove()}),u.$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)}),s(d)(u),i.safeApply(u,function(){angular.element("body").append(d)})}function o(){r.setLightBoxStatus(!1),u.$destroy()}function c(e){e!==u.selectedTab&&(u.selectedTab=e)}function l(){return angular.element('<div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="AbsenceLightbox">\n\n                        <div class="lightboxHeaderContainer" id="AbsenceLightboxHeader">\n\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n\n                            <h1 class="lightboxHeader">\n                                <i ng-show="lightboxAbsence.type == \'na\'">'+customLabels.NA+":</i>\n                                <i ng-show=\"lightboxAbsence.type == 'break'\">"+customLabels.Break+":</i>\n                                {{ lightboxAbsence.name }}\n                            </h1>\n\n                            <span ng-click=\"changeTab('details')\" ng-class=\"{lightboxSelectedTab: selectedTab == 'details'}\">\n                                "+customLabels.Details+'\n                            </span>\n\n                            <span ng-show="chatterAvailable" ng-click="changeTab(\'chatter\')" ng-class="{lightboxSelectedTab: selectedTab == \'chatter\'}">\n                                '+customLabels.Chatter+'\n                            </span>\n\n                            <div class="ExtendedForm">\n                                <a ng-click="openConsoleTab($event,lightboxAbsence.id)" target="_blank" href="../{{ lightboxAbsence.id }}" title="'+customLabels.ExtandedForm+'">\n                                    <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                        \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                    \u2028</svg>\n                                </a>\n                            </div>\n                        </div>\n\n                        <iframe ng-show="selectedTab == \'details\'" ng-src="{{ urls.details }}"></iframe>\n                        <iframe ng-show="selectedTab == \'chatter\'" ng-src="{{ urls.chatter }}"></iframe>\n\n                    </div>\n                </div>')}var u=null;return{open:a}}e.$inject=["$rootScope","TimePhasedDataService","$sce","$compile","utils","StateService"],angular.module("serviceExpert").factory("AbsenceLightboxService",e)}(),function(){function e(e,t,n,s,i,r){function a(s,a){var o=e.defer(),c=new Date(a.start_date.getTime()+1e3*a.travelTo),l=new Date(a.end_date.getTime()-1e3*a.travelFrom);
if(useLocationTimezone){var u=t.getIntersectingSrstOffset(a,a.getGanttResource()),d=r.getUserOffset(c),v=r.getUserOffset(l);c.setMinutes(c.getMinutes()+d-u),l.setMinutes(l.getMinutes()+v-u)}return n.saveChangesToAbsence(a.id,a.getGanttResource(),c,l,a.absenceType,a.ganttLabel).then(function(e){if(e.error)return void o.reject([e,s]);var n={};n.absences=t.updateTimePhaseData(e.resourceAbsences,"na").absences,n.services=t.updateTimePhaseData(e.services,"service").services;var a=[];a.push.apply(a,_toConsumableArray(n.services).concat(_toConsumableArray(n.absences)));var c=a.map(function(e){return e.id});c.length&&i.checkRules(r.getRelatedServices(c)).then(function(){return scheduler.updateView()}),o.resolve(n)})["catch"](function(e){o.reject([e,s])}),o.promise}function o(s){var a=e.defer();if(useLocationTimezone){var o=t.getIntersectingSrstOffset(s,s.resource),c=r.getUserOffset(s.start_date),l=r.getUserOffset(s.end_date);s.start_date.setMinutes(s.start_date.getMinutes()+c-o),s.end_date.setMinutes(s.end_date.getMinutes()+l-o)}return n.saveChangesToAbsence(null,s.resource,s.start_date,s.end_date,s.absenceType,s.ganttLabel).then(function(e){if(e.error)return void a.reject(e);var n={};n.absences=t.updateTimePhaseData(e.resourceAbsences,"na").absences,n.services=t.updateTimePhaseData(e.services,"service").services;var s=[];s.push.apply(s,_toConsumableArray(n.services).concat(_toConsumableArray(n.absences)));var o=s.map(function(e){return e.id});o.length&&i.checkRules(r.getRelatedServices(o)).then(function(){return scheduler.updateView()}),a.resolve(n)})["catch"](function(e){a.reject(e)}),a.promise}function c(t){var i=e.defer();return n.deleteResourceAbsence(t).then(function(e){s.getDelta()})["catch"](function(e){i.reject(e)}),i.promise}function l(){var t=e.defer();return n.getEmployeeAbsenceTypes().then(function(e){if(e){for(var n=0;n<e.length;n++)u.push(e[n]);t.resolve(u)}})["catch"](function(e){t.reject(e)}),t.promise}var u=[];return{saveChangesToAbsence:a,saveNewAbsence:o,deleteAbsence:c,getEmployeeAbsenceTypes:l}}e.$inject=["$q","TimePhasedDataService","sfdcService","DeltaService","servicesService","utils"],angular.module("serviceExpert").factory("AbsencesService",e)}(),function(){function e(e,t,n,s,i,r,a,o,c){function l(){_=t.$new(!0),_.$on("keypress",function(e,t){27==t.which&&_.$evalAsync(_.closeLightbox)});var a=i.GetUserSettingsProperty("locations");_.filteredLocations=a.map(function(e){return n.territories[e]}),_.selectedCount=s.countSelectedServices(),_.contractorSupport=r.areContractorsSupported(),p(),_.dateSelectFinishWidget=d,_.dateSelectStartWidget=v,_.validateDatesStart=h,_.validateDatesEnd=g,_.targetServices=0==_.selectedCount?"locations":"selectedServices",_.bulkState="form",_.bulkCancel=b,_.results={},_.toggleFlag=m,_.isFlagged=f,_.getServiceName=S,_.selectedLocations={},_.nothingToDispatch=!1;var o=y();o.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(o),_.closeLightbox=u,_.$on("$destroy",function(){return o.remove()}),e(o)(_),o.show(),r.setLightBoxStatus()}function u(){"running"!==_.bulkState&&(r.setLightBoxStatus(!1),_.$destroy())}function d(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(_.actionFinish),navigation:!0,handler:function(e,t){var n=new Date(e);n.setMinutes(parseInt(_.endMinutes)),n.setHours(parseInt(_.endHour)),n<_.actionStart?alert(customLabels.finishAfterStart):_.actionFinish=n,scheduler.destroyCalendar(),_.$apply()}})}function v(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(_.actionStart),navigation:!0,handler:function(e,t){var n=new Date(e);n.setMinutes(parseInt(_.startMinutes)),n.setHours(parseInt(_.startHour)),n>_.actionFinish?alert(customLabels.startBeforeEnd):_.actionStart=n,scheduler.destroyCalendar(),_.$apply()}})}function h(){var e=new Date(_.actionStart);e.setMinutes(parseInt(_.startMinutes)),e.setHours(parseInt(_.startHour)),e>=_.actionFinish?(alert(customLabels.startBeforeEnd),_.startMinutes=_.actionStart.getMinutes(),_.startHour=_.actionStart.getHours().toString()):_.actionStart=e}function g(){var e=new Date(_.actionFinish);e.setMinutes(parseInt(_.endMinutes)),e.setHours(parseInt(_.endHour)),e<=_.actionStart?(alert(customLabels.finishAfterStart),_.endMinutes=_.actionFinish.getMinutes().toString(),_.endHour=_.actionFinish.getHours().toString()):_.actionFinish=e}function p(){_.minutes=T,_.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],_.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),_.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),_.startHour="0",_.endHour="0",_.startMinutes="0",_.endMinutes="0"}function m(e){a.flagged[e]=!a.flagged[e]}function f(e){return a.flagged[e]}function S(e){return o.serviceAppointments()[e].name}function b(){var e=[],t=void 0,n=void 0;if("locations"===_.targetServices){t=_.actionStart,n=_.actionFinish,t.setHours(_.startHour),t.setMinutes(_.startMinutes),t.setHours(_.endHour),t.setMinutes(_.endMinutes);for(var i in _.selectedLocations)_.selectedLocations[i]&&e.push(i);if(0===e.length)return void alert(customLabels.noLocationWasSelected)}else e=s.getSelected();r.setBulkActionRunning(),_.bulkState="running",a.changeStatus(e,c.CANCELED,t,n).then(function(t){if(t.nothingToDispatch)return void(_.nothingToDispatch=!0);a.drawServicesAndAbsences(t.services),_.results.canceled=[],e="locations"===_.targetServices?t.services.map(function(e){return e.id}):e;for(var n=0;n<e.length;n++)o.serviceAppointments()[e[n]].status===c.CANCELED&&_.results.canceled.push(o.serviceAppointments()[e[n]]);_.results.failed=Object.keys(t.failedResults).length>0?t.failedResults:null})["catch"](function(e){console.warn("bulk cancel failed :("),console.log(e)})["finally"](function(){r.setBulkActionRunning(!1),_.bulkState="finished"})}function y(){var e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n							</select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>');return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer LightboxContainerAnimation" id="BulkActionsLightbox">\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                            \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                        \u2028</svg>\n                        <h1 class="light-box-header">'+customLabels.BulkCancel+'</h1>\n                    </div>\n\n                    <div ng-show="bulkState == \'finished\'">\n\n                        <div ng-show="nothingToDispatch" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n\n                        <div ng-show="results.canceled.length" class="lightboxResultContainer">\n\n                            <div class="unscheduleTableTitle">'+customLabels.SuccessfullyCanceled+'</div>\n\n                            <div ng-repeat="dispatced in results.canceled" class="lightboxTableRow">\n                                {{ dispatced.name }}\n                                <div ng-click="toggleFlag(dispatced.id)" class="bulkActionLightboxFlag">\n                                    <span ng-show="isFlagged(dispatced.id)">'+customLabels.Unflag+'</span>\n                                    <span ng-show="!isFlagged(dispatced.id)">'+customLabels.Flag+'</span>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div ng-show="results.failed" class="lightboxResultContainer">\n                            <div class="unscheduleTableTitle">'+customLabels.FailToCancel+'</div>\n                            <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                <span>{{ failedReason.errorMessage }}</span>\n\n                                <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                    <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                    <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                </div>\n\n                            </div>\n                        </div>\n\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.CancelingPleaseWait+'\n                    </div>\n\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.CancelLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ \''+customLabels.x_selected+'\' | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+"</label>\n                                </div>\n\n                                <div class=\"bulkOptimizeOptions\" ng-class=\"{'disabled-area': targetServices != 'locations'}\">\n                                    "+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="bulkCancel()">'+customLabels.CancelServices+"</div>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            ")}for(var _=null,T=[],L=0;60>L;L++)T.push(L);return{open:l}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService","SERVICE_STATUS"],angular.module("serviceExpert").factory("bulkCancelService",e)}(),function(){function e(e,t,n,s,i,r,a,o,c){function l(){_=t.$new(!0),_.$on("keypress",function(e,t){27==t.which&&_.$evalAsync(_.closeLightbox)});var a=i.GetUserSettingsProperty("locations");_.filteredLocations=a.map(function(e){return n.territories[e]}),_.selectedCount=s.countSelectedServices(),_.contractorSupport=r.areContractorsSupported(),p(),_.dateSelectFinishWidget=d,_.dateSelectStartWidget=v,_.validateDatesStart=h,_.validateDatesEnd=g,_.targetServices=0==_.selectedCount?"locations":"selectedServices",_.bulkState="form",_.bulkDispatch=b,_.results={},_.toggleFlag=m,_.isFlagged=f,_.getServiceName=S,_.selectedLocations={},_.nothingToDispatch=!1,_.isAmpm=isAMPM?"ampm":"24",_.selectedMashu=customLabels.x_selected;var o=y();o.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(o),_.closeLightbox=u,_.$on("$destroy",function(){return o.remove()}),e(o)(_),o.show(),r.setLightBoxStatus()}function u(){"running"!==_.bulkState&&(r.setLightBoxStatus(!1),_.$destroy())}function d(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(_.actionFinish),navigation:!0,handler:function(e,t){var n=new Date(e);n.setMinutes(parseInt(_.endMinutes)),n.setHours(parseInt(_.endHour)),n<_.actionStart?alert(customLabels.finishAfterStart):_.actionFinish=n,scheduler.destroyCalendar(),_.$apply()}})}function v(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(_.actionStart),navigation:!0,handler:function(e,t){var n=new Date(e);n.setMinutes(parseInt(_.startMinutes)),n.setHours(parseInt(_.startHour)),n>_.actionFinish?alert(customLabels.startBeforeEnd):_.actionStart=n,scheduler.destroyCalendar(),_.$apply()}})}function h(){var e=new Date(_.actionStart);e.setMinutes(parseInt(_.startMinutes)),e.setHours(parseInt(_.startHour)),e>=_.actionFinish?(alert(customLabels.startBeforeEnd),_.startMinutes=_.actionStart.getMinutes(),_.startHour=_.actionStart.getHours().toString()):_.actionStart=e}function g(){var e=new Date(_.actionFinish);e.setMinutes(parseInt(_.endMinutes)),e.setHours(parseInt(_.endHour)),e<=_.actionStart?(alert(customLabels.finishAfterStart),_.endMinutes=_.actionFinish.getMinutes().toString(),_.endHour=_.actionFinish.getHours().toString()):_.actionFinish=e}function p(){_.minutes=T,_.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],_.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),_.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),_.startHour="0",_.endHour="0",_.startMinutes="0",_.endMinutes="0"}function m(e){a.flagged[e]=!a.flagged[e]}function f(e){return a.flagged[e]}function S(e){return o.serviceAppointments()[e].name}function b(){var e=[],t=void 0,n=void 0;if("locations"===_.targetServices){t=_.actionStart,n=_.actionFinish,t.setHours(_.startHour),t.setMinutes(_.startMinutes),n.setHours(_.endHour),n.setMinutes(_.endMinutes);for(var i in _.selectedLocations)_.selectedLocations[i]&&e.push(i);if(0===e.length)return void alert(customLabels.noLocationWasSelected)}else e=s.getSelected();r.setBulkActionRunning(),_.bulkState="running",a.changeStatus(e,c.DISPATCHED,t,n).then(function(t){if(t.nothingToDispatch)return void(_.nothingToDispatch=!0);a.drawServicesAndAbsences(t.services),_.results.dispatched=[],e="locations"===_.targetServices?t.services.map(function(e){return e.id}):e;for(var n=0;n<e.length;n++)o.serviceAppointments()[e[n]].status===c.DISPATCHED&&_.results.dispatched.push(o.serviceAppointments()[e[n]]);_.results.failed=Object.keys(t.failedResults).length>0?t.failedResults:null})["catch"](function(e){console.warn("bulk dispatch failed :("),console.log(e)})["finally"](function(){r.setBulkActionRunning(!1),_.bulkState="finished"})}function y(){var e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n							</select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>');return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer LightboxContainerAnimation" id="BulkActionsLightbox">\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" id="CloseDispatchLightbox">\n                            \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                        \u2028</svg>\n                        <h1 class="light-box-header">'+customLabels.BulkDispatch+'</h1>\n                    </div>\n\n                    \n                    <div id="ori-ohev-banim" ng-show="bulkState == \'finished\'">\n                        <div ng-show="bulkState == \'finished\'">\n    \n                            <div ng-show="nothingToDispatch" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n    \n                            <div ng-show="results.dispatched.length" class="lightboxResultContainer dispatchResultsContainer1">\n    \n                                <div class="unscheduleTableTitle">'+customLabels.SuccessfullyDispatched+'</div>\n    \n                                <div ng-repeat="dispatced in results.dispatched" class="lightboxTableRow">\n                                    {{ dispatced.name }}\n                                    <div ng-click="toggleFlag(dispatced.id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(dispatced.id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(dispatced.id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">'+customLabels.FailToDispatch+'</div>\n                                <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span>{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n    \n                        </div>\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.DispatchingPleaseWait+'\n                    </div>\n\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.DispatchLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ selectedMashu | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+"</label>\n                                </div>\n\n                                <div class=\"bulkOptimizeOptions\" ng-class=\"{'disabled-area': targetServices != 'locations'}\">\n                                    "+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="bulkDispatch()">'+customLabels.Dispatch+"</div>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            ")}for(var _=null,T=[],L=0;60>L;L++)T.push(L);return{open:l}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService","SERVICE_STATUS"],angular.module("serviceExpert").factory("bulkDispatchService",e)}(),function(){function e(e,t,n,s,i){function r(s,r){d=i.get("servicesService"),v=t.$new(!0),v.getServiceName=c,v.results={success:[],failed:Object.keys(s.failedResults).length>0?s.failedResults:null},v.labels=r,v.toggleFlag=a,v.isFlagged=o;for(var h=0;h<s.services.length;h++)s.failedResults[s.services[h].Id]||v.results.success.push(s.services[h].Id);v.$on("keypress",function(e,t){27==t.which&&v.$evalAsync(v.closeLightbox)});var g=u();g.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(g),v.closeLightbox=l,v.$on("$destroy",function(){return g.remove()}),e(g)(v),g.show(),n.setLightBoxStatus()}function a(e){d.flagged[e]=!d.flagged[e]}function o(e){return d.flagged[e]}function c(e){return s.serviceAppointments()[e].name}function l(){n.setLightBoxStatus(!1),v.$destroy()}function u(){return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer LightboxContainerAnimation" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.BulkActionResults+'</h1>\n                        </div>\n\n                        <div class="resultsContainerOverflow">\n                            <div ng-show="results.success && results.success.length" class="lightboxResultContainer">\n    \n                                <div class="unscheduleTableTitle">{{labels.success}}</div>\n    \n                                <div ng-repeat="id in results.success" class="lightboxTableRow">\n                                    {{ getServiceName(id) }}\n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed && results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">{{labels.fail}}</div>\n                                <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span class="BulkResultLine">{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+"</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                </div>\n            ")}for(var d=null,v=null,h=[],g=0;60>g;g++)h.push(g);return{open:r}}e.$inject=["$compile","$rootScope","StateService","TimePhasedDataService","$injector"],angular.module("serviceExpert").factory("bulkResultsService",e)}(),function(){function e(e,t,n,s,i){function r(s){var r=null;v=i.get("servicesService"),r=t.$new(!0),r.toggleFlag=c,r.isFlagged=l,r.results=s,r.getService=o,r.isError=a,r.successfullyScheduled=0,r.globalSelectedCount=Object.keys(s).length,r.replaceLabelsForSebas=function(){return customLabels.x_services_scheduled_of_y_here_are_results.replaceAll(r.successfullyScheduled,r.globalSelectedCount)};for(var h in s)"scheduled"===s[h]&&r.successfullyScheduled++;r.$on("keypress",function(e,t){27==t.which&&r.$evalAsync(r.closeLightbox)}),r.closeLightbox=u,r.$on("$destroy",function(){return g.remove()});var g=d();g.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),e(g)(r),angular.element("body").append(g),g.show(),n.setLightBoxStatus()}function a(e){return angular.isObject(e)}function o(e){return s.serviceAppointments()[e]}function c(e){v.flagged[e]=!v.flagged[e]}function l(e){return v.flagged[e]}function u(e){n.setLightBoxStatus(!1),e.$destroy()}function d(){return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer LightboxContainerAnimation" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox(this)" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.BulkScheduleResults+'</h1>\n                        </div>\n\n                        <div style="padding:0 15px">\n                        \n                            <p>{{ replaceLabelsForSebas() }}</p>\n            \n                            <div id="ResultTableHeader">\n                                <span>'+customLabels.ID+'</span>\n                                <span id="ResultHeaderStart">'+customLabels.Start+"</span>\n                                <span>"+customLabels.Finish+'</span>\n                                <span id="ResultResourceHeader">'+customLabels.Resource+'</span>\n                            </div>\n            \n                            <div id="ScheduledResultsTable">\n                                <div ng-repeat="(id,res) in results" class="ScheduleResultRow">\n                                    <span class="scheduledResultColName">{{ getService(id).name }}</span>\n                                    <span class="scheduledResultDate" ng-if="res == \'scheduled\'">{{getService(id).start | amDateFormat:\'lll\'}}</span>\n                                    <span class="scheduledResultDate" ng-if="res == \'scheduled\'">{{getService(id).finish | amDateFormat:\'lll\'}}</span>\n                                    <span class="scheduledResultDate" ng-if="res == \'scheduled\'">{{getService(id).resourceName}}</span>\n                                    <span class="ScheduleResultUnscheduled" ng-if="isError(res)">'+customLabels.ErrorNekudotaim+' {{ res.msg }}</span>\n                                    <!--<span class="ScheduleResultUnscheduled" ng-if="isError(res)">'+customLabels.NoCandidates+'</span>-->\n                                    <span class="ScheduleResultUnscheduled" ng-if="res == \'no candidates\'">'+customLabels.NoCandidates+'</span>\n                                    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+"</span>\n                                    </div>\n                                </div>\n                            </div>\n                            \n                        </div>\n                    </div>\n\n                </div>\n            ");
}var v=null;return{open:r}}e.$inject=["$compile","$rootScope","StateService","TimePhasedDataService","$injector"],angular.module("serviceExpert").factory("bulkScheduleResultsService",e)}(),function(){function e(e,t,n,s,i,r,a,o){function c(){g=n.$new(!0),g.isInConsole=r.isInConsole(),g.actionName="Schedule",g.currentSchedulingIndex=0,g.successfullyScheduled=0,g.afterSchedulingServiceObjects={},g.close=l,g.showResults=u,g.progressBarStyle=d,g.getLabel=function(e){return customLabels[e]};var e=h();angular.element("body").append(e),g.$on("$destroy",function(){return e.remove()}),t(e)(g),e.show()}function l(){g.$destroy()}function u(){a.open(g.afterSchedulingServiceObjects),g.$destroy()}function d(){return{width:(g.currentSchedulingIndex+1)/g.globalSelectedCount*100+"%"}}function v(t){0===t.length||r.isScheduleRunning||(g&&g.$destroy(),c(),r.isScheduleRunning=!0,g.globalSelectedCount=t.length,s.sortServicesByPriority(t).then(function(t){function n(e){r.schedulingRunningFor[o[e].id]=!0,s.autoScheduleService(o[e].id).then(function(t){s.drawServicesAndAbsences(t.services,t.absences),i.serviceAppointments()[o[e].id].isScheduled()&&!i.serviceAppointments()[o[e].id].violations&&g.successfullyScheduled++,g.afterSchedulingServiceObjects[o[e].id]="no candidates",t.services.forEach(function(t){t.id==o[e].id&&(g.afterSchedulingServiceObjects[o[e].id]="scheduled")})})["catch"](function(t){var n={};n.msg=t.message,g.afterSchedulingServiceObjects[o[e].id]=n})["finally"](function(){if(g.currentSchedulingIndex++,r.schedulingRunningFor[o[e].id]=!1,e+1<g.globalSelectedCount&&a[e+1].resolve(e+1),e+1==g.globalSelectedCount){var t=[];for(var n in scheduler._events)"service"===scheduler._events[n].type&&t.push(n);t.length>0&&s.checkRules(t).then(function(){return scheduler.updateView()}),r.isScheduleRunning=!1}})}var a=[],o=[];t.forEach(function(e){o.push(i.serviceAppointments()[e.ServiceId])}),g.globalSelectedServiceObjects=o;for(var c=0;c<g.globalSelectedCount;c++){var l=e.defer();l.promise.then(n),a.push(l)}a[0].resolve(0)}))}function h(){return angular.element('\n            <div id="SchedulingInProgress" class="slideInProgressBox" ng-class="{SchedulingInProgressConsole: isInConsole}">\n\n				<div ng-show="currentSchedulingIndex != globalSelectedCount">\n					<i class="fa fa-spinner fa-spin"></i> '+customLabels.Scheduling_Services+'\n					<div class="ProgressBar">\n						<div ng-style="progressBarStyle()"></div>\n					</div>\n\n					<div ng-cloak class="ProgressBarLabel">{{ getLabel(\'Scheduling_service\') | replaceLabels : (currentSchedulingIndex+1) : globalSelectedCount }}</div>\n				</div>\n\n				<div ng-show="currentSchedulingIndex == globalSelectedCount">\n					<i class="fa fa-check"></i> '+customLabels.Scheduling_Complete+'\n					<div ng-cloak class="HowManyWereScheduled">{{  getLabel(\'Scheduled_x_out_of_y\') | replaceLabels : successfullyScheduled : globalSelectedCount }}</div>\n					<span ng-cloak class="InProgressAction" ng-click="close()">'+customLabels.Close+'</span>\n					<span ng-cloak class="InProgressAction" ng-click="showResults()">'+customLabels.View_services+"</span>\n				</div>\n\n			</div>")}var g=null;return{schedule:v}}e.$inject=["$q","$compile","$rootScope","servicesService","TimePhasedDataService","StateService","bulkScheduleResultsService","utils"],angular.module("serviceExpert").factory("bulkScheduleService",e)}(),function(){function e(e,t,n,s,i,r,a,o){function c(){y=t.$new(!0),y.$on("keypress",function(e,t){27==t.which&&y.$evalAsync(y.closeLightbox)});var a=i.GetUserSettingsProperty("locations");y.filteredLocations=a.map(function(e){return n.territories[e]}),y.selectedCount=s.countSelectedServices(),y.contractorSupport=r.areContractorsSupported(),g(),y.dateSelectFinishWidget=u,y.dateSelectStartWidget=d,y.validateDatesStart=v,y.validateDatesEnd=h,y.targetServices=0==y.selectedCount?"locations":"selectedServices",y.bulkState="form",y.bulkUnschedule=S,y.results={},y.toggleFlag=p,y.isFlagged=m,y.getServiceName=f,y.selectedLocations={},y.nothingToUnschedule=!1,y.isAmpm=isAMPM?"ampm":"24",y.exception=null;var o=b();o.find("#UnschduleLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(o),y.closeLightbox=l,y.getCustomLabel=function(e){return customLabels[e]},y.$on("$destroy",function(){return o.remove()}),e(o)(y),o.show(),r.setLightBoxStatus()}function l(){"running"!==y.bulkState&&(r.setLightBoxStatus(!1),y.$destroy())}function u(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(y.actionFinish),navigation:!0,handler:function(e,t){var n=new Date(e);n.setMinutes(parseInt(y.endMinutes)),n.setHours(parseInt(y.endHour)),n<y.actionStart?alert(customLabels.finishAfterStart):y.actionFinish=n,scheduler.destroyCalendar(),y.$apply()}})}function d(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(y.actionStart),navigation:!0,handler:function(e,t){var n=new Date(e);n.setMinutes(parseInt(y.startMinutes)),n.setHours(parseInt(y.startHour)),n>y.actionFinish?alert(customLabels.startBeforeEnd):y.actionStart=n,scheduler.destroyCalendar(),y.$apply()}})}function v(){var e=new Date(y.actionStart);e.setMinutes(parseInt(y.startMinutes)),e.setHours(parseInt(y.startHour)),e>=y.actionFinish?(alert(customLabels.startBeforeEnd),y.startMinutes=y.actionStart.getMinutes(),y.startHour=y.actionStart.getHours().toString()):y.actionStart=e}function h(){var e=new Date(y.actionFinish);e.setMinutes(parseInt(y.endMinutes)),e.setHours(parseInt(y.endHour)),e<=y.actionStart?(alert(customLabels.finishAfterStart),y.endMinutes=y.actionFinish.getMinutes().toString(),y.endHour=y.actionFinish.getHours().toString()):y.actionFinish=e}function g(){y.minutes=_,y.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],y.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),y.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),y.startHour="0",y.endHour="0",y.startMinutes="0",y.endMinutes="0"}function p(e){a.flagged[e]=!a.flagged[e]}function m(e){return a.flagged[e]}function f(e){return o.serviceAppointments()[e].name}function S(){var e=[],t=void 0,n=void 0;if("locations"===y.targetServices){t=y.actionStart,n=y.actionFinish,t.setHours(y.startHour),t.setMinutes(y.startMinutes),n.setHours(y.endHour),n.setMinutes(y.endMinutes);for(var i in y.selectedLocations)y.selectedLocations[i]&&e.push(i);if(0===e.length)return void alert(customLabels.noLocationWasSelected)}else e=s.getSelected();r.setBulkActionRunning(),y.bulkState="running",a.unscheduleServices(e,t,n).then(function(t){if(t.nothingToUnschedule)return void(y.nothingToUnschedule=!0);a.drawServicesAndAbsences(t.services,t.absences,[],t.capacities),y.results.unscheduled=[],e="locations"===y.targetServices?t.services.map(function(e){return e.id}):e;for(var n=0;n<e.length;n++)o.serviceAppointments()[e[n]].isScheduled()||y.results.unscheduled.push(o.serviceAppointments()[e[n]]);y.results.failed=Object.keys(t.failedResults).length>0?t.failedResults:null})["catch"](function(e){console.warn("bulk unschedule failed :("),console.log(e),y.exception=e})["finally"](function(){r.setBulkActionRunning(!1),y.bulkState="finished"})}function b(){var e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n							</select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>');return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer LightboxContainerAnimation" id="BulkActionsLightbox">\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                            \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                        \u2028</svg>\n                        <h1 class="light-box-header">'+customLabels.BulkUnschedule+'</h1>\n                    </div>\n\n                    <div ng-show="bulkState == \'finished\'">\n\n\n                        <div ng-show="nothingToUnschedule" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n\n                        <div class="resultsContainerOverflow class="unschedule_res_thingy_qa_halash">\n                        \n                            <div class="bulk-exception" ng-show="exception">\n                                <svg aria-hidden="true" class="slds-icon kpiIcon">\n                                    \u2028<use xlink:href="'+lsdIcons.violation+'"></use>\n                                \u2028</svg>\n                                {{ exception.message }} \n                            </div>\n                        \n                            <div ng-show="results.unscheduled.length" class="lightboxResultContainer">\n    \n                                <div class="unscheduleTableTitle">'+customLabels.SuccessfullyUnscheduled+'</div>\n    \n                                <div ng-repeat="unscheduled in results.unscheduled track by $index" class="lightboxTableRow">\n                                    {{ unscheduled.name }}\n                                    <div ng-click="toggleFlag(unscheduled.id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(unscheduled.id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(unscheduled.id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">'+customLabels.FailToUnschedule+'</div>\n                                <div ng-repeat="(id, failedReason) in results.failed track by $index" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span>{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n                        </div>\n\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.UnschedulingPleaseWait+'\n                    </div>\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.UnscheduleLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ getCustomLabel(\'x_selected\') | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+'</label>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    '+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="bulkUnschedule()">'+customLabels.Unschedule+"</div>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            ")}for(var y=null,_=[],T=0;60>T;T++)_.push(T);return{open:c}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService"],angular.module("serviceExpert").factory("bulkUnscheduleService",e)}(),function(){angular.module("serviceExpert").factory("calendarsService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils",function(e,t,n,s){function i(){f={},S={},b={},y.resourceToWorkingDates=b}function r(n,i,r){for(var o=new Date(n),c=null;i>o;){var l=s.formatDayToString(o);if(!f[l]){f[l]=!0,c||(c=m(t.resourcesAndTerritories()));var u=new Date(o);u.setDate(u.getDate()+1);for(var d in e.getResources())a(new Date(o),new Date(u),d,c[d])}o.setDate(o.getDate()+1)}}function a(t,n,i,r,a){var l={P:[],R:[],S:[]},u={};for(var v in r){for(var h=r[v].slice(),f=s.generateResourceId(i,v),b=t,y=0;y<h.length;y++){var _=h[y],T=s.intersectDates({start:b,finish:n},_);if(l[_.type].push(_),"S"!=_.type){if(T.intersection){for(var L=0;L<T.remainderFrom1.length;L++){var w=T.remainderFrom1[L];w.isStart&&p(w.start,w.finish,f)}"R"!=_.type||S[_.id]||a||g(_,r,i),b=T.intersection.finish;var k=_.operatingHours||e.allTerritories[v].operatingHours;k?d(T.intersection.start,T.intersection.finish,k,f,a):p(T.intersection.start,T.intersection.finish,f)}}else u[_.serviceTerritory]=_}b.getTime()==n.getTime()||u[f.split("_")[1]]||p(b,n,f)}if(showSecondarySTMs&&!s.isEmpty(u)&&!a){var C=o(l,i,u),R=m(C);c(t,n,i,R[i],!0)}}function o(e,t,n){var i={};i[t]={};for(var r=0;r<e.P.length;r++){var a=e.P[r];if(0!=e.R.length)for(var o=0;o<e.R.length;o++){var c=e.R[o],l=s.intersectDates(a,c);if(l.intersection||(i[t][a.id]=a),l.remainderFrom1.length>0)for(var u=0;u<l.remainderFrom1.length;u++){var d=angular.copy(a);d.start=l.remainderFrom1[u].start,d.finish=l.remainderFrom1[u].finish,i[t][a.id+"_"+u]=d}if(!i[t][c.id]){var v=angular.copy(c);v.serviceTerritory=a.serviceTerritory,i[t][v.id]=v}}else i[t][a.id]=a}var h={};h[t]={};for(var g=0;g<e.S.length;g++){var p=e.S[g];for(var m in i[t]){var f=i[t][m],S=s.intersectDates(f,p);if(S.intersection){var b=angular.copy(f);b.start=S.intersection.start,b.finish=S.intersection.finish,b.ohTerr=b.serviceTerritory,b.serviceTerritory=p.serviceTerritory,h[t][m+"_"+g]=b}}}return h}function c(t,n,i,r,a){for(var o in r){for(var c=r[o].slice(),l=s.generateResourceId(i,o),u=t,v=0;v<c.length;v++){var h=c[v],g=s.intersectDates({start:u,finish:n},h);if(g.intersection){for(var m=0;m<g.remainderFrom1.length;m++){var f=g.remainderFrom1[m];f.isStart&&p(f.start,f.finish,l)}u=g.intersection.finish;var S=h.operatingHours||e.allTerritories[h.ohTerr].operatingHours;S?d(g.intersection.start,g.intersection.finish,S,l,a):p(g.intersection.start,g.intersection.finish,l)}}u.getTime()!=n.getTime()&&p(u,n,l)}}function l(e,t){return s.convertDtToMomentDt(e,t)}function u(e){return s.convertMomentDtToDt(e)}function d(t,n,i,r,a){var o=e.getOperatingHours()[i],c=o.timezone,d=useLocationTimezone?c:userTimeZone;if(a&&useLocationTimezone)for(var g=r.split(","),m=0;m<g.length;m++){var f=g[m].split("_")[1],S=e.territories[f].operatingHours;d=e.getOperatingHours()[S].timezone}for(var b=l(t,d),y=l(n,d),_=(b.clone().tz(c),y.clone().tz(c),u(b)),T=u(y),L=_,w=[b.clone().add(-1,"days"),b.clone(),b.clone().add(1,"days")],k=0;k<w.length;k++)for(var C=w[k],R=o.slots[C.get("day")]||[],D=0;D<R.length;D++){var A=R[D],I=v(C,A,"startHour","startMinute",c,d,a),x=v(C,A,"endHour","endMinute",c,d,a),F=s.intersectDates({start:I,finish:x},{start:_,finish:T}).intersection;F&&(I=F.start,x=F.finish,"Extended"==A.type?(p(L,I,r,null),p(I,x,r,A.type)):p(L,I,r,A.type),h(I,x,A.type,r),L=x)}p(L,T,r,null)}function v(e,t,n,s,i,r,a){var o=u(e);o.setHours(t[n]),o.setMinutes(t[s]);var c=useLocationTimezone?i:userTimeZone;a&&useLocationTimezone&&(c=r);var d=l(o,i),v=u(d.tz(c));return v}function h(e,t,n,i){var r=(t.getTime()-e.getTime())/6e4,a=b[i];a||(a={},b[i]=a);var o=s.formatDayToString(e),c=a[o];c||(c={regular:0,overtime:0},a[o]=c),"Extended"==n?c.overtime+=r:c.regular+=r}function g(t,n,i){var r=[];if(showSecondarySTMs)for(var a in n)for(var o=0;o<n[a].length;o++)"S"!=n[a][o].type&&r.push(a);else r=Object.keys(n);r.splice(r.indexOf(t.serviceTerritory),1);for(var c=t.serviceTerritory,d=e.territories[c].operatingHours,v=e.getOperatingHours()[d].timezone,h=0;h<r.length;h++){var g=[s.generateResourceId(i,r[h])];S[t.id]=!0;var p=t.start,m=t.finish;if(useLocationTimezone){var f=e.territories[r[h]].operatingHours,b=e.getOperatingHours()[f].timezone;p=u(l(p,v).tz(b)),m=u(l(m,v).tz(b))}var y=e.territories[t.serviceTerritory].name,T=_.escape(customLabels.Relocated_to_many_params.replaceAll(y,moment(p).format("llll"),moment(m).format("llll"))),L=null;L=y?customLabels.Relocated_to.replace("$0",_.escape(y)):customLabels.Relocated_No_Permissions;var w="relocation",k="relocation_monthly";scheduler.addMarkedTimespan({start_date:p,end_date:m,sections:{ZoomLevel2:g,ZoomLevel3:g,ZoomLevel4:g,ZoomLevel5:g,ZoomLevel6:g},html:"<div class='relocatedLabel' title='"+T+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.relocation+"'></use></svg> "+L+"</div>",css:w}),scheduler.addMarkedTimespan({start_date:p,end_date:m,sections:{MonthlyView:g,MTDView:g},html:"<div class='relocatedLabel' title='"+T+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.relocation+"'></use></svg></div>",css:k})}}function p(e,t,n,s){if(e.getTime()!=t.getTime()){var i={};for(var r in scheduler.matrix)"MonthlyView"!==r&&(i[r]=n.indexOf(",")>-1?n.split(","):[n]);var a="gray_section";"Extended"==s&&(a="overtime_section"),scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:i,css:a})}}function m(e){var n={},i=e||t.resourcesByPrimariesAndRelocations();for(var r in i){var a=i[r],o={};n[r]=o;for(var c in a){var l=a[c],u=o[l.serviceTerritory];u||(u=[],o[l.serviceTerritory]=u),u.push({start:l.effectiveStartDate||l.start,finish:l.effectiveEndDate||l.finish,serviceTerritory:l.serviceTerritory,operatingHours:l.operatingHours,type:l.serviceTerritoryType||l.type,id:l.id,ohTerr:l.ohTerr||null})}for(var d in o){var v=o[d];v.sort(s.sortByTime)}}return n}var f={},S={},b={};n.$on("gotNewTimePhasedObjects",function(e,t){r(t.start,t.finish,t.resourceToServiceCrewMembers)});var y={resourceToWorkingDates:b,relocationsOnGantt:S,reset:i};return y}])}(),function(){function e(e,t,n,s,i,r,a,o,c,l,u){function d(s){_=e.$new(!0),_.lightboxCapacity=n.resourceCapacities()[s],_.fieldsTypes=r.fieldsTypes,_.selectedTab="details",_.kpiStart=_.lightboxCapacity.start_date,_.kpiEnd=_.lightboxCapacity.end_date,_.servicesScheduledToCapacity={},_.tableSort={orderByField:"",reverse:!1},_.flaggedServices=t.flagged,_.invokedActionFor={},_.SERVICE_CATEGORY=c,_.currentMenu=null,_.closeLightbox=v,_.openConsoleTab=r.openConsoleTab,_.formatKpitText=g,_.getObjectKeys=p,_.flagService=m,_.unscheduleServices=S,_.postToChatter=f,_.getStatusClass=r.getCSSClassForContext,_.violationsTooltip=b,u.fieldsSetFields().then(function(e){_.servicesListFields=e.CapacityServiceColumns,_.tableSort.orderByField=_.servicesListFields[0].APIName}),_.order=function(e,t){_.tableSort.orderByField=e,_.tableSort.reverse=t},_.getRefFieldID=function(e,t){var n=t.APIName.replace("__r","__c");return e[n]},_.setCurrentMenu=function(e){_.currentMenu==e?_.currentMenu=null:_.currentMenu=e},h(s);var o=y();o.find("#ContractorCapacityLightbox").draggable({handle:"#ContractorCapacityLightboxHeader"}),angular.element("body").append(o),a.setLightBoxStatus(),_.$on("$destroy",function(){return o.remove()}),_.$on("keypress",function(e,t){27==t.which&&_.$evalAsync(_.closeLightbox)}),i(o)(_),r.safeApply(_)}function v(){a.setLightBoxStatus(!1),_.$destroy()}function h(e){_.capacityKpi={hoursCapacity:0,hoursInUse:0,completed:0,jeopardy:0,workItemsCapacity:0,workItemsAllocated:0};var t=scheduler.getEvent(e),n=scheduler.getEvents(t.start_date,t.end_date);_.servicesScheduledToCapacity={},_.capacityKpi.hoursCapacity=t.hoursPerTimePeriod?t.hoursPerTimePeriod:0,_.capacityKpi.hoursInUse=t.hoursInUse?t.hoursInUse:0,_.capacityKpi.completed=0,_.capacityKpi.jeopardy=0,_.capacityKpi.violations=0,_.capacityKpi.workItemsCapacity=t.workItemsPerTimePeriod?t.workItemsPerTimePeriod:0,_.capacityKpi.workItemsAllocated=t.workItemsAllocated?t.workItemsAllocated:0,_.capacityKpi.total=0;for(var s=0;s<n.length;s++)n[s].resourceId==t.resourceId&&"service"==n[s].type&&n[s].start.getTime()>=t.start_date.getTime()&&n[s].start.getTime()<=t.end_date.getTime()&&(_.capacityKpi.total++,n[s].statusCategory==c.COMPLETED&&_.capacityKpi.completed++,n[s].jeopardy&&_.capacityKpi.jeopardy++,n[s].violations&&_.capacityKpi.violations++,_.servicesScheduledToCapacity[n[s].id]=n[s])}function g(){return customLabels.KPIsAreCalculatedFromTo.replaceAll(moment(_.kpiStart).format("llll"),moment(_.kpiEnd).format("llll"))}function p(e){return Object.keys(e).length>0?Object.keys(e):0}function m(e){return t.flagged[e]?void(t.flagged[e]&&(t.flagged[e]=!t.flagged[e])):void(t.flagged[e]=!0)}function f(e,n){return""===n&&(n=prompt(customLabels.msg_to_post_to_chatter,"")),""===n?void alert(customLabels.no_empty_msg_to_chatter):(t.recentlyUsed[e]=!0,void t.postToChatter([e],n).then(function(e){}))}function S(e){if(!confirm(customLabels.are_you_sure_unschedule))return!0;var s=[],i=[];e.forEach(function(e){_.invokedActionFor[e]=!0,i.push(n.serviceAppointments()[e]),s.push(n.serviceAppointments()[e].resource),t.recentlyUsed[e]=!0}),t.unscheduleServices(e).then(function(n){t.drawServicesAndAbsences(n.services,n.absences,[],n.capacities),h(_.lightboxCapacity.id),_.invokedActionFor[e[0]]=!1})["catch"](function(t){r.addNotification(customLabels.Action_Could_Not_Be_Performed,t.message||customLabels.user_is_not_allowed_to_perform_action),_.invokedActionFor[e[0]]=!1})}function b(e){if(e.violations){for(var t="",n=0;n<e.violations.length;n++)t+=e.violations[n].RuleName+" - "+e.violations[n].ViolationString+"\n";return t&&(t=t.substring(0,t.length-1)),t}}function y(){return angular.element('<div class="LightboxBlackContainer">\n				<div class="LightboxContainer" id="ContractorCapacityLightbox">\n\n					<div class="lightboxHeaderContainer" id="ContractorCapacityLightboxHeader">\n\n						<svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n							\u2028<use xlink:href="'+lsdIcons.close+'"></use>\n						</svg>\n\n						<h1 class="lightboxHeader">\n							<i>'+customLabels.Capacity+':</i>\n							{{ lightboxCapacity.name }}\n						</h1>\n\n						<span class="lightboxSelectedTab">\n							'+customLabels.Details+'\n						</span>\n\n						<div class="ExtendedForm">\n							<a ng-click="openConsoleTab($event,lightboxCapacity.id)" target="_blank" href="../{{ lightboxCapacity.id }}" title="'+customLabels.ExtandedForm+'">\n								<svg aria-hidden="true" class="slds-icon openExternalIcon">\n									\u2028<use xlink:href="'+lsdIcons.external+'"></use>\n								\u2028</svg>\n							</a>\n						</div>\n					</div>\n\n					<div id="KPIforCapacity" class="KPIforCapacity">\n						<div class="kpiIndicator" ng-show="capacityKpi.hoursCapacity > 0">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.clock+'"></use>\n								\u2028</svg>\n								{{ capacityKpi.hoursInUse }}/{{ capacityKpi.hoursCapacity }}</div>\n							'+customLabels.Hours_Capacity+'\n						</div>\n\n						<div class="kpiIndicator" ng-show="capacityKpi.workItemsCapacity > 0">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.standard_objects+'"></use>\n								\u2028</svg>\n								{{ capacityKpi.workItemsAllocated }}/{{ capacityKpi.workItemsCapacity }}</div>\n							'+customLabels.Services_Capacity+'\n						</div>\n\n						<div class="kpiIndicator">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.violation+'"></use>\n								\u2028</svg>\n								<!--<i class="fa fa-warning"></i>-->\n								{{ capacityKpi.violations }}</div>\n							'+customLabels.Violations+'\n						</div>\n\n						<div class="kpiIndicator">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.jeopardy+'"></use>\n								\u2028</svg>\n								{{ capacityKpi.jeopardy }}</div>\n							'+customLabels.In_Jeopardy+'\n						</div>\n\n						<div class="kpiIndicator">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.completed+'"></use>\n								\u2028</svg>\n\n								{{ capacityKpi.completed }}/{{ capacityKpi.total }}</div>\n							'+customLabels.Completed+'\n						</div>\n\n						<div class="KpiRange">{{formatKpitText()}}</div>\n					</div>\n                    <div id="ContractorCapacityButtons">\n                            <span class="capacityServiceUnscheduleAll" ng-show="getObjectKeys(servicesScheduledToCapacity).length > 0" ng-click="unscheduleServices(getObjectKeys(servicesScheduledToCapacity))">\n                                <i class="fa fa-ban"></i>\n                                 '+customLabels.Unschedule_All+'\n                            </span>\n                        </div>\n					<div id="ContractorCapacityLightboxContent">\n					\n                            <div class="NoServicesFound" ng-show="!getObjectKeys(servicesScheduledToCapacity)">\n                                <i class="fa fa-times"></i>\n                                <div>'+customLabels.No_services+'</div>\n                            </div>\n                        \n                        <table id="CapacityServicesTable" ng-show="getObjectKeys(servicesScheduledToCapacity).length > 0">\n                          <thead>\n                            <tr class="table-header">\n                                <th></th>\n                                <th></th>\n                                <th></th>\n                                <th ng-attr-title="{{field.Label}}" ng-repeat="field in servicesListFields" ng-class="{sortCapacityServicesBy: tableSort.orderByField == field.APIName}" class="truncate capacityServiceColName" ng-click="tableSort.reverse=!tableSort.reverse;order(field.APIName, tableSort.reverse)">\n                                    <span class="">{{field.Label}}</span>\n                                    <span ng-show="tableSort.orderByField == field.APIName">\n                                        <span>\n                                            <svg ng-show ="!tableSort.reverse" aria-hidden="true" class="slds-icon arrowIcon">\n                                              <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                            </svg>\n                                            <svg ng-show ="tableSort.reverse" aria-hidden="true" class="slds-icon arrowIcon">\n                                              <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                            </svg>\n                                        </span>\n                                    </span>\n                                </th>\n                            </tr>\n                          </thead>\n                          <tbody>\n                            <tr ng-repeat="(key, capacityService) in servicesScheduledToCapacity | orderObjectBy:tableSort.orderByField:tableSort.reverse" class="capacityServiceRow">\n                                <td style="background:{{capacityService.ganttColor}}" class="TaskStatusColor {{ getStatusClass(capacityService.statusCategory, SERVICE_CATEGORY) }}" ></td>\n                                <td class="moreOptions">\n                                    <div class="serviceCapacityActionsButton" title="Actions" ng-click="setCurrentMenu($index)">\n                                          <svg class="slds-icon carretDownIcon" aria-hidden="true" ng-show="!invokedActionFor[capacityService.id]">\n                                                <use xlink:href="'+lsdIcons.down+'"></use>\n                                          </svg>\n                                          <img class="capacityServiceLoading"\n                                             src="'+lsdIcons.spinnerGif+'"\n                                             ng-show="invokedActionFor[capacityService.id]"/>\n                                    </div>   \n                                    <div id="actions-menu-{{$index}}" class="serviceCapacityActions" ng-show="currentMenu == $index">\n                                        <a class="saSingleAction" ng-click="openConsoleTab($event,capacityService.id); setCurrentMenu($index);" target="_blank" href="../{{ capacityService.id }}">'+customLabels.Details+'</a>\n                                        <div class="saSingleAction" ng-click="flagService(capacityService.id); setCurrentMenu($index);">\n                                            <span ng-show="!flaggedServices[capacityService.id]">'+customLabels.Flag+'</span>\n                                            <span ng-show="flaggedServices[capacityService.id]">'+customLabels.Unflag+'</span>\n                                        </div>\n                                        <div class="saSingleAction" ng-click="unscheduleServices([capacityService.id]); setCurrentMenu($index);">'+customLabels.Unschedule+'</div>\n                                        <div class="saSingleAction" ng-click="postToChatter(capacityService.id, \'\'); setCurrentMenu($index);">'+customLabels.Chatter+'</div>\n                                    </div>\n                                </td>\n                                <td class="iconOnServiceRow"\n                                        title="{{ violationsTooltip(capacityService) }}"\n                                        ng-class="{\'serviceList_jeopardy\': capacityService.jeopardy, \'serviceList_violations\': !capacityService.jeopardy && capacityService.violations}">\n                                        <i class="fa fa-bell" ng-if="capacityService.jeopardy"></i>\n                                        <i class="fa fa-warning" ng-if="capacityService.violations && !capacityService.jeopardy"></i>\n                                </td>\n                                <td ng-attr-title="{{capacityService | displayFieldSetField : field}}" ng-repeat="field in servicesListFields" class="truncate">\n                                    <span ng-show="field.Type != fieldsTypes.Reference" title="{{capacityService | displayFieldSetField : field}}">{{capacityService | displayFieldSetField : field}}</span>\n                                    <a ng-show="field.Type == fieldsTypes.Reference" ng-click="openConsoleTab($event, getRefFieldID(capacityService, field))" target="_blank" href="../{{ getRefFieldID(capacityService, field) }}" title="{{capacityService | displayFieldSetField : field}}">\n                                        {{capacityService | displayFieldSetField : field}}\n                                    </a>\n\n                                </td>\n                            </tr>\n                          </tbody>\n                        </table>\n\n\n					</div>\n				</div>\n			</div>');
}var _=null;return{open:d}}e.$inject=["$rootScope","servicesService","TimePhasedDataService","$sce","$compile","utils","StateService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService","FieldSetFieldsService"],angular.module("serviceExpert").factory("CapacityLightboxService",e)}(),function(){function e(e,t,n,s,i,r,a){function o(){e.getDelta(d).then(function(e){d=e.updateTime;var t=[];if(e.deletedAbsence&&e.deletedAbsence.length>0||e.updatedAbsence&&e.updatedAbsence.length>0){var a={};if(e.deletedAbsence.length>0&&(a.deleted=n.deleteTimePhaseData(e.deletedAbsence,"na").absences,t.push.apply(t,_toConsumableArray(r.getRelatedServices(a.deleted)))),e.updatedAbsence.length>0){a.updated=n.updateTimePhaseData(e.updatedAbsence,"na").absences;var o=a.updated.map(function(e){return e.resource}).join(",");t.push.apply(t,_toConsumableArray(r.getRelatedServices(r.getIdsOfSObjects(a.updated),o)))}(a.updated||a.deleted)&&h.absences.forEach(function(e){return e(a)})}if(e.updatedGanttServices&&e.updatedGanttServices.length>0||e.deletedGanttServices&&e.deletedGanttServices.length>0){var c={};e.deletedGanttServices.length>0&&(c.deleted=n.deleteTimePhaseData(e.deletedGanttServices,"service").services,t.push.apply(t,_toConsumableArray(r.getRelatedServices(c.deleted)))),e.updatedGanttServices.length>0&&(c.updated=n.updateTimePhaseData(e.updatedGanttServices,"service").services,t.push.apply(t,_toConsumableArray(r.getRelatedServices(r.getIdsOfSObjects(c.updated))))),(c.updated||c.deleted)&&h.services.forEach(function(e){return e(c)})}if(e.updatedLivePositions){var l=s.updatePositions(e.updatedLivePositions);l.isUpdated&&h.positions.forEach(function(e){return e(l.dic)})}if(t.length>0&&h.rules.forEach(function(e){return e(t)}),i.areContractorsSupported&&(e.deletedCapacities&&e.deletedCapacities.length>0||e.updatedCapacities&&e.updatedCapacities.length>0)){var u={};e.deletedCapacities.length>0&&(u.deleted=n.deleteTimePhaseData(e.deletedCapacities,"capacity").capacities),e.updatedCapacities.length>0&&(u.updated=n.updateTimePhaseData(e.updatedCapacities,"capacity").capacities),(u.updated||u.deleted)&&h.capacities.forEach(function(e){return e(u)})}i.isOptimizationEnabled&&e.optimizationRequests&&e.optimizationRequests.length>0&&h.optimizationRequests.forEach(function(t){return t(e.optimizationRequests)})})["catch"](function(e){console.warn(e)})}function c(e){h.optimizationRequests.forEach(function(t){return t([e])})}function l(e,t){return h[e]&&h[e].push(t)}function u(e,t){h[e].splice(h[e].indexOf(t),1)}var d=null,v=deltaInterval||10,h={services:[],absences:[],capacities:[],positions:[],optimizationRequests:[],rules:[]};return t(o,1e3*v),{register:l,unRegister:u,getDelta:o,updateOptimizationRequest:c}}e.$inject=["sfdcService","$interval","TimePhasedDataService","LastKnownPositionService","StateService","utils","MstResolver"],angular.module("serviceExpert").factory("DeltaService",e)}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(e,t){var n=e.defer(),s={};return e.all([t.getServiceListFields(),t.getServiceMiniFormFields(),t.getServiceMapInfoWindowFields(),t.getGanttToolTipFields(),t.getServiceCapacityColumns()]).then(function(e){s={ListColumns:e[0],ListExpanded:e[1],MapInfo:e[2],GanttToolTip:e[3],CapacityServiceColumns:e[4]},"object"!==_typeof(GanttService.prototype.allFieldSets)&&(GanttService.prototype.allFieldSets=s),n.resolve(s)})["catch"](function(e){n.reject(),console.warn("FieldSetFieldsService: unable to get service appointment field sets")}),{fieldsSetFields:function(){return n.promise}}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("FieldSetFieldsService",e)}(),function(){function e(e,t,n,s,i){function r(r,l){if(!c){c=e.$new(!0),c.url=t.trustAsResourceUrl(l).toString(),c.title=r,c.closeLightbox=a;var u=o();u.find("#ResourceLightbox").draggable({handle:"#ResourceLightboxHeader"}),angular.element("body").append(u),i.setLightBoxStatus(),c.$on("$destroy",function(){return u.remove()}),c.$on("keypress",function(e,t){27==t.which&&c.$evalAsync(c.closeLightbox)}),n(u)(c),s.safeApply(c)}}function a(){c.killWatch&&c.killWatch(),i.setLightBoxStatus(!1),c.$destroy(),c=null}function o(){return angular.element('<div class="LightboxBlackContainer ng-cloack">\n                    <div class="LightboxContainer ng-cloak" id="ResourceLightbox">\n\n                        <div class="lightboxHeaderContainer lightbox-general" id="ResourceLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            \n                            <h1 class="lightboxHeader" id="resourceName" ng-bind="title"></h1>\n                        </div>\n                        \n                        <iframe ng-src="{{ url }}" class="resourceLightboxIframe"></iframe>\n\n                    </div>\n                </div>')}var c=null;return{open:r}}e.$inject=["$rootScope","$sce","$compile","utils","StateService"],angular.module("serviceExpert").factory("GeneralLightbox",e)}(),function(){function e(e,t,n,s,i,r,a,o,c,l,u,d,v,h){function g(t){V&&m(),V=e.$new(!0),U=null,V.StateService=a,V.gettingSlots=!0,V.closePanel=m,V.getResourceField=b,V.formatDateInterval=y,V.service=n.serviceAppointments()[t],V.generateResultText=T,V.allSlotsArray=null,V.slotsTimespansIds=[],V.trustHtml=r.trust,V.jumpToDate=A,V.GRADES=z,V.scheduleToSlot=O,V.replaceLabels=I,V.openLightbox=x,V.showOnGantt=F,V.formatDateHeader=_,V.notifyWhenDoneGettingSlots=w,V.shouldNotify=!1,V.scheduledActionInvoked=!1,V.groupSlotsBy="Resource",V.roundGrade=f,V.bestSlot=null,V.gotSlots=!0,V.exception=null,V.isMst=!1,V.mstPromise=null,V.schedulingTakesLong=!1,V.rawTimespans=[],j||L(t);var s=M();angular.element("#LeftSideContainer").prepend(s),V.$on("$destroy",function(){return s.remove()}),i(s)(V),r.safeApply(V)}function p(e){j=!0,g(e.fslOperation.result.Service.Id),"exception"===e.eventType&&k(e),k({value:e.fslOperation.result},!0),j=!1}function m(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!0;V&&(U=null,t&&e.$broadcast("GotSlotsEnded"),showCandidates.on=!1,showCandidates.id=null,S(),scheduler.updateView(),t&&V.$destroy())}function f(e){return Math.round(e)}function S(){for(var e=0;e<V.slotsTimespansIds.length;e++)scheduler.deleteMarkedTimespan(V.slotsTimespansIds[e])}function b(e,t){return e&&o.getResources()[e]?o.getResources()[e][t]:null}function y(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1,n=60*new Date(e).getTimezoneOffset()*1e3,s=new Date(e+n);return t?moment(s).format("LT"):moment(s).format("llll")}function _(e){var t=e.split("_"),n=new Date(t[2],t[1],t[0],0,0,0,0);return moment(n).format("LL")}function T(e){if(e){var t=0,n=0;return e.forEach(function(e){t++,n+=e.SchedulingOptions.length}),customLabels.getSlotsExpText.replaceAll("<b>"+t+"</b>","<b>"+n+"</b>","<b>"+V.service.name+"</b>","<b>"+y(V.bestSlot.Interval.Start)+"</b>","<b>"+V.bestSlot.Resource.m_resource.Name+"</b>","<b>("+Math.round(V.bestSlot.Grade)+"</b>")}}function L(e){console.time("getting slots"),s.getSlots(e,a.selectedPolicyId).then(function(e){return e.value.FSLOperationId?(console.log("get candidates with MST"),V.isMst=!0,t(function(){return V.schedulingTakesLong=!0},1e3*G),void(V.mstPromise=d.getUpdates(e.value.FSLOperationId).then(function(e){return console.log(e),console.log(e.fslOperation.result),console.timeEnd("getting slots"),V.shouldNotify||k({value:e.fslOperation.result},!0),e})["catch"](function(e){console.error(e);var t={message:e};return V.shouldNotify||k({eventType:"exception",event:t}),h.reject({eventType:"exception",event:t})}))):void k(e)})["catch"](function(e){console.warn("could not get candidates"),console.log(e)})}function w(){V.shouldNotify=!0,V.mstPromise.then(function(e){r.addNotification(customLabels.MstFinishedGettingSlots.replace("$0",V.service.AppointmentNumber),customLabels.MstFinishedGettingSlotsMessage,function(){p(e)})})["catch"](function(e){console.error(e),r.addNotification(customLabels.MstFinishedGettingSlots.replace("$0",V.service.AppointmentNumber),e,function(){})}),m(!0)}function k(e){if(V.gettingSlots=!1,"exception"===e.eventType)return V.gotSlots=!1,void(V.exception=e.event);if(D(e.value),V.gotSlots){V.allSlotsArray=[],V.slotsByDateObject={},U={};for(var t in e.value.ResourceIDToScheduleData){var n=e.value.ResourceIDToScheduleData[t];V.allSlotsArray.push(n);for(var s=0;s<n.SchedulingOptions.length;s++){var i=new Date(n.SchedulingOptions[s].Interval.Start),r=60*new Date(n.SchedulingOptions[s].Interval.Start).getTimezoneOffset()*1e3;U[t]=!0,i.setMilliseconds(i.getMilliseconds()+r);var a=B(i);V.slotsByDateObject[a]=V.slotsByDateObject[a]||[],n.SchedulingOptions[s].Resource=e.value.ResourceIDToScheduleData[t].Resource,V.slotsByDateObject[a].push(n.SchedulingOptions[s])}}V.allSlotsArray.sort(function(e,t){return e.Resource.m_resource.Name>t.Resource.m_resource.Name?1:e.Resource.m_resource.Name<t.Resource.m_resource.Name?-1:0});for(var o=0;o<V.allSlotsArray.length;o++)V.allSlotsArray[o].highest=C(V.allSlotsArray[o].SchedulingOptions);for(var c in V.slotsByDateObject){var l=V.slotsByDateObject[c];l.sort(function(e,t){return e.Interval.Start>t.Interval.Start?1:e.Interval.Start<t.Interval.Start?-1:0}),l.highest=C(l),V.bestSlot?V.bestSlot.Grade<l.highest&&(V.bestSlot=l.highest):V.bestSlot=l.highest}setTimeout(function(){return angular.element("#slotsSentence").html(T(V.allSlotsArray))},100)}}function C(e){for(var t=0,n=e,s=n[0],i=0;i<n.length;i++)n[t].Grade<n[i].Grade&&(t=i,s=n[i]);return s}function R(e){var t=60*new Date(e.Start).getTimezoneOffset()*1e3,n=60*new Date(e.Finish).getTimezoneOffset()*1e3;return{startDate:new Date(e.Start+t),endDate:new Date(e.Finish+n)}}function D(t){var s="",i=null,o=!1;for(var c in t.ResourceIDToScheduleData)if(t.ResourceIDToScheduleData[c].SchedulingOptions)for(var l=t.ResourceIDToScheduleData[c].SchedulingOptions,u=0;u<l.length;u++){var d=R(l[u].Interval),v=n.getResoruceGanttIdByDate(c,d.startDate);if(showSecondarySTMs&&V.service.ServiceTerritoryId&&(v=n.getResoruceGanttIdByDateAndTerritory(c,d.startDate,V.service.ServiceTerritoryId)),v){0===u&&(s+=t.ResourceIDToScheduleData[c].Resource.m_resource.Name+", ",o=!0),(d.startDate<i||null===i)&&(i=new Date(d.startDate));for(var h in scheduler.matrix){var g={};g[h]=v.indexOf(",")>-1?v.split(","):[v];var p="";l[u].MSTOptions&&(p=(new Date).getTime()+Math.floor(1e5*Math.random()),window.mstOptions=window.mstOptions||{},window.mstOptions[p]=l[u].MSTOptions);var m=.11+parseInt(l[u].Grade)/100*.64,f="background-color: rgba(118, 226, 164,"+m+");",S=Math.round(l[u].Grade)+"/100",b=customLabels.CandidateGradeGantt.replaceAll(moment(d.startDate).format("dddd LT"),moment(d.endDate).format("dddd LT"),S),y={start_date:d.startDate,end_date:d.endDate,sections:g,html:"<div oncontextmenu='scheduleSlot(event, \""+V.service.id+'", "'+d.startDate.getTime()+'", "'+v+'", "'+a.selectedPolicyId+'", "'+p+"\")', title='"+b+"' style='"+f+"'><span class='slotText'>"+S+"</span></div>",css:"slotMark"};V.rawTimespans.push(y)}}}if(o){var _=r.setDatesByStartAndMode(i);_.start.setDate(_.start.getDate()-1),_.end.setDate(_.end.getDate()+1),n.getTimePhasedObjects(_.start,_.end).then(function(){for(var e=0;e<V.rawTimespans.length;e++)V.slotsTimespansIds.push(scheduler.addMarkedTimespan(V.rawTimespans[e]));scheduler.updateView()}),showCandidates.on=!0,showCandidates.id=V.service.id,r.ganttSettings&&r.ganttSettings.filterCandidates&&(V.service.resourceId&&-1===s.indexOf(V.service.resourceName)&&(s+=V.service.resourceName+", "),s=s.substr(0,s.length-2)),e.$broadcast("GotSlots",{resourceToFilter:s,minDateOfCandidate:i}),scheduler.setCurrentView(i)}else V.gotSlots=!1}function A(t){e.$broadcast("JumpToDate",new Date(t))}function I(e,t){var n;return(n=customLabels[e]).replaceAll.apply(n,_toConsumableArray(t))}function x(){c.open(V.service.id)}function F(){r.showOnGantt(V.service.id)}function M(){var e='\n                <div id="GetSlotsPanel" xmlns="http://www.w3.org/1999/html">\n\n                    <div class="slots-panel-title">\n                        {{ replaceLabels(\'ShowingCandidatesTo\', [service.name] ) }}\n                        <div class="clear-slots" ng-click="closePanel()">'+customLabels.HideSlots+'</div>\n                    </div>\n\n\n                    <div ng-show="gettingSlots" class="getting-slots">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.FindingCandidates+'\n                        \n                        <div class="get-slots-mst" ng-show="isMst && schedulingTakesLong">\n                            '+customLabels.MstTakingLongTime+'\n                            <div class="get-slots-mst-button" ng-click="notifyWhenDoneGettingSlots()">'+customLabels.MstNotifyMeWhenDone+'</div>\n                        </div>\n                    </div>\n                    \n                    \n                    <div ng-show="exception" class="get-slots-error">\n                        <svg aria-hidden="true" class="slds-icon">\n                          \u2028<use xlink:href=\''+lsdIcons.violation+"'></use>\n                        \u2028</svg>\n                        {{ exception.message }}\n                        \n                        <div>"+customLabels.ContactSysAdmin+'</div>\n                    </div>\n                    \n                    <div ng-show="!gotSlots && !exception" class="get-slots-error">\n                        <i class="fa fa-frown-o"></i>\n                        \n                        <div>'+customLabels.noCandidatesMessageGantt+'</div>\n                    </div>\n\n\n\n\n                    <div class="slots-results-recommendations" ng-if="allSlotsArray" ng-show="gotSlots">\n                        <span id="slotsSentence"></span>\n                        <div class="assign-to-recommended" ng-click="scheduleToSlot(bestSlot.Interval.Start, bestSlot.Resource.m_resource.Id, StateService.selectedPolicyId,bestSlot.Interval)">'+customLabels.AssignToRecommended+'</div>\n                    </div>\n\n\n\n                    <div class="slots-grouping" ng-show="allSlotsArray" ng-show="gotSlots">\n                        <span class="truncate groupSlotsBy" title="'+customLabels.GroupSlotsBy+'">'+customLabels.GroupSlotsBy+'</span>\n                        <input type="radio" id="groupByResource" name="groupBy" ng-model="groupSlotsBy" value="Resource" checked="checked">\n                        <label class="groupSlotsBy slots-groupByResource truncate" for="groupByResource" title="'+customLabels.Resource+'">'+customLabels.Resource+'</label>\n                        <input type="radio" id="groupByName" name="groupBy" ng-model="groupSlotsBy" value="Date">\n                        <label class="groupSlotsBy truncate slots-groupByName" for="groupByName" title="'+customLabels.Date+'">'+customLabels.Date+'</label>\n\n                        <div class="button-on-grouping" ng-show="service.isScheduled()" ng-click="showOnGantt()" title="'+customLabels.Show_on_gantt+'">\n                            <svg aria-hidden="true" class="slds-icon quickActionIcon">\n                                \u2028<use xlink:href="'+lsdIcons.table+'"></use>\n                            \u2028</svg>\n                        </div>\n\n                        <div class="button-on-grouping" ng-click="openLightbox()" title="'+customLabels.OpenDetailsWindow+'">\n                            <svg aria-hidden="true" class="slds-icon quickActionIcon">\n                                \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                            \u2028</svg>\n                        </div>\n                    </div>\n\n\n                    <div id="Slots-List-In-Panel" ng-show="gotSlots">\n                    \n                        <div ng-repeat="candidate in allSlotsArray" class="resource-slot-row" ng-init="candidate.showSlots = false" ng-show="groupSlotsBy == \'Resource\'">\n    \n                            <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'name\')" class="candidates-container-row" ng-click="candidate.showSlots = !candidate.showSlots">\n                                <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') == null" class="ResourcePhotoIcon"></div>\n                                <img ng-show="getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') != null" ng-src="{{getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\')}}" class="ResourcePhotoIcon" />\n                                <h1>{{ getResourceField(candidate.Resource.m_resource.Id, \'name\') }}</h1>\n                                {{ replaceLabels(\'Xoptions\', [candidate.SchedulingOptions.length] ) }}\n                                \n                                <div class="slot-grade slots-highest-grade" ng-class=\'{\n                                                "GS-grade-excellent": candidate.highest.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": candidate.highest.Grade >= GRADES.GOOD && candidate.highest.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": candidate.highest.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(candidate.highest.Grade)}}/100\n                                </div>\n                                \n                            </div>\n    \n                            <div ng-repeat="intervalItem in candidate.SchedulingOptions" class="time-interval" ng-show="candidate.showSlots">\n                                <span class="jump-to-date" title="Jump to date" ng-click="jumpToDate(intervalItem.Interval.Start)">{{ formatDateInterval(intervalItem.Interval.Start) }}</span>\n    \n                                <div class="slot-grade" ng-class=\'{\n                                                "GS-grade-excellent": intervalItem.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": intervalItem.Grade >= GRADES.GOOD && intervalItem.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": intervalItem.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(intervalItem.Grade)}}/100\n                                </div>\n    \n                                <div ng-click="scheduleToSlot(intervalItem.Interval.Start, candidate.Resource.m_resource.Id, StateService.selectedPolicyId, intervalItem)" class="schedule-to-slot">'+customLabels.Schedule+'</div>\n                            </div>\n    \n                        </div>\n                        \n                       \n                       \n                        <div ng-repeat="(date,slots) in slotsByDateObject" class="resource-slot-row" ng-init="candidate.showSlots = false" ng-show="groupSlotsBy == \'Date\'">\n    \n                            <div class="candidates-container-row date-title-container" ng-click="slots.showDatesSlots = !slots.showDatesSlots">\n                                <h1>{{ formatDateHeader(date) }}</h1>\n                                {{ replaceLabels(\'Xoptions\', [slots.length] ) }}\n                                \n                                <div class="slot-grade slots-highest-grade" ng-class=\'{\n                                                "GS-grade-excellent": slots.highest.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": slots.highest.Grade >= GRADES.GOOD && slots.highest.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": slots.highest.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(slots.highest.Grade)}}/100\n                                </div>\n                            </div>\n    \n                            <div ng-repeat="intervalItem in slots" class="time-interval" ng-show="slots.showDatesSlots">\n                                <span class="jump-to-date" title="Jump to date" ng-click="jumpToDate(intervalItem.Interval.Start)">{{ formatDateInterval(intervalItem.Interval.Start, true) }}</span>\n                                <span> ({{intervalItem.Resource.m_resource.Name}})</span>\n    \n                                <div class="slot-grade" ng-class=\'{\n                                                "GS-grade-excellent": intervalItem.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": intervalItem.Grade >= GRADES.GOOD && intervalItem.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": intervalItem.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(intervalItem.Grade)}}/100\n                                </div>\n    \n                                <div ng-click="scheduleToSlot(intervalItem.Interval.Start, intervalItem.Resource.m_resource.Id, StateService.selectedPolicyId, intervalItem)" class="schedule-to-slot">'+customLabels.Schedule+"</div>\n                            </div>\n    \n                        </div>\n\n                </div>\n            ";return angular.element(e)}function E(e,t,i){var o=e.Interval.Start,c=e.Interval.Finish,d=e.Resource.m_resource.Id,h=n.serviceAppointments()[t],g=60*new Date(o).getTimezoneOffset()*1e3,p=n.getResoruceGanttIdByDate(d,o);return o+=g,c+=g,h?(P(h,o,p,i),void l.saveChangesToServiceAppointment(h,h).then(function(e){e.absences.forEach(function(e){e.isScheduled()&&e.setGanttResource(n.resourcesAndTerritories(),r.generateResourceId)}),e.services.forEach(function(e){e.isScheduled()&&e.setGanttResource(n.resourcesAndTerritories(),r.generateResourceId)}),l.drawServicesAndAbsences(e.services||[],e.absences||[]),u.calculateKpis()})):(o=new Date(o),c=new Date(c),s.saveChangesToServiceAppointment(t,d,null,o,c,a.selectedPolicyId,"Manual"),void v.getDelta())}function O(t,s,i,a){if(!V.scheduledActionInvoked){if(V.scheduledActionInvoked=!0,a.MSTOptions&&Object.keys(a.MSTOptions).length>0)for(var o in a.MSTOptions)E(a.MSTOptions[o],o,i);var c=V.service,d=60*new Date(t).getTimezoneOffset()*1e3;t+=d,c.resourceBeforeDrag=c.resourceId,c.eventBeforeDrag=angular.copy(c);var v=n.getResoruceGanttIdByDate(s,t);P(c,t,v,i),scheduler._events[c.id]?(scheduler.updateEvent(c.id),scheduler.callEvent("onEventChanged",[c.id,scheduler.getEvent(c.id)]),setTimeout(function(){scheduler.callEvent("onDragEnd")},1200),m()):l.saveChangesToServiceAppointment(c,c).then(function(s){s.absences.forEach(function(e){e.isScheduled()&&e.setGanttResource(n.resourcesAndTerritories(),r.generateResourceId)}),s.services.forEach(function(e){e.isScheduled()&&e.setGanttResource(n.resourcesAndTerritories(),r.generateResourceId)}),l.drawServicesAndAbsences(s.services||[],s.absences||[]),u.calculateKpis(),e.$broadcast("JumpToDate",new Date(parseInt(t)))})["catch"](function(e){console.warn("Couldn't update service. "+e[0]+" "+e[2]),r.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2])})["finally"](function(){e.$broadcast("JumpToDate",new Date(parseInt(t))),m()}),m()}}function P(e,t,n,s){var i=r.getServiceDuration(e);e.start=new Date(t),e.finish=new Date(t+i),e.start_date=new Date(t),e.end_date=new Date(t+i),e.travelTo=0,e.travelFrom=0,n&&(e.resourceId=n),e.policyUsed=s,e.scheduleMode="Automatic"}function N(e,t){for(var n in mstOptions[e])E(mstOptions[e][n],n,t)}function B(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function H(){return U}var G=2,V=null,U=null,j=!1,z={STAR:candidatesGrades.ideal,EXCELLENT:candidatesGrades.ideal,GOOD:candidatesGrades.reecommended};return window.scheduleSlot=function(t,s,i,a,o,c){t.preventDefault(),$("#ScheduleOnSlot").remove(),$('<div id="ScheduleOnSlot">'+customLabels.ScheduleHere+"</div>").css("left",t.clientX-30+"px").css("top",t.clientY+5+"px").on("click",function(){c&&N(c,o);var t=V.service;t&&(t.resourceBeforeDrag=t.resourceId,t.eventBeforeDrag=angular.copy(t),P(t,parseInt(i),a,o),$("#ScheduleOnSlot").remove(),scheduler._events[t.id]?(scheduler.updateEvent(t.id),scheduler.callEvent("onEventChanged",[t.id,scheduler.getEvent(t.id)]),setTimeout(function(){scheduler.callEvent("onDragEnd")},1200),m()):l.saveChangesToServiceAppointment(t,t).then(function(t){t.absences.forEach(function(e){e.isScheduled()&&e.setGanttResource(n.resourcesAndTerritories(),r.generateResourceId)}),t.services.forEach(function(e){e.isScheduled()&&e.setGanttResource(n.resourcesAndTerritories(),r.generateResourceId)}),l.drawServicesAndAbsences(t.services||[],t.absences||[]),u.calculateKpis(),e.$broadcast("JumpToDate",new Date(parseInt(i)))})["catch"](function(e){console.warn("Couldn't update service. "+e[0]+" "+e[2]),r.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2])})["finally"](function(){e.$broadcast("JumpToDate",new Date(parseInt(i))),m()}))}).appendTo("body")},$("body").on("click",function(){$("#ScheduleOnSlot").remove()}),{get:g,close:m,getCandidatesIds:H}}e.$inject=["$rootScope","$timeout","TimePhasedDataService","sfdcService","$compile","utils","StateService","ResourcesAndTerritoriesService","ServiceAppointmentLightboxService","servicesService","kpiCalculationsService","MstResolver","DeltaService","$q"],angular.module("serviceExpert").factory("GetSlotsService",e)}(),function(){function e(e,t,n){function s(e){var t={},n=!1;for(var s in e){var i=new LastKnownPosition(e[s]);(!r[i.id]||r[i.id].lastModifiedDate<i.lastModifiedDate)&&(t[s]=i,r[s]=i,n=!0)}return{dic:t,isUpdated:n}}function i(){return t.getLivePositions().then(function(e){for(var t in e)r[t]=new LastKnownPosition(e[t]);return r})}var r={};return{getLastKnownPositions:i,updatePositions:s,lastKnownPositions:function(){return r}}}e.$inject=["$q","sfdcService","utils"],angular.module("serviceExpert").factory("LastKnownPositionService",e)}(),function(){function e(e,t,n,s,i){function r(r,o,l,u){var d=e.defer(),v=a(o,l,u);if(v.horizon<=0){var h={scheduledServices:[],unscheduledServices:[],remainingCount:0,newStart:n.addDaysToDate(v.date,-v.horizon+1),horizon:v};return d.resolve(h),d.promise}var g=n.addDaysToDate(v.date,-v.horizon+1),p=c(r,l,u),m=CustomSettings.maxServiceAppointmentsToLoad-p.length;return 0>=m&&(n.addNotification(customLabels.Too_Many_Services_Header_Services_List,customLabels.Too_Many_Services_Services_List),d.reject()),t.loadServiceAppointmentsToList(v.date,v.horizon,m,p).then(function(e){s.updateTimePhaseData(e.stms,"stm");var t=s.updateTimePhaseData(e.ganttServiceAppointments,"service"),r=s.resourcesAndTerritories(),a={scheduledServices:[],unscheduledServices:[],remainingCount:e.remainingCount,newStart:g,horizon:v};t.services.forEach(function(e){e.isScheduled()?(e.setGanttResource(r,n.generateResourceId),a.scheduledServices.push(e)):(scheduler._events[e.id]&&delete scheduler._events[e.id],a.unscheduledServices.push(e))}),i.drawServicesAndAbsences(a.scheduledServices,[],[],[]),d.resolve(a)})["catch"](function(e){d.reject(e),console.warn("loadServiceAppointmentsToList: something went wrong"),n.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}),d.promise}function a(e,t,s){var i=void 0,r=void 0,a=n.addDaysToDate(t,-s+1),o=t;if(e[a]){for(r=a;o>=r&&e[r];)r=n.addDaysToDate(r,1);return i=(o.getTime()-r.getTime())/864e5,i++,{date:o,horizon:i}}for(r=o;r>=a&&e[r];)r=n.addDaysToDate(r,-1);return i=(r.getTime()-a.getTime())/864e5,i++,{date:r,horizon:i}}function o(e,t,s){var i=n.addDaysToDate(t,-s);return e.earlyStart&&e.earlyStart>i&&e.earlyStart<=t?!0:e.dueDate&&e.dueDate>i&&e.dueDate<=t?!0:e.appStart&&e.appStart>i&&e.appStart<=t?!0:e.appEnd&&e.appEnd>i&&e.appEnd<=t?!0:e.finish&&e.finish>i&&e.finish<=t?!0:e.start&&e.start>i&&e.start<=t?!0:!1}function c(e,t,n){var s=[];for(var i in e)o(e[i],t,n)&&s.push(i);return s}return{loadServiceAppointmentsToList:r,getBackHorizonToFetch:a}}e.$inject=["$q","sfdcService","utils","TimePhasedDataService","servicesService"],angular.module("serviceExpert").factory("LoadServiceListService",e)}(),function(){function e(e,t,n,s,i,r,a,o,c,l){function u(){m.show(),o.setLightBoxStatus()}function d(e,t,n){if(e.depth=t,n.push(e),e.items)for(var s=0,i=e.items.length;i>s;s++)e.items[s].depth=t,d(e.items[s],t+1,n)}function v(e,t){for(var n=null,s=0;s<e.length;s++){if(e[s].id===t)return e[s];if(n=v(e[s].items,t))return n}return n}function h(e,t){for(var n=0;n<e.items.length;n++)p.locationFilter[e.items[n].id]=t,h(e.items[n],t)}function g(){return angular.element('<div class="LightboxBlackContainer">\n                        <div class="LightboxContainer LightboxContainerAnimation" id="LocationFilteringLightbox">\n\n                            <div class="lightboxHeaderContainer" id="LocationFilteringLightboxHeader">\n                                <h1 class="light-box-header">'+customLabels.Location_filtering+'</h1>\n                                <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" ng-hide="noLocationsLoad">\n                                    \u2028\u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                                </svg>\n                            </div>\n\n                            <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.LocationFilteringParagraph+'</p>\n                                <p id="secondary-notice" ng-show="showSecondaryTimezoneNotice">'+customLabels.Stms_with_different_tz+'</p>\n\n                                <div class="LocationsTreeContainer">\n\n                                    <div class="locationFilterRow addBorderBottom">\n                                        <input type="checkbox" ng-model="showOrphanServices" id="servicesNoLocations" />\n                                        <label for="servicesNoLocations">'+customLabels.unassosiated_filtering+'</label><br/>\n                                    </div>\n\n                                    <input id="locationFilteringSearch" type="text" ng-model="locationSearchTerm.text" placeholder="'+customLabels.Search_location+'" />\n                                    <span class="selectAllLocations" ng-click="selectAllLocations(true)" title="'+customLabels.Select_all+'">'+customLabels.All+'</span>\n                                    <span class="selectAllLocations" ng-click="selectAllLocations(false)" title="'+customLabels.Select_none+'">'+customLabels.None+'</span>\n\n                                    <div ng-repeat="l in filteredLocations = (locationsFlat | filter:locationSearchTerm)" class="locationFilterRow" ng-style="{{ styleForLocationTree(l.depth) }}" ng-click="selectLocation(l.id)">\n                                        <input type="checkbox" ng-model="locationFilter[l.id]" id="location_{{ l.id }}" />\n                                        <label for="location_{{ l.id }}" ng-bind="l.text"></label><br/>\n                                    </div>\n\n                                </div>\n\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="applyFilterLocation()">'+customLabels.Save+"</div>\n                            </div>\n\n                        </div>\n                    </div>")}var p=t.$new(!0),m=g().hide();return m.find("#LocationFilteringLightbox").draggable({handle:"#LocationFilteringLightboxHeader"}),angular.element("body").append(m),p.trust=r.trust,p.showOrphanServices=!0,p.locationSearchTerm="",p.showLocationFiltering=!1,p.noLocationsLoad=!1,p.locationFilter={},p.locationFilterCopy={},
p.locationsFlat=[],p.showSecondaryTimezoneNotice=showSecondarySTMs&&useLocationTimezone,e(m)(p),p.$on("keypress",function(e,t){27==t.which&&p.closeLightbox()}),p.closeLightbox=function(){if(!p.noLocationsLoad){for(var e in p.locationFilterCopy)p.locationFilter[e]=p.locationFilterCopy[e];p.showOrphanServices=p.showOrphanServicesOldValue,m.hide(),o.setLightBoxStatus(!1)}},p.styleForLocationTree=function(e){return{"margin-left":20*e+"px"}},n.promises.territories().then(function(){function e(s){if(s.id&&s.parent){if(t[s.parent.id])return s.parent;var i={};return n.allTerritories[s.parent.id]&&(i={id:n.allTerritories[s.parent.id].id,parent:n.allTerritories[s.parent.id].parentTerritory?n.allTerritories[s.parent.id].parentTerritory:0}),e(i)}}var t={},a=[],o=[],c=[];for(var l in n.territories)t[l]={id:l,parent:n.territories[l].parentTerritory?n.territories[l].parentTerritory:0,text:n.territories[l].name,items:[]};for(var v in t){var h=t[v],g=e(h);0!==h.parent&&g?t[g.id].items.push(h):a.push(h)}p.locationsTree=a;for(var m=0;m<a.length;m++)d(a[m],0,p.locationsFlat);p.showOrphanServices=JSON.parse(s.GetUserSettingsProperty("Show_Orphan_Services__c")),p.showOrphanServicesOldValue=p.showOrphanServices,null!=s.GetUserSettingsProperty("locations")&&(o=s.GetUserSettingsProperty("locations")),i.getUnPrivilegeUserSettingsFields().then(function(e){if(e.length>1){for(var t=customLabels.Unprivileged_Usersettings_Fields_Msg.split("{1}"),n=t[0],s="",i=3,a=0;a<e.length&&i>a;++a)s+="<br>"+e[a];if(i<e.length){var o=e.length-i;s+="<br>",n+=t[1].replace("{2}",o)}n=n.replace("{0}",s),r.addNotification(customLabels.Unprivileged_Usersettings_Fields,n)}})["catch"](function(e){console.warn("GetUserSettingsProperty failed :-("),console.error(e)});for(var f=0;f<p.locationsFlat.length;f++){if(0===o.length)return p.showLocationFiltering=!0,p.noLocationsLoad=!0,void u();p.noLocationsLoad=!1,p.locationFilter[p.locationsFlat[f].id]=o.indexOf(p.locationsFlat[f].id)>-1,p.locationFilter[p.locationsFlat[f].id]&&c.push(p.locationsFlat[f].id)}p.locationFilterCopy=angular.copy(p.locationFilter),s.SetUserSettingsProperty("locations",JSON.stringify(c))}),p.applyFilterLocation=function(){var e=[],i=[];for(var u in p.locationFilter)p.locationFilter[u]?e.push(u):i.push(u);return 0===e.length?void alert(customLabels.One_loaded_location):(p.noLocationsLoad=!1,angular.extend(p.locationFilterCopy,p.locationFilter),p.showOrphanServicesOldValue=p.showOrphanServices,o.isLoadingNewLocations=!0,s.SetUserSettingProperties(p.parseLocationSettings(JSON.stringify(e),p.showOrphanServices)).then(function(){l.reset(),n.reset(),scheduler._events={},scheduler.deleteMarkedTimespan(),a.reset(),c.reset(),n.getResourceAndTerritories().then(function(){var n=new Date(scheduler.getState().min_date),s=new Date(scheduler.getState().max_date);n.setDate(n.getDate()-1),s.setDate(s.getDate()+1),a.getTimePhasedObjects(n,s).then(function(){scheduler.updateView(),t.$broadcast("gotNewResources",{show:e}),o.isLoadingNewLocations=!1})})})["catch"](function(e){for(var t=customLabels.territories_r_failure_msg+"\n",n=JSON.parse(e.FailedLocations),s=0;s<n.length;s++)t+=n[s].Name+"\n";r.addNotification(customLabels.territories_r_failure,t),o.isLoadingNewLocations=!1}),void p.closeLightbox())},p.parseLocationSettings=function(e,t){return{locations:e,Show_Orphan_Services__c:t}},p.selectLocation=function(e){var t=p.locationFilter[e],n=v(p.locationsTree,e);n&&h(n,t)},p.selectAllLocations=function(e){angular.forEach(p.filteredLocations,function(t){p.locationFilter[t.id]=e})},{open:u}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","sfdcService","utils","TimePhasedDataService","StateService","calendarsService","monthlyViewHelperService"],angular.module("serviceExpert").factory("LocationFilteringService",e)}(),function(){function e(e,t,n,s,i,r,a,o){function c(){f=t.$new(!0),f.$on("keypress",function(e,t){27==t.which&&f.$evalAsync(f.closeLightbox)});var r=s.GetUserSettingsProperty("locations");f.filteredLocations=r.map(function(e){return n.territories[e]}),g(),f.dateSelectFinishWidget=u,f.dateSelectStartWidget=d,f.validateDatesStart=v,f.validateDatesEnd=h,f.optimizeAllServices="all",f.runOptimizion=p,f.selectedLocations={},f.checkBoxFields=a.checkBoxFields,f.optimizeSelectedFilter="noFilter",f.orphanServices=!1,f.policyOptions=i.policies,f.selectedPolicy=f.policyOptions[0];for(var o=0;o<i.policies.length;o++)if(i.policies[o].Id===i.selectedPolicyId){f.selectedPolicy=i.policies[o];break}var c=m();c.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(c),f.closeLightbox=l,f.$on("$destroy",function(){return c.remove()}),e(c)(f),c.show(),i.setLightBoxStatus()}function l(){i.setLightBoxStatus(!1),f.$destroy()}function u(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(f.actionFinish),navigation:!0,handler:function(e,t){var n=new Date(e);n.setMinutes(parseInt(f.endMinutes)),n.setHours(parseInt(f.endHour)),n<f.actionStart?alert(customLabels.finishAfterStart):f.actionFinish=n,scheduler.destroyCalendar(),f.$apply()}})}function d(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(f.actionStart),navigation:!0,handler:function(e,t){var n=new Date(e);n.setMinutes(parseInt(f.startMinutes)),n.setHours(parseInt(f.startHour)),n>f.actionFinish?alert(customLabels.startBeforeEnd):f.actionStart=n,scheduler.destroyCalendar(),f.$apply()}})}function v(){var e=new Date(f.actionStart);e.setMinutes(parseInt(f.startMinutes)),e.setHours(parseInt(f.startHour)),e>=f.actionFinish?(alert(customLabels.startBeforeEnd),f.startMinutes=f.actionStart.getMinutes(),f.startHour=f.actionStart.getHours().toString()):f.actionStart=e}function h(){var e=new Date(f.actionFinish);e.setMinutes(parseInt(f.endMinutes)),e.setHours(parseInt(f.endHour)),e<=f.actionStart?(alert(customLabels.finishAfterStart),f.endMinutes=f.actionFinish.getMinutes().toString(),f.endHour=f.actionFinish.getHours().toString()):f.actionFinish=e}function g(){f.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),f.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),f.startHour="0",f.endHour="0",f.startMinutes="0",f.endMinutes="0"}function p(){var e=[],t=void 0,n=void 0,s=void 0,r=void 0;for(var c in f.selectedLocations)f.selectedLocations[c]&&e.push(c);return 0===e.length?void alert(customLabels.noLocationWasSelected):(t=f.actionStart,n=f.actionFinish,n.setDate(n.getDate()+1),s="noFilter"===f.optimizeSelectedFilter?null:f.optimizeSelectedFilter,r="all"===f.optimizeAllServices,i.setBulkActionRunning(),o.runOptimization(t,n,e,r,f.orphanServices,f.selectedPolicy.Id,s).then(function(e){e?o.getRequestObject(e).then(function(e){e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?a.addNotification(customLabels.Optimization_Request_Sent,customLabels.Optimization_sent_details,function(e){a.openSObjectLink("../"+e)},e.Id):a.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){a.openSObjectLink("../"+e)},e.Id)}):a.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)})["catch"](function(e){console.warn("runOptimization failed :("),console.log(e)})["finally"](function(){i.setBulkActionRunning(!1)}),void f.closeLightbox())}function m(){var e=customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n								<option value="all">'+customLabels.All+'</option>\n								<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n							</select>"),t='<div id="PolicyInOptimize">'+customLabels.Use_the_following_policy_x_and_y.replace("$0",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions"></select>').replace("$1",'<select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n								 	<option ng-repeat="(fieldName, fieldLbl) in checkBoxFields()" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n								 	<option value="noFilter">'+customLabels.None+"</option>\n								 </select>")+"</div>";return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer LightboxContainerAnimation" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.Optimize+'</h1>\n                        </div>\n\n\n                        <div class="lightboxContentContainer">\n\n                            <p class="bulkExplain">'+customLabels.SelectServicesOptimize+'</p>\n\n                            <div class="selectedTargetLocations">\n                                <label for="bulkRadioSelectedIds">'+customLabels.ChooseLocationsLB+'</label>\n                            </div>\n\n\n                            <div id="bulkLocationNames">\n                                <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                    <input ng-model="selectedLocations[location.id]" type="checkbox" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                    <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                </div>\n\n                                <div>\n                                    <input ng-model="orphanServices" type="checkbox" name="orphanLocationsOptimize" id="orphanLocationsOptimize" />\n                                    <label for="orphanLocationsOptimize">'+customLabels.IncludeServicesNoLocations+'</label>\n                                </div>\n                            </div>\n\n\n                            <div class="bulkOptimizeOptions">\n                                '+e+"\n                                "+t+'\n                            </div>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <div class="lightboxSaveButton" ng-click="runOptimizion()">'+customLabels.Optimize+"</div>\n                        </div>\n\n\n                    </div>\n                </div>\n            ")}for(var f=null,S=[],b=0;60>b;b++)S.push(b);return{open:c}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","servicesService","utils","sfdcService"],angular.module("serviceExpert").factory("optimizeLightboxService",e)}(),function(){angular.module("serviceExpert").factory("ResourceCapacitiesService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils","StateService",function(e,t,n,s,i){function r(e,t){for(var n=new Date(e),i=null;t>n;){var r=s.formatDayToString(n);if(!c[r]){c[r]=!0,i||(i=o());var l=new Date(n);l.setDate(l.getDate()+1);for(var u=0;u<=i.length;u++)a(new Date(n),new Date(l),i[u])}n.setDate(n.getDate()+1)}}function a(e,t,n){if(e.getTime()!=t.getTime()){var s={};for(var i in scheduler.matrix)"MonthlyView"!==i&&(s[i]=[n]);var r="capacityPattern";scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:s,css:r})}}function o(){for(var n=[],i=t.resourcesAndTerritories(),r=0;r<=e.contractorResources.length;r++){var a=e.contractorResources[r],o=i[a];for(var c in o){var l=o[c];n.push(s.generateResourceId(a,l.serviceTerritory))}}return n}var c={};return n.$on("gotNewTimePhasedObjects",function(e,t){i.areContractorsSupported()&&r(t.start,t.finish)}),{}}])}(),function(){angular.module("serviceExpert").factory("resourceFilterHelper",["$q","sfdcService","$sce",function(e,t,n){function s(){return u}function i(){return d}function r(e,t){var n=v.picklistOptions.indexOf(e);-1===n?v.picklistOptions.push(e):v.picklistOptions.splice(n,1)}function a(){if(v.selectedPicklist&&(v.picklistOptions.length||v.picklistNullValues))return!0;for(var e in v.resourceFilteringOptions)if(v.resourceFilteringOptions[e])return!0;return!1}function o(){v.selectedPicklist="select_a_field",v.length=0,v.picklistOptions.length=0,v.picklistNullValues=!1;for(var e in v.resourceFilteringOptions)v.resourceFilteringOptions[e]=!1}function c(){for(var e in v.resourceFilteringOptions)v.resourceFilteringOptions[e]=!0}function l(e){var t="",n="",s=customLabels.SelectAfieldToResourceFilter;e&&(t="<b>"+customLabels.CurrentlyWorking+"</b>");for(var i in u)"BOOLEAN"===u[i][1]&&v.resourceFilteringOptions[u[i][2]]?""===t?t="<b>"+u[i][0]+"</b>":t+=" and <b>"+u[i][0]+"</b>":"PICKLIST"===u[i][1]&&v.selectedPicklist===u[i][2]&&(n=v.picklistOptions.join("</b> "+customLabels.or+" <b>"),n.length>0&&(n="<b>"+u[i][0]+"</b> is <b>"+n+"</b>"),v.picklistNullValues&&(""===n?n="<b>"+customLabels.None+"</b>":n+=" "+customLabels.or+" <b>"+customLabels.None+"</b>"));return""!==t&&""!==n?s=customLabels.Resources_That_Are_x_and_y.replaceAll(t,n):""===t&&""!==n?s=customLabels.Resources_That_Are_x.replaceAll(n):""!==t&&""==n&&(s=customLabels.Resources_That_Are_x.replaceAll(t)),s}var u=null,d=null,v={selectedPicklist:null,resourceFilteringOptions:{},picklistOptionsModel:[],picklistOptions:[],picklistNullValues:!1},h=t.getResourceFieldSetFields().then(function(e){u=e,u.Name=["Name","STRING","Name"];for(var t in u)"BOOLEAN"===u[t][1]&&(v.resourceFilteringOptions[t]=!1)});return h.then(function(){var e=[];for(var n in u)"PICKLIST"===u[n][1]&&e.push(n);t.getResourcePicklistValues(e).then(function(e){d=e})}),{getResourceFieldset:s,getPicklistNames:i,selectionInfo:v,updateSelectedPicklist:r,resetFilter:o,setAll:c,generateFilterExplanation:l,isResourceFilterApplied:a,resourceFieldToSortyBy:"Name",descending:!0}}])}(),function(){function e(e,t,n,s,i,r,a,o,c,l,u,d,v){function h(a,o){if(!$){$=e.$new(!0),$.lightboxResource=t.getResources()[a],$.terMemberKey=o,$.selectedTab="details",$.urls={related:n.trustAsResourceUrl(customResourceRelatedListLightboxPage+"?id="+a).toString(),chatter:n.trustAsResourceUrl(customResourceChatter+"?id="+a).toString(),details:n.trustAsResourceUrl(customResourceLightboxPage+"?id="+a).toString(),calendar:n.trustAsResourceUrl("vf079_ResourceCalendar?id="+a).toString()},$.urls.custom1=CustomResourceTab1?n.trustAsResourceUrl(CustomResourceTab1+"?id="+a).toString():null,$.urls.custom2=CustomResourceTab2?n.trustAsResourceUrl(CustomResourceTab2+"?id="+a).toString():null,$.changeTab=p,$.closeLightbox=g,$.chatterAvailable=fieldTrackingEnabled.resource,$.formatTravel=f,$.openConsoleTab=i.openConsoleTab,$.formatKpitText=S,$.formatCapacityKpitText=b,$.getContractorCapacityStatus=F,$.isMapEnabled=r.isMapEnabled(),$.contractorSupport=r.areContractorsSupported(),$.isDaily="ZoomLevel3"==scheduler._mode?!0:!1,$.actualRoute=null,$.showActual=!0,$.toggleShowRoute=I,$.toggleActualVisibilityWhenMapTabClicked=P,Chart.defaults.global.colours=["#16325c","#DCDCDC","#F7464A","#46BFBD","#FDB45C","#949FB1","#4D5360"],$.donutCharts=null,$.isMapEnabled&&y(),m(a),F(a);var c=N();c.find("#ResourceLightbox").draggable({handle:"#ResourceLightboxHeader"}),angular.element("body").append(c),r.setLightBoxStatus(),$.$on("$destroy",function(){return c.remove()}),$.$on("keypress",function(e,t){27==t.which&&$.$evalAsync($.closeLightbox)}),s(c)($),i.safeApply($),v.getResourceActualRoute($.lightboxResource.id,scheduler.getState().min_date).then(A)}}function g(){$.killWatch&&$.killWatch(),r.setLightBoxStatus(!1),$.$destroy(),$=null}function p(e){e!==$.selectedTab&&($.selectedTab=e)}function m(e){var t=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date);$.resourceKpi={total:0,completed:0,violations:0,jeopardy:0,avgTravelTime:0,totalScheduledDuration:0};for(var n=0;n<t.length;n++)t[n].resource==e&&("na"===t[n].type&&($.resourceKpi.avgTravelTime+=t[n].travelTo+t[n].travelFrom),"service"===t[n].type&&($.resourceKpi.total++,t[n].statusCategory==l.COMPLETED&&$.resourceKpi.completed++,t[n].violations&&$.resourceKpi.violations++,t[n].jeopardy&&$.resourceKpi.jeopardy++,$.resourceKpi.avgTravelTime+=t[n].travelTo+t[n].travelFrom,t[n].start_date&&t[n].end_date&&($.resourceKpi.totalScheduledDuration+=(t[n].finish-t[n].start)/1e3)));t.length>0&&$.resourceKpi.total>0?$.resourceKpi.avgTravelTime=Math.floor($.resourceKpi.avgTravelTime/60/$.resourceKpi.total):$.resourceKpi.avgTravelTime=0}function f(e){var t=Math.floor(e/60/60),n=Math.floor(e/60%60);return t+customLabels.kpi_h+" "+n+customLabels.kpi_m}function S(){return $.isDaily?customLabels.KPIsAreCalculatedFrom.replaceAll(moment(scheduler._min_date).format("ll"),moment(scheduler._max_date).format("ll")):customLabels.KPIsAreCalculatedFromTo.replaceAll(moment(scheduler._min_date).format("ll"),moment(scheduler._max_date).format("ll"))}function b(e,t){return""===e||""===t?"":customLabels.Between_x_and_y.replaceAll(moment(e).format("ll"),moment(t).format("ll"))}function y(){$.getServiceInfoRowClass=i.getServiceInfoRowClass,$.firstMapShow=!0,$.showRoute=!0,$.showTrafficLayer=!1,$.showServices=!0,$.mapControl={},$.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}},$.serviceInfoWindow={show:!1},$.livePosInfoWindow={show:!1},$.resourceInfoWindow={show:!1},$.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)},resource:{pixelOffset:new google.maps.Size(0,-38)}},$.resourceServicesDate=scheduler.getState().min_date,$.markersArray=[],d.fieldsSetFields().then(function(e){$.serviceFields=e.MapInfo}),$.killWatch=$.$watch("selectedTab",function(e){"map"==e&&o(function(){if($.map=$.mapControl.getGMap(),google.maps.event.trigger($.map,"resize"),$.firstMapShow){$.firstMapShow=!1;var e=$.map.getStreetView(),t={fullscreenControl:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER}};e.setOptions(t),$.firstMapShow=!1,$.generateMarkersAndRoute()}},0)}),$.generateMarkersAndRoute=T,$.openDatePicker=D,$.routeToggled=function(){var e=$.showRoute?$.map:null;$.polyLineGoogleObj&&$.polyLineGoogleObj.setMap(e),$.directionsDisplay&&$.directionsDisplay.setMap(e)},$.markerClicked=function(e,t,n){_(n)},$.markerCloseClicked=function(){$.serviceInfoWindow.show=!1,$.livePosInfoWindow.show=!1,$.resourceInfoWindow.show=!1,$.$apply()},$.openFieldSetLink=function(e,t){i.openLink(e,t)},$.openLink=function(e){i.openSObjectLink(e)}}function _(e){var t=e.type;switch($.serviceInfoWindow.show=!1,$.livePosInfoWindow.show=!1,$.resourceInfoWindow.show=!1,$.currentMarker=e,t){case"service":$.serviceInfoWindow.show=!0;break;case"lastKnownPosition":$.livePosInfoWindow.show=!0;break;case"resource":$.resourceInfoWindow.show=!0}o(function(){$.$apply(),i.setMapCloseButtonPosition()},0)}function T(e){$.resourceSLRPath={stroke:{weight:2,color:"#16325C"},path:[],geodesic:!0,toggle:!0},$.polyLinePath={path:[],geodesic:$.resourceSLRPath.geodesic,strokeColor:$.resourceSLRPath.stroke.color,strokeWeight:$.resourceSLRPath.stroke.weight,strokeOpacity:1},$.markersArray=[],$.bounds=new google.maps.LatLngBounds;var n=C(),s=R(),i={};if(n)if(n.latitude)i={latitude:n.latitude,longitude:n.longitude};else{var r=t.territories[n.serviceTerritory];r.latitude&&(i={latitude:r.latitude,longitude:r.longitude})}var a=null;i.latitude&&($.markersArray.push({id:n.serviceResource,type:"resource",coords:i,markerOptions:{icon:staticResources.homebase_png},resourceName:$.lightboxResource.name}),a=new google.maps.LatLng(i.latitude,i.longitude),$.polyLinePath.path.push(a),$.bounds.extend(a));for(var o=0;o<s.length;o++){var c=s[o];if(c.latitude){if($.showServices){var l=staticResources.service_png,u={id:c.id,type:"service",coords:{latitude:c.latitude,longitude:c.longitude},markerOptions:{icon:l,labelContent:"<span>"+(o+1)+"</span>"+moment(c.start).format("LT"),labelClass:"ResourceMapServiceMarkerLabel",zIndex:200},item:c};$.markersArray.push(u)}var d=new google.maps.LatLng(c.latitude,c.longitude);$.bounds.extend(d),$.resourceSLRPath.path.push({location:d,stopover:!0}),$.polyLinePath.path.push(d)}}if(i.latitude&&$.polyLinePath.path.push(a),!e){if($.showRoute)if(allowStreetLevelRouting&&$.resourceSLRPath.path.length>0){var v=new google.maps.DirectionsService;v.route({origin:a?a:$.resourceSLRPath.path[0].location,destination:a?a:$.resourceSLRPath.path[$.resourceSLRPath.path.length-1].location,waypoints:$.resourceSLRPath.path,travelMode:google.maps.TravelMode.DRIVING},function(e,t){t===google.maps.DirectionsStatus.OK?($.polyLineGoogleObj&&($.polyLineGoogleObj.setMap(null),$.polyLineGoogleObj=null),$.directionsDisplay||($.directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:!0})),$.directionsDisplay.setMap($.map),$.directionsDisplay.setDirections(e)):(window.alert("Directions request failed due to "+t),L())})}else L();else $.polyLineGoogleObj?$.polyLineGoogleObj.setMap(null):$.directionsDisplay&&$.directionsDisplay.setMap(null);var h=new google.maps.LatLng(37.794024,-122.394837);$.bounds.isEmpty()?$.map.setCenter(h):$.map.fitBounds($.bounds)}w()}function L(){$.directionsDisplay&&($.directionsDisplay.setMap(null),$.directionsDisplay=null),$.polyLineGoogleObj&&$.polyLineGoogleObj.setMap(null),$.polyLineGoogleObj=new google.maps.Polyline($.polyLinePath),$.polyLineGoogleObj.setMap($.map)}function w(){var e=u.lastKnownPositions();for(var t in e)k(e[t])}function k(e){var n=t.getResources()[e.id],s={id:e.id+"_position",markerOptions:{icon:staticResources.livepos_png},type:"lastKnownPosition",resourceId:e.id,coords:{latitude:e.latitude,longitude:e.longitude},item:angular.extend(angular.copy(e),{resourceName:n.name})};s.item.lastModifiedDate=i.convertDateBetweenTimeZones(s.item.lastModifiedDate,"UTC",userTimeZone),$.markersArray.push(s)}function C(){var e=$.resourceServicesDate,t=new Date(e);t.setHours(24,0,0,0);var n=a.resourcesAndTerritories();for(var s in n){var r=n[s];for(var o in r){var c=r[o];if(i.generateResourceId(c.serviceResource,c.serviceTerritory)==$.terMemberKey&&isIntersect(e,t,c.effectiveStartDate,c.effectiveEndDate))return c}}return null}function R(){var e=$.resourceServicesDate,t=new Date(e);t.setHours(24,0,0,0);var n=scheduler.getEvents(e,t),s=n.filter(function(e){return e.resourceId==$.terMemberKey&&e.latitude}).sort(function(e,t){return e.start.getTime()-t.start.getTime()});return s}function D(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"resourceServicesDateStart",date:new Date($.resourceServicesDate),navigation:!0,handler:function(e,t){$.$apply(function(){$.resourceServicesDate=e,$.generateMarkersAndRoute(),v.getResourceActualRoute($.lightboxResource.id,e).then(A)}),scheduler.destroyCalendar()}})}function A(e){$.actualRoute&&($.actualRoute.visible=!1,$.actualRoute.setMap($.map));var t={},n=[];e.forEach(function(e){("LastKnownLatitude"===e.Field||"LastKnownLongitude"===e.Field)&&(t[e.CreatedDate]=t[e.CreatedDate]||{},t[e.CreatedDate][e.Field.indexOf("Long")>-1?"lng":"lat"]=e.NewValue,t[e.CreatedDate].date=e.CreatedDate)});for(var s in t)n.push(t[s]);$.actualRoute=new google.maps.Polyline({path:n,geodesic:!0,strokeColor:"#ff73bf",strokeOpacity:1,strokeWeight:3}),x()&&$.actualRoute.setMap($.map)}function I(){$.actualRoute&&($.actualRoute.visible=$.showActual,$.actualRoute.setMap($.map))}function x(){return $.showActual}function F(e){for(var t=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),n=[],s=[],i=0;i<t.length;i++)t[i].resource==e&&"contractorcapacity"==t[i].type&&("Week"==t[i].timePeriod&&n.push(t[i]),"Month"==t[i].timePeriod&&s.push(t[i]));$.donutCharts=M(),setTimeout(function(){E(n[0],s[0])},1e3)}function M(){var e={segmentShowStroke:!1,segmentStrokeColor:"#fff",segmentStrokeWidth:2,percentageInnerCutout:75,animation:!0,animationSteps:100,animationEasing:"easeOutSine",animateRotate:!0,animateScale:!1,showTooltips:!0};return{labels:[customLabels.Hours_Used,customLabels.Hours_Available],weekly:{data:[],percentage:"",start:"",end:"",show:!1,options:e},monthly:{data:[],percentage:"",start:"",end:"",show:!1,options:e}}}function E(e,t){var n;e?(n=e.hoursPerTimePeriod-e.hoursInUse,0>n&&(n=0),$.donutCharts.weekly.data=[e.hoursInUse,n],$.donutCharts.weekly.percentage=O(e.hoursInUse,e.hoursPerTimePeriod)+"%",$.donutCharts.weekly.start=e.start_date,$.donutCharts.weekly.end=e.end_date,$.donutCharts.weekly.show=!0):($.donutCharts.weekly.data=[0,10],$.donutCharts.weekly.show=!1,$.donutCharts.weekly.options.showTooltips=!1,$.donutCharts.weekly.start=$.kpiStart,$.donutCharts.weekly.end=$.kpiEnd),t?(n=t.hoursPerTimePeriod-t.hoursInUse,0>n&&(n=0),$.donutCharts.monthly.data=[t.hoursInUse,n],$.donutCharts.monthly.percentage=O(t.hoursInUse,t.hoursPerTimePeriod)+"%",$.donutCharts.monthly.start=t.start_date,$.donutCharts.monthly.end=t.end_date,$.donutCharts.monthly.show=!0):($.donutCharts.monthly.data=[0,10],$.donutCharts.monthly.show=!1,$.donutCharts.monthly.options.showTooltips=!1,$.donutCharts.monthly.start=scheduler.getState().min_date,$.donutCharts.monthly.end=scheduler.getState().max_date)}function O(e,t){return parseFloat((e/t*100).toFixed(2))}function P(){o(function(){return $.actualRoute.setMap($.map)},500)}function N(){return angular.element('<div class="LightboxBlackContainer ng-cloack">\n                    <div class="LightboxContainer ng-cloak" id="ResourceLightbox">\n\n                        <div class="lightboxHeaderContainer" id="ResourceLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <img ng-show="lightboxResource.pictureLink" class="resourcePhotoLightbox" ng-src="{{ lightboxResource.pictureLink }}" alt="{{ lightboxResource.name }}" />\n                            <div ng-show="!lightboxResource.pictureLink" alt="{{ lightboxResource.name }}" class="ResourcePhotoIcon resourcePhotoLightbox"></div>\n\n                            <h1 class="lightboxHeader" id="resourceName" ng-bind="lightboxResource.name"></h1>\n                            <span ng-click="changeTab(\'details\')" ng-class="{lightboxSelectedTab: selectedTab == \'details\'}">\n                                '+customLabels.Details+"\n                            </span>\n\n                            <span ng-click=\"changeTab('relatedLists')\" ng-class=\"{lightboxSelectedTab: selectedTab == 'relatedLists'}\">\n                                "+customLabels.Related+'\n                            </span>\n\n                            <span ng-show="chatterAvailable" ng-click="changeTab(\'chatter\')" ng-class="{lightboxSelectedTab: selectedTab == \'chatter\'}">\n                                '+customLabels.Chatter+'\n                            </span>\n\n                            <span ng-if="isMapEnabled" ng-click="changeTab(\'map\'); toggleActualVisibilityWhenMapTabClicked(); " ng-class="{lightboxSelectedTab: selectedTab == \'map\'}">\n                                '+customLabels.Map+"\n                            </span>\n\n                            <span ng-click=\"changeTab('calendar')\" ng-class=\"{lightboxSelectedTab: selectedTab == 'calendar'}\">\n                                "+customLabels.Calendar+'\n                            </span>\n                            \n                            <span ng-show="urls.custom1" ng-click="changeTab(\'customTab1\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab1\'}">\n                                '+customLabels.CustomResourceTab1+'\n                            </span>\n                            \n                            <span ng-show="urls.custom2" ng-click="changeTab(\'customTab2\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab2\'}">\n                                '+customLabels.CustomResourceTab2+'\n                            </span>\n\n                            <div class="ExtendedForm">\n                                <a ng-click="openConsoleTab($event,lightboxResource.id)" target="_blank" href="../{{ lightboxResource.id }}" title="'+customLabels.ExtandedForm+'">\n                                    <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                        \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                    \u2028</svg>\n                                </a>\n                            </div>\n                        </div>\n\n                        <section ng-if="isMapEnabled" id="resourceLightboxMap" ng-show ="selectedTab == \'map\'">\n                            <ui-gmap-google-map pan="false" control="mapControl" center="{latitude: 0 ,longitude: 0}" options="mapOptions" zoom="16" class="map-canvas">\n                                <ui-gmap-markers click="markerClicked" models="markersArray" idKey="id" coords="\'coords\'" options="\'markerOptions\'"">\n                                </ui-gmap-markers>\n\n                                <ui-gmap-window show="serviceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.service" >\n                                    <div class="googleMapInfoWindowService">\n                                        <img class="mapTooltipIcon" src="'+staticResources.wo_icon_png+'"/>\n                                        <h1 class="truncate mapTooltipTitle">{{currentMarker.item | displayFieldSetField : serviceFields[0] }}</h1>\n\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[1] || serviceFields[1]">{{serviceFields[1].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[1])" ng-class="getServiceInfoRowClass(serviceFields[1])">{{currentMarker.item | displayFieldSetField : serviceFields[1]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[2] || serviceFields[2]">{{serviceFields[2].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[2])" ng-class="getServiceInfoRowClass(serviceFields[2])">{{currentMarker.item | displayFieldSetField : serviceFields[2]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[3] || serviceFields[3]">{{serviceFields[3].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[3])" ng-class="getServiceInfoRowClass(serviceFields[3])">{{currentMarker.item | displayFieldSetField : serviceFields[3]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[4] || serviceFields[4]">{{serviceFields[4].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[4])" ng-class="getServiceInfoRowClass(serviceFields[4])">{{currentMarker.item | displayFieldSetField : serviceFields[4]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[5] || serviceFields[5]">{{serviceFields[5].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[5])" ng-class="getServiceInfoRowClass(serviceFields[5])">{{currentMarker.item | displayFieldSetField : serviceFields[5]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[6] || serviceFields[6]">{{serviceFields[6].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[6])" ng-class="getServiceInfoRowClass(serviceFields[6])">{{currentMarker.item | displayFieldSetField : serviceFields[6]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[7] || serviceFields[7]">{{serviceFields[7].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[7])" ng-class="getServiceInfoRowClass(serviceFields[7])">{{currentMarker.item | displayFieldSetField : serviceFields[7]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[8] || serviceFields[8]">{{serviceFields[8].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[8])" ng-class="getServiceInfoRowClass(serviceFields[8])">{{currentMarker.item | displayFieldSetField : serviceFields[8]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[9] || serviceFields[9]">{{serviceFields[9].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[9])" ng-class="getServiceInfoRowClass(serviceFields[9])">{{currentMarker.item | displayFieldSetField : serviceFields[9]}}</span></div>\n\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-window show="resourceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.resource">\n                                    <div class="googleMapInfoWindowHomebase">\n                                        <svg aria-hidden="true" class="slds-icon homebaseTooltipIcon">\n                                            \u2028<use xlink:href="'+lsdIcons.home+'"></use>\n                                        \u2028</svg>\n                                        <h1 class="truncate mapTooltipTitle"><span class="homebaseLabel">{{ "'+customLabels.homebase_of+'" | replaceLabels : currentMarker.resourceName }}</span></h1>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.id)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-window show="livePosInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.livePos">\n                                    <div class="googleMapInfoWindowLivePos">\n                                        <svg aria-hidden="true" class="slds-icon livePosTooltipIcon">\n                                        \u2028	<use xlink:href="'+lsdIcons.user+'"></use>\n                                    \u2028	</svg>\n                                        <h1 class="truncate mapTooltipTitle" ng-bind="$parent.$parent.$parent.currentMarker.item.resourceName"></h1>\n                                        <div>'+customLabels.Last_seen+' {{ currentMarker.item.lastModifiedDate | amDateFormat:\'lll\' }}</div>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.resourceId)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-layer type="TrafficLayer"\n                                show=\'showTrafficLayer\'\n                                >\n                            </ui-gmap-layer>\n                            </ui-gmap-google-map>\n                            <div id="ResourceMapOptions">\n                                <div id="ResourceMapOptionsWrapper">\n                                    <input ng-model="$parent.showServices" ng-change="generateMarkersAndRoute(true)" type="checkbox" id="ResourceServicesFilter"></input>\n                                    <label for="ResourceServicesFilter">'+customLabels.Show_services_for+'</label>\n                                    <u id="resourceServicesDateStart" class="bulkDatePicker" ng-click ="openDatePicker()" >{{resourceServicesDate | amDateFormat:\'L\'}}</u>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="$parent.showRoute" ng-change="routeToggled()" type="checkbox" id="RouteFilter"></input>\n                                    <label ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="RouteFilter">'+customLabels.Route+'</label>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="$parent.showActual" ng-change="toggleShowRoute()" type="checkbox" id="actualToggle"></input>\n                                    <label ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="actualToggle">'+customLabels.ActualRoute+'</label>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="showTrafficLayer" type="checkbox" id="trafficToggle"></input>\n                                    <label ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="trafficToggle">'+customLabels.Traffic+'</label>\n                                </div>\n                            </div>\n                        </section>\n\n                        <div class="capacitiesDonuts" ng-show="selectedTab == \'details\' && lightboxResource.isCapacityBased && contractorSupport">\n                            <div id="weeklyCapacity">\n                                <div id="weeklyDonutPercentage" class="donutPercentage">\n                                    <div ng-show="donutCharts.weekly.show" ng-bind="donutCharts.weekly.percentage"></div>\n                                    <div class="noCapacity" ng-show="!donutCharts.weekly.show">'+customLabels.No_Weekly_Capacity+'</div>\n                                    <div class="capacityTimeFrameLabel" ng-show="donutCharts.weekly.show">'+customLabels.Weekly_Capacity+'</div>\n                                </div>\n                                <canvas id="weeklyDoughnutChart"\n                                        class="chart chart-doughnut"\n                                        chart-options="donutCharts.weekly.options"\n                                        chart-data="donutCharts.weekly.data"\n                                        chart-labels="donutCharts.labels">\n                                </canvas>\n                                <div class="capacityRange">{{formatCapacityKpitText(donutCharts.weekly.start, donutCharts.weekly.end)}}</div>\n                            </div>\n\n                            <div id="monthlyCapacity">\n                                <div id="monthlyDonutPercentage" class="donutPercentage">\n                                    <div ng-show="donutCharts.monthly.show" ng-bind="donutCharts.monthly.percentage"></div>\n                                    <div class="noCapacity" ng-show="!donutCharts.monthly.show">'+customLabels.No_Monthly_Capacity+'</div>\n                                    <div class="capacityTimeFrameLabel" ng-show="donutCharts.monthly.show">'+customLabels.Monthly_Capacity+'</div>\n                                </div>\n                                <canvas id="monthlyDoughnutChart"\n                                        class="chart chart-doughnut"\n                                        chart-options="donutCharts.monthly.options"\n                                        chart-data="donutCharts.monthly.data"\n                                        chart-labels="donutCharts.labels">\n                                </canvas>\n                                <div class="capacityRange">{{formatCapacityKpitText(donutCharts.monthly.start, donutCharts.monthly.end)}}</div>\n                            </div>\n                        </div>\n\n                        <div id="KPIforResource" ng-show="selectedTab == \'details\'" ng-class="{KPIforResourceWithCapacity: (lightboxResource.isCapacityBased && contractorSupport)}">\n                            <div class="kpiIndicator" ng-show="!lightboxResource.isCapacityBased || (lightboxResource.isCapacityBased && !contractorSupport)">\n                                <div class="kpiResourceValue" >\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.clock+'"></use>\u2028</svg>\n                                    {{ formatTravel(resourceKpi.totalScheduledDuration) }}\n                                </div>\n\n                                '+customLabels.Total_Scheduled+'\n                            </div>\n\n                            <div class="kpiIndicator" ng-show="isMapEnabled && (!lightboxResource.isCapacityBased || (lightboxResource.isCapacityBased && !contractorSupport))">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIconTravel"><use xlink:href="'+lsdIcons.car+'"></use>\u2028</svg>\n                                    {{ formatTravel(resourceKpi.avgTravelTime * 60) }}\n                                </div>\n\n                                '+customLabels.Average_Travel+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.violation+'"></use>\u2028</svg>\n                                    {{ resourceKpi.violations }}\n                                </div>\n\n                                '+customLabels.Violations+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon"><use xlink:href="'+lsdIcons.jeopardy+'"></use>\u2028</svg>\n                                    {{ resourceKpi.jeopardy }}\n                                </div>\n                                 '+customLabels.In_Jeopardy+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.completed+'"></use>\u2028</svg>\n                                    {{ resourceKpi.completed }}/{{ resourceKpi.total }}\n                                </div>\n\n                                '+customLabels.Completed+'\n                            </div>\n\n                            <div class="KpiRange">{{formatKpitText()}}</div>\n                        </div>\n\n                        <iframe ng-src="{{ urls.details }}" id="detailsIframeResource" ng-class="{detailsIframeResourceContractor: lightboxResource.isCapacityBased && contractorSupport}" ng-show="selectedTab == \'details\'"></iframe>\n                        <iframe ng-src="{{ urls.related }}" id="relatedListIframeResource" ng-show="selectedTab == \'relatedLists\'" ></iframe>\n                        <iframe ng-src="{{ urls.chatter }}" id="chatterIframeResource" ng-show="selectedTab == \'chatter\'" ></iframe>\n                        <iframe ng-src="{{ urls.calendar }}" id="calendarIframeResource" ng-show="selectedTab == \'calendar\'" ></iframe>\n                        <iframe ng-if="urls.custom1" ng-show="selectedTab == \'customTab1\'" ng-src="{{ urls.custom1 }}" class="resourceLightboxIframe"></iframe>\n                        <iframe ng-if="urls.custom2" ng-show="selectedTab == \'customTab2\'" ng-src="{{ urls.custom2 }}" class="resourceLightboxIframe"></iframe>\n\n                    </div>\n                </div>');
}var $=null;return{open:h}}e.$inject=["$rootScope","ResourcesAndTerritoriesService","$sce","$compile","utils","StateService","TimePhasedDataService","$timeout","SERVICE_STATUS","SERVICE_CATEGORY","LastKnownPositionService","FieldSetFieldsService","sfdcService"],angular.module("serviceExpert").factory("ResourceLightboxService",e)}(),function(){function e(e,t,n,s,i,r,a,o,c){function l(i,r,a){g=e.$new(!0),g.menuResource=t.getResources()[i],g.resourceId=i,g.section=r,g.openResourceLightbox=d,g.runDynamicGanttFunction=v,g.hasCustomPermission=s.hasCustomPermission;var o=h(),c=$($(a).closest(".resourceMenuBtn")),l=c.offset();angular.element("body").append(o),$(".resourceMenuContainer").css({top:l.top,left:l.left}),g.$on("$destroy",function(){return o.remove()}),angular.element("body").on("mousedown",function(e){for(var t=["resMenuSingleAction"],n=0;n<t.length;n++)if(e.target.classList.contains(t[n])||e.target.parentNode&&e.target.parentNode.classList.contains(t[n]))return;u(),e.stopPropagation(),angular.element("body").off("mousedown")}),n(o)(g),s.safeApply(g)}function u(){g.$destroy()}function d(){i.open(g.resourceId,g.section.key)}function v(e){var t=void 0,n=void 0;t=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),n=a.selectedPolicyId;var i={FillInSchedule:{FunctionName:r.runFillInSchedule,NotificationHeaderText:customLabels.x_request_sent.replaceAll(customLabels.Fill_in_Schedule),NotificationText:customLabels.RequestNotificationSent.replaceAll(customLabels.Fill_in_Schedule,g.menuResource.name,moment(t).format("L"))},FixOverlaps:{FunctionName:r.runFixOverlaps,NotificationHeaderText:customLabels.x_request_sent.replaceAll(customLabels.FixOverlaps),NotificationText:customLabels.RequestNotificationSent.replaceAll(customLabels.FixOverlaps,g.menuResource.name,moment(t).format("L"))}};if(useLocationTimezone){var l=t,d=addDaysToDate(t,1),v={start_date:l,end_date:d},h=c.getIntersectingSrstOffset(v,g.resourceId),p=s.getUserOffset(l);s.getUserOffset(d);t.setMinutes(l.getMinutes()+p-h)}var m=i[e].FunctionName;m(t,g.resourceId,n).then(function(t){t?(t[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?s.addNotification(i[e].NotificationHeaderText,i[e].NotificationText,function(e){s.openSObjectLink("../"+e)},t.Id):s.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){s.openSObjectLink("../"+e)},t.Id),o.updateOptimizationRequest(t)):s.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).then(function(){})["catch"](function(t){console.warn(e+" failed :("),console.log(t),s.addNotification(customLabels.Action_Could_Not_Be_Performed,t.message)})["finally"](function(){}),u()}function h(){return angular.element('\n                    <div id="resourceMenu" class="resourceMenuContainer">\n                        <div class="truncate resMenuSingleAction" ng-click="openResourceLightbox()" title="'+customLabels.Details+'">\n                            <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                <use xlink:href="'+lsdIcons.info+'"></use>\n                            \u2028</svg>\n                            '+customLabels.Details+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="runDynamicGanttFunction(\'FixOverlaps\')" ng-hide="menuResource.isCapacityBased || !hasCustomPermission(\'Fix_Overlaps\')" title="'+customLabels.FixOverlaps+'">\n                            <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                <use xlink:href="'+lsdIcons.crossfilter+'"></use>\n                            \u2028</svg>\n                            '+customLabels.FixOverlaps+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="runDynamicGanttFunction(\'FillInSchedule\')" ng-hide="!hasCustomPermission(\'Fill_in\')" title="'+customLabels.Fill_in_Schedule+'">\n                            <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                <use xlink:href="'+lsdIcons.summarydetail+'"></use>\n                            \u2028</svg>\n                            '+customLabels.Fill_in_Schedule+"</div>\n                    </div>\n                ")}var g=null;return{open:l}}e.$inject=["$rootScope","ResourcesAndTerritoriesService","$compile","utils","ResourceLightboxService","sfdcService","StateService","DeltaService","TimePhasedDataService"],angular.module("serviceExpert").factory("ResourceSmallMenu",e)}(),function(){function e(e,t){function n(){return l}function s(){return d}function i(){var n=e.defer();return t.GetResourcesAndTerritories().then(function(e){n.resolve(),e.territories.forEach(function(e){e.IsActive&&(o[e.Id]=new ServiceTerritory(e)),c[e.Id]=new ServiceTerritory(e)}),e.resources.forEach(function(e){l[e.Id]=new ServiceResource(e),l[e.Id].isCapacityBased&&u.push(e.Id)}),e.operatingHours.forEach(function(e){d[e.Id]=new OperatingHours(e)}),a.territories.resolve(o),a.resources.resolve(l),a.operatingHours.resolve(d)})["catch"](function(e){n.reject(e),a.resources.reject(),a.territories.reject(),a.operatingHours.reject(),console.warn("GetResourcesAndTeritorries: unable to load resources, territories, or operating hours"),bootstrap.handleError(e)}),n.promise}function r(){o={},l={},d={},u=[]}var a={territories:e.defer(),resources:e.defer(),operatingHours:e.defer()},o={},c={},l={},u=[],d={};return i(),{promises:{territories:function(){return a.territories.promise},resources:function(){return a.resources.promise},operatingHours:function(){return a.operatingHours.promise}},territories:o,allTerritories:c,getResources:n,operatingHours:d,getOperatingHours:s,contractorResources:u,getResourceAndTerritories:i,reset:r}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("ResourcesAndTerritoriesService",e)}(),function(){function e(e,t,n,s,i,r,a,o,c,l,u,d,v,h){function g(o){T=e.$new(!0),T.lightboxService=t.serviceAppointments()[o],T.selectedTab="service",T.urls={service:n.trustAsResourceUrl(customLightboxPage+"?id="+o).toString()},T.lightboxService.accountId&&(T.urls.account=n.trustAsResourceUrl(customAccountLightbox+"?id="+T.lightboxService.accountId).toString()),T.urls.service_chatter=n.trustAsResourceUrl(customServiceChatterLightbox+"?id="+T.lightboxService.id).toString(),T.lightboxService.parentRecordType===r.WORKORDER?(T.urls.wo=n.trustAsResourceUrl(customWoLightbox+"?id="+T.lightboxService.parentRecord).toString(),T.urls.wo_chatter=n.trustAsResourceUrl(customWoChatterLightbox+"?id="+T.lightboxService.parentRecord).toString(),T.urls.related=n.trustAsResourceUrl(customWoRelatedLightbox+"?id="+T.lightboxService.parentRecord).toString()):T.lightboxService.parentRecordType===r.LINEITEM?(T.urls.wo=n.trustAsResourceUrl(customWoliLightbox+"?id="+T.lightboxService.parentRecord).toString(),T.urls.wo_chatter=n.trustAsResourceUrl(customWoliChatterLightbox+"?id="+T.lightboxService.parentRecord).toString(),T.urls.related=n.trustAsResourceUrl(customWoliRelatedLightbox+"?id="+T.lightboxService.parentRecord).toString()):T.lightboxService.parentRecordType===r.ACCOUNT?(T.urls.related=null,T.urls.account=n.trustAsResourceUrl(customAccountLightbox+"?id="+T.lightboxService.parentRecord).toString()):T.urls.related=null,T.urls.custom1=CustomServiceTab1?n.trustAsResourceUrl(CustomServiceTab1+"?id="+T.lightboxService.id).toString():null,T.urls.custom2=CustomServiceTab2?n.trustAsResourceUrl(CustomServiceTab2+"?id="+T.lightboxService.id).toString():null,T.changeTab=y,T.isChatterAvailable=m,T.closeLightbox=b,T.chatterAvailable=fieldTrackingEnabled.service,T.openConsoleTab=i.openConsoleTab,T.isMapEnabled=a.isMapEnabled(),T.selectedSubTabWo="details",T.selectedSubTabService="details",T.showWOTab=f,T.getIdOfObjectInActiveTab=p,T.isMapEnabled&&S(),T.$on("$destroy",function(){return c.remove()}),T.$on("keypress",function(e,t){27==t.which&&T.$evalAsync(T.closeLightbox)});var c=_();c.find("#ServiceLightbox").draggable({handle:"#ServiceLightboxHeader"}),a.setLightBoxStatus(),s(c)(T),i.safeApply(T,function(){angular.element("body").append(c)})}function p(){switch(T.selectedTab){case"account":return T.lightboxService.accountId?T.lightboxService.accountId:T.lightboxService.id;case"wo":return T.lightboxService.parentRecord?T.lightboxService.parentRecord:T.lightboxService.id;default:return T.lightboxService.id}}function m(e){return"wo"===e&&"WorkOrder"===T.lightboxService.parentRecordType&&fieldTrackingEnabled.workorder?!0:"wo"===e&&"WorkOrderLineItem"===T.lightboxService.parentRecordType&&fieldTrackingEnabled.woli?!0:"service"===e&&fieldTrackingEnabled.service?!0:!1}function f(e){return e===r.LINEITEM||e===r.WORKORDER}function S(){function e(e){var t=e.type;switch(T.serviceInfoWindow.show=!1,T.livePosInfoWindow.show=!1,T.currentMarker=e,t){case"service":T.serviceInfoWindow.show=!0;break;case"lastKnownPosition":T.livePosInfoWindow.show=!0}o(function(){T.$apply(),i.setMapCloseButtonPosition()},0)}function t(){var e=u.lastKnownPositions();for(var t in e)n(e[t])}function n(e){var t=d.getResources()[e.id],n={id:e.id+"_position",icon:staticResources.livepos_png,type:"lastKnownPosition",resourceId:e.id,coords:{latitude:e.latitude,longitude:e.longitude},item:angular.extend(angular.copy(e),{resourceName:t.name})};T.allMarkersArray.push(n)}if(T.serviceIcon=staticResources.wo_icon_png,T.resourceIcon=lsdIcons.user,T.lastSeenLabel=customLabels.Last_seen,T.getServiceInfoRowClass=i.getServiceInfoRowClass,T.currentMarker={},T.map=null,T.mapControl={},T.allMarkersArray=[],T.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}},T.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)}},T.serviceInfoWindow={show:!1},T.livePosInfoWindow={show:!1},l.fieldsSetFields().then(function(e){T.serviceFields=e.MapInfo}),null!=T.lightboxService.latitude&&null!=T.lightboxService.longitude)var s=c(function(){if(!T.mapControl||T.mapControl.getGMap){c.cancel(s),T.map=T.mapControl.getGMap();var e=staticResources.service_png;T.lightboxService.statusCategory==h.COMPLETED&&(e=staticResources.service_completed_png),T.allMarkersArray.push({id:T.lightboxService.id,icon:e,type:"service",coords:{latitude:T.lightboxService.latitude,longitude:T.lightboxService.longitude},item:T.lightboxService}),t();var n=new google.maps.LatLng(T.lightboxService.latitude,T.lightboxService.longitude);T.map.setCenter(n)}},500);T.openLink=function(e,t){i.openLink(e,t)},T.markerCloseClicked=function(){T.serviceInfoWindow.show=!1,T.livePosInfoWindow.show=!1,T.$apply()},T.markerClicked=function(t,n,s){e(s)},T.killWatch=T.$watch("selectedTab",function(e){"map"==e&&o(function(){google.maps.event.trigger(T.map,"resize")},0)})}function b(){a.setLightBoxStatus(!1),T.killWatch&&T.killWatch(),T.$destroy()}function y(e){e!==T.selectedTab&&(T.selectedTab=e)}function _(){return angular.element('<div class="LightboxBlackContainer">\n                <div class="LightboxContainer" id="ServiceLightbox">\n\n                    <div class="lightboxHeaderContainer" id="ServiceLightboxHeader">\n\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n\n                        <h1 class="lightboxHeader">{{lightboxService.name}}</h1>\n\n                        <span ng-click="changeTab(\'service\')" ng-class="{lightboxSelectedTab: selectedTab == \'service\'}">\n                            '+customLabels.Service+'\n                        </span>\n\n                        <span ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-click="changeTab(\'wo\')" ng-class="{lightboxSelectedTab: selectedTab == \'wo\'}">\n                            <div ng-show="lightboxService.parentRecordType === \'WorkOrder\'">'+customLabels.WorkOrder+"</div>\n                            <div ng-show=\"lightboxService.parentRecordType === 'WorkOrderLineItem'\">"+customLabels.Woli+'</div>\n                        </span>\n\n                        <span ng-show="urls.related" ng-click="changeTab(\'relatedList\')" ng-class="{lightboxSelectedTab: selectedTab == \'relatedList\'}">\n                            '+customLabels.Related+'\n                        </span>\n\n                        <span ng-if="isMapEnabled" ng-show="lightboxService.latitude && lightboxService.longitude" ng-click="changeTab(\'map\')" ng-class="{lightboxSelectedTab: selectedTab == \'map\'}">\n                            '+customLabels.Map+'\n                        </span>\n\n                        <span ng-show="urls.account" ng-click="changeTab(\'account\')" ng-class="{lightboxSelectedTab: selectedTab == \'account\'}">\n                            '+customLabels.Account+'\n                        </span>\n                        \n                        <span ng-show="urls.custom1" ng-click="changeTab(\'customTab1\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab1\'}">\n                            '+customLabels.CustomServiceTab1+'\n                        </span>\n                        \n                        <span ng-show="urls.custom2" ng-click="changeTab(\'customTab2\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab2\'}">\n                            '+customLabels.CustomServiceTab2+'\n                        </span>\n\n                        <div class="ExtendedForm">\n                            <a ng-click="openConsoleTab($event,getIdOfObjectInActiveTab())" target="_blank" href="../{{ getIdOfObjectInActiveTab() }}" title="'+customLabels.ExtandedForm+'">\n                                <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                    \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                \u2028</svg>\n                            </a>\n                        </div>\n\n                    </div>\n                   \n                    <div class="InnerWoTabs" ng-show="isChatterAvailable(\'service\') && selectedTab == \'service\'">\n                        <div class="InnerLightboxTab" ng-class="{\'selected\': selectedSubTabService == \'details\'}" ng-click="selectedSubTabService=\'details\'"}">'+customLabels.Details+"</div>\n                        <div class=\"InnerLightboxTab\" ng-class=\"{'selected': selectedSubTabService == 'feed'}\" ng-click=\"selectedSubTabService='feed'\">"+customLabels.Feed+'</div>\n                        <div class="InnerLightboxHr"></div>\n                    </div>\n                    \n                    <div class="InnerWoTabs" ng-show="isChatterAvailable(\'wo\') && selectedTab == \'wo\'">\n                        <div class="InnerLightboxTab" ng-class="{\'selected\': selectedSubTabWo == \'details\'}" ng-click="selectedSubTabWo=\'details\'"}">'+customLabels.Details+"</div>\n                        <div class=\"InnerLightboxTab\" ng-class=\"{'selected': selectedSubTabWo == 'feed'}\" ng-click=\"selectedSubTabWo='feed'\">"+customLabels.Feed+'</div>\n                        <div class="InnerLightboxHr"></div>\n                    </div>\n                    \n                    <iframe ng-show="selectedTab == \'wo\' && selectedSubTabWo == \'details\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'wo\')}" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-src="{{ urls.wo }}"></iframe>\n                    <iframe ng-show="selectedTab == \'wo\' && selectedSubTabWo == \'feed\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'wo\')}" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-src="{{ urls.wo_chatter }}"></iframe>\n                    \n                    <iframe ng-show="selectedTab == \'service\' && selectedSubTabService == \'details\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'service\')}"  ng-src="{{ urls.service }}"></iframe>\n                    <iframe ng-show="selectedTab == \'service\' && selectedSubTabService == \'feed\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'service\')}"  ng-src="{{ urls.service_chatter }}"></iframe>\n                    \n                    <iframe ng-show="selectedTab == \'relatedList\' && urls.related" ng-src="{{ urls.related }}"></iframe>  \n                    <iframe ng-show="selectedTab == \'account\' && urls.account" ng-src="{{ urls.account }}"></iframe>\n                    \n                    <iframe ng-if="urls.custom1" ng-show="selectedTab == \'customTab1\'" ng-src="{{ urls.custom1 }}"></iframe>\n                    <iframe ng-if="urls.custom2" ng-show="selectedTab == \'customTab2\'" ng-src="{{ urls.custom2 }}"></iframe>\n\n                    <section ng-if="isMapEnabled" id="serviceLightboxMap" ng-show ="selectedTab == \'map\'">\n                        <ui-gmap-google-map pan="false" control="mapControl" center="{latitude: 0 ,longitude: 0}" options="mapOptions" zoom="16" class="map-canvas">\n                            <ui-gmap-markers click="markerClicked" models="allMarkersArray" idKey="id" coords="\'coords\'" icon="\'icon\'">\n                            </ui-gmap-markers>\n\n                            <ui-gmap-window show="serviceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.service" >\n                                    <div class="googleMapInfoWindowService">\n                                        <img class="mapTooltipIcon" ng-src="{{serviceIcon}}"/>\n                                        <h1 class="truncate mapTooltipTitle">{{currentMarker.item | displayFieldSetField : serviceFields[0] }}</h1>\n\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[1] || serviceFields[1]">{{serviceFields[1].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[1])" ng-class="getServiceInfoRowClass(serviceFields[1])">{{currentMarker.item | displayFieldSetField : serviceFields[1]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[2] || serviceFields[2]">{{serviceFields[2].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[2])" ng-class="getServiceInfoRowClass(serviceFields[2])">{{currentMarker.item | displayFieldSetField : serviceFields[2]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[3] || serviceFields[3]">{{serviceFields[3].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[3])" ng-class="getServiceInfoRowClass(serviceFields[3])">{{currentMarker.item | displayFieldSetField : serviceFields[3]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[4] || serviceFields[4]">{{serviceFields[4].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[4])" ng-class="getServiceInfoRowClass(serviceFields[4])">{{currentMarker.item | displayFieldSetField : serviceFields[4]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[5] || serviceFields[5]">{{serviceFields[5].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[5])" ng-class="getServiceInfoRowClass(serviceFields[5])">{{currentMarker.item | displayFieldSetField : serviceFields[5]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[6] || serviceFields[6]">{{serviceFields[6].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[6])" ng-class="getServiceInfoRowClass(serviceFields[6])">{{currentMarker.item | displayFieldSetField : serviceFields[6]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[7] || serviceFields[7]">{{serviceFields[7].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[7])" ng-class="getServiceInfoRowClass(serviceFields[7])">{{currentMarker.item | displayFieldSetField : serviceFields[7]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[8] || serviceFields[8]">{{serviceFields[8].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[8])" ng-class="getServiceInfoRowClass(serviceFields[8])">{{currentMarker.item | displayFieldSetField : serviceFields[8]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[9] || serviceFields[9]">{{serviceFields[9].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[9])" ng-class="getServiceInfoRowClass(serviceFields[9])">{{currentMarker.item | displayFieldSetField : serviceFields[9]}}</span></div>\n\n                                    </div>\n                            </ui-gmap-window>\n\n                            <ui-gmap-window show="livePosInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.livePos">\n                                <div class="googleMapInfoWindowLivePos">\n                                    <svg aria-hidden="true" class="slds-icon livePosTooltipIcon">\n                                    \u2028	<use xlink:href="{{resourceIcon}}"></use>\n                                \u2028	</svg>\n                                    <h1 class="truncate mapTooltipTitle" ng-bind="$parent.$parent.$parent.currentMarker.item.resourceName"></h1>\n                                    <div>{{lastSeenLabel}} {{ currentMarker.item.lastModifiedDate | amDateFormat:\'lll\' }}</div>\n                                </div>\n                            </ui-gmap-window>\n                        </ui-gmap-google-map>\n                    </section>\n\n                </div>\n            </div>')}var T=null;return{open:g}}e.$inject=["$rootScope","TimePhasedDataService","$sce","$compile","utils","PARENT_RECORD_TYPE","StateService","$timeout","$interval","FieldSetFieldsService","LastKnownPositionService","ResourcesAndTerritoriesService","SERVICE_STATUS","SERVICE_CATEGORY"],angular.module("serviceExpert").factory("ServiceAppointmentLightboxService",e)}(),function(){function e(e,t,n,s,i){function r(){for(var e in v)v[e]=!1}function a(){p=e("servicesListFilter")(n.serviceAppointments(),h,g);for(var t=0;t<p.length;t++)v[p[t].id]=!0}function o(){r();var t=angular.copy(h);t.selectedFilter="Violating","Custom filter"==h.selectedFilter&&(t.endDate=h.advancedFilter.maxDate),p=e("servicesListFilter")(n.serviceAppointments(),h,g),p=e("servicesListFilter")(p,t,g);for(var s=0;s<p.length;s++)v[p[s].id]=!0}function c(){r();var t=angular.copy(h);t.selectedFilter="inJeopardy","Custom filter"==h.selectedFilter&&(t.endDate=h.advancedFilter.maxDate),p=e("servicesListFilter")(n.serviceAppointments(),h,g),p=e("servicesListFilter")(p,t,g);for(var s=0;s<p.length;s++)v[p[s].id]=!0}function l(){r();var t=angular.copy(h);t.selectedFilter="Unscheduled","Custom filter"==h.selectedFilter&&(t.endDate=h.advancedFilter.maxDate),p=e("servicesListFilter")(n.serviceAppointments(),h,g),p=e("servicesListFilter")(p,t,g);for(var s=0;s<p.length;s++)v[p[s].id]=!0}function u(){var e=0;for(var t in v)v[t]&&e++;return e}function d(){var e=[];for(var t in v)v[t]&&e.push(t);return e}var v={},h=t.filter,g=[],p={};return i.register("services",function(e){e.deleted&&e.deleted.forEach(function(e){return delete v[e]})}),s.getServiceListFields().then(function(e){g=e}),{SelectedServices:v,unselectAll:r,selectAll:a,selectViolations:o,selectInJeopardy:c,selectUnscheduled:l,countSelectedServices:u,getSelected:d}}e.$inject=["$filter","servicesService","TimePhasedDataService","sfdcService","DeltaService"],angular.module("serviceExpert").factory("ServiceSelectorService",e)}(),function(){function e(e,t,n){function s(e,t){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=n.getResources()[e];Array.isArray(t)||(t=[t]);for(var a=0,o=t.length;o>a;a++){if(!r.skills[t[a]])return!1;if(s&&i&&!isIntersect(s,i,r.skills[t[a]].effectiveStartDate,r.skills[t[a]].effectiveEndDate))return!1}return!0}var i=[],r={skills:e.defer()};return t.getSkills().then(function(e){for(var t=0;t<e.length;t++)i.push(e[t]);r.skills.resolve(i)})["catch"](function(e){r.skills.reject(e),console.log(e),console.warn("unable to get skill list")}),{skills:i,doesHaveSkills:s,promises:{skills:function(){return r.skills.promise}}}}e.$inject=["$q","sfdcService","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("SkillsService",e)}(),function(){function e(e,t){function n(){return contractorSupport}function s(){return mapMode}function i(){return-1!=window.navigator.userAgent.indexOf("Mac OS X")}function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!0;p=e}function a(){return p}function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!0;m=e}function c(){return m}var l={},u={policies:e.defer()},d=userLocale?userLocale.split("_")[0]:"en",v=function(){return"undefined"!=typeof sforce?sforce.console.isInConsole():null},h=[],g=null,p=!1;t.getPolicies().then(function(e){h.push.apply(h,_toConsumableArray(e)),h.length>0?u.policies.resolve(h):u.policies.reject("no policies found")})["catch"](function(e){u.policies.reject(e)});var m=!1,f={},S=!1;return{isOptimizationEnabled:isOptimizationEnabled,lang:d,isOSX:i,isInConsole:v,policies:h,selectedPolicyId:g,areContractorsSupported:n,isMapEnabled:s,setLightBoxStatus:o,isLightboxOpened:c,setBulkActionRunning:r,isBulkActionRunning:a,schedulingRunningFor:f,isScheduleRunning:S,ganttOpenedTerritories:l,promises:{policies:function(){return u.policies.promise}}}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("StateService",e)}(),function(){function e(e,t,n,s,i){function r(e){return L[s.formatDayToString(e)]}function a(e,t){var n=!1;for(var s in S[e]){var i=S[e][s];isIntersect(t,t,i.effectiveStartDate,i.effectiveEndDate)&&(n=!0)}return n}function o(r,a){var o=e.defer();r.setDate(r.getDate()-2),a.setDate(a.getDate()+2),(0!=r.getMinutes()||0!=r.getHours())&&(r.setHours(0),r.setMinutes(0)),(0!=a.getMinutes()||0!=a.getHours())&&(a.setHours(0),a.setMinutes(0),a.setDate(a.getDate()+1));for(var l=!1,u=new Date(r);a>u;u.setDate(u.getDate()+1))if("undefined"==typeof L[s.formatDayToString(u)]){l=!0;break}return l?(n.GetTimePhasedObjects(r,a).then(function(e){for(var n=i.get("monthlyViewHelperService"),l={resourcesAndTerritories:{},resourcesByPrimariesAndRelocations:{},resourceOperatingHours:{},serviceAppointments:{},resourceAbsences:{},resourceCapacities:{},start:r,finish:a},u=new Date(r);a>u;u.setDate(u.getDate()+1))L[s.formatDayToString(u)]=!0;0===f.initialPhasedData.promise.$$state.status&&f.initialPhasedData.resolve(),e.resourcesAndTerritories.forEach(function(e){var t=new ResourcesAndTerritories(e);S[t.serviceResource]=S[t.serviceResource]||{},S[t.serviceResource][t.id]=t,l.resourcesAndTerritories[t.serviceResource]=l.resourcesAndTerritories[t.serviceResource]||{},l.resourcesAndTerritories[t.serviceResource][t.id]=t,"S"!=t.serviceTerritoryType&&(b[t.serviceResource]=b[t.serviceResource]||{},b[t.serviceResource][t.id]=t,l.resourcesByPrimariesAndRelocations[t.serviceResource]=l.resourcesByPrimariesAndRelocations[t.serviceResource]||{},l.resourcesByPrimariesAndRelocations[t.serviceResource][t.id]=t)}),e.services.forEach(function(e){var t=new GanttService(e);(!y[t.id]||y[t.id].isChanged(t)||y[t.id].isChainChanged(t))&&(y[e.Id]=t,l.serviceAppointments[e.Id]=t,(monthlyViewSettings.isMonthlyAvailable&&!scheduler._events[t.id]||scheduler._events[e.Id])&&n.updateMonthlyCapacity(t))}),e.resourceAbsences.forEach(function(e){_[e.Id]&&e.LastModifiedDate===_[e.Id].lastModifiedDate||(_[e.Id]=new ResourceAbsence(e),l.resourceAbsences[e.Id]=_[e.Id],n.updateMonthlyCapacity(_[e.Id]))}),e.resourceCapacities.forEach(function(e){T[e.Id]&&e.LastModifiedDate===T[e.Id].lastModifiedDate||(T[e.Id]=new ResourceCapacity(e),useLocationTimezone||c(T[e.Id]),l.resourceCapacities[e.Id]=T[e.Id])}),t.$broadcast("gotNewTimePhasedObjects",l),o.resolve()})["catch"](function(e){0===f.initialPhasedData.promise.$$state.status&&f.initialPhasedData.reject(e),o.reject(e),console.warn("GetTimePhasedObjects: something went wrong "+e.message),s.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}),o.promise):(o.resolve(),o.promise)}function c(e){var t=s.getUserOffset(e.start_date),n=s.getUserOffset(e.end_date),i=g(e,e.resource);e.start_date=e.start_date.setMinutes(e.start_date.getMinutes()+t-i),e.end_date=e.end_date.setMinutes(e.end_date.getMinutes()+n-i)}function l(e,t){var n=i.get("monthlyViewHelperService"),s={absences:[],services:[],capacities:[]};return Array.isArray(e)||(e=[e]),e.forEach(function(e){if("na"===t){if(_[e.Id]&&e.LastModifiedDate===_[e.Id].lastModifiedDate)return;_[e.Id]=new ResourceAbsence(e),s.absences.push(_[e.Id]),n.updateMonthlyCapacity(_[e.Id])}if("service"===t){var i=new GanttService(e);(!y[i.id]||y[i.id].isChanged(i)||y[i.id].isChainChanged(i))&&(y[e.Id]=i,s.services.push(i),scheduler._events[i.id]&&scheduler._events[i.id].violations&&i.isScheduled()&&(i.violations=scheduler._events[i.id].violations),(monthlyViewSettings.isMonthlyAvailable&&!scheduler._events[i.id]||scheduler._events[e.Id])&&n.updateMonthlyCapacity(i))}if("capacity"===t){if(T[e.Id]&&e.LastModifiedDate===T[e.Id].lastModifiedDate)return;T[e.Id]=new ResourceCapacity(e),s.capacities.push(T[e.Id])}if("stm"===t){var r=new ResourcesAndTerritories(e);S[r.serviceResource]=S[r.serviceResource]||{},S[r.serviceResource][r.id]=r,"S"!=r.serviceTerritoryType&&(b[r.serviceResource]=b[r.serviceResource]||{},b[r.serviceResource][r.id]=r)}}),s}function u(e,t){var n=i.get("monthlyViewHelperService"),s={absences:[],services:[],capacities:[]};return Array.isArray(e)||(e=[e]),e.forEach(function(e){"na"===t?(_[e.Id]&&(_[e.Id].isDeleted=!0),_[e.Id]&&n.updateMonthlyCapacity(_[e.Id]),delete _[e.Id],s.absences.push(e.Id)):"service"===t?(y[e.Id]&&(y[e.Id].isDeleted=!0),n.updateMonthlyCapacity(y[e.Id]),delete y[e.Id],s.services.push(e.Id)):"capacity"===t&&(delete T[e.Id],s.capacities.push(e.Id))}),s}function d(){S={},b={},y={},_={},T={},L={}}function v(e,t){for(var n in S[e]){var i=S[e][n];if(i.effectiveStartDate<=t&&t<=i.effectiveEndDate&&"R"===i.serviceTerritoryType)return s.generateResourceId(e,i.serviceTerritory)}var r=[];for(var a in S[e]){var o=S[e][a];if(!showSecondarySTMs&&o.effectiveStartDate<=t&&t<=o.effectiveEndDate&&"P"===o.serviceTerritoryType)return s.generateResourceId(e,o.serviceTerritory);o.effectiveStartDate<=t&&t<=o.effectiveEndDate&&r.push(o.serviceTerritory)}return r.length>0?s.generateResourceId(e,r):null}function h(e,t,n){for(var i in S[e]){var r=S[e][i];if(r.effectiveStartDate<=t&&t<=r.effectiveEndDate&&"R"===r.serviceTerritoryType)return s.generateResourceId(e,r.serviceTerritory)}var a=null,o=null;for(var c in S[e]){
var l=S[e][c];l.effectiveStartDate<=t&&t<=l.effectiveEndDate&&"P"===l.serviceTerritoryType&&(o=l.serviceTerritory),l.effectiveStartDate<=t&&t<=l.effectiveEndDate&&l.serviceTerritory===n&&(a=l.serviceTerritory)}return a?s.generateResourceId(e,a):s.generateResourceId(e,o)}function g(e,t){var n=S[t],i=null;for(var r in n){var a=n[r];if(isIntersect(a.effectiveStartDate,a.effectiveEndDate,e.start_date,e.end_date)&&(i=a,"R"===a.serviceTerritoryType))break}var o=i&&i.timezone?i.timezone:"GMT";return-moment.tz.zone(o).offset(s.convertDtToMomentDt(e.start_date,o).valueOf())}function p(e,t){var n=e.split("_")[0],s=e.split("_")[1],i=S[n]||{};for(var r in i){var a=i[r];if(a.serviceTerritory!==s&&"R"===a.serviceTerritoryType&&isIntersect(a.effectiveStartDate,a.effectiveEndDate,t,t))return!0}return!1}function m(e,t){var n=e.split("_")[0],s=e.split("_")[1],i=S[n]||{};for(var r in i){var a=i[r];if(a.serviceTerritory==s&&"S"===a.serviceTerritoryType&&isIntersect(a.effectiveStartDate,a.effectiveEndDate,t,t))return!0}return!1}var f={initialPhasedData:e.defer()},S={},b={},y={},_={},T={},L={};return{resourcesAndTerritories:function(){return S},resourcesByPrimariesAndRelocations:function(){return b},serviceAppointments:function(){return y},resourceAbsences:function(){return _},resourceCapacities:function(){return T},visitedDates:function(){return L},getTimePhasedObjects:o,updateTimePhaseData:l,deleteTimePhaseData:u,reset:d,getResoruceGanttIdByDate:v,getResoruceGanttIdByDateAndTerritory:h,getIntersectingSrstOffset:g,didVisitDay:r,isTimephaseAvailable:a,isResourceRelocated:p,isResourceSecondary:m,promises:{initialPhasedData:f.initialPhasedData.promise}}}e.$inject=["$q","$rootScope","sfdcService","utils","$injector"],angular.module("serviceExpert").factory("TimePhasedDataService",e)}(),function(){function e(e,t,n){function s(){for(var e in r)r[e]=0}function i(){var i=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),a=0;s();for(var o=n.GetUserSettingsProperty("locations"),c=0;c<i.length;c++){var l=i[c],u=!0;if(-1!==o.indexOf(i[c].resourceId.split("_")[1])&&("na"===l.type&&(r.avgTravelTime+=l.travelTo+l.travelFrom),"service"===l.type)){if(e.areContractorsSupported()&&l.resourceContractor?u=!1:a++,r.total++,l.statusCategory===t.COMPLETED&&r.completed++,l.violations&&r.violations++,l.jeopardy&&r.jeopardy++,u)if(l.isMDT){var d=0;l.mdtTimes.travel.forEach(function(e){scheduler._min_date<=e.Start&&e.Finish<=scheduler._max_date&&(d+=e.Finish-e.Start)}),r.avgTravelTime+=d/1e3}else r.avgTravelTime+=l.travelTo+l.travelFrom;if(l.isMDT){var v=0;l.mdtTimes.working.forEach(function(e){scheduler._min_date<=e.Start&&e.Finish<=scheduler._max_date&&(v+=e.Finish-e.Start)}),r.totalScheduledDuration+=v/1e3}else r.totalScheduledDuration+=(l.finish-l.start)/1e3}}i.length>0&&r.total>0&&a>0?e.areContractorsSupported()?r.avgTravelTime=Math.floor(r.avgTravelTime/60/a):r.avgTravelTime=Math.floor(r.avgTravelTime/60/r.total):r.avgTravelTime=0}var r={total:0,completed:0,violations:0,jeopardy:0,avgTravelTime:0,totalScheduledDuration:0};return{calculateKpis:i,kpis:r}}e.$inject=["StateService","SERVICE_CATEGORY","userSettingsManager"],angular.module("serviceExpert").factory("kpiCalculationsService",e)}(),function(){function e(e,t,n,s,i,r,a){function o(e){e.setGanttResource(i.resourcesAndTerritories(),r.generateResourceId);var t=scheduler._events[e.id],n=null;if((e.resourceId||t)&&(!e.isMDT||e.mdtTimes)){if(t){var s=c(t.eventBeforeDrag||t);t.eventBeforeDrag&&(t.eventBeforeDrag=null),"service"===e.type||"na"===e.type?(n=t.resourceName===e.resourceName?e.resourceId:t.resourceBeforeDrag||t.resourceId,t.resourceBeforeDrag=null):"break"===e.type&&(n=t.resourceId),v(t.id,n,s.travelBeforeSum,"travel",!1),v(t.id,n,s.scheduledObjectSum,t.type,!1),v(t.id,n,s.travelAfterSum,"travel",!1)}if(!e.resourceId||e.isDeleted||e.locationRemovedMe)return void(e.locationRemovedMe&&(e.locationRemovedMe=!1));var a=c(e);v(e.id,e.resourceId,a.travelBeforeSum,"travel"),v(e.id,e.resourceId,a.scheduledObjectSum,e.type),v(e.id,e.resourceId,a.travelAfterSum,"travel")}}function c(e){if(e.resourceId.indexOf(",")>-1)for(var t=e.resourceId.split(","),n=0;n<t.length;n++)w[t[n]]=w[t[n]]||{};else w[e.resourceId]=w[e.resourceId]||{};var s={start:new Date(e.start_date),finish:new Date(e.start)},i={start:new Date(e.start),finish:new Date(e.finish)},r={start:new Date(e.finish),finish:new Date(e.end_date)};return{travelBeforeSum:e.isMDT?l(e.mdtTimes.travel):l(s.start,s.finish),scheduledObjectSum:e.isMDT?l(e.mdtTimes.working):l(i.start,i.finish),travelAfterSum:l(r.start,r.finish)}}function l(e,t){var n={};if(!t)return e.forEach(function(e){t=new Date(e.Finish);for(var s=new Date(e.Start);t>s;s=d(s)){var i=d(s);i=i>t?t:i,n[u(s)]?n[u(s)]+=Math.round((i.getTime()-s.getTime())/1e3/60):n[u(s)]=Math.round((i.getTime()-s.getTime())/1e3/60)}}),n;for(var s=new Date(e);t>s;s=d(s)){var i=d(s);i=i>t?t:i,n[u(s)]=Math.round((i.getTime()-s.getTime())/1e3/60)}return n}function u(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function d(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate()+1,0,0,0,0)}function v(e,t,n,s){for(var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:!0,r=t.split(","),a=0;a<r.length;a++){t=r[a];for(var o in n)if(w[t]=w[t]||{},void 0===w[t][o]&&(w[t][o]=new h),i)w[t][o][s]+=n[o],-1===w[t][o].events.indexOf(e)&&w[t][o].events.push(e);else{w[t][o][s]-=n[o];var c=w[t][o].events.indexOf(e);c>-1&&w[t][o].events.splice(c,1)}}}function h(){this["break"]=0,this.na=0,this.service=0,this.travel=0,this.capacity=-1,this.overtime=0,this.events=[]}function g(t,n){var s=new h,r=u(n);s.capacity=0;for(var a=0;a<t.length;a++){var o=null,c=t[a].key;if(!(contractorSupport&&t[a].contractor||i.isResourceRelocated(c,n)||i.isResourceSecondary(c,n))){w[c]||(w[c]={}),w[c][r]&&(o=w[c][r]),o||(w[c][r]=new h,o=w[c][r]),-1===o.capacity;var l=L;e.resourceToWorkingDates[c]&&e.resourceToWorkingDates[c][r]&&(l=e.resourceToWorkingDates[c][r]),o&&(s["break"]+=o["break"],s.na+=o.na>l.regular?l.regular:o.na,s.service+=o.service,s.travel+=o.travel,s.capacity+=l.regular>-1?l.regular:0,s.overtime+=l.overtime)}}return s}function p(e){var t=0;C.services&&(t+=e.service),C.breaks&&(t+=e["break"]),C.na&&(t+=e.na),C.travel&&(t+=e.travel);var n=C.overtime?e.capacity+e.overtime:e.capacity;if(n>0){var s=t/n;return s=Math.round(100*s)}return null}function m(e,t,n,s){var i=0;C.services&&(i+=e.service),C.breaks&&(i+=e["break"]),C.na&&(i+=e.na),C.travel&&(i+=e.travel);var r=C.overtime?e.capacity+e.overtime:e.capacity;if(r>0){var a=i/r;a=Math.round(100*a);var o="";o=a<=monthlyViewSettings.high?"style='box-shadow: inset 0 -2px 0 rgb(24, 165, 146)'":a>monthlyViewSettings.high&&a<=monthlyViewSettings.critical?"style='box-shadow: inset 0 -2px 0 #FFEB3B'":"style='box-shadow: inset 0 -2px 0 rgb(236, 95, 84)'";var c="";return e.travel/r>monthlyViewSettings.highTravel/100&&(c='<svg aria-hidden="true" class="tooMuchTravel slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>'),"<div "+o+' onmouseout="removeMonthlyLocationTooltip()" onmouseover="createLocationMonthlyTooltip(event,\''+t+"', '"+n+"', '"+s+"')\">"+c+'<div class="monthlyViewHoursContainer">'+a+"%</div></div>"}return""}function f(e){var t=Math.floor(e/60),n=e%60;return 10>n&&(n="0"+n),{hours:t,minutes:n}}function S(e){return e.hours+"h "+e.minutes+"m"}function b(e){return customLabels.Start+": "+moment(e.start).format("llll")+"\n"+(customLabels.Finish+": "+moment(e.finish).format("llll"))}function y(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:L;if(e.service){var s=f(e.service);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.clock+'"></use></svg>\n                        '+S(s)+"\n                        <div>"+customLabels.TotalScheduled+"</div>\n                    </div>"}if(e.travel){var i=f(e.travel);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_travel_icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>\n                        '+S(i)+"\n                        <div>"+customLabels.TotalTravel+"</div>\n                    </div>"}if(e.na){var r=f(e.na);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.na+'"></use></svg>\n                        '+S(r)+"\n                        <div>"+customLabels.TotalNAs+"</div>\n                    </div>"}if(e["break"]){var a=f(e["break"]);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_travel_icon"><use xlink:href="'+lsdIcons.coffee+'"></use></svg>\n                        '+S(a)+"\n                        <div>"+customLabels.TotalBreaks+"</div>\n                    </div>"}e.capacity,e.overtime;if(n.regular){var o=f(n.regular);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.bucket+'"></use></svg>\n                        '+S(o)+"\n                        <div>"+customLabels.TotalCapacity+"</div>\n                    </div>"}if(n.overtime){var c=f(n.overtime);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_overtime_icon"><use xlink:href="'+lsdIcons.overtime+'"></use></svg>\n                        '+S(c)+"\n                        <div>"+customLabels.TotalOvertime+"</div>\n                    </div>"}return t}function T(){w={},k={}}var L={regular:0,overtime:0},w={},k={},C={services:!0,na:!0,travel:!0,breaks:!0,overtime:!0};return scheduler.attachEvent("onSchedulerReady",function(){scheduler.attachEvent("onXScaleClick",function(e,t,n){"MonthlyView"===scheduler._mode&&scheduler.setCurrentView(t,"ZoomLevel3")}),scheduler.templates.MonthlyView_scalex_class=function(e){return"monthlyXScale"},scheduler.templates.MonthlyView_cell_value=function(t,n){var s=n.key;n.name;if(!contractorSupport||!n.contractor){if(n.children){var i=g(n.children,t);return k[n.key]||(k[n.key]={}),k[n.key][u(t)]=i,m(i,n.key,n.name,u(t))}if(w[s]&&w[n.key][u(t)]){var r=0,a=w[s][u(t)],o=L;if(e.resourceToWorkingDates[s]&&(o=e.resourceToWorkingDates[s][u(t)]||L),C.services&&(r+=a.service),C.breaks&&(r+=a["break"]),C.na){var c=a.na;a.na>o.regular&&(c=o.regular),r+=c}if(C.travel&&(r+=a.travel),0===r)return;var l=void 0,d=void 0,v=C.overtime?o.regular+a.overtime:o.regular;if(v>0){d=r/v,d=Math.round(100*d);var h="";return a.travel/v>monthlyViewSettings.highTravel/100&&(h='<svg aria-hidden="true" class="tooMuchTravel slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>'),l="",l=d<=monthlyViewSettings.high?"rgba(125, 195, 125, "+d/100+")":d>monthlyViewSettings.high&&d<=monthlyViewSettings.critical?"rgba(242, 207, 91, "+(.11+d/100*.65)+")":"rgba(239, 110, 100, "+(.11+d/100*.65)+")","<div onclick=\"createMonthlyTooltip(event, '"+s+"', '"+u(t)+'\')" style="background: '+l+'">'+h+'<div class="monthlyViewHoursContainer">'+d+"%</div></div>"}return l="rgba(239, 110, 100, 1)","<div onclick=\"createMonthlyTooltip(event, '"+s+"', '"+u(t)+'\')" style="background: '+l+'"><div class="monthlyViewHoursContainer"><i class="fa fa-ban" /></div></div>'}}}}),window.createLocationMonthlyTooltip=function(e,t,n,s){$("#MonthlyLocationViewTooltip").remove(),$("#MonthlyViewTooltip").remove();var i=k[t][s],r="";r=y(i,r,{regular:i.capacity,overtime:i.overtime});var a=s.split("_");a=new Date(a[2],a[1],a[0],0,0,0,0),a=moment(a).format("ll");var o=window.innerHeight,c=window.innerWidth,l=e.clientX+340<=c?e.clientX:e.clientX-340;$('<div id="MonthlyLocationViewTooltip">\n                    <h1>'+_.escape(n)+" - "+_.escape(a)+'</h1>\n                    <div id="CapacityIconsContainer">'+r+"</div>\n               </div>").css("left",l+"px").css("top",e.clientY+5+"px").appendTo("body");var u=$("#MonthlyViewTooltip"),d=u.height();d+e.clientY>o&&u.css("top",e.clientY-d-20+"px")},window.removeMonthlyLocationTooltip=function(){$("#MonthlyLocationViewTooltip").remove()},window.createMonthlyTooltip=function(t,n,s){t.stopPropagation(),$("#MonthlyViewTooltip").remove(),$("#MonthlyLocationViewTooltip").remove();var i=a.getResources()[n.split("_")[0]].name,r=w[n][s],o="",c=L;e.resourceToWorkingDates[n]&&e.resourceToWorkingDates[n][s]&&(c=e.resourceToWorkingDates[n][s]),o=y(r,o,c);var l=r.events.sort(function(e,t){return scheduler._events[e].start_date.getTime()>scheduler._events[t].start_date.getTime()?-1:scheduler._events[e].start_date.getTime()<scheduler._events[t].start_date.getTime()?1:0}).map(function(e){var t="",n="";if(scheduler._events[e]&&"service"===scheduler._events[e].type){var s=flaggedServices[e]?customLabels.Unflag:customLabels.Flag;t="__monthlyViewFunctions.service('"+e+"')",n="<div onclick=\"__monthlyViewFunctions.flag(event, '"+e+'\')" class="monthlyViewFlag">'+s+"</div>"}else t="__monthlyViewFunctions.absence('"+e+"')";var i=" ";i+=scheduler._events[e]&&scheduler._events[e].jeopardy?"monthlyView_JeopardyTooltip":"",i+=scheduler._events[e]&&scheduler._events[e].violations&&!scheduler._events[e].jeopardy?"monthlyView_ViolationsTooltip":"";var r="";scheduler._events[e]&&"break"!==scheduler._events[e].type&&(r=Math.floor((scheduler._events[e].travelTo+scheduler._events[e].travelFrom)/60),r=""+S(f(r)),r='<svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg> '+r);var a=Math.floor((scheduler._events[e].finish-scheduler._events[e].start)/1e3/60);a=""+S(f(a)),a='<svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.clock+'"></use></svg> '+a;var o=""===r?"mytooltip_breakfix":"";return'\n                        <div class="'+i+' monthlyView_TooltipEventRow" title="'+b(scheduler._events[e])+'">\n                            <div class="monthlyView_EventName" onclick="'+t+'">'+scheduler._events[e].name+'</div>\n                            <div class="monthlyView_EventDate"><span class="mytooltip_duration '+o+'">'+a+'</span><span class="mytooltip_travel">'+r+"</span>"+n+"</div>\n                        </div>"}),u=s.split("_");u=new Date(u[2],u[1],u[0],0,0,0,0),u=moment(u).format("ll");var d=window.innerHeight,v=window.innerWidth,h=t.clientX+340<=v?t.clientX:t.clientX-340;$('<div id="MonthlyViewTooltip">\n                    <h1>\n                        '+_.escape(i)+" - "+u+'\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.close+'"></use></svg>\n                    </h1>\n                    <div id="CapacityIconsContainer">'+o+'</div>\n                    <div id="MonthlyTooltipListContainer">'+l.join("")+"</div>\n               </div>").css("left",h+"px").css("top",t.clientY+5+"px").appendTo("body");var g=$("#MonthlyViewTooltip"),p=g.height();p+t.clientY>d&&g.css("top",t.clientY-p-20+"px")},$("body").on("click",function(){$("#MonthlyViewTooltip").remove()}),window.__monthlyViewFunctions={service:function(e){s.open(e)},absence:function(e){n.open(e)},flag:function(e,n){e.currentTarget.innerHTML=e.currentTarget.innerHTML===customLabels.Flag?customLabels.Unflag:customLabels.Flag,e.stopPropagation(),t.$broadcast("flagService",n),t.$apply()}},{updateMonthlyCapacity:o,capacityCalculationFields:C,workingTimesByLocation:k,calculateLocation:g,calculateLocationUtilization:p,reset:T}}e.$inject=["calendarsService","$rootScope","AbsenceLightboxService","ServiceAppointmentLightboxService","TimePhasedDataService","utils","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("monthlyViewHelperService",e)}(),function(){function e(){var e={fslOperationRemoteAction:null,apiVersion:"38.0",fieldNames:{Initiator:"Initiator__c",Request_Type:"Request_Type__c",ResultText:"ResultText__c"}};this.setConfig=function(t){return e=t},this.$get=function(n){return t(n,e)},this.$get.$inject=["$q"]}function t(e,t){function n(){$.cometd.addListener("/meta/handshake",function(e){e.successful?(console.log("Handshake successful!"),console.log(e),console.log("setting replay: "+l),u.setReplay(l),$.cometd.subscribe("/topic/MstCompletedChannel",s)):console.warn("Handshake! error: "+e.error)}),$.cometd.addListener("/meta/connect",function(e){e.successful||(console.warn("disconnected! error: "+e.error),console.log(e))});$.cometd.init({url:window.location.protocol+"//"+window.location.hostname+(null!=window.location.port?":"+window.location.port:"")+"/cometd/"+t.apiVersion+"/",requestHeaders:{Authorization:"OAuth "+sessionId},maxBackoff:5e3,logLevel:"debug"})}function s(e){if("deleted"!==e.data.event.type){console.info("message from stream, type: "+e.data.event.type+", replayId: "+e.data.event.replayId+", fslOp: "+e.data.sobject.Id),l=e.data.event.replayId,c[e.data.sobject.Id]=e;var t=o[e.data.sobject.Id];t&&t.deferred.resolve(e)}}function i(e){var t=e.ResourceIDToScheduleData;for(var n in t)t[n].SchedulingOptions.forEach(function(e){e.Interval.Start=moment(e.Interval.Start).valueOf(),e.Interval.Finish=moment(e.Interval.Finish).valueOf();for(var t in e.MSTOptions)e.MSTOptions[t].Interval.Start=moment(e.MSTOptions[t].Interval.Start).valueOf(),e.MSTOptions[t].Interval.Finish=moment(e.MSTOptions[t].Interval.Finish).valueOf()})}function r(e){e.forEach(function(e){e.Interval.Start=moment(e.Interval.Start).valueOf(),e.Interval.Finish=moment(e.Interval.Finish).valueOf()})}function a(n){o[n]={time:(new Date).getTime(),deferred:e.defer(),mstPromise:e.defer()};var s=o[n];return o[n].deferred.promise.then(function(e){t.fslOperationRemoteAction&&Visualforce.remoting.Manager.invokeAction(t.fslOperationRemoteAction,s.time,e.data.sobject.Id,function(e,n){n.status&&!e.fslOperation.fslOperation[t.fieldNames.ResultText]?(e.fslOperation.result=JSON.parse(e.fslOperation.result),"Get Candidates"===e.fslOperation.fslOperation[t.fieldNames.Request_Type]&&i(e.fslOperation.result),"Appointment Booking"===e.fslOperation.fslOperation[t.fieldNames.Request_Type]&&r(e.fslOperation.result.Slots),s.mstPromise.resolve(e)):s.mstPromise.reject(e.fslOperation.fslOperation[t.fieldNames.ResultText])},{buffer:!1,escape:!1,timeout:12e4})}),c[n]&&(s.deferred.resolve(c[n]),delete c[n]),o[n].mstPromise.promise}var o={},c={},l=-1,u=new cometdReplayExtension;return u.setChannel("/topic/MstCompletedChannel"),u.setReplay(l),$.cometd.registerExtension("myReplayExtensionName",u),function(){try{n()}catch(e){console.log(e)}}(),{getUpdates:a}}angular.module("MstResolver",[]).provider("MstResolver",e)}(),GanttService.prototype.setSchedulerProperties=function(){var e=void 0,t=void 0,n=void 0,s=void 0,i=void 0,r=void 0,a=void 0,o=void 0;this.schedStartTime&&(e=60*new Date(this.schedStartTime).getTimezoneOffset()*1e3),this.schedEndTime&&(t=60*new Date(this.schedEndTime).getTimezoneOffset()*1e3),this.dueDate&&(r=60*new Date(this.dueDate).getTimezoneOffset()*1e3),this.earliestStartTime&&(i=60*new Date(this.earliestStartTime).getTimezoneOffset()*1e3),this.arrivalWindowStartTime&&(a=60*new Date(this.arrivalWindowStartTime).getTimezoneOffset()*1e3),this.arrivalWindowEndTime&&(o=60*new Date(this.arrivalWindowEndTime).getTimezoneOffset()*1e3),this.actualStartTime&&(n=60*new Date(this.actualStartTime).getTimezoneOffset()*1e3),this.actualEndTime&&(s=60*new Date(this.actualEndTime).getTimezoneOffset()*1e3),this.text=this.ganttLabel?this.ganttLabel:this.name,this.start=this.schedStartTime?new Date(this.schedStartTime+e):null,this.finish=this.schedEndTime?new Date(this.schedEndTime+t):null,this.dueDate=this.dueDate?new Date(this.dueDate+r):null,this.earlyStart=this.earliestStartTime?new Date(this.earliestStartTime+i):null,this.appStart=this.arrivalWindowStartTime?new Date(this.arrivalWindowStartTime+a):null,this.appEnd=this.arrivalWindowEndTime?new Date(this.arrivalWindowEndTime+o):null,this.actualStartTime=this.actualStartTime?new Date(this.actualStartTime+n):null,this.actualEndTime=this.actualEndTime?new Date(this.actualEndTime+s):null,this.type="service",this.travelTo=this.travelTimeTo?60*parseInt(this.travelTimeTo):0,this.travelFrom=this.travelTimeFrom?60*parseInt(this.travelTimeFrom):0,this.estDuration=this.estDuration?parseFloat(this.estDuration):null},GanttService.prototype.setGanttResource=function(e,t){if(this.isScheduled()){var n=e[this.resource],s=[],i=void 0,r=void 0;this.resourceId=null,this.schedStartTime&&(i=60*new Date(this.schedStartTime).getTimezoneOffset()*1e3),this.schedEndTime&&(r=60*new Date(this.schedEndTime).getTimezoneOffset()*1e3),this.start_date=this.schedStartTime?new Date(this.schedStartTime+i):null,this.end_date=this.schedEndTime?new Date(this.schedEndTime+r):null;for(var a in n){var o=n[a];"R"===o.serviceTerritoryType&&(isIntersect(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.end_date)||!o.effectiveEndDate&&o.effectiveStartDate<this.end_date)&&s.push(o.serviceTerritory)}if(0===s.length)for(var c in n){var l=n[c];isIntersect(l.effectiveStartDate,l.effectiveEndDate,this.start_date,this.start_date)&&s.push(l.serviceTerritory)}this.resourceId=t(this.resource,s),this.isScheduled()&&this.updateDatesBasedOnTravel()}},GanttService.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds?this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60)):(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds,this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60)))),this.travelTo&&(this.travelTo<=maxTravelTimeInSeconds?this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)):(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds,this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)))))},GanttService.prototype.isScheduled=function(){return this.resource&&this.schedEndTime&&this.schedStartTime},GanttService.prototype.getGanttResource=function(e){return e&&getGanttResourceWithSecondaryStms(this),this.resourceId?this.resourceId.substr(0,18):this.resourceId},GanttService.prototype.getGanttTerritory=function(){return this.resourceId?this.resourceId.substr(19,37):this.resourceId},GanttService.prototype.isChanged=function(e){return this.AssignedResourceLastModifiedDate!=e.AssignedResourceLastModifiedDate||this.ServiceAppointmentLastModifiedDate!=e.ServiceAppointmentLastModifiedDate},GanttService.prototype.isChainChanged=function(e){return this.isServiceInChain!=e.isServiceInChain||this.relatedService1!=e.relatedService1||this.relatedService2!=e.relatedService2},GanttService.prototype.minPriority=1e6,GanttService.copy=function(e){var t=new GanttService(null,!0);return angular.merge(t,e),t},GanttService.prototype.calculateMdtTimes=function(e){this.mdtTimes=JSON.parse(e);var t=1e3*(new Date).getTimezoneOffset()*60,n={travel:[],working:[]};this.mdtTimes.forEach(function(e){var s=moment.tz(e.Start,userTimeZone),i=moment.tz(e.Finish,userTimeZone);s=new Date(s.valueOf()-60*s._offset*1e3+t),i=new Date(i.valueOf()-60*i._offset*1e3+t),e.Start=s,e.Finish=i,"OperationalSlot"===e.Type?n.working.push(e):"Travel"===e.Type&&n.travel.push(e)}),this.mdtTimes=n},function(e){var t={Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6};e.TimeSlot=function(e){this.startHour=Math.floor(e[fieldNames.TimeSlot.StartTime]/1e3/60/60),this.startMinute=Math.ceil(e[fieldNames.TimeSlot.StartTime]/1e3/60/60%1*60),this.endHour=Math.floor(e[fieldNames.TimeSlot.EndTime]/1e3/60/60),this.endMinute=Math.ceil(e[fieldNames.TimeSlot.EndTime]/1e3/60/60%1*60),this.type=e[fieldNames.TimeSlot.Type],0==this.endHour&&(this.endHour=24)},e.OperatingHours=function(e){this.id=e.Id,this.name=e.Name,this.timezone=e[fieldNames.OperatingHours.Timezone],this.slots={};var n=e[fieldNames.OperatingHours.Time_Slots__r];n||(n=[]);for(var s=0;s<n.length;s++){var i=n[s],r=i[fieldNames.TimeSlot.DayOfWeek];r=t[r];var a=this.slots[r];a||(a=[],this.slots[r]=a),a.push(new TimeSlot(i))}}}(window),ResourceAbsence.prototype.setSchedulerProperties=function(){var e=void 0,t=void 0;this.start&&(e=60*new Date(this.start).getTimezoneOffset()*1e3),this.end&&(t=60*new Date(this.end).getTimezoneOffset()*1e3),this.start=new Date(this.start+e),this.finish=new Date(this.end+t)},ResourceAbsence.prototype.setGanttResource=function(e,t){var n=e[this.resource],s=[];if(this.resourceId=null,this.isScheduled()){this.start_date=this.start?new Date(this.start.getTime()):null,this.end_date=this.finish?new Date(this.finish.getTime()):null;for(var i in n){var r=n[i];"R"===r.serviceTerritoryType&&(isIntersect(r.effectiveStartDate,r.effectiveEndDate,this.start_date,this.end_date)||!r.effectiveEndDate&&r.effectiveStartDate<this.end_date)&&s.push(r.serviceTerritory)}if(0===s.length)for(var a in n){var o=n[a];(isIntersect(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.end_date)||!o.effectiveEndDate&&o.effectiveStartDate<this.end_date)&&s.push(o.serviceTerritory)}this.resourceId=t(this.resource,s),this.isScheduled()&&this.updateDatesBasedOnTravel()}},ResourceAbsence.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds?this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60)):(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds,this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60)))),this.travelTo&&(this.travelTo<=maxTravelTimeInSeconds?this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)):(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds,this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)))))},ResourceAbsence.prototype.isScheduled=function(){return!!this.resource},ResourceAbsence.prototype.getGanttResource=function(){return this.resourceId?this.resourceId.substr(0,18):this.resourceId},ResourceCapacity.prototype.setSchedulerProperties=function(){var e=void 0,t=void 0;switch(this.start&&(e=60*new Date(this.start).getTimezoneOffset()*1e3),this.end&&(t=60*new Date(this.end).getTimezoneOffset()*1e3),this.start_date=this.start?new Date(this.start+e):null,this.end_date=this.end?new Date(this.end+t):null,this.timePeriod){case"Day":this.end_date=addDaysToDate(this.start_date,1);break;case"Week":this.end_date=addDaysToDate(this.start_date,7);break;case"Month":this.end_date=addDaysToDate(this.end_date,1)}this.hoursPerTimePeriod>0?this.text="<b>"+customLabels.booked.replaceAll(calcCapacityPercentage(this.hoursInUse,this.hoursPerTimePeriod)+"%")+"</b> (<b>"+customLabels.x_Hours_scheduled_out_of_y.replaceAll(this.hoursInUse,this.hoursPerTimePeriod)+"</b>)":this.workItemsPerTimePeriod>0&&(this.text="<b>"+customLabels.booked.replaceAll(calcCapacityPercentage(this.workItemsAllocated,this.workItemsPerTimePeriod)+"%")+"</b> (<b>"+customLabels.NumServicesScheduled.replaceAll(this.workItemsAllocated,this.workItemsPerTimePeriod)+"</b>)"),this.type="contractorcapacity"},ResourceCapacity.prototype.setGanttResource=function(e,t){var n=e[this.resource],s=[];for(var i in n){var r=n[i];(isIntersect(r.effectiveStartDate,r.effectiveEndDate,this.start_date,this.end_date)||!r.effectiveEndDate&&r.effectiveStartDate<this.end_date)&&s.push(r.serviceTerritory)}this.resourceId=t(this.resource,s)},ResourceCapacity.prototype.isScheduled=function(){return!!this.resource},ResourceCapacity.prototype.getGanttResource=function(){return this.resourceId?this.resourceId.substr(0,18):this.resourceId};var bootstrap={};bootstrap.loadUserSettings=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.IsUserSettingExist,function(e,t){t.status?0==t.result?Visualforce.remoting.Manager.invokeAction(RemoteActions.CreateNewUserSettingsLocStorage,localStorage.getItem(sfdcUser+"_serviceExpertLocations"),localStorage.getItem(sfdcUser+"_serviceExpertOrphan"),localStorage.getItem(sfdcUser+"_serviceExpertSettings"),localStorage.getItem(sfdcUser+"_serviceExpertFilters"),function(e,t){t.status&&(bootstrap.loadedUserSettings=JSON.parse(t.result),angular.bootstrap(document.getElementById("serviceExpertApp"),["serviceExpert"]))},{buffer:!1,escape:!1,timeout:12e4}):Visualforce.remoting.Manager.invokeAction(RemoteActions.GetCreateUserSettings,function(e,t){t.status?(bootstrap.loadedUserSettings=JSON.parse(t.result),angular.bootstrap(document.getElementById("serviceExpertApp"),["serviceExpert"])):bootstrap.handleError(t)},{buffer:!1,escape:!1,timeout:12e4}):bootstrap.handleError(t)},{buffer:!1,escape:!1,timeout:12e4})},bootstrap.Start=function(){bootstrap.UpdatePermissionSets()},bootstrap.UpdatePermissionSets=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.updatePermissionSets,function(e,t){bootstrap.loadUserSettings()})},bootstrap.UpdatePermissionSetsBootstrap=function(e,t){angular.bootstrap(document.getElementById(e),[t])},bootstrap.handleError=function(e){var t={no_dispatcher_license_found:!0},n=!1;for(var s in t)customLabels[s]==e.message&&(n=!0);cantLoadGantt(-1!=e.message.toLowerCase().indexOf("dml")?customLabels.no_dispatcher_permissions_found.replace("{0}",'<a href="vf066_settings#page=0&tab=1" target="_blank">').replace("{1}","</a>"):n?e.message:customLabels.dispatcher_console_error_loading)};var globalStatuses={},globalCategories={},flaggedServices={},contextShown=!1,snapTo=!1,globalSelectedGanttServices={},capacityDurationFilter="Day",cachedDomElements={},violationDelimiter="&lt;br/&gt;",minHourToDisplay=0,maxHourToDisplay=24,includeWeekends=!1,gameOn=!1,showCandidates={on:!1,id:null};$(function(){moment.locale(userLocale)}),$(function(){svg4everybody(),"function"==typeof srcUp&&$("body").css("margin","0")});var formatDateByLocaleWithDayOfTheWeek=function(e){var t=utils.formatDateWithDayOfWeek(e);if(t)return t;var n=["en_US"];return-1!=n.indexOf(userLocale)?moment(e).format("ddd, MMM D YYYY"):moment(e).format("LL")};scheduler.attachEvent("onSchedulerReady",function(){scheduler.templates.ZoomLevel1_second_scale_date=function(e){return formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.MonthlyView_second_scale_date=function(e){return moment(e).format("MMM")},scheduler.templates.MDTView_second_scale_date=scheduler.templates.MonthlyView_second_scale_date,scheduler.templates.ZoomLevel2_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel3_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel4_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel5_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel6_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel2_date=function(e,t){return e.getDate()!==t.getDate()?formatDateByLocaleWithDayOfTheWeek(e)+" - "+formatDateByLocaleWithDayOfTheWeek(t):formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.ZoomLevel3_date=function(e,t){return formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.ZoomLevel4_date=function(e,t){var n=new Date(t);return n.setDate(n.getDate()-1),formatDateByLocaleWithDayOfTheWeek(e)+" - "+formatDateByLocaleWithDayOfTheWeek(n)},scheduler.templates.ZoomLevel5_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.ZoomLevel6_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MonthlyView_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MDTView=scheduler.templates.ZoomLevel4_date});var BrickBreaker=function(){
function e(){function e(e){var t=e.clientX-h.offsetLeft;t>0&&t<h.width&&(T=t-_/2)}function t(){g.beginPath(),g.arc(m,f,p,0,2*Math.PI),g.fillStyle="#0095DD",g.fill(),g.closePath()}function n(){g.beginPath(),g.rect(T,h.height-y,_,y),g.fillStyle="#0095DD",g.fill(),g.closePath()}function s(){for(var e=0;e<l.length;e++)if(0!=l[e].status){var t=l[e].left,n=l[e].top,s=l[e].width,i=l[e].height;g.beginPath(),g.rect(t,n,s,i),g.fillStyle=l[e].color,g.fill(),s>=40&&(g.font="10px Salesforce Sans",g.fillStyle="#000",g.fillText(l[e].name,t+5,n+10)),g.closePath()}}function i(){if(g.clearRect(0,0,h.width,h.height),s(),t(),n(),r(),o(),(m+S>h.width-p||p>m+S)&&(S=-S),p>f+b)b=-b;else if(f+b>h.height-p)if(m>T&&T+_>m)b=-b;else{if(C--,!C)return alert("GAME OVER - back to work"),void a();m=h.width/2,f=h.height-30,S=5,b=-5,T=(h.width-_)/2}L&&T<h.width-_?T+=7:w&&T>0&&(T-=7),m+=S,f+=b,requestAnimationFrame(i)}function r(){for(var e=0;e<l.length;e++){var t=l[e];if(1==t.status&&m>=t.left&&m<=t.left+t.width&&f>=t.top&&f<=t.top+t.height&&(b=-b,t.status=0,k+=10,k/10==l.length))return alert("You win, great... ¯\\_(ツ)_/¯. back to work"),void a()}}function a(){gameOn=!1,document.removeEventListener("mousemove",e),scheduler.updateView(),$("#bricks-overlay").remove()}function o(){g.font="16px Salesforce Sans",g.fillStyle="#0095DD",g.fillText("Score: "+k+", Lives: "+C,d/2,25)}function c(){for(var e={scheduled:"#F9D058","new":"#A5E2D6",dispatched:"#8DD8FA",inprogress:"#D68EF9",completed:"#95D055",incomplete:"#EA8288","default":"#B7C9EA"},t=[],n=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),s=0;s<n.length;s++){var i=n[s],r=void 0,a=void 0,o=$(scheduler.getRenderedEvent(i.id));o.visible()&&(a=$(o.children()[0]).width(),"service"==i.type?r=e[i.Status.toLowerCase().replace(" ","")]:"break"==i.type?(r="#5e698f",a=o.width()):"na"==i.type&&(r="#d7dfe7"),t.push({color:r,top:o.offset().top-264,left:o.offset().left-$("#LeftSideContainer").width()+8,width:a,height:scheduler.matrix.ZoomLevel3.event_dy-2,name:i.name,status:1}))}return t}var l=c();gameOn=!0,scheduler.updateView(),$("#GanttContainer").append('<div id="bricks-overlay" style="position:absolute; top:100px; z-index:100">\n                                            <canvas id="brick-canvas"></canvas>\n                                        </div>');var u=$(".dhx_cal_data"),d=u.width(),v=u.height(),h=document.getElementById("brick-canvas");h.width=d,h.height=v;var g=h.getContext("2d"),p=15,m=h.width/2,f=h.height-30,S=5,b=-5,y=15,_=95,T=($("body").width()-_)/2,L=!1,w=!1,k=0,C=3;$(".item").length>15?15:$(".item").length;return document.addEventListener("mousemove",e,!1),i(),"GAME ON!"}return $.fn.visible=function(e){var t=$(this),n=$(window),s=n.scrollTop(),i=s+n.height(),r=t.offset().top,a=r+t.height(),o=e===!0?a:r,c=e===!0?r:a;return i>=c&&o>=s},{play:e}}(),schedulerConfig=function(e){function t(){scheduler.createTimelineView({name:"ZoomLevel2",x_unit:"minute",x_date:v.dateFormat,x_step:30,x_size:16,x_start:0,x_length:6,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:v.resourceCellSize,second_scale:{x_unit:"day",x_date:v.dateTitleFormat},event_dy:v.eventHeight,dy:v.rowHeight,section_autoheight:!1,folder_dy:v.locationCellHeight,folder_events_available:!1,sort:v.sort})}function n(){scheduler.createTimelineView({name:"ZoomLevel3",x_unit:"minute",x_date:v.dateFormat,x_step:60,x_size:24,x_start:0,x_length:24,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:v.resourceCellSize,second_scale:{x_unit:"day",x_date:v.dateTitleFormat},event_dy:v.eventHeight,dy:v.rowHeight,section_autoheight:!1,folder_dy:v.locationCellHeight,folder_events_available:!1,sort:v.sort})}function s(){scheduler.createTimelineView({name:"ZoomLevel4",x_unit:"minute",x_date:v.dateFormat,x_step:120,x_size:24,x_start:0,x_length:12,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:v.resourceCellSize,second_scale:{x_unit:"day",x_date:v.dateTitleFormat},event_dy:v.eventHeight,dy:v.rowHeight,section_autoheight:!1,folder_dy:v.locationCellHeight,folder_events_available:!1,sort:v.sort})}function i(){scheduler.createTimelineView({name:"ZoomLevel5",x_unit:"minute",x_date:v.dateFormat,x_step:240,x_size:18,x_start:0,x_length:6,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:v.resourceCellSize,second_scale:{x_unit:"day",x_date:v.dateTitleFormat},event_dy:v.eventHeight,dy:v.rowHeight,section_autoheight:!1,folder_dy:v.locationCellHeight,folder_events_available:!1,sort:v.sort})}function r(){scheduler.createTimelineView({name:"ZoomLevel6",x_unit:"minute",x_date:v.dateFormat,x_step:360,x_size:28,x_start:0,x_length:4,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:v.resourceCellSize,second_scale:{x_unit:"day",x_date:v.dateTitleFormat},event_dy:v.eventHeight,dy:v.rowHeight,section_autoheight:!1,folder_dy:v.locationCellHeight,folder_events_available:!1,sort:v.sort})}function a(){scheduler.createTimelineView({name:"MonthlyView",x_unit:"day",x_date:"%d",x_step:1,x_size:31,x_start:0,x_length:1,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:v.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:v.eventHeight,dy:v.rowHeight,section_autoheight:!1,folder_dy:v.locationCellHeight,folder_events_available:!1,sort:v.sort})}function o(){scheduler.createTimelineView({name:"MTDView",x_unit:"day",x_date:"%d",x_step:1,x_size:35,x_start:0,x_length:1,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:v.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:v.eventHeight,dy:v.rowHeight,section_autoheight:!1,folder_dy:v.locationCellHeight,folder_events_available:!1,sort:v.sort})}function c(){t(),n(),s(),i(),r(),a(),o()}function l(){scheduler.config.drag_resize=!1,scheduler.config.multisection=!0,scheduler.config.multisection_shift_all=!1,scheduler.config.limit_drag_out=!1,scheduler.config.dblclick_create=!1,scheduler.config.mark_now=!1,scheduler.config.time_step=1,scheduler.dhtmlXTooltip.config.className="dhtmlXTooltip tooltip expertTooltip",scheduler.dhtmlXTooltip.config.timeout_to_display=375,scheduler.dhtmlXTooltip.config.delta_x=-15,scheduler.dhtmlXTooltip.config.delta_y=-15,scheduler.config.minicalendar.mark_events=!1,scheduler.config.preserve_length=!1}function u(e,t){var n=32;switch(e){case"xsmall":n=27;break;case"small":n=32;break;case"normal":n=39;break;case"large":n=46;break;default:n=39}if(scheduler.matrix.ZoomLevel3.dy!=n){for(var s in scheduler.matrix)scheduler.matrix[s].dy=n,scheduler.matrix[s].event_dy=n-4,scheduler.matrix[s].folder_dy=n+2;t&&scheduler._is_initialized()&&scheduler.setCurrentView()}}function d(e,t){var n=new Date(e.start_date),s=new Date(e.end_date),i=new Date(t.start_date),r=new Date(t.end_date);return"na"==e.type&&"na"!=t.type?(n>r||i>s)&&+n>+i?1:-1:"na"==t.type&&"na"!=e.type?i>s||n>r?+n>+i?1:-1:1:+n>+i?1:-1}var v={dateTitleFormat:"%D, %F %d",dateFormat:"%g:%i%A",resourceCellSize:170,locationCellHeight:44,rowHeight:46,eventHeight:42,sort:d};return{timelineConfigs:v,configTimelines:c,setRowHeights:u,setConfigurations:l,sortEvents:d}}(schedulerConfig||{});scheduler.attachEvent("onSchedulerReady",function(){scheduler.templates.calendar_month=function(e){var t=["en_US","en_GB"];return-1!=t.indexOf(userLocale)?moment(e).format("MMMM YYYY"):moment(e).format("LL")},scheduler.templates.calendar_date=function(e){return moment(e).format("DD")},scheduler.templates.calendar_scale_date=function(e){return moment(e).format("ddd")},scheduler.templates.calendar_time=function(e){return moment(e).format("l")}});